#+TITLE: Emacs config
#+OPTIONS: toc:4
#+PROPERTY: header-args :results silent :tangle yes :comments yes
#+STARTUP: showeverything
#+auto_tangle: t

*  Custom configuration
#+BEGIN_SRC emacs-lisp
(load "~/.emacs.user" t t)
#+END_SRC

*  Package Management
** Set priorities
#+begin_src emacs-lisp
(setq package-archive-priorities '(("melpa"  . 100)
                                   ("gnu"    .  50)
                                   ("nongnu" .  25)))
#+end_src

** Automatically update
#+BEGIN_SRC emacs-lisp
(use-package auto-package-update
  :custom
  (auto-package-update-interval 7)
  (auto-package-update-prompt-before-update t)
  (auto-package-update-hide-results t)
  (auto-package-update-delete-old-versions t)
  :config
  (auto-package-update-maybe)
  (auto-package-update-at-time "12:00"))
#+END_SRC

** [[https://github.com/tarsius/auto-compile][Automatically compile packages]]
Do not load outdated byte code
#+BEGIN_SRC emacs-lisp
(setq load-prefer-newer t)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package auto-compile
  :custom
  (auto-compile-ding nil)
  (auto-compile-display-buffer nil)
  (auto-compile-use-mode-line nil)
  :config
  (auto-compile-on-load-mode)
  (auto-compile-on-save-mode))
#+END_SRC

** [[https://gitlab.com/jabranham/system-packages][System packages]]
Do not ask for confirmation for new shell buffers
#+BEGIN_SRC emacs-lisp
(setq async-shell-command-buffer 'new-buffer)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package use-package-ensure-system-package)

(use-package system-packages
  :ensure-system-package ((pip . python3-pip) npm (gem . rubygems))
  :custom (system-packages-noconfirm t))
(with-eval-after-load "system-packages"
  (defun cpped-run-command-sync-logged (wrapped-function &rest arguments)
    "Run a command synchronously and return the output."
    (shell-command-to-string (car arguments)))
  (advice-add 'async-shell-command :around #'cpped-run-command-sync-logged)
  (add-hook 'after-init-hook '(lambda ()
                                (advice-remove 'async-shell-command #'cpped-run-command-sync-logged)))
  (defun cpped-install-system-package (package &rest arguments)
    "Wrapper around system-packages-install to install only missing packages."
    (let ((system-packages-packagemanager (or (plist-get arguments :package-manager)
                                              system-packages-packagemanager)))
      (if (not (or (executable-find (or (plist-get arguments :executable)
                                        package))
                   (string-match (concat ".*" package ".*") (system-packages--run-command 'list-installed-packages nil package))))
          (progn
            (message (concat "Installing system package '" package "'."))
            (system-packages-install package))
        (message (concat "System package '" package "' is already installed. Skipping."))))
    nil)
  (add-to-list 'system-packages-supported-package-managers
               '(dnf .
                     ((default-sudo . t)
                      (install . "dnf install --assumeyes")
                      (search . "dnf search")
                      (uninstall . "dnf remove --assumeyes")
                      (update . ("dnf upgrade --assumeyes"))
                      (clean-cache . "dnf clean all --assumeyes")
                      (log . "dnf history")
                      (get-info . "rpm -qi")
                      (get-info-remote . "dnf info")
                      (list-files-provided-by . "rpm -ql")
                      (verify-all-packages . "rpm -Va")
                      (verify-all-dependencies . "dnf repoquery --requires")
                      (remove-orphaned . "dnf autoremove")
                      (list-installed-packages . "dnf list --installed")
                      (list-installed-packages-all . nil)
                      (list-dependencies-of . "rpm -qR"))))
  (add-to-list 'system-packages-supported-package-managers
               '(pip .
                     ((default-sudo . nil)
                      (install . "pip3 install")
                      (search . "pip3 search")
                      (uninstall . "pip3 uninstall")
                      (update . nil)
                      (clean-cache . nil)
                      (log . nil)
                      (get-info . nil)
                      (get-info-remote . nil)
                      (list-files-provided-by . nil)
                      (verify-all-packages . nil)
                      (verify-all-dependencies . nil)
                      (remove-orphaned . nil)
                      (list-installed-packages . "pip3 list")
                      (list-installed-packages-all . nil)
                      (list-dependencies-of . nil)))
               t)
  (add-to-list 'system-packages-supported-package-managers
               '(npm .
                     ((default-sudo . t)
                      (install . "npm --global install")
                      (search . "npm --global search")
                      (uninstall . "npm --global uninstall")
                      (update . "npm --global update")
                      (clean-cache . "npm --global cache clean")
                      (log . nil)
                      (get-info . nil)
                      (get-info-remote . nil)
                      (list-files-provided-by . nil)
                      (verify-all-packages . nil)
                      (verify-all-dependencies . nil)
                      (remove-orphaned . nil)
                      (list-installed-packages . "npm --global list")
                      (list-installed-packages-all . nil)
                      (list-dependencies-of . nil)))
               t)
  (add-to-list 'system-packages-supported-package-managers
               '(gem .
                     ((default-sudo . nil)
                      (install . "gem install")
                      (search . "gem query")
                      (uninstall . "gem uninstall")
                      (update . "gem update")
                      (clean-cache . "npm cache clean")
                      (log . nil)
                      (get-info . "gem query")
                      (get-info-remote . "gem search")
                      (list-files-provided-by . nil)
                      (verify-all-packages . nil)
                      (verify-all-dependencies . nil)
                      (remove-orphaned . nil)
                      (list-installed-packages . "gem list")
                      (list-installed-packages-all . nil)
                      (list-dependencies-of . "gem dependency")))
               t))
#+END_SRC

*  Internals
** Include cl package
#+BEGIN_SRC emacs-lisp
(use-package cl-lib)
#+END_SRC

** Silence native compilation warnings
#+BEGIN_SRC emacs-lisp
(setq native-comp-async-report-warnings-errors nil)
#+END_SRC

** Utilities
#+BEGIN_SRC emacs-lisp
(defun cpped-word-or-region-bounds()
  "Get the bounds of the current region or word under point."
  (if (use-region-p)
      (cons (region-beginning) (region-end))
    (bounds-of-thing-at-point 'word)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun shark-bytes/truncate (string max-length)
  "Truncate STRING to MAX-LENGTH charcaters by replacing characters in the middle with an ellipsis."
  (if (< (length string) max-length)
      string
    (let ((len (min (/ (length string) 2) (/ (- max-length 1) 2))))
      (concat (substring string 0 len) "…" (substring string (- 0 (+ len (- max-length 1 (* len 2)))) nil)))))
#+END_SRC

** Increase subprocess read chunk size
#+BEGIN_SRC emacs-lisp
(setq read-process-output-max (* 16 1024 1024))
#+END_SRC

** [[https://github.com/jschaf/esup][Startup Profiler]]
#+BEGIN_SRC emacs-lisp
(use-package esup
  :commands (esup))
#+END_SRC

** [[https://github.com/lastquestion/explain-pause-mode][Waiting time information]]
#+BEGIN_SRC emacs-lisp
(use-package explain-pause-mode
  :straight (explain-pause-mode
             :type git
             :host github
             :repo "lastquestion/explain-pause-mode")
  :init (explain-pause-mode))
#+END_SRC

** Debug on error
#+BEGIN_SRC emacs-lisp
(setq debug-on-error init-file-debug
      eval-expression-debug-on-error init-file-debug)
#+END_SRC

** Debug on message
#+BEGIN_SRC emacs-lisp
;; (setq debug-on-message "")
#+END_SRC

*  User Interface
** Startup
*** Disable startup screen
#+BEGIN_SRC emacs-lisp
(setq inhibit-startup-screen t)
#+END_SRC

*** Disable startup message
#+BEGIN_SRC emacs-lisp
(when (boundp 'username)
  (setq inhibit-startup-echo-area-message username))
#+END_SRC

** Frame Setup
Show normal for single monitor, fullscreen for non-4k monitor
#+BEGIN_SRC emacs-lisp
(defvar cpped-is-4k-monitor nil "Indicates if a 4k monitor is available.")

(set-frame-name "IDE")

(add-hook 'before-make-frame-hook '(lambda ()
                                     (setq default-frame-alist `((title . "IDE")
                                                                 (name . "IDE")
                                                                 (background-color . "#121212")
                                                                 (internal-border-width . 8))

                                           cpped-is-4k-monitor (>= (x-display-pixel-width) 3840))
                                     (unless cpped-is-4k-monitor
                                       (push '(fullscreen . fullboth) default-frame-alist))))
#+END_SRC

Show below other windows
#+BEGIN_SRC emacs-lisp
(defun cpped-move-frame-below-others (&optional frame)
  "Move frame below others in window system."
  (interactive)
  (with-selected-frame (or frame (selected-frame))
    (when (and window-system
               (not cpped-is-4k-monitor))
      (x-send-client-message nil 0 nil "_NET_WM_STATE" 32 '(1 "_NET_WM_STATE_BELOW" 0)))))

(add-hook 'after-make-frame-functions #'cpped-move-frame-below-others t)
#+END_SRC

** Do not auto-raise minibuffer
#+BEGIN_SRC emacs-lisp
(setq minibuffer-auto-raise nil)
#+END_SRC

** Do not allow cursor in minibuffer
#+BEGIN_SRC emacs-lisp
(setq minibuffer-prompt-properties '(read-only t point-entered minibuffer-avoid-prompt face minibuffer-prompt))
#+END_SRC

** GTK+ interface
*** Disable Menus, Toolbars, Scrollbars and Dialogs
#+BEGIN_SRC emacs-lisp
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)
(setq use-file-dialog nil
      use-dialog-box nil)
#+END_SRC

*** Use GTK+ Tooltips
#+BEGIN_SRC emacs-lisp
(setq x-gtk-use-system-tooltips t)
#+END_SRC

** Notifications
#+BEGIN_SRC emacs-lisp
(use-package notifications)
#+END_SRC

** Disable bell
#+BEGIN_SRC emacs-lisp
(setq ring-bell-function 'ignore)
#+END_SRC

** Disable messages
#+BEGIN_SRC emacs-lisp
(setq inhibit-message t)
#+END_SRC

** Keep more lines in message buffer
#+BEGIN_SRC emacs-lisp
(setq message-log-max 16384)
#+END_SRC

** Remove annoying ellipsis when printing SEXP in message buffer
#+BEGIN_SRC emacs-lisp
(setq eval-expression-print-length nil
      eval-expression-print-level nil
      edebug-print-length nil
      edebug-print-level nil
      print-length nil
      print-level nil)
#+END_SRC

** Disable mouse
#+BEGIN_SRC emacs-lisp
(use-package disable-mouse
  :config
  (mouse-wheel-mode -1)
  (global-disable-mouse-mode))
#+END_SRC

*** Hide mouse pointer
#+BEGIN_SRC emacs-lisp
(setq make-pointer-invisible t)
#+END_SRC

*** Do not copy highlighted text to the kill ring
#+BEGIN_SRC emacs-lisp
(setq mouse-drag-copy-region nil)
#+END_SRC

** Use y/n instead of yes/no
#+BEGIN_SRC emacs-lisp
(fset 'yes-or-no-p 'y-or-n-p)
#+END_SRC

** Do not show unusable commands
#+begin_src emacs-lisp
(setq read-extended-command-predicate #'command-completion-default-include-p)
#+end_src

** Show keystrokes earlier
#+BEGIN_SRC emacs-lisp
(setq echo-keystrokes 0.1)
#+END_SRC

** History
#+BEGIN_SRC emacs-lisp
(use-package savehist
  :custom
  (history-length 10000)
  (history-delete-duplicates t)
  (savehist-save-minibuffer-history t)
  (savehist-additional-variables '(kill-ring
                                   search-ring
                                   regexp-search-ring
                                   extended-command-history))
  (savehist-autosave-interval 180)
  :config
  (savehist-mode t))
#+END_SRC

** Fonts
*** Disable font cache compacting
#+BEGIN_SRC emacs-lisp
(setq inhibit-compacting-font-caches t)
#+END_SRC

*** [[https://github.com/mickeynp/ligature.el][Support Ligatures]]
#+BEGIN_SRC emacs-lisp
(use-package ligature
  :straight (ligature
             :type git
             :host github
             :repo "mickeynp/ligature.el")
  :config
  (ligature-set-ligatures 't '("www"))
  (ligature-set-ligatures 'eww-mode '("ff" "fi" "ffi"))
  (ligature-set-ligatures 'prog-mode '("|||>" "<|||" "<==>" "<!--" "####" "~~>" "***" "||=" "||>"
                                       ":::" "::=" "=:=" "===" "==>" "=!=" "=>>" "=<<" "=/=" "!=="
                                       "!!." ">=>" ">>=" ">>>" ">>-" ">->" "->>" "-->" "---" "-<<"
                                       "<~~" "<~>" "<*>" "<||" "<|>" "<$>" "<==" "<=>" "<=<" "<->"
                                       "<--" "<-<" "<<=" "<<-" "<<<" "<+>" "</>" "###" "#_(" "..<"
                                       "..." "+++" "/==" "///" "_|_" "www" "&&" "^=" "~~" "~@" "~="
                                       "~>" "~-" "**" "*>" "*/" "**/" "||" "|}" "|]" "|=" "|>" "|-" "{|"
                                       "[|" "]#" "::" ":::" ":=" ":>" ":<" "$>" "==" "=>" "!=" "!!" ">:"
                                       ">=" ">>" ">-" "-~" "-|" "->" "--" "..<" "-<" "<~" "<*" "<|" "<:"
                                       "<$" "<=" "<>" "<-" "<<" ">>" "<+" "</" "#{" "#[" "#:" "#=" "#!"
                                       "##" "###" "####" "#(" "#?" "#_" "%%" ".=" ".-" ".." ".?" "+>" "++" "?:"
                                       "^=" "?=" "?." "??" ";;" "/*" "/**" "/=" "/>" "//" "///" "__" "~~" "(*" "*)"
                                       "\\\\" "\\\\\\" "://" "[]" "{-" "-}" "<<<" ">>>" ">>-" ">>=" "<<-" "<<="  "<~"))
  (ligature-set-ligatures '(html-mode nxml-mode web-mode) '("<!--" "-->" "</>" "</" "/>" "://"))
  (global-ligature-mode t))
#+END_SRC

*** Show pretty symbols
Do not disable prettification if cursor is at edge of expression
#+BEGIN_SRC emacs-lisp
(setq prettify-symbols-unprettify-at-point nil)
#+END_SRC

Allow prettification in comments
#+BEGIN_SRC emacs-lisp
(defun cpped-prettify-symbols-default-compose-p (start end _match)
  "Same as `prettify-symbols-default-compose-p', except compose symbols in comments as well."
  (let* ((syntaxes-beg (if (memq (char-syntax (char-after start)) '(?w ?_))
                           '(?w ?_) '(?. ?\\)))
         (syntaxes-end (if (memq (char-syntax (char-before end)) '(?w ?_))
                           '(?w ?_) '(?. ?\\))))
    (not (or (memq (char-syntax (or (char-before start) ?\s)) syntaxes-beg)
             (memq (char-syntax (or (char-after end) ?\s)) syntaxes-end)
             (nth 3 (syntax-ppss))))))

(add-hook 'prog-mode-hook '(lambda ()
                             (setq prettify-symbols-compose-predicate 'cpped-prettify-symbols-default-compose-p)))
#+END_SRC

Prettify common symbols
#+BEGIN_SRC emacs-lisp
(add-hook 'find-file-hook (lambda ()
                            (push '("\t" . ?) prettify-symbols-alist)
                            (push '("lambda" . ?λ) prettify-symbols-alist)
                            (push '("\r" . ?) prettify-symbols-alist)))

(global-prettify-symbols-mode)
#+END_SRC

Prettify escaped newline
#+BEGIN_SRC emacs-lisp
(add-to-list 'font-lock-extra-managed-props 'display)

(font-lock-add-keywords nil
                        `((,(rx (group "\\") eol) 1 '(face nil display "﬌"))))
#+END_SRC

** Faces
*** Info
#+BEGIN_SRC emacs-lisp
(defface info '((t :inherit default))
  "Face used for info text."
  :group 'basic-faces)
#+END_SRC

*** [[github:Fuco1/fontify-face][Fontify symbols representing faces]]
#+BEGIN_SRC emacs-lisp
(use-package fontify-face
  :hook (emacs-lisp-mode . fontify-face-mode)
  :straight (fontify-face
             :type git
             :host github
             :repo "Fuco1/fontify-face"))
#+END_SRC

** Icons
*** [[https://github.com/domtronn/all-the-icons.el][Show icons]]
#+BEGIN_SRC emacs-lisp
(defconst cpped-faicon5-data-file (expand-file-name "data-faicon5.el" user-emacs-directory) "The data file for FontAwesome 5 icon names.")

(defun cpped-update-faicon5-data ()
  (delete-file cpped-faicon5-data-file)
  (write-region "(defvar fa5-icon-alist\n'(\n" nil cpped-faicon5-data-file 'append)
  (with-current-buffer (url-retrieve-synchronously "https://raw.githubusercontent.com/FortAwesome/Font-Awesome/master/css/all.css")
    (widen)
    (goto-char 1)
    (save-match-data
      (while (search-forward-regexp (rx bol (0+ space) ".fa-" (group (+ (not (in ":")))) ":before" (0+ space) "{" (+ space) "content:" (0+ space) "\"\\" (group (+ (not (in "\""))))) nil t)
        (write-region (format "(\"%s\" . \"\\x%s\")\n" (match-string 1) (match-string 2)) nil cpped-faicon5-data-file 'append)))
    (kill-buffer))
  (write-region "\n))\n(provide 'data-faicon5)" nil cpped-faicon5-data-file 'append))

(defconst cpped-material-icon-data-file (expand-file-name "data-material-icon.el" user-emacs-directory) "The data file for material icon names.")

(defun cpped-update-material-icon-data ()
  (delete-file cpped-material-icon-data-file)
  (write-region "(defvar material-icon-alist\n'(\n" nil cpped-material-icon-data-file 'append)
  (with-current-buffer (url-retrieve-synchronously "https://raw.githubusercontent.com/google/material-design-icons/master/iconfont/codepoints")
    (widen)
    (goto-char 1)
    (save-match-data
      (while (search-forward-regexp (rx bol (0+ space) (group (+ (or (in alphanumeric) "_"))) (+ space) (group (+ (in hex-digit)))) nil t)
        (write-region (format "(\"%s\" . \"\\x%s\")\n" (match-string 1) (match-string 2)) nil cpped-material-icon-data-file 'append)))
    (kill-buffer))
  (write-region "\n))\n(provide 'data-material-icon)" nil cpped-material-icon-data-file 'append))

(use-package all-the-icons
  :config
  (unless (file-exists-p cpped-faicon5-data-file)
    (cpped-update-faicon5-data))
  (require 'data-faicon5 cpped-faicon5-data-file)
  (define-icon faicon5 fa5-icon-alist "Font Awesome 5 Free" "fa-regular-400")
  (define-icon faicon-brands fa5-icon-alist "Font Awesome 5 Brands" "fa-brands-400")
  (unless (file-exists-p cpped-material-icon-data-file)
    (cpped-update-material-icon-data))
  (require 'data-material-icon cpped-material-icon-data-file)
  (define-icon material-icon material-icon-alist "Material Icons" "MaterialIcons-Regular"))
#+END_SRC

** SVG Tag support
#+BEGIN_SRC emacs-lisp
(use-package svg-tag-mode
  :demand t
  :custom (svg-tag-action-at-point 'edit)
  ;:config (global-svg-tag-mode)
  )
#+END_SRC

** Theme
*** Colors
Taken from SharkBytes background image.
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defvar shark-bytes-ok-saturated           "#35E356" "")
(defvar shark-bytes-info-saturated         "#E3D835" "")
(defvar shark-bytes-warning-saturated      "#E38635" "")
(defvar shark-bytes-error-saturated        "#E3353C" "Background color for windows.")
(defvar shark-bytes-burning-saturated      "#E335A6" ".")
(defvar shark-bytes-hot-saturated          "#CA36BB" ".")
(defvar shark-bytes-warm-saturated         "#B137CF" ".")
(defvar shark-bytes-cozy-saturated         "#9939E2" ".")
(defvar shark-bytes-mild-saturated         "#8139F4" ".")
(defvar shark-bytes-bleak-saturated        "#6F3BFD" ".")
(defvar shark-bytes-chilly-saturated       "#563DF9" ".")
(defvar shark-bytes-cold-saturated         "#3D3FF3" ".")
(defvar shark-bytes-icy-saturated          "#2442ED" ".")
(defvar shark-bytes-freezing-saturated     "#0C43E8" ".")
#+END_SRC

The saturation for non-saturated colors is 60.
#+BEGIN_SRC emacs-lisp
(defvar shark-bytes-ok                     "#5BE375" "")
(defvar shark-bytes-info                   "#E3DA5B" "")
(defvar shark-bytes-warning                "#E39A5B" "")
(defvar shark-bytes-error                  "#E35B60" "Background color for windows.")
(defvar shark-bytes-burning                "#E35BB3" ".")
(defvar shark-bytes-hot                    "#CA51BE" ".")
(defvar shark-bytes-warm                   "#B653CF" ".")
(defvar shark-bytes-cozy                   "#A75AE2" ".")
(defvar shark-bytes-mild                   "#9A62F4" ".")
(defvar shark-bytes-bleak                  "#8E65FD" ".")
(defvar shark-bytes-chilly                 "#7764F9" ".")
(defvar shark-bytes-cold                   "#6163F3" ".")
(defvar shark-bytes-icy                    "#5F74ED" ".")
(defvar shark-bytes-freezing               "#5D80E8" ".")
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defvar shark-bytes-window-background      "#121212" "Background color for windows.")
(defvar shark-bytes-block-background       "#212121" "Background for blocks.")
(defvar shark-bytes-menu-window-background "#303030" "Background color for menu windows.")
(defvar shark-bytes-current-line           "#424242" "Background color for the current line.")
(defvar shark-bytes-highlight              "#757575" "Color for normal text.")

(defvar shark-bytes-irrelevant             "#212121" "Color for shadow text.")
(defvar shark-bytes-insignificant          "#303030" "Color for shadow text.")
(defvar shark-bytes-minor                  "#424242" "Color for shadow text.")
(defvar shark-bytes-detail                 "#757575" "Color for shadow text.")

(defvar shark-bytes-shadow                 "#303030" "Color for shadow text.")
(defvar shark-bytes-text                   "#F1F1F1" "Color for normal text.")
#+END_SRC

***  Faces
#+BEGIN_SRC emacs-lisp
(defface shark-bytes-ui '((t :inherit default)) "" :group 'user-interface)
(defface shark-bytes-ui-title '((t :inherit shark-bytes-ui :height 1.7 :weight bold)) "" :group 'user-interface)
(defface shark-bytes-ui-section '((t :inherit shark-bytes-ui :height 1.2 :weight bold)) "" :group 'user-interface)
(defface shark-bytes-ui-subsection '((t :inherit shark-bytes-ui :height 1.1 :weight bold)) "" :group 'user-interface)
(defface shark-bytes-ui-entry '((t :inherit shark-bytes-ui)) "" :group 'user-interface)
(defface shark-bytes-ui-info '((t :inherit shark-bytes-ui :weight light)) "" :group 'user-interface)
#+END_SRC

*** Load default theme
#+BEGIN_SRC emacs-lisp
(defvar shark-bytes-theme 'shark-bytes "The default theme")

(setq custom-safe-themes shark-bytes-theme)

(load-theme shark-bytes-theme t)
#+END_SRC

** [[https://github.com/rakanalh/emacs-dashboard][Dashboard]]
#+BEGIN_SRC emacs-lisp
(defvar cpped-dashboard-footer nil "The dashboard footer text")

(use-package dashboard
  :after consult
  :custom
  (initial-buffer-choice (lambda () (get-buffer-create "*dashboard*")))
  (dashboard-startup-banner (let ((logo (expand-file-name "~/.logo.svg")))
                              (if (file-exists-p logo)
                                  logo
                                nil)))
  (dashboard-banner-logo-title "")
  (dashboard-page-separator "\n\n")
  (dashboard-items '((agenda . 15)
                     (recents . 20)
                     (projects . 10)))
  (dashboard-heading-icons '((recents   . "")
                             (bookmarks . "")
                             (agenda    . "")
                             (projects . "")
                             (registers . "")))
   (dashboard-set-heading-icons t)
   (dashboard-set-init-info nil)
   (dashboard-set-footer nil)
   (dashboard-footer-icon "")
   (dashboard-footer-messages (let ((file (expand-file-name "~/.dashboard-messages")))
                                (if (file-exists-p file)
                                  (with-temp-buffer
                                    (insert-file-contents file)
                                    (split-string (buffer-string) "\n" t))
                                  '(""))))
   :config
   (setq cpped-dashboard-footer (dashboard-random-footer))
   (advice-add 'dashboard-insert-banner :after #'(lambda ()
                                                   (insert "\n")
                                                   (dashboard-center-line cpped-dashboard-footer)
                                                   (insert " ")
                                                   (insert (propertize cpped-dashboard-footer 'face 'dashboard-footer))
                                                   (insert "\n")))
   (defun cpped-dashboard-insert-heading (heading &optional shortcut)
     "Insert a widget HEADING in dashboard buffer, adding SHORTCUT if provided."
     (when (and (display-graphic-p)
                dashboard-set-heading-icons)
       (insert (cond
                ((string-equal heading "Recent Files:")
                 (cdr (assoc 'recents dashboard-heading-icons)))
                ((string-equal heading "Bookmarks:")
                 (cdr (assoc 'bookmarks dashboard-heading-icons)))
                ((or (string-equal heading "Agenda for today:")
                     (string-equal heading "Agenda for the coming week:"))
                 (cdr (assoc 'agenda dashboard-heading-icons)))
                ((string-equal heading "Registers:")
                 (cdr (assoc 'registers dashboard-heading-icons)))
                ((string-equal heading "Projects:")
                 (cdr (assoc 'projects dashboard-heading-icons)))
                (t " ")))
       (insert " "))
     (insert (propertize heading 'face 'dashboard-heading))
     (when shortcut (insert (format " (%s)" shortcut))))
   (advice-add 'dashboard-insert-heading :override 'cpped-dashboard-insert-heading)
   (push (regexp-quote dashboard-buffer-name) consult-buffer-filter)
   (defun shark-bytes/show-dashboard ()
     "Show the dashboard."
     (interactive)
     (switch-to-buffer "*dashboard*"))
   (dashboard-setup-startup-hook))
#+END_SRC

** Mode Line
#+BEGIN_SRC emacs-lisp
(defun cpped-buffer-name ()
  "Returns a (virtual) buffer name, for non-file modes."
  (pcase major-mode
    ('shell-mode default-directory)
    ('term-mode default-directory)
    ('dired-mode default-directory)
    (_ buffer-file-name)))
#+END_SRC

*** Base Location
#+BEGIN_SRC emacs-lisp
(defvar-local cpped-project-dir-checked nil)
(defvar-local cpped-project-dir nil)

(defun cpped-tramp-file-remote-p (file)
  "Checks if a tramp file is actually remote."
  (and (tramp-tramp-file-p file)
       (not (string-equal (tramp-file-name-host (tramp-dissect-file-name file)) "localhost"))))

(with-eval-after-load "projectile"
  (defun cpped-project-dir ()
    (interactive)
    (unless cpped-project-dir-checked
      (setq cpped-project-dir (or (when (and (ignore-errors (projectile-project-p))
					     (fboundp 'projectile-project-root))
				    (projectile-project-root))
				  (when vc-mode
				    (let ((backend (vc-deduce-backend)))
				      (when backend
					(ignore-errors (vc-call-backend backend 'root default-directory)))))))
      (setq cpped-project-dir-checked t))
    cpped-project-dir)

  (defun cpped-modeline-project-id ()
    (let ((buffer-location (cpped-buffer-name)))
      (when buffer-location
	(let* ((project-root (cpped-project-dir))
	       (project-name (projectile-project-name project-root))
	       (remote (if (cpped-tramp-file-remote-p buffer-location)
			   (tramp-file-name-host (tramp-dissect-file-name buffer-location))))
	       (localname (if (tramp-tramp-file-p buffer-location)
			      (tramp-file-local-name buffer-location)
			    buffer-location)))
	  (concat
	   (when remote (format " %s " remote))
	   (if (string-prefix-p (getenv "HOME") localname)
	       (replace-regexp-in-string "/Projects/" "🗐 " (concat "/"
                                                                    (file-name-directory (directory-file-name (file-relative-name (file-name-directory (or project-root
                                                                                                                                                           (file-name-directory localname)))
											  (getenv "HOME"))))))
	     (concat "" (file-name-directory (directory-file-name (file-name-directory (tramp-file-local-name (or project-root
										                                   localname)))))))
	   (when (not (= 0 (length project-name))) (concat " " project-name))))))))
#+END_SRC

*** Major mode icon
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-mode-icon ()
  (let ((icon (all-the-icons-icon-for-buffer)))
    (unless (symbolp icon)
      (propertize icon
                  'face `(:family ,(all-the-icons-icon-family-for-buffer)
                          :background ,(face-attribute 'header-line :background)
                          :height 1.2)
                  'display '(raise 0.0)
                  'help-echo (format "%s" major-mode)))))
#+END_SRC

*** Buffer name
Helper function to figure out version control root directory
#+BEGIN_SRC emacs-lisp
(defvar cpped-special-buffer-names-alist nil "A list of buffer name transformations.")

(with-eval-after-load "projectile"
  (defun cpped-modeline-buffer-id ()
    (let* ((home-dir (getenv "HOME"))
	   (buffer-virtual-name (cpped-buffer-name))
	   (buffer-name (let ((name (if buffer-virtual-name
					(if (tramp-tramp-file-p buffer-virtual-name)
					    (tramp-file-local-name buffer-virtual-name)
					  buffer-virtual-name)
				      (format-mode-line "%b"))))
			  (or (cdr (assoc name cpped-special-buffer-names-alist))
			      name)))
	   (filename (if buffer-virtual-name
			 (file-truename buffer-name)))
	   (project-root (or (cpped-project-dir)
			     (when (and filename
					home-dir
					(string-equal (substring filename 0 (length home-dir)) home-dir))
			       home-dir)))
	   (relative-path (when filename
			    (shark-bytes/truncate (file-name-directory (if project-root
						                           (file-relative-name filename project-root)
						                         filename)) 20)))
	   (special-buffer (string-match "^\\*.*\\*?$" buffer-name)))
      (if special-buffer
	  (propertize (replace-regexp-in-string "^\\*\\([^\*]*\\)\\*?$" "\\1" buffer-name)
		      'face `(:background ,(face-attribute 'header-line :background)
				          :weight normal
				          :slant italic))
	(concat
	 (when relative-path
	   (propertize relative-path
		       'face `(:background ,(face-attribute 'header-line :background)
				           :weight light)))
	 (propertize (file-name-nondirectory buffer-name)
		     'face `(:background ,(face-attribute 'header-line :background)
			                 :weight black)))))))
#+END_SRC

*** Docker project
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-docker-project ()
  (when (cpped-is-docker-project-p)
    ""))
#+END_SRC

*** Git Info
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun cpped-modeline-version-control ()
    (when (and buffer-file-name (magit-inside-worktree-p t))
      (let* ((branch (shark-bytes/truncate (magit-get-current-branch) 10))
             (branch-head (magit-rev-parse "--short" branch))
             (revision (magit-rev-parse "--short" "HEAD")))
        (concat " " branch (unless (string= revision branch-head)
                              (format " · %s (%s)" revision (magit-git-string "rev-list"
                                                                              "--count"
                                                                              (concat revision ".." branch-head)))))))))
#+END_SRC

*** Running process
#+BEGIN_SRC emacs-lisp
(defvar-local cpped-process-running nil "Flag to indicate if a process is running for the current buffer.")
(defvar-local cpped-current-process-start-time nil)

(defun cpped-get-run-time ()
  (time-subtract (current-time)
                 cpped-current-process-start-time))

(defun cpped-format-run-time (time)
  (let* ((run-time (truncate (float-time time)))
         (days (/ run-time 60 60 24))
         (hours (% (/ run-time 60 60) 24))
         (minutes (% (/ run-time 60) 60))
         (seconds (% run-time 60)))
    (concat (when (> days 0)
              (format "%d days " days))
            (when (or (> days 0)
                      (> hours 0))
              (format "%d:" hours))
            (if (or (> days 0)
                    (> hours 0))
                (format "%02d:" minutes)
              (when (> minutes 0)
                (format "%d:" minutes)))
            (if (or (> days 0)
                    (> hours 0)
                    (> minutes 0))
                (format "%02ds" seconds)
              (format "%ds" seconds)))))

(defun cpped-modeline-process-running ()
  (when cpped-process-running
    (concat "  " (cpped-format-run-time (cpped-get-run-time)))))
#+END_SRC

*** Show if file is opened in su-mode
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-su ()
  (when (string-match "^/su\\(do\\)?:" default-directory)
    ""))
#+END_SRC

*** Modification
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-modified ()
  (pcase (format-mode-line "%*")
    (`"*" "")
    (`"-" (if buffer-file-name
              (if vc-mode
                  (if (string-equal (vc-state buffer-file-name) 'edited)
                      ""
                    "")
                "")
            ""))
    (`"%" "")
    (_ "")))
#+END_SRC

*** Auto-format
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-auto-format ()
  (when (bound-and-true-p format-all-mode)
    ""))
#+END_SRC

*** Cursor position
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-position-info ()
  (format "%s %s" (format-mode-line "%4l ") (format-mode-line "%3c")))
#+END_SRC

*** Selected region
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-region-info ()
  (when mark-active
    (format " %s/%s/%s"
            (count-lines (region-beginning) (region-end))
            (count-words (region-end) (region-beginning))
            (- (region-end) (region-beginning)))))
#+END_SRC

*** IEdit Info
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-iedit-info ()
  (when (bound-and-true-p iedit-mode)
    (format " %s/%s"
            iedit-occurrence-index
            (iedit-counter))))
#+END_SRC

*** Show if overwrite mode is active
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-overwrite-mode ()
  (when overwrite-mode
    "סּ"))
#+END_SRC

*** Show if typo mode is active
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "typo"
  (defun cpped-modeline-typo-mode ()
    (when typo-mode
      "")))
#+END_SRC

*** Show if buffer is narrowed
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-narrowed ()
    (when (buffer-narrowed-p)
      ""))
#+END_SRC

*** Show if buffer is filtered
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-filtered ()
    (when loccur-mode
      ""))
#+END_SRC

*** Key Lock
#+BEGIN_SRC emacs-lisp
(defvar cpped-caps-lock-active nil "Indicates if caps lock is enabled.")
(defvar cpped-num-lock-active nil "Indicates if num lock is enabled.")

(add-hook 'after-init-hook '(lambda ()
                              (run-with-timer 60 3 '(lambda ()
                                                      (with-temp-buffer
                                                        (call-process "xset" nil t nil "q")
                                                        (let ((led-mask (string-to-number (save-match-data
                                                                                            (and (string-match ".*LED mask:[[:space:]]*\\([[:alnum:]]+\\).*" (buffer-string))
                                                                                                 (match-string 1 (buffer-string))))
                                                                                          16)))
                                                          (setq cpped-caps-lock-active (eq (logand led-mask 1) 1)
                                                                cpped-num-lock-active (eq (logand led-mask 2) 2))))))))

(defun cpped-modeline-key-lock (lock icon)
   (when lock
     icon))
#+END_SRC

*** Line/Character Mode
#+BEGIN_SRC emacs-lisp
(make-local-variable 'cpped-term-char-mode)

(advice-add 'term-char-mode :after (lambda ()
                                     (setq cpped-term-char-mode t)))

(advice-add 'term-line-mode :after (lambda ()
                                     (setq cpped-term-char-mode nil)))

(defun cpped-modeline-term-input-mode ()
  (when (and (equal major-mode 'term-mode)
             cpped-term-char-mode)
    ""))
#+END_SRC

*** Current function
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-which-function ()
  "Print current function in hte mode line."
  (when-let ((current-function (when (bound-and-true-p which-function-mode)
                                 (which-function))))
    (concat " " (shark-bytes/truncate (substring-no-properties current-function) 30))))
#+END_SRC

*** Check Status
#+BEGIN_SRC emacs-lisp
(defvar cpped-modeline-check-status-functions nil "A list of functions that format mode line status data.")

(defun shark-bytes/check-process-status()
  "Format generic mode line status information."
  (format-mode-line mode-line-process))

(add-to-list 'cpped-modeline-check-status-functions 'shark-bytes/check-process-status)

(defface cpped-check-status-info `((t :inherit info
                                      :weight ultra-bold))
  "Face used for modeline check info status."
  :group 'cpped-modeline-check-status)

(defface cpped-check-status-warning `((t :inherit warning
                                         :weight ultra-bold))
  "Face used for modeline check warning status."
  :group 'cpped-modeline-check-status)

(defface cpped-check-status-error `((t :inherit error
                                       :weight ultra-bold))
  "Face used for modeline check error status."
  :group 'cpped-modeline-check-status)

(defun cpped-modeline-check-status ()
  "Collect check status information."
  (let ((status (mapconcat 'identity
                           (-non-nil (mapcar 'funcall cpped-modeline-check-status-functions))
                           " ")))
    (add-face-text-property 0 (length status) (list ':background (face-attribute 'header-line :background)) nil status)
    status))
#+END_SRC

*** Display on top
#+BEGIN_SRC emacs-lisp
(defface shark-bytes-mode-line-emphasis '((t :inherit mode-line :weight bold)) "")
(defface shark-bytes-mode-line-de-emphasis '((t :inherit mode-line :height 0.7 :weight extra-light)) "")

(defvar cpped-selected-window nil)
(add-function :before pre-redisplay-function (lambda (_wins) (setq cpped-selected-window (selected-window))))

(setq-default mode-line-format nil)
(setq-default header-line-format
              '((:eval
                 (let* ((mode-line-face (if (eq (frame-selected-window) cpped-selected-window)
                                       'mode-line
                                     'mode-line-inactive))
                        (left-side (mapconcat #'identity
                                              (-non-nil (list (cpped-modeline-mode-icon)
                                                              (shark-bytes/truncate (cpped-modeline-project-id) 20)
                                                              (propertize (or (when (fboundp 'cpped-modeline-version-control)
                                                                                (cpped-modeline-version-control))
                                                                              "")
                                                                          'face 'shark-bytes-mode-line-de-emphasis)
                                                              (propertize (or (cpped-modeline-buffer-id)
                                                                              "")
                                                                          'face 'shark-bytes-mode-line-emphasis)
                                                              (propertize (or (cpped-modeline-which-function)
                                                                              "")
                                                                          'face 'shark-bytes-mode-line-de-emphasis
                                                                          'display '(raise 0.0))))
                                              "  "))
                        (right-side (mapconcat #'identity
                                          (-non-nil (list (cpped-modeline-process-running)
                                                          (cpped-modeline-su)
                                                          (cpped-modeline-modified)
                                                          (cpped-modeline-overwrite-mode)
                                                          (cpped-modeline-auto-format)
                                                          (cpped-modeline-typo-mode)
                                                          (cpped-modeline-narrowed)
                                                          (cpped-modeline-filtered)
                                                          (cpped-modeline-key-lock (symbol-value 'cpped-caps-lock-active) "")
                                                          (cpped-modeline-key-lock (symbol-value 'cpped-num-lock-active) "")
                                                          (cpped-modeline-term-input-mode)
                                                          (cpped-modeline-position-info)
                                                          (cpped-modeline-region-info)
                                                          (cpped-modeline-iedit-info)
                                                          (cpped-modeline-check-status)
                                                          ))
                                          "  ")))
                    (concat (propertize "  " 'display `(raise +0.4))
                                       left-side
                                       (propertize " " 'display `(space :align-to (- right ,(* 1.1 (length right-side)))))
                                       (propertize " " 'display `(raise -0.4))
                                       right-side)))))
#+END_SRC

*** Update every second
#+BEGIN_SRC emacs-lisp
(run-with-timer 0 1 '(lambda()
                       (force-mode-line-update t)))
#+END_SRC

** [[https://github.com/bbatsov/projectile][Projectile]]
#+BEGIN_SRC emacs-lisp
(defvar cpped-project-directories (list "~/Projects" "~/projects") "A list of directories to check for projects.")

(use-package projectile
  :custom
  (projectile-create-missing-test-files t)
  (projectile-dynamic-mode-line nil)
  (projectile-enable-caching nil)
  (projectile-find-dir-includes-top-level t)
  (projectile-git-submodule-command nil)
  (projectile-idle-timer-hook nil)
  (projectile-project-search-path (cl-remove-if (lambda (directory)
                                                  (not (file-directory-p directory)))
                                                (mapcar #'expand-file-name cpped-project-directories)))
  (projectile-ignored-project-function (lambda (project)
                                         (not (or (string-match (concat (file-truename user-emacs-directory) ".*") project)
                                                  (string-match (concat user-emacs-directory ".*") project)))))
  (projectile-sort-order 'recently-active)
  (projectile-verbose nil)
  :config
  (projectile-global-mode))
#+END_SRC

** [[https://github.com/minad/vertico][Minibuffer completion]]
#+BEGIN_SRC emacs-lisp
(use-package vertico
  :init (vertico-mode)
  :hook ((rfn-eshadow-update-overlay . vertico-directory-tidy))
  :bind (:map vertico-map
              ("<pos1>" . vertico-first)
              ("<end>" . vertico-last)
              ("<left>" . vertico-previous-group)
              ("<right>" . vertico-next-group))
  :custom
  (vertico-resize nil)
  (vertico-count 20)
  (vertico-cycle t)
  (read-buffer-completion-ignore-case t)
  (completion-ignore-case t))

(use-package vertico-directory
  :after vertico
  :straight nil
  :load-path "straight/repos/vertico/extensions/"
  :bind (:map vertico-map
              ("RET" . vertico-directory-enter)
              ("DEL" . vertico-directory-delete-char)
              ("M-DEL" . vertico-directory-delete-word)))

(use-package vertico-repeat
  :after vertico
  :straight nil
  :load-path "straight/repos/vertico/extensions/"
  :hook (minibuffer-setup . vertico-repeat-save))
#+END_SRC

*** [[https://github.com/oantolin/orderless][Advanced filtering]]
#+BEGIN_SRC emacs-lisp
(use-package orderless
  :custom
  (completion-styles '(orderless partial-completion))
  (completion-category-defaults nil)
  (completion-category-overrides nil)
  (orderless-component-separator "[ &+]"))
#+END_SRC
  :config

*** [[https://github.com/minad/marginalia][Show more information]]
#+BEGIN_SRC emacs-lisp
(use-package marginalia
  :config
  (add-to-list 'marginalia-command-categories '(flycheck-error-list-set-filter . builtin))
  (add-to-list 'marginalia-command-categories '(projectile-find-file . project-file))
  (add-to-list 'marginalia-command-categories '(projectile-recentf . project-file))
  (add-to-list 'marginalia-command-categories '(projectile-switch-to-buffer . buffer))
  (add-to-list 'marginalia-command-categories '(projectile-switch-project . project-file))
  :custom (truncate-string-ellipsis "…")
  :init (marginalia-mode))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package all-the-icons-completion
  :after (all-the-icons marginalia)
  :hook (marginalia-mode . all-the-icons-completion-marginalia-setup)
  :init (all-the-icons-completion-mode))
#+END_SRC

*** [[https://github.com/minad/consult][Additional completion functions]]
#+BEGIN_SRC emacs-lisp
(use-package consult
  :demand t
  :hook (completion-list-mode . consult-preview-at-point-mode)
  :bind (
;([remap find-file] . consult-find)
         ([remap apropos] . consult-apropos)
         ([remap bookmark-jump] . consult-bookmark)
         ([remap goto-line] . consult-goto-line)
         ([remap imenu] . consult-imenu)
         ([remap locate] . consult-locate)
         ([remap load-theme] . consult-theme)
         ([remap man] . consult-man)
         ([remap recentf-open-files] . consult-recent-file)
         ([remap switch-to-buffer] . consult-buffer)
         ("C-x C-b" . shark-bytes/switch-to-buffer-show-all)
         ([remap switch-to-buffer-other-window] . consult-buffer-other-window)
         ([remap switch-to-buffer-other-frame] . consult-buffer-other-frame)
         ([remap yank-pop] . consult-yank-pop))
  :custom
  (consult-ripgrep-args "rg --null --line-buffered --color=never --max-columns=1000 --path-separator /   --smart-case --no-heading --line-number .")
  (consult-line-point-placement 'match-beginning)
  (consult-line-start-from-top t)
  (consult-preview-key (list :debounce 0.75 'any))
  (consult-async-min-input 2)
  (consult-async-refresh-delay 0.15)
  (consult-async-input-throttle 0.2)
  (consult-async-input-debounce 0.1)
  (consult-async-split-style 'comma)
  (xref-show-xrefs-function #'consult-xref)
  (consult-narrow-key "<")
  (consult-line-numbers-widen t)
  (xref-show-definitions-function #'consult-xref)
  :config
  (setenv "RIPGREP_CONFIG_PATH" (expand-file-name "~/.ripgreprc"))
  (defun shark-bytes/switch-to-buffer-show-all ()
    "Select a buffer without filter."
    (interactive)
    (let ((consult-buffer-filter))
      (consult-buffer)))
  (defun cpped-consult-line-symbol-at-point ()
    ""
    (interactive)
    (consult-line (thing-at-point 'symbol)))
  (defun cpped-consult-ripgrep (original-function &optional dir initial-argument)
     ""
     (interactive)
     (let ((initial (list (or initial-argument
                              (if (use-region-p)
			          (buffer-substring (region-beginning) (region-end))
                                (thing-at-point 'symbol))))))
	 (apply original-function (or dir
                                      (cpped-project-dir)
                                      default-directory) initial)))
  (advice-add 'consult-ripgrep :around #'cpped-consult-ripgrep)
  (advice-add #'completing-read-multiple :override #'consult-completing-read-multiple)
  (push "\\*emacs\\*" consult-buffer-filter)
  (push "\\*Backtrace\\*" consult-buffer-filter)
  (push "\\*Buffer List\\*" consult-buffer-filter)
  (push "\\*Async-native-compile-log\\*" consult-buffer-filter)
  (push "\\*straight-process\\*" consult-buffer-filter)
  (push "\\*straight-byte-compilation\\*" consult-buffer-filter)
  (push "\\*Messages\\*" consult-buffer-filter)
  (push "\\*Warnings\\*" consult-buffer-filter)
  (push "\\*Completions\\*" consult-buffer-filter)
  (push "\\*Help\\*" consult-buffer-filter)
  (push "\\*compilation\\*" consult-buffer-filter)
  (push "\\*compile.*\\*" consult-buffer-filter)
  (push "\\*Compilation Log\\*" consult-buffer-filter))
#+END_SRC


#+BEGIN_SRC emacs-lisp
#+END_SRC

** Imenu
*** Automatically rescan
#+BEGIN_SRC emacs-lisp
(set-default 'imenu-auto-rescan t)
#+END_SRC

*** Show results from all buffers
#+BEGIN_SRC emacs-lisp
(use-package imenu-anywhere
  :custom (imenu-anywhere-friendly-modes '((c-mode c++-mode cmake-mode qml-mode gtest-mode)
                                           (clojure-mode clojurex-mode clojurec-mode clojurescript-mode cider-repl-mode cider-clojure-interaction-mode)
                                           (emacs-lisp-mode inferior-emacs-lisp-mode lisp-interaction-mode)
                                           (ess-mode inferior-ess-mode)
                                           (python-mode inferior-python-mode))))
#+END_SRC

** Buffers
*** Optimize scrolling
#+BEGIN_SRC emacs-lisp
(setq fast-but-imprecise-scrolling t
      redisplay-skip-fontification-on-input t)

(pixel-scroll-mode 1)
#+END_SRC

*** Do not adjust auto-window-vscroll
This optimizes line-scrolling.
#+BEGIN_SRC emacs-lisp
(setq auto-window-vscroll nil)
#+END_SRC

*** Disable bidirectional support
#+BEGIN_SRC emacs-lisp
(setq-default bidi-display-reordering 'left-to-right
              bidi-paragraph-direction 'left-to-right)
(setq bidi-inhibit-bpa t)
#+END_SRC

*** Remember open buffers
#+BEGIN_SRC emacs-lisp
(defun cpped-yes (_)
  t)

(defun cpped-always-yes (wrapped-function &rest arguments)
  (advice-add 'yes-or-no-p :override #'cpped-yes)
  (advice-add 'y-or-n-p :override #'cpped-yes)
  (let ((result (apply wrapped-function arguments)))
    (advice-remove 'yes-or-no-p #'cpped-yes)
    (advice-remove 'y-or-n-p #'cpped-yes)
    result))

(use-package desktop
  :custom
  (desktop-dirname user-emacs-directory)
  (desktop-lazy-idle-delay 10)
  (desktop-lazy-verbose nil)
  (desktop-load-locked-desktop t)
  (desktop-path (list user-emacs-directory))
  (desktop-restore-eager 5)
  (desktop-restore-eager 5)
  (desktop-restore-forces-onscreen nil)
  (desktop-restore-frames t)
  :config
  (desktop-save-mode 1)
  (run-with-idle-timer 300 t '(lambda ()
                                (desktop-save user-emacs-directory)))
  (advice-add 'desktop-save :around #'cpped-always-yes)
  (advice-add 'desktop-read :around #'cpped-always-yes))
#+END_SRC

*** Go to last position when opening buffer
#+BEGIN_SRC emacs-lisp
(save-place-mode 1)
#+END_SRC

Switch to previous buffer
#+BEGIN_SRC emacs-lisp
(defun cpped-previous-buffer ()
  (interactive)
  (switch-to-buffer (other-buffer (current-buffer) 1)))
#+END_SRC

*** Scratch Buffer
**** Start with empty scratch buffer (no message)
#+BEGIN_SRC emacs-lisp
(setq initial-scratch-message nil)
#+END_SRC

**** [[https://github.com/Fanael/persistent-scratch][Save scratch buffers between sessions]]
#+BEGIN_SRC emacs-lisp
(use-package persistent-scratch
  :config (persistent-scratch-setup-default))
#+END_SRC

*** Popup Windows
#+BEGIN_SRC emacs-lisp
(use-package popwin
  :config
  (push '("*Messages*" :dedicated t :position bottom :height 40 :tail) popwin:special-display-config)
  (push '(compilation-mode :dedicated t :position bottom :height 30) popwin:special-display-config)
  (push '(help-mode :dedicated t :position bottom :height 40) popwin:special-display-config)
  (popwin-mode 1))
#+END_SRC

*** Add path if required to make buffer name unique
#+BEGIN_SRC emacs-lisp
(setq uniquify-buffer-name-style 'forward
      uniquify-separator "/"
      uniquify-after-kill-buffer-p t
      uniquify-ignore-buffers-re "^\\*")
#+END_SRC

*** [[https://github.com/dimitri/switch-window][Use smarter window switching (numbered windows)]]
#+BEGIN_SRC emacs-lisp
(use-package switch-window
  :custom (switch-window-background t)
  :config (global-set-key [remap other-window] #'switch-window))
#+END_SRC

*** Do not show buffer boundaries in fringe
#+BEGIN_SRC emacs-lisp
(setq-default indicate-buffer-boundaries nil)
#+END_SRC

*** [[https://github.com/mina86/auto-dim-other-buffers.el][Dim inactive buffers]]
#+BEGIN_SRC emacs-lisp
(use-package auto-dim-other-buffers
  :hook (after-init . auto-dim-other-buffers-mode))
#+END_SRC

*** Use recursive minibuffer
#+BEGIN_SRC emacs-lisp
(setq enable-recursive-minibuffers t)
#+END_SRC

Indicate recursive minibuffer
#+BEGIN_SRC emacs-lisp
(minibuffer-depth-indicate-mode 1)
#+END_SRC

*** Highlight minibuffer when in use
#+BEGIN_SRC emacs-lisp
(defface shark-bytes-minibuffer-active '((t :inherit default))
  "Face used for active minibuffer."
  :group 'basic-faces)

(add-hook 'minibuffer-setup-hook (lambda ()
                                   (make-local-variable 'face-remapping-alist)
                                   (add-to-list 'face-remapping-alist '(default shark-bytes-minibuffer-active))))
#+END_SRC

*** Kill current buffer by default
#+BEGIN_SRC emacs-lisp
(defvar cpped-bury-buffers-list '("*scratch*" "*Messages*") "A list of buffer names to bury instead of kill.")

(defun cpped-kill-default-buffer ()
  "Kill the currently active buffer."
  (interactive)
  (let ((kill-buffer-query-functions)
        (name (substring-no-properties (buffer-name))))
    (if (member name cpped-bury-buffers-list)
        (bury-buffer)
      (when (and buffer-file-name
               (buffer-modified-p))
        (save-buffer))
      (kill-buffer))))
#+END_SRC

*** Do not ask before killing buffer with running processes
#+BEGIN_SRC emacs-lisp
(setq kill-buffer-query-functions
      (remq 'process-kill-buffer-query-function
            kill-buffer-query-functions))
#+END_SRC

*** Multi-buffer kill
#+BEGIN_SRC emacs-lisp
(defvar clean-buffer-list-delay-general 1)
#+END_SRC

*** Kill unused buffers automatically
#+BEGIN_SRC emacs-lisp
(defun cpped-clean-buffer-list-delay-1hour (name)
  "Wrapper around clean-buffer-list-delay to allow delays in hours instead of days"
  (or (assoc-default name clean-buffer-list-kill-buffer-names #'string=
                     clean-buffer-list-delay-special)
      (assoc-default name clean-buffer-list-kill-regexps
                     (lambda (regex input)
                       (if (functionp regex)
                           (funcall regex input) (string-match regex input)))
                     clean-buffer-list-delay-special)
      (* 60 60)))

(fset 'clean-buffer-list-delay 'cpped-clean-buffer-list-delay-1hour)
(run-with-timer 0 (* 60 60) 'clean-buffer-list)
#+END_SRC

*** Allow erasing
#+BEGIN_SRC emacs-lisp
(put 'erase-buffer 'disabled nil)
#+END_SRC

*** Lines
**** Highlight current line
#+BEGIN_SRC emacs-lisp
(use-package hl-line
  :hook ((after-init . global-hl-line-mode)
         (find-file . hl-line-mode))
  :config (advice-add 'hl-line-make-overlay :after (lambda ()
                                                     (unless (window-minibuffer-p)
                                                       (when hl-line-overlay
                                                         (overlay-put hl-line-overlay 'priority 1000))))))
#+END_SRC

**** Break long lines
#+BEGIN_SRC emacs-lisp
(setq visual-line-fringe-indicators '(nil nil))
(global-visual-line-mode 1)
#+END_SRC

**** [[https://github.com/purcell/page-break-lines][Show page breaks as line instead of '^L']]
#+BEGIN_SRC emacs-lisp
(use-package page-break-lines
  :config
  (global-page-break-lines-mode))
#+END_SRC

**** Show line numbers
#+BEGIN_SRC emacs-lisp
(setq display-line-numbers nil
      display-line-numbers-grow-only t
      display-line-numbers-widen nil
      display-line-numbers-width-start t)

(add-hook 'find-file-hook (lambda ()
                            (unless (equal major-mode 'org-mode)
                              (display-line-numbers-mode))))
#+END_SRC

*** Utilities
**** Copy buffer file name to clipboard
#+BEGIN_SRC emacs-lisp
(defun cpped-copy-file-name-to-clipboard ()
  "Copy the current buffer file name to the clipboard."
  (interactive)
  (kill-new (cpped-buffer-name)))
#+END_SRC

** Screen
*** Lock screen
#+BEGIN_SRC emacs-lisp
(require 'dbus)

(defun cpped-lock-screen ()
  "Lock the screen."
  (interactive)
  (dbus-call-method :session "org.freedesktop.ScreenSaver" "/org/freedesktop/ScreenSaver" "org.freedesktop.ScreenSaver" "Lock"))
#+END_SRC

** Cursor
*** Stretch block cursor to cover glyph
#+BEGIN_SRC emacs-lisp
(setq-default x-stretch-cursor t)
#+END_SRC

*** Center Cursor
#+BEGIN_SRC emacs-lisp
(use-package centered-cursor-mode
  :config (global-centered-cursor-mode +1))
#+END_SRC

*** Show cursor as bar in insert mode and block in overwrite mode
#+BEGIN_SRC emacs-lisp
(use-package bar-cursor
  :config (bar-cursor-mode 1))
#+END_SRC

*** Hide cursor in non-selected windows
#+BEGIN_SRC emacs-lisp
(setq-default cursor-in-non-selected-windows nil)
#+END_SRC

** [[https://www.emacswiki.org/emacs/UndoTree][Undo]]
#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :after popwin
    :custom
    (undo-tree-visualizer-timestamps t)
    (undo-tree-visualizer-diff t)
    (undo-tree-enable-undo-in-region t)
    (undo-tree-auto-save-history t)
    (undo-tree-history-directory-alist `(("." . ,(expand-file-name "~/.cache/emacs-undo"))))
    :config
    (global-undo-tree-mode)
    (push '(" *undo-tree*" :dedicated t :width 60 :position right) popwin:special-display-config))
#+END_SRC

*** Keep selection when undoing
#+BEGIN_SRC emacs-lisp
(defadvice undo-tree-undo (around keep-region activate)
  (if (use-region-p)
      (let ((mark-position (set-marker (make-marker) (mark)))
            (point-position (set-marker (make-marker) (point))))
        ad-do-it
        (goto-char point-position)
        (set-mark mark-position)
        (set-marker point-position nil)
        (set-marker mark-position nil))
    ad-do-it))
#+END_SRC

** Shell
#+BEGIN_SRC emacs-lisp
(setq comint-terminfo-terminal "xterm-256color"
      comint-buffer-maximum-size 10000
      comint-scroll-show-maximum-output t
      comint-input-ring-size 500
      comint-input-ignoredups t
      comint-completion-addsuffix t
      comint-output-filter-functions '(ansi-color-process-output
                                       comint-strip-ctrl-m
                                       comint-postoutput-scroll-to-bottom
                                       comint-watch-for-password-prompt
                                       comint-truncate-buffer)
      term-buffer-maximum-size 100000)
(add-hook 'term-exec-hook #'term-char-mode)

(use-package eshell
  :custom
  (eshell-banner-message "")
  (eshell-scroll-to-bottom-on-input 'this)
  (eshell-scroll-to-bottom-on-output 'this)
  (eshell-kill-processes-on-exit t)
  (eshell-error-if-no-glob t)
  (eshell-hist-ignoredups t)
  (eshell-history-size 20000)
  (eshell-save-history-on-exit t)
  (eshell-input-filter 'eshell-input-filter-initial-space)
  (eshell-prefer-lisp-functions nil)
  (eshell-list-files-after-cd t)
  (eshell-destroy-buffer-when-process-dies t)
  (eshell-cmpl-cycle-completions t)
  (eshell-buffer-maximum-lines 2000)
  (eshell-cd-shows-directory t)
  (eshell-cmpl-autolist t)
  (eshell-cmpl-dir-ignore "\\`\\(\\.\\.?\\|CVS\\|.git\\|.svn\\|.bzr\\)/\\'")
  (eshell-cmpl-expand-before-complete t)
  (eshell-cmpl-ignore-case t)
  (eshell-show-lisp-completions t)
  (eshell-command-completions-alist '(("e" . "\\.pdf\\'")
                                      ("ar" . "\\.[ao]\\'")
                                      ("e" . "\\.[Cc]\\([Cc]\\|[PpXx][PpXx]\\)?\\'")
                                      ("e" . "\\.[Hh]\\([Hh]\\|[PpXx][PpXx]\\)?\\'")
                                      ("readelf" . "\\(\\`[^.]*\\|\\.\\([ao]\\|so\\)\\)\\'")
                                      ("objdump" . "\\(\\`[^.]*\\|\\.\\([ao]\\|so\\)\\)\\'")
                                      ("nm" . "\\(\\`[^.]*\\|\\.\\([ao]\\|so\\)\\)\\'")
                                      ("gdb" . "\\`\\([^.]*\\|a\\.out\\)\\'")
                                      ("e" . "\.txt\'")
                                      ("e" . "\.md\'")
                                      ("e" . "\.bat\'")
                                      ("e" . "\.bin\'")
                                      ("e" . "\.cfg\'")
                                      ("e" . "\.config\'")
                                      ("e" . "\.ini\'")
                                      ("e" . "\.el\'")
                                      ("e" . "\.org\'")
                                      ("e" . "\.log\'")
                                      ("gv" . "\.ps\'")
                                      ("xdvi" . "\.dvi\'")
                                      ("e" . "\.png\'")
                                      ("e" . "\.jpe?g\'")
                                      ("e" . "\.svg\'")
                                      ("e" . "\.xml\'")
                                      ("e" . "\.xslt?\'")
                                      ("unzip -l" . "\.zip\'")
                                      ("unrar l" . "\.rar\'")
                                      ("tar tf" . "\.tar\'")
                                      ("tar ztf" . "\.tar.gz\'")
                                      ("tar jtf" . "\.tar.bz2\'")
                                      ("unace l" . "\.ace\'")))
  (eshell-glob-include-dot-files t)
  (eshell-ls-initial-args '("-A"
                            "-F"
                            "-h"
                            "-l"
                            "-1"
                            "-v"
                            "--color"
                            "--group-directories-first"))
  (eshell-modules-list '(eshell-alias
                         eshell-banner
                         eshell-basic
                         eshell-cmpl
                         eshell-dirs
                         eshell-glob
                         eshell-hist
                         eshell-ls
                         eshell-pred
                         eshell-prompt
                         eshell-script
                         eshell-smart
                         eshell-term
                         eshell-tramp
                         eshell-unix))
  (eshell-output-filter-functions '(eshell-truncate-buffer
                                    eshell-postoutput-scroll-to-bottom
                                    eshell-handle-control-codes
                                    eshell-handle-ansi-color
                                    eshell-watch-for-password-prompt))
  :config
  (require 'em-smart)
  (setq eshell-where-to-jump 'begin
        eshell-review-quick-commands nil
        eshell-smart-space-goes-to-end t)
  (add-hook 'eshell-mode-hook 'eshell-smart-initialize)
  (defun cpped-eshell-last-command ()
    "Return the last command."
    (interactive)
    (when (derived-mode-p 'eshell-mode)
      (format "%s %s" eshell-last-command-name (mapconcat 'identity eshell-last-arguments " "))))
  (with-eval-after-load "which-func"
    (add-to-list 'which-func-functions 'cpped-eshell-last-command)))
#+END_SRC

*** Environment
#+BEGIN_SRC emacs-lisp
(setenv "PAGER" "ccat")
(setenv "BROWSER" "eww")
#+END_SRC

https://github.com/purcell/exec-path-from-shell
#+BEGIN_SRC emacs-lisp
(use-package exec-path-from-shell
  :custom (exec-path-from-shell-variables '("PATH" "MANPATH" "LANG" "LC_CTYPE" "LC_NUMERIC" "LC_TIME" "LC_MONETARY" "LC_PAPER" "LC_NAME" "LC_ADDRESS" "LC_TELEPHONE" "LC_MEASUREMENT" "NINJA_STATUS"))
  :config (exec-path-from-shell-initialize))
#+END_SRC

*** Aliases
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "em-alias"
  (eshell/alias ".." "cd ..")
  (eshell/alias "..." "cd ../..")
  (eshell/alias "...." "cd ../../..")
  (eshell/alias "....." "cd ../../../..")

  (eshell/alias "d" "dired $1")
  (eshell/alias "cd.." "cd ..")
  (eshell/alias "cp" "cp -i $*")
  (eshell/alias "du" "du -h $*")
  (eshell/alias "gti" "git $*")

  (eshell/alias "dnf" "sudo dnf $*")
  (eshell/alias "log" "sudo lnav")
  (eshell/alias "sysinfo" "glances -1 --tree --fs-free-space --process-short-name -C ~/.config/glances")
  (eshell/alias "lstree" "l -R $*")
  (eshell/alias "make" "make -j $*")
  (eshell/alias "mkdir" "mkdir -p $*")
  (eshell/alias "mv" "mv -i $*")
  (eshell/alias "p" "ps aux $*")
  (eshell/alias "x" "extract $*")
  (eshell/alias "ag" "ag --smart-case $*")

  (when (executable-find "ninja-build")
    (eshell/alias "ninja" "ninja-build $*"))

  (eshell/alias "dos2unix" "recode ibmpc..lat1 $*")
  (eshell/alias "unix2dos" "recode lat1..ibmpc $*")
  (eshell/alias "unix2mac" "recode lat1..mac $*")
  (eshell/alias "mac2unix" "recode mac..lat1 $*")
  (eshell/alias "dos2mac" "recode ibmpc..mac $*")
  (eshell/alias "mac2dos" "recode mac..ibmpc $*"))

(defun eshell/l (&rest args)
  (eshell/ls args))

(defun eshell/e (file)
  (find-file file))

(defun eshell/mcd (directory)
  "Create a directory and enter it."
  (eshell/mkdir directory)
  (eshell/cd directory))

(defun eshell/top ()
  "Use proced instead of top."
  (proced))

(defun eshell/cat (arguments)
  "Like `cat' but output with Emacs syntax highlighting."
  (let ((files (eshell-flatten-list arguments)))
    (while files
      (let* ((file (expand-file-name (car files)))
             (type (file-name-extension file)))
        (eshell-printn
         (if (or (string= type "jpg")
                 (string= type "jpeg")
                 (string= type "png")
                 (string= type "gif")
                 (string= type "tiff")
                 (string= type "svg"))
             (propertize " " 'display (create-image file))
           (with-temp-buffer
             (insert-file-contents file)
             (let ((buffer-file-name file))
               (delay-mode-hooks
                 (set-auto-mode)
                 (if (fboundp 'font-lock-ensure)
                     (font-lock-ensure)
                   (with-no-warnings
                     (font-lock-fontify-buffer)))))
               (buffer-string))))
         (setq files (cdr files))))))

(with-eval-after-load "dired"
  (defun eshell/pack (argument)
    "Compress files."
    (dired-compress-file argument))
  (defun eshell/unpack (argument)
    "Uncompress file."
    (dired-compress-file argument)))
#+END_SRC

**** Git support
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun eshell/gitroot ()
    "chnage directory to current project root."
    (eshell/cd (vc-git-root default-directory)))

  (defun eshell/git-log (&rest arguments)
    "Use magit instead of git log."
    (magit-mode-setup #'magit-log-mode arguments)
    (magit-log-goto-same-commit)
    (eshell/echo))

  (defun eshell/git (command &rest arguments)
    "use magit for git status and log commands."
    (pcase command
      ("log" (apply #'eshell/git-log arguments))
      ("status" (progn
                  (magit-status)
                  (eshell/echo)))
      (_ (shell-command-to-string (s-join " " (append (list "git"
                                                            command)
                                                      arguments)))))))
#+END_SRC

*** Smart-open new eshell buffers
#+BEGIN_SRC emacs-lisp
(defun cpped-eshell-maybe-new-session (&optional argument)
  "Create a new interactive Eshell buffer if the current buffer is an Eshell buffer."
  (interactive "P")
  (if (eq major-mode 'eshell-mode)
      (eshell (or argument
                  t))
    (eshell argument)))
#+END_SRC

*** Prompt
#+BEGIN_SRC emacs-lisp
(defun cpped-eshell-prompt-concat (&rest contents)
  (let ((items (-flatten (-non-nil contents))))
    (when items
      (s-join " " items))))

(defun cpped-eshell-prompt-section (section-face next-section-face &rest contents)
  (when contents
    (concat (propertize (cpped-eshell-prompt-concat " "
                                                    contents
                                                    " ")
                        'face section-face)
            (propertize ""
                        'face `(:foreground ,(face-attribute section-face :background)
                                            :background ,(face-attribute next-section-face :background))))))

(defun cpped-eshell-prompt-result ()
  (unless (= 0 0)
    (propertize (cpped-eshell-prompt-concat ""
                                            eshell-last-command-status)
                'face '(:foreground ,(face-attribute 'warning :foreground)
                                    :weight 'bold))))

(defun cpped-eshell-prompt-user ()
  (if (string= "root"
               (getenv "USER"))
      (concat "")
    (unless (string= (getenv "LOGNAME")
                     (getenv "USER"))
        (cpped-eshell-prompt-concat "𓄅"
                                    (user-login-name)))))

(defun cpped-eshell-prompt-host ()
  (when (let ((host (getenv "SSH_CONNECTION")))
          (and host
               (not (string= "" host))))
    (cpped-eshell-prompt-concat "" (system-name))))

(defun cpped-eshell-prompt-docker ()
  (let* ((id (shell-command-to-string "cat /proc/self/cgroup | grep docker | head -n 1 | cut -d '/' -f3"))
         (container (when (and id
                               (not (string= "" id)))
                      (shell-command-to-string (concat "docker inspect -f '{{.Config.Image}}' "
                                                       id)))))
    (when container
      (cpped-eshell-prompt-concat "" container))))

(defun cpped-eshell-prompt-path ()
  (cpped-eshell-prompt-concat "ﱮ"
                              (propertize (eshell/pwd)
                                          'face `(:weight 'ultra-bold))))

(setq eshell-prompt-function (lambda ()
                               (concat (cpped-eshell-prompt-section 'modeline-active1
                                                                    'modeline-active2
                                                                    (cpped-eshell-prompt-result)
                                                                    (cpped-eshell-prompt-user)
                                                                    (cpped-eshell-prompt-host)
                                                                    (cpped-eshell-prompt-docker)
                                                                    (cpped-modeline-version-control))
                                       (cpped-eshell-prompt-section 'modeline-active2
                                                                    'mode-line
                                                                    (cpped-eshell-prompt-path))
                                       "\n▶ "))
      eshell-highlight-prompt nil
      eshell-prompt-regexp (rx bol "▶ "))
#+END_SRC

*** [[https://github.com/akreisher/eshell-syntax-highlighting/][Syntax Highlighting]]
#+BEGIN_SRC emacs-lisp
(use-package eshell-syntax-highlighting
  :after eshell
  :config (eshell-syntax-highlighting-global-mode +1))
#+END_SRC

*** Clear buffer
#+BEGIN_SRC emacs-lisp
(defun cpped-clear-comint-buffer ()
  "Remove content of comint buffer."
  (interactive)
  (delete-region (point-min) (point-max))
  (comint-send-input))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun eshell/clear ()
  "Clear the eshell buffer."
  (let ((inhibit-read-only t))
    (erase-buffer)
    (eshell-send-input)))
#+END_SRC

*** Close buffer after process exits
#+BEGIN_SRC emacs-lisp
(advice-add 'term-sentinel :after (lambda (proc msg)
                                    (when (memq (process-status proc) '(signal exit))
                                      (kill-buffer (process-buffer proc)))))
#+END_SRC

*** Visual commands
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "em-term"
  (add-to-list 'eshell-visual-commands "top")
  (add-to-list 'eshell-visual-commands "glances")
  (add-to-list 'eshell-visual-commands "lnav")
  (add-to-list 'eshell-visual-commands "ccmake")

  (add-to-list 'eshell-visual-options '("git" "--help")))
#+END_SRC

*** Navigation
**** [[https://github.com/Fuco1/eshell-bookmark][Bookmarks]]
#+BEGIN_SRC emacs-lisp
(use-package eshell-bookmark
  :hook (eshell-mode . eshell-bookmark-setup))
#+END_SRC

**** [[https://github.com/peterwvj/eshell-up][Go to parent directories]]
#+BEGIN_SRC emacs-lisp
(use-package eshell-up
  :custom (eshell-up-ignore-case nil)
  :config
  (defun eshell/up (directory)
    "Alias for eshell-up."
    (eshell-up directory)))
#+END_SRC

**** [[https://github.com/coldnew/eshell-autojump][Jump to directories]]
#+BEGIN_SRC emacs-lisp
(use-package eshell-autojump)
#+END_SRC

**** Jump over directories without files and one subdirectory
#+BEGIN_SRC emacs-lisp
(add-hook 'eshell-directory-change-hook #'(lambda ()
                                            (let* ((content (directory-files default-directory))
                                                   (directories (seq-remove '(lambda (directory)
                                                                               (string-match "\\.\\.?" directory))
                                                                            (seq-filter 'file-directory-p content)))
                                                   (files (seq-filter 'file-regular-p content)))
                                              (when (and (not files)
                                                         directories
                                                         (= 1 (length directories))
                                                         (not (string-match "^cd +[\./]+$" (eshell-get-history 0))))
                                                (let ((eshell-list-files-after-cd nil))
                                                  (eshell/cd (car directories)))))))
#+END_SRC

**** Re-enter directory if necessary
#+BEGIN_SRC emacs-lisp
(defun cpped-eshell-reenter ()
  "Re-enter current directory if necessary."
  (unless (> (file-nlinks default-directory) 0)
    (eshell/cd (if (file-directory-p default-directory)
                   default-directory
                 (expand-file-name "~")))))

(add-hook 'eshell-mode-hook #'(lambda ()
                                (add-hook 'eshell-pre-command-hook #'cpped-eshell-reenter nil t)))
#+END_SRC


*** Add sudo to command line
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "eshell"
  (defun cpped-add-sudo ()
    "Add sudo to the curent command."
    (interactive)
    (save-excursion
      (eshell-bol)
      (let ((commands (buffer-substring-no-properties (point) (point-max))))
        (if (string-match-p "^sudo " commands)
            (while (re-search-forward "sudo " nil t)
              (replace-match "" t nil))
          (insert "sudo ")))))

  (add-hook 'eshell-mode-hook (lambda ()
                                (define-key eshell-mode-map (kbd "C-M-s") 'cpped-add-sudo))))
#+END_SRC

*** History
#+BEGIN_SRC emacs-lisp
(add-hook 'eshell-mode-hook (lambda ()
                              (define-key eshell-mode-map (kbd "M-r") 'eshell-list-history)))
#+END_SRC

*** [[https://github.com/magit/with-editor][Use emacs as editor]]
#+BEGIN_SRC emacs-lisp
(use-package with-editor
  :hook ((shell-mode term-exec eshell-mode) . with-editor-export-editor)
  :config
  (define-key (current-global-map) [remap async-shell-command] 'with-editor-async-shell-command)
  (define-key (current-global-map) [remap shell-command] 'with-editor-shell-command))
#+END_SRC

*** [[https://github.com/riscy/bifocal-mode][Split buffer on scroll to show both scrolled position and tail]]
#+BEGIN_SRC emacs-lisp
(use-package bifocal
  :config (bifocal-global-mode 1))
#+END_SRC

*** Show running command status in mode line
#+BEGIN_SRC emacs-lisp
(advice-add 'eshell-command-started :before (lambda ()
                                              (setq cpped-process-running t)
                                              (force-mode-line-update t)))

(advice-add 'eshell-command-finished :before (lambda ()
                                               (setq cpped-process-running nil)
                                               (force-mode-line-update t)))
#+END_SRC

*** Show last command status in mode line
#+BEGIN_SRC emacs-lisp
(defun cpped-modeline-eshell-status ()
  "Format the mode line eshell status information."
  (when (and (equal major-mode 'eshell-mode)
             (> eshell-last-command-status 0))
    (concat "" (propertize (format " %d" eshell-last-command-status)
                            'face `(:foreground, (face-attribute 'error :foreground)
                                                 :weight 'bold)))))

(add-to-list 'cpped-modeline-check-status-functions 'cpped-modeline-eshell-status)
#+END_SRC

*** Notify when long-running command finishes
#+BEGIN_SRC emacs-lisp
(defcustom cpped-eshell-minimum-interesting-run-time 30 "The minimum time a command has to take to be interesting.")

(defun cpped-eshell-current-command-start ()
  "Save timestamp on command start."
  (setq cpped-eshell-current-process-start-time (current-time)))

(defun cpped-eshell-current-command-stop ()
  "Show notification when command stops."
  (when cpped-eshell-current-process-start-time
    (let ((run-time (truncate (float-time (cpped-get-run-time)))))
      (unless (< run-time cpped-eshell-minimum-interesting-run-time)
        (let ((time-string (cpped-format-run-time (cpped-get-run-time)))
              (command (s-join " " (eshell-flatten-list (list eshell-last-command-name eshell-last-arguments)))))
          (eshell-interactive-print (format "\nRunning time: %s\n"
                                            time-string))
          (notifications-notify :title (format "'%s' finished"
                                               command)
                                :body (format "The eshell command '%s' finished %s%s"
                                              command
                                              (if (= 0 eshell-last-command-status)
                                                  "successfully."
                                                "with error.")
                                              (if (= 0 eshell-last-command-status)
                                                  ""
                                                (format "<br><br>Error code: %d"
                                                        eshell-last-command-status)))
                                :app-icon (if (= 0 eshell-last-command-status)
                                              "utilities-terminal"
                                            "emblem-important")
                                :timeout (if (= 0 eshell-last-command-status)
                                             7200
                                           0)))))
    (setq cpped-eshell-current-process-start-time nil)))

(add-hook 'eshell-mode-hook #'(lambda ()
                                (add-hook 'eshell-pre-command-hook #'cpped-eshell-current-command-start nil t)
                                (add-hook 'eshell-post-command-hook #'cpped-eshell-current-command-stop nil t)))
#+END_SRC


** Help
*** [[https://github.com/Wilfred/helpful][Better Help Buffer]]
#+BEGIN_SRC emacs-lisp
(use-package helpful
  :after consult
  :custom (helpful-max-buffers 3)
  :config
  (push "\\`\\*helpful.*\\*\\'" consult-buffer-filter)
  (advice-add 'describe-function :override #'helpful-function)
  (advice-add 'describe-variable :override #'helpful-variable)
  (advice-add 'describe-key :override #'helpful-key)
  (advice-add 'describe-symbol :override #'helpful-symbol))
#+END_SRC

** Utilites
*** [[https://github.com/bbatsov/crux][A Collection of Ridiculously Useful eXtensions]]
#+BEGIN_SRC emacs-lisp
(use-package crux
  :config (advice-add 'crux-rename-file-and-buffer :around 'cpped-post-rename))
#+END_SRC

*** Date/time formatting
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "all-the-icons"
  (defun cpped-print-date ()
    (concat
     ""
     (propertize (format-time-string " %W")
                 'face '(:weight ultra-light))
     (format-time-string " %e.%-m.%G")))

  (defun cpped-print-time ()
    (format "%c %s" (+ #xe381 (% (string-to-number (format-time-string "%I")) 12)) (format-time-string " %H:%M"))))
#+END_SRC

**** Run freedesktop applications
#+BEGIN_SRC emacs-lisp
(defun cpped-run-application ()
  "Run a freedesktop application."
  (interactive)
  (helm :sources (helm-build-sync-source "Applications"
                   :candidates (let ((candidates))
                                 (mapcar (lambda (directory)
                                           (let ((desktop-directory (expand-file-name "applications" directory)))
                                             (when (file-exists-p desktop-directory)
                                               (mapcar (lambda (desktop-file)
                                                         (with-temp-buffer
                                                           (insert-file-contents desktop-file)
                                                           (let ((content (buffer-string)))
                                                             (when (and (not (string-match (rx bol (or "Hidden" "NoDisplay") (0+ (in space)) "=" (0+ (in space)) "true") content))
                                                                        (string-match (rx bol "Type" (0+ (in space)) "=" (0+ (in space)) "Application") content)
                                                                        (or (not (string-match (rx bol "TryExec" (0+ (in space)) "=" (0+ (in space)) (group (+ any))) content))
                                                                            (executable-find (match-string-no-properties 1 content))))
                                                               (let ((simple-name)
                                                                     (name)
                                                                     (exec))
                                                                 (when (string-match (rx bol "Name" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                   (setq simple-name (match-string-no-properties 1 content))
                                                                   (setq name simple-name)
                                                                   (when (and (string-match (rx bol "GenericName" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                              (not (equal name (match-string-no-properties 1 content))))
                                                                     (setq name (format "%s %s" simple-name (propertize (match-string-no-properties 1 content) 'face '(:weight extra-light :slant italic)))))
                                                                   (when (string-match (rx bol "Keywords" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                     (setq name (format "%s %s" name (propertize (match-string-no-properties 1 content) 'invisible t))))
                                                                   (when (string-match (rx bol "Comment" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                     (setq name (propertize name 'help-echo (match-string-no-properties 1 content))))
                                                                   (when (string-match (rx bol "Exec" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                     (setq exec (split-string (replace-regexp-in-string "%k" desktop-file (replace-regexp-in-string "%c" simple-name (replace-regexp-in-string "%[FfUuDdNnivm]" "" (match-string-no-properties 1 content))))))
                                                                     (push (cons name exec) candidates))))))))
                                                       (directory-files-recursively desktop-directory ".*\.desktop")))))
                                         (split-string (getenv "XDG_DATA_DIRS") ":"))
                                 candidates)
                   :action (helm-make-actions "Run" (lambda (selection)
                                                      (make-process :name (car selection)
                                                                    :buffer (format "*%s*" (car selection))
                                                                    :command selection))))
        :prompt "Run: "
        :buffer "*Applications*"))

(with-eval-after-load "consult"
  (push "\\*Applications\\*" consult-buffer-filter))
#+END_SRC

** Windows
*** Re-use frames
#+BEGIN_SRC emacs-lisp
(setq display-buffer-reuse-frames t)
#+END_SRC

*** Hide dividers between windows
#+BEGIN_SRC emacs-lisp
(setq window-divider-mode nil)
#+END_SRC

*** [[https://github.com/cyrus-and/zoom][Automatically zoom current window]]
#+BEGIN_SRC emacs-lisp
(use-package zoom
  :custom
  (zoom-size '(0.618 . 0.618))
  (zoom-ignored-major-modes '(dired-mode markdown-mode))
  (zoom-ignored-buffer-name-regexps '("^*calc"))
  :config
  (zoom-mode t))
#+END_SRC

*  File Handling
** Config
#+BEGIN_SRC emacs-lisp
(defvar cpped-config-file "~/.emacs-config.org")
#+END_SRC

** Ignore case for file names
#+BEGIN_SRC emacs-lisp
(setq read-file-name-completion-ignore-case t)
#+END_SRC

** Do not ask if file should be created
#+BEGIN_SRC emacs-lisp
(setq confirm-nonexistent-file-or-buffer nil)
#+END_SRC

** Automatically create parent directories on save
#+BEGIN_SRC emacs-lisp
(defun shark-bytes/create-parent-directories(&optional file)
  "Create parent directories for FILE."
  (when-let* ((file-path (or file
                             buffer-file-name
                             (buffer-name)))
              (parent-directory (file-name-directory file-path))
              (is-absolute (file-name-absolute-p file-path)))
    (unless (file-exists-p parent-directory)
      (make-directory parent-directory t)
      (set-visited-file-name file-path))))

(defun shark-bytes/enable-create-parent-directories()
  "Add shark-bytes/create-parent-directories to before-save-hook."
  (add-hook 'before-save-hook 'shark-bytes/create-parent-directories))

(add-hook 'find-file-hook 'shark-bytes/enable-create-parent-directories)
#+END_SRC

** [[https://gitlab.com/kisaragi-hiu/didyoumean.el/][Prefer existing files]]
#+BEGIN_SRC emacs-lisp
(use-package didyoumean
  :config (add-hook 'after-init #'(run-with-timer 60 nil didyoumean-mode)))
#+END_SRC

** Save backup files to .emacs.d/backups
#+BEGIN_SRC emacs-lisp
(setq backup-directory-alist `((".*" . ,(expand-file-name "backups" user-emacs-directory)))
      tramp-backup-directory-alist backup-directory-alist
      backup-by-copying t
      version-control t
      delete-old-versions t
      kept-new-versions 20
      kept-old-versions 5)
#+END_SRC

** [[https://github.com/shingo256/trashed][Use system trash]]
#+BEGIN_SRC emacs-lisp
(setq delete-by-moving-to-trash t)

(use-package trashed
  :custom
  (trashed-action-confirmer 'y-or-n-p)
  (trashed-size-format 'human-readable))
#+END_SRC

** Automatically silently reload unmodified buffers when file has changed on disk
#+BEGIN_SRC emacs-lisp
(setq global-auto-revert-non-file-buffers t
      auto-revert-verbose nil)
(global-auto-revert-mode t)
#+END_SRC

** Save current region or buffer to different file
#+BEGIN_SRC emacs-lisp
(defun cpped-save-copy ()
  "Save the current buffer or region to a different file."
  (interactive)
  (let* ((original (buffer-file-name))
         (copy (read-file-name "Copy to file: " nil nil nil (and original
                                                                 (file-name-nondirectory original))))
         (begin (if (use-region-p)
                    (region-beginning)
                  (point-min)))
         (end (if (use-region-p)
                  (region-end)
                (point-max)))
         (mustbenew (if (and original (file-equal-p original copy))
                        'excl
                      t)))
    (write-region begin end copy nil nil nil mustbenew)))
#+END_SRC

** [[https://github.com/bbatsov/super-save][Auto-save buffers]]
#+BEGIN_SRC emacs-lisp
(use-package super-save
  :custom
  (super-save-auto-save-when-idle t)
  (super-save-idle-duration 2)
  (super-save-remote-files t)
  :config
  (add-to-list 'super-save-triggers 'compile)
  (super-save-mode +1))
#+END_SRC

** [[https://github.com/nflath/sudo-edit][Allow editing via sudo]]
#+BEGIN_SRC emacs-lisp
(use-package su
  :config (su-mode +1))
#+END_SRC

** [[https://github.com/m00natic/vlfi][Allow opening large files]]
#+BEGIN_SRC emacs-lisp
(setq large-file-warning-threshold (* 25 1024 1024))

(use-package vlf
  :custom (vlf-application 'dont-ask)
  :config (require 'vlf-setup))
#+END_SRC

** Execute command on file
#+BEGIN_SRC emacs-lisp
(defun cpped-execute-command-on-buffer-file (command)
  (interactive "sCommand: ")
  (when buffer-file-name
    (shell-command (concat command " " buffer-file-name))))
#+END_SRC

** Allow editing compressed files
#+BEGIN_SRC emacs-lisp
(auto-compression-mode 1)
#+END_SRC

** Handle renames
#+BEGIN_SRC emacs-lisp
(defun cpped-post-rename (function)
  "Update recent files and projectile after rename."
  (let ((old buffer-file-name))
    (funcall function)
    (when (fboundp 'recentf-add-file)
      (recentf-add-file buffer-file-name)
      (recentf-remove-if-non-kept old))
    (when (ignore-errors (projectile-project-p))
      (call-interactively #'projectile-invalidate-cache))))
#+END_SRC

** File Management
*** [[https://www.emacswiki.org/emacs/RecentFiles][Recent files]]
#+BEGIN_SRC emacs-lisp
(use-package recentf
  :custom
  (recentf-max-saved-items 200)
  (recentf-max-menu-items 15)
  (recentf-auto-save-timer (run-with-idle-timer 300 t
                                                '(lambda ()
                                                   (let ((warning-minimum-level :error))
                                                     (ignore-errors (recentf-save-list))))))
  :config (recentf-mode))
#+END_SRC

*** Show multiple sources for open command
#+BEGIN_SRC emacs-lisp

(defvar cpped-consult-source-projectile
  `(:name     "Project files"
    :narrow   ?p
    :category file
    :face     consult-file
    :history  file-name-history
    :state    ,#'consult--file-state
    :enabled  ,(lambda () (ignore-errors (projectile-project-p)))
    :items    ,(lambda () (mapcar (lambda (file)
                                    (expand-file-name file (cpped-project-dir)))
                                  (projectile-project-files (cpped-project-dir)))))
  "Project file candidate source for `consult'.")

(defvar cpped-consult-source-directory
  `(:name     "Directory files"
    :narrow   ?d
    :category file
    :face     consult-file
    :history  file-name-history
    :state    ,#'consult--file-state
    :enabled  ,(lambda () (file-accessible-directory-p default-directory))
    :items    ,(lambda () (directory-files default-directory t)))
  "Directory file candidate source for `consult'.")

(defun cpped-consult-find-file ()
  ""
  (interactive)
  (when-let (buffer (consult--multi '(
                                      ;consult--source-buffer
                                      consult--source-recent-file
                                      cpped-consult-source-directory
                                      cpped-consult-source-projectile)
                                    :require-match (confirm-nonexistent-file-or-buffer)
                                    :prompt "Open: "
                                    :history 'consult--buffer-history
                                    :sort nil))
    (unless (cdr buffer)
      (consult--buffer-action (car buffer)))))
#+END_SRC

*** Dired
#+BEGIN_SRC emacs-lisp
(setq dired-auto-revert-buffer t
      dired-recursive-copies 'always
      dired-recursive-deletes 'top
      dired-dwim-target t
      dired-create-destination-dirs 'ask)
#+END_SRC

**** Re-use dired buffers
#+BEGIN_SRC emacs-lisp
(put 'dired-find-alternate-file 'disabled nil)

(define-key dired-mode-map (kbd "RET") 'dired-find-alternate-file)
#+END_SRC

**** [[https://github.com/DamienCassou/dired-imenu][imenu Integration]]
#+BEGIN_SRC emacs-lisp
(use-package dired-imenu)
#+END_SRC

**** [[https://www.emacswiki.org/emacs/wdired.el][Editing]]
#+BEGIN_SRC emacs-lisp
(use-package wdired
  :bind (:map dired-mode-map ("r" . wdired-change-to-wdired-mode))
  :custom
  (wdired-allow-to-change-permissions t)
  (wdired-create-parent-directories t))
#+END_SRC

**** Use standard ls parameters for listing
#+BEGIN_SRC emacs-lisp
(setq dired-listing-switches "-aFhl1v --group-directories-first")
#+END_SRC

**** [[https://github.com/purcell/diredfl/][Coloring]]
#+BEGIN_SRC emacs-lisp
(use-package diredfl
  :config
  (diredfl-global-mode))
#+END_SRC

**** Show lines in alternating colors
#+BEGIN_SRC emacs-lisp
(use-package stripe-buffer
  :hook (dired-mode . turn-on-stripe-buffer-mode))
#+END_SRC

**** Show Icons
#+BEGIN_SRC emacs-lisp
(use-package all-the-icons-dired
  :after all-the-icons
  :hook (dired-mode . all-the-icons-dired-mode))
#+END_SRC

**** Collapse empty directories
#+BEGIN_SRC emacs-lisp
(use-package dired-collapse
  :hook dired-mode)
#+END_SRC

**** [[https://github.com/calancha/dired-du][Show directory sizes]]
#+BEGIN_SRC emacs-lisp
(use-package dired-du
  :straight (dired-du
             :type git
             :host github
             :repo "calancha/dired-du")
  :custom (dired-du-size-format t))
#+END_SRC

**** [[github:amno1/dired-git-log][Show git information]]
#+begin_src emacs-lisp
(use-package dired-git-log
  :straight (dired-git-log
             :type git
             :host github
             :repo "amno1/dired-git-log")
  :hook dired-after-readin
  :custom (dired-git-log-auto-hide-details-p nil))
#+end_src

**** [[https://github.com/Fuco1/dired-hacks#dired-subtree][Show subtrees inline]]
#+BEGIN_SRC emacs-lisp
(use-package dired-subtree
  :bind (:map dired-mode-map
              ("<tab>" . dired-subtree-toggle)))
#+END_SRC

**** Filtering
#+BEGIN_SRC emacs-lisp
(use-package dired-narrow
  :bind (:map dired-mode-map ("f" . dired-narrow)))
#+END_SRC

**** Preview
#+BEGIN_SRC emacs-lisp
(use-package peep-dired
  :bind (:map dired-mode-map ("v" . peep-dired)))
#+END_SRC

**** [[https://github.com/dalanicolai/mediator][Open in application]]
#+BEGIN_SRC emacs-lisp
(use-package mediator
  :straight (mediator
             :type git
             :host github
             :repo "dalanicolai/mediator")
  :bind (:map dired-mode-map ("o" . cpped-dired-open-xdg))
  :custom (mediator-data-directories "/usr/share//")
  :config
  (defun cpped-dired-open-xdg ()
    "Open a file selected in dired with the default xdg application."
    (interactive)
    (mediator-open-file (dired-get-file-for-visit))))
#+END_SRC

**** Diff files
#+BEGIN_SRC emacs-lisp
(defvar cpped-dired-ediff-window-configuration nil)

(defun cpped-dired-ediff-files ()
  "Show a diff of two files marked in dired."
  (interactive)
  (let* ((files (dired-get-marked-files))
         (file1 (car files))
         (file2 (if (cdr files)
                    (cadr files)
                  (read-file-name "Diff to: " (dired-dwim-target-directory)))))
    (when (file-newer-than-file-p file1 file2)
      (cl-rotatef file1 file2))
    (setq cpped-dired-ediff-window-configuration (current-window-configuration))
    (ediff-files file1 file2 '((lambda ()
                                 (setq-local ediff-quit-hook (lambda ()
                                                               (ediff-kill-buffer-carefully ediff-buffer-A)
                                                               (ediff-kill-buffer-carefully ediff-buffer-B)
                                                               (set-window-configuration cpped-dired-ediff-window-configuration))))))))

(define-key dired-mode-map "d" 'cpped-dired-ediff-files)
#+END_SRC

**** Compress files
#+BEGIN_SRC emacs-lisp
(define-key dired-mode-map "c" 'dired-do-compress)
(define-key dired-mode-map "C" 'dired-do-compress-to)
#+END_SRC

**** Sync files
#+BEGIN_SRC emacs-lisp
(use-package dired-rsync)
#+END_SRC

**** OCR files
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "tesseract")
(cpped-install-system-package "tesseract-langpack-eng")
(cpped-install-system-package "tesseract-langpack-deu")

(defcustom cpped-ocr-language "deu+eng" "The language(s) for OCR.")

(defun cpped-dired-ocr ()
  "Copy text in images to kill ring."
  (interactive)
  (kill-new (mapconcat '(lambda (file)
                          (shell-command-to-string (format "tesseract -l %s %s stdout" cpped-ocr-language file)))
                       (dired-get-marked-files)
                       "")))

(define-key dired-mode-map "o" 'cpped-dired-ocr)
#+END_SRC

*** [[https://github.com/Alexander-Miller/treemacs][Treemacs]]
#+BEGIN_SRC emacs-lisp
(use-package treemacs
  :after consult
  :bind ("<f1>" . treemacs)
  :custom
  (treemacs-collapse-dirs 3)
  (treemacs-file-event-delay 2000)
  (treemacs-follow-after-init t)
  (treemacs-is-never-other-window t)
  (treemacs-silent-filewatch t)
  (treemacs-silent-refresh t)
  (treemacs-goto-tag-strategy 'refetch-index)
  (treemacs-ignored-file-predicates '(treemacs--std-ignore-file-predicate))
  (treemacs-space-between-root-nodes nil)
  (treemacs-width 50)
  :config
  (push "\\`\\*Treemacs\\*\\'" consult-buffer-filter)
  (push "\\`\\*Desktop Treemacs Helper\\*\\'" consult-buffer-filter)
  (treemacs-git-mode 'deferred)
  (treemacs-filewatch-mode)
  (treemacs-follow-mode)
  (treemacs-project-follow-mode)
  (treemacs-tag-follow-mode)
  (treemacs-fringe-indicator-mode nil))

(use-package treemacs-projectile
  :after (treemacs projectile))

(use-package lsp-treemacs
  :after (treemacs lsp-mode)
  :custom (lsp-treemacs-sync-mode 1))

(use-package treemacs-magit
  :after (treemacs magit))
#+END_SRC

*  Text
#+BEGIN_SRC emacs-lisp
(push '("\\.txt\\'" . text-mode) auto-mode-alist)
#+END_SRC

** Encoding
#+BEGIN_SRC emacs-lisp
(set-charset-priority 'unicode)
(set-language-environment 'utf-8)
(set-default-coding-systems 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-buffer-file-coding-system 'utf-8)
(set-clipboard-coding-system 'utf-8)
(set-file-name-coding-system 'utf-8)
(modify-coding-system-alist 'process "*" 'utf-8)
(prefer-coding-system 'utf-8)
(setq locale-coding-system 'utf-8)
(setq default-process-coding-system '(utf-8-unix . utf-8-unix))

(defun cpped-dos2unix ()
  (interactive)
  (set-buffer-file-coding-system 'utf-8-unix nil))

(defun cpped-unix2dos ()
  (interactive)
  (set-buffer-file-coding-system 'utf-8-dos nil))
#+END_SRC

** Highlighting
*** Enable stealth fontification
#+BEGIN_SRC emacs-lisp
(setq jit-lock-stealth-time 1
      jit-lock-chunk-size 1000
      jit-lock-defer-time 0.05)
#+END_SRC

*** Pretty symbols
#+BEGIN_SRC emacs-lisp
(add-hook 'text-mode-hook (lambda()
                            (push '("<_->" . ?⇄) prettify-symbols-alist)
                            (push '("<-_>" . ?⇆) prettify-symbols-alist)

                            (push '("--->" . ?⤏) prettify-symbols-alist)
                            (push '("<---" . ?⤎) prettify-symbols-alist)

                            (push '("-|>" . ?⇾) prettify-symbols-alist)
                            (push '("<|-" . ?⇽) prettify-symbols-alist)
                            (push '("<|-|>" . ?⇿) prettify-symbols-alist)

                            (push '("=/=>" . ?⇏) prettify-symbols-alist)
                            (push '("<=/=" . ?⇍) prettify-symbols-alist)
                            (push '("=|=>" . ?⤃) prettify-symbols-alist)
                            (push '("<=|=" . ?⤂) prettify-symbols-alist)
                            (push '("<=|=>" . ?⤄) prettify-symbols-alist)
                            (push '("<=/=>" . ?↮) prettify-symbols-alist)

                            (push '("..>" . ?⇢) prettify-symbols-alist)
                            (push '("<.." . ?⇠) prettify-symbols-alist)
                            (push '("^.." . ?⇡) prettify-symbols-alist)
                            (push '("v.." . ?⇣) prettify-symbols-alist)

                            (push '("->|" . ?⇥) prettify-symbols-alist)
                            (push '("|<-" . ?⇤) prettify-symbols-alist)
                            (push '("|<-_>|" . ?↹) prettify-symbols-alist)

                            (push '("-|->" . ?⇸) prettify-symbols-alist)
                            (push '("<-|-" . ?⇷) prettify-symbols-alist)
                            (push '("<-|->" . ?⇹) prettify-symbols-alist)

                            (push '("-||->" . ?⇻) prettify-symbols-alist)
                            (push '("<-||-" . ?⇺) prettify-symbols-alist)
                            (push '("<-||->" . ?⇼) prettify-symbols-alist)

                            (push '("^||v" . ?⇅) prettify-symbols-alist)
                            (push '("v||^" . ?⇵) prettify-symbols-alist)

                            (push '("\/v" . ?↯) prettify-symbols-alist)))
#+END_SRC

[[https://github.com/iqbalansari/emacs-emojify][Emojis]]
#+BEGIN_SRC emacs-lisp
(use-package emojify
  :hook (after-init-hook . global-emojify-mode))
#+END_SRC

*** Syntax types
**** [[https://github.com/sensorflo/adoc-mode][AsciiDoc]]
#+BEGIN_SRC emacs-lisp
(use-package adoc-mode
  :mode ("\\.adoc\\'" . adoc-mode))
#+END_SRC

**** Markdown
#+BEGIN_SRC emacs-lisp
(use-package markdown-mode
  :mode
  (("README\\.md\\'" . gfm-mode)
   ("\\.md\\'" . markdown-mode)
   ("\\.markdown\\'" . markdown-mode))
  :hook (markdown-mode . (lambda ()
                           (typo-mode -1)))
  :custom
  (markdown-command "multimarkdown")
  (markdown-enable-wiki-links t)
  (markdown-italic-underscore t)
  (markdown-make-gfm-checkboxes-buttons t))
#+END_SRC

***** Editing
****** Wrap Region
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "wrap-region"
  (wrap-region-add-wrappers
   '(("*" "*" "/" (gfm-mode markdown-mode))
     ("**" "**" "b" (gfm-mode markdown-mode))
     ("***" "***" "e" (gfm-mode markdown-mode))))
  (add-hook 'gfm-mode-hook 'wrap-region-mode)
  (add-hook 'markdown-mode-hook 'wrap-region-mode))
#+END_SRC

****** [[https://github.com/ardumont/markdown-toc][Table of contents]]
#+BEGIN_SRC emacs-lisp
(use-package markdown-toc
  :custom
  (markdown-toc-header-toc-start nil)
  (markdown-toc-header-toc-end nil))
#+END_SRC

***** Syntax checker
https://github.com/mivok/markdownlint
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "mdl" :package-manager 'gem))
#+END_SRC

***** [[https://github.com/mola-T/flymd][Preview]]
#+BEGIN_SRC emacs-lisp
(use-package flymd
  :custom
  (flymd-close-buffer-delete-temp-files t)
  (flymd-output-directory temporary-file-directory))
#+END_SRC

*** [[https://github.com/minad/goggles][Highlight edited areas shortly]]
#+BEGIN_SRC emacs-lisp
(use-package goggles
  :hook (find-file . goggles-mode))
#+END_SRC

*** Highlight current symbol
#+BEGIN_SRC emacs-lisp
(use-package auto-highlight-symbol
  :custom
  (ahs-case-fold-search nil)
  (ahs-default-range 'ahs-range-whole-buffer)
  (ahs-idle-interval 0.25)
  (ahs-inhibit-face-list nil)
  (ahs-suppress-log t)
  :config
  (push 'org-mode ahs-modes)
  (global-auto-highlight-symbol-mode t))
#+END_SRC

*** [[https://github.com/alvarogonzalezsotillo/region-occurrences-highlighter][Highlight current region]]
#+BEGIN_SRC emacs-lisp :tangle no
(use-package region-occurrences-highlighter
  :functions region-occurrences-highlighter
  :hook (prog-mode . region-occurrences-highlighter-mode))
#+END_SRC

*** Highlight number packs
Use custom regex to ignore color definitions (numbers starting with a # sign)
#+BEGIN_SRC emacs-lisp
(use-package num3-mode
  :hook find-file
  :custom (num3--number-re (concat "[^#]0[xX]\\([[:xdigit:]]+\\)"
                                   "\\|"
                                   "[^#]\\(?1:\\b\\(?:[0-9]+[a-fA-F]\\|[a-fA-F]+[0-9]\\)[[:xdigit:]]*\\b\\)"
                                   "\\|"
                                   "[^#]\\([0-9]+\\)"
                                   "\\|"
                                   "\\.\\([0-9]+\\)")))
#+END_SRC

*** Highlight colors
#+BEGIN_SRC emacs-lisp
(use-package rainbow-mode
  :hook find-file
  :config (add-to-list 'rainbow-html-colors-major-mode-list 'emacs-lisp-mode))
#+END_SRC

*** Highlight matching parens
#+BEGIN_SRC emacs-lisp
(setq show-paren-style 'mixed
      show-paren-delay 0.1
      show-paren-highlight-openparen t
      show-paren-when-point-inside-paren nil
      show-paren-when-point-in-periphery t)
(show-paren-mode)
#+END_SRC

**** Highlight off-screen matching parens
#+BEGIN_SRC emacs-lisp :tangle no
(remove-hook 'post-self-insert-hook
             #'blink-paren-post-self-insert-function)

(setq blink-matching-paren 'show)

(defvar-local cpped-matching-paren-overlay nil "An overlay for off-screen matching parens.")

(defun cpped-highlight-paren (&rest unused-arguments)
  "Display matching line for off-screen paren."
  (when (overlayp cpped-matching-paren-overlay)
    (delete-overlay cpped-matching-paren-overlay))
  (when (and (overlay-buffer show-paren--overlay)
             (not (or cursor-in-echo-area
                      executing-kbd-macro
                      noninteractive
                      (minibufferp)
                      this-command))
             (and (not (bobp))
                  (memq (char-syntax (char-before)) '(?\) ?\$)))
             (= 1 (logand 1 (- (point)
                               (save-excursion
                                 (forward-char -1)
                                 (skip-syntax-backward "/\\")
                                 (point))))))
    (cl-letf (((symbol-function #'minibuffer-message)
               (lambda (message &rest arguments)
                 (setq cpped-matching-paren-overlay (save-excursion
                                                      (goto-char (window-start))
                                                      (make-overlay (line-beginning-position)
                                                                    (line-end-position))))
                 (overlay-put cpped-matching-paren-overlay 'display (replace-regexp-in-string "Matches " "" (apply #'format-message message arguments)))
                 (overlay-put cpped-matching-paren-overlay 'priority 2000)
                 (overlay-put cpped-matching-paren-overlay 'face '(:inherit flycheck-info)))))
      (blink-matching-open))))

(advice-add #'show-paren-function :after #'cpped-highlight-paren)
#+END_SRC

*** Highlight last screen content when navigating
#+BEGIN_SRC emacs-lisp
(use-package on-screen
  :custom
  (on-screen-auto-update t)
  (on-screen-delay 1.5)
  (on-screen-drawing-threshold 10)
  (on-screen-highlight-method 'shadow)
  (on-screen-remove-when-edit t)
  (on-screen-highlighting-to-background-delta 0.9)
  :config (on-screen-global-mode +1))
#+END_SRC

*** Smart narrowing/widening
#+BEGIN_SRC emacs-lisp
(defun cpped-narrow-or-widen-dwim (prefix)
  "Widen if buffer is narrowed, narrow otherwise. If a prefix is given, always narrow regardless of narrowed state."
  (interactive "P")
  (declare (interactive-only))
  (cond ((and (buffer-narrowed-p)
              (not prefix)
              (not (region-active-p)) (widen)))
        ((region-active-p)
         (narrow-to-region (region-beginning)
                           (region-end)))
        ((derived-mode-p 'org-mode)
         (cond ((ignore-errors (org-edit-src-code) t)
                (delete-other-windows))
               ((ignore-errors (org-narrow-to-block) t))
               (t (org-narrow-to-subtree))))
        ((derived-mode-p 'latex-mode)
         (LaTeX-narrow-to-environment))
        (t (narrow-to-defun))))
#+END_SRC

** Syntax checker
*** [[https://github.com/tmalsburg/guess-language.el][Guess language]]
#+BEGIN_SRC emacs-lisp
(use-package guess-language
  :hook text-mode-hook
  :custom (guess-language-languages '(en de)))
#+END_SRC

*** [[https://github.com/bnbeckwith/writegood-mode][Mark common language issues]]
#+BEGIN_SRC emacs-lisp
(use-package writegood-mode
  :hook fundamental-mode)
#+END_SRC

*** [[https://github.com/amperser/proselint][Prose Linter]]
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "proselint" :package-manager 'pip)
  (with-eval-after-load "flycheck"
    (flycheck-define-checker proselint
      "A linter for prose."
      :command ("proselint" source-inplace)
      :error-patterns
      ((warning line-start (file-name) ":" line ":" column ": "
                (id (one-or-more (not (any " "))))
                (message (one-or-more not-newline)
                         (zero-or-more "\n" (any " ") (one-or-more not-newline)))
                line-end))
      :modes (text-mode org-mode markdown-mode gfm-mode))
    (add-to-list 'flycheck-checkers 'proselint)))
#+END_SRC

*** Diction
#+BEGIN_SRC emacs-lisp
(defvar-local cpped-diction-language "en" "The language used for diction checks.")
#+END_SRC

#+BEGIN_SRC emacs-lisp
(with-eval-after-load "flycheck"
  (with-eval-after-load "guess-language"
    (defun cpped-guess-language-switch-diction-function (lang &optional beginning end)
      "Switch the diction dictionary and recheck the current paragraph."
      (let ((new-language (cadr (assq lang guess-language-langcodes))))
        (when (and (not (string= cpped-diction-language new-language))
                   (member new-language '("en" "de")))
          (setq cpped-diction-language new-language)
          (flyspell-buffer))))

    (add-to-list 'guess-language-after-detection-functions 'cpped-guess-language-switch-diction-function))

  (with-eval-after-load "system-packages"
    (cpped-install-system-package "diction")

    (flycheck-define-checker cpped-diction
      "Diction checker"
      :command ("diction" "-bs" "-L" (eval cpped-diction-language) source-original)
      :error-patterns ((info line-start (file-name) ":" line ": " (message) line-end))
      :modes (text-mode org-mode markdown-mode gfm-mode))

    (add-to-list 'flycheck-checkers 'cpped-diction)))
#+END_SRC

** Navigation
*** [[https://github.com/ahungry/fast-scroll][Fast scrolling]]

#+begin_src emacs-lisp
(use-package fast-scroll
  :config
  (fast-scroll-config)
  (fast-scroll-mode 1))
#+end_src

*** Smart begin/end
#+BEGIN_SRC emacs-lisp
(use-package beginend
  :config (beginend-global-mode))
#+END_SRC

*** End sentence with single space
#+BEGIN_SRC emacs-lisp
(setq sentence-end-double-space nil)
#+END_SRC

*** [[https://github.com/elpa-host/goto-char-preview][Go to character with preview]]
#+BEGIN_SRC emacs-lisp
(use-package goto-char-preview)
#+END_SRC

*** [[https://github.com/tam17aki/ace-isearch][Jump to any symbol]]
#+BEGIN_SRC emacs-lisp
(use-package avy
  :custom
  (avy-all-windows t)
  (avy-background t)
  (avy-style 'words)
  (avy-dispatch-alist '((?k . avy-action-kill-move)
                        (?r . avy-action-kill-stay)
                        (?t . avy-action-teleport)
                        (?w . avy-action-copy)
                        (?y . avy-action-yank))))

(use-package ace-isearch
  :custom
  (ace-isearch-function 'avy-goto-subword-1)
  (ace-isearch-input-length 2)
  :config (global-ace-isearch-mode +1))
#+END_SRC

*** [[https://github.com/camdez/goto-last-change.el][Jump to last change]]
#+BEGIN_SRC emacs-lisp
(use-package goto-last-change)
#+END_SRC

*** [[https://github.com/Overdr0ne/gumshoe][Jump to one of the last locations]]
#+BEGIN_SRC emacs-lisp
(use-package gumshoe
  :straight (gumshoe :type git
                     :host github
                     :repo "Overdr0ne/gumshoe")
  :config
  (global-gumshoe-mode 1)
#+END_SRC

*** URIs
**** Allow clicking on URIs
#+BEGIN_SRC emacs-lisp
(add-hook 'prog-mode-hook 'goto-address-prog-mode)
#+END_SRC

**** [[https://github.com/abo-abo/ace-link][Jump to link address via keys]]
#+BEGIN_SRC emacs-lisp
(use-package ace-link
  :config
  (ace-link-setup-default)
  (defun cpped-jump-to-url ()
    "Jump to the URL at point."
    (interactive)
    (let ((url (url-get-url-at-point)))
      (if url
          (browse-url url)
        (ace-link-addr)))))
#+END_SRC

** Editing
*** Indentation
#+BEGIN_SRC emacs-lisp
(setq-default indent-tabs-mode nil)
(setq-default fill-column 120)
(setq auto-fill-mode t
      comment-empty-lines t
      electric-indent-mode t
      electric-layout-mode t
      electric-pair-mode nil
      show-trailing-whitespace t
      tab-always-indent 'complete
      c-tab-always-indent 'complete
      tab-width 4
      text-mode-hook '(turn-on-auto-fill text-mode-hook-identify)
      require-final-newline nil)

(defvar cpped-default-indentation 4 "The default number of spaces to indent.")
(defvar autopair-skip-whitespace t)
(defvar electric-spacing-double-space-docs nil)
(defvar whitespace-action '(cleanup))
(defvar whitespace-global-modes t)
(defvar whitespace-line-column nil)
(defvar whitespace-style '(face))
#+END_SRC

*** [[https://gitlab.com/emacs-stuff/indent-tools][Indent tools]]
#+BEGIN_SRC emacs-lisp
(use-package indent-tools)
#+END_SRC

*** Upper/lower case
#+BEGIN_SRC emacs-lisp
(use-package fix-word)
#+END_SRC

*** [[https://github.com/ainame/smart-newline.el][Smart Newline]]
#+BEGIN_SRC emacs-lisp
(use-package smart-newline
  :commands smart-newline-mode
  :hook (prog-mode . smart-newline-mode))
#+END_SRC

*** [[https://github.com/davidshepherd7/aggressive-fill-paragraph-mode][Auto-fill paragraphs]]
#+BEGIN_SRC emacs-lisp
(use-package aggressive-fill-paragraph
  :custom (afp-fill-comments-only-mode-list '(prog-mode)))
#+END_SRC

*** Join lines
#+BEGIN_SRC emacs-lisp
(defun cpped-join-lines ()
  "Join lines, optionally with a separator and quotes."
  (interactive)
  (if (region-active-p)
      (let ((separator-character (read-string "Separator: "))
            (quote-character (read-string "Quote: ")))
        (save-restriction
          (narrow-to-region (region-beginning) (region-end))
          (let ((lines (split-string (buffer-string) "\n" t)))
            (delete-region (point-min) (point-max))
            (insert (concat quote-character
                            (s-join (concat quote-character separator-character quote-character)
                                    lines)
                            quote-character)))))
    (crux-top-join-line)))
#+END_SRC

*** Easier escaping
#+BEGIN_SRC emacs-lisp
(use-package string-edit)
#+END_SRC

*** Expand selection
#+BEGIN_SRC emacs-lisp
(use-package expand-region)
#+END_SRC

*** Clipboard
Keep up to 500 entries
#+BEGIN_SRC emacs-lisp
(setq kill-ring-max 500)
#+END_SRC

Ignore duplicates
#+BEGIN_SRC emacs-lisp
(setq kill-do-not-save-duplicates t)
#+END_SRC

Use system clipboard
#+BEGIN_SRC emacs-lisp
(setq select-enable-clipboard t)
#+END_SRC

Save system clipboard contents to kill ring before killing
#+BEGIN_SRC emacs-lisp
(setq save-interprogram-paste-before-kill t)
#+END_SRC

Set prefered clipboard formats
#+BEGIN_SRC emacs-lisp
(setq x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING))
#+END_SRC

*** Do not delete selected text when inserting characters
#+BEGIN_SRC emacs-lisp
(delete-selection-mode nil)
#+END_SRC

*** Do not alert when killing read-only text
#+BEGIN_SRC emacs-lisp
(setq kill-read-only-ok t)
#+END_SRC

*** Move text
#+BEGIN_SRC emacs-lisp
(use-package smart-shift
  :config (global-smart-shift-mode 1))
#+END_SRC

*** [[https://github.com/nflath/hungry-delete][Delete adjoining whitespaces in all major modes]]
#+BEGIN_SRC emacs-lisp
(use-package hungry-delete
  :custom (hungry-delete-join-reluctantly t)
  :config (global-hungry-delete-mode))
#+END_SRC

*** Smart backward delete
#+BEGIN_SRC emacs-lisp
(defun cpped-backward-kill-dwim ()
  (interactive "p")
  (if (region-active-p)
      (call-interactively #'kill-region)
    (kill-region (line-beginning-position) (point))))
#+END_SRC

*** [[https://github.com/lewang/ws-butler][Remove trailing whitespace in changed lines]]
#+BEGIN_SRC emacs-lisp
(use-package ws-butler
  :custom
  (ws-butler-global-mode t)
  (ws-butler-keep-whitespace-before-point nil)
  :config (ws-butler-global-mode))
#+END_SRC

*** Allow adding a newline to the end of the current line, regardless of point position
#+BEGIN_SRC emacs-lisp
(defun cpped-newline-after-current-line ()
  "Moves to the end of the current line and inserts a newline."
  (interactive)
  (end-of-line)
  (newline-and-indent))
#+END_SRC

*** Cut/copy whole line if no region is active
#+BEGIN_SRC emacs-lisp
(use-package whole-line-or-region
  :config (whole-line-or-region-global-mode t))
#+END_SRC

*** Case-insensitive line sorting
#+BEGIN_SRC emacs-lisp
(defun cpped-sort-lines-case-insensitive ()
  (interactive)
  (let ((sort-fold-case t))
    (call-interactively 'sort-lines)))
#+END_SRC

*** Remove duplicate adjacent lines
#+BEGIN_SRC emacs-lisp
(defun cpped-remove-duplicate-lines ()
  "Remove duplicate adjacent lines in a region or buffer."
  (interactive)
  (save-excursion
    (let ((begin (if (region-active-p)
                     (region-beginning)
                   (point-min)))
          (end (if (region-active-p)
                   (region-end)
                 (point-max))))
      (goto-char begin)
      (while (re-search-forward "^\\(.*\n\\)\\1+" end t)
        (replace-match "\\1")))))
#+END_SRC

*** Sort words
#+BEGIN_SRC emacs-lisp
(use-package sort-words)
#+END_SRC

*** [[https://github.com/mkcms/interactive-align][Regex alignment]]
#+BEGIN_SRC emacs-lisp
(use-package ialign
  :custom (ialign-align-with-tabs indent-tabs-mode))
#+END_SRC

*** [[https://github.com/benma/visual-regexp.el][Visual regular expressions]]
#+BEGIN_SRC emacs-lisp
(use-package visual-regexp
  :custom (vr/engine 'emacs))

(use-package visual-regexp-steroids
  :after visual-regexp)
#+END_SRC

*** Automatic insert
**** Typographic characters
#+BEGIN_SRC emacs-lisp
(use-package typo
  :hook (text-mode . (lambda ()
                       (when (not (string-equal (buffer-name) (file-name-nondirectory cpped-config-file)))
                         (typo-mode)))))
#+END_SRC

**** Abbreviations
Enable Abbrev-Mode by default
#+BEGIN_SRC emacs-lisp
(setq-default abbrev-mode t)
#+END_SRC

Always save abbreviations. Do not ask.
#+BEGIN_SRC emacs-lisp
(setq save-abbrevs 'silently)
#+END_SRC

Some useful abbreviations
#+BEGIN_SRC emacs-lisp
(define-abbrev-table 'global-abbrev-table '(("cpsign" "©")
                                            ("tmsign" "™")
                                            ("infsign" "∞")
                                            ("ifomration" "information")))
#+END_SRC

**** [[https://github.com/joaotavora/yasnippet][Templates]]
#+BEGIN_SRC emacs-lisp
(use-package yasnippet
  :bind (:map yas-keymap (("ESC" . yas-abort-snippet)
                          ("DEL" . yas-skip-and-clear-or-delete-char)))
  :custom
  (yas-snippet-dirs '("~/.yas-snippets"))
  (yas-wrap-around-region t)
  (yas-use-menu nil)
  (yas-triggers-in-field t)
  (yas-also-indent-empty-lines t)
  :config (yas-global-mode 1))
#+END_SRC

[[https://joaotavora.github.io/yasnippet/snippet-development.html][Snippet Development Documentation]]

***** Consult integration
#+BEGIN_SRC emacs-lisp
(use-package consult-yasnippet
  :after (consult yasnippet))
#+END_SRC

***** Licenses
#+BEGIN_SRC emacs-lisp
(use-package license-snippets
  :after yasnippet
  :config (license-snippets-init))
#+END_SRC

***** [[https://github.com/abo-abo/auto-yasnippet][Automatic snippets]]
#+BEGIN_SRC emacs-lisp
(use-package auto-yasnippet
  :after yasnippet)
#+END_SRC

*** [[https://github.com/rejeep/wrap-region.el][Wrap Region]]
#+BEGIN_SRC emacs-lisp
(use-package wrap-region
  :hook ((wrap-region-before-wrap . (lambda () (electric-pair-mode 0)))
         (wrap-region-after-wrap . (lambda () (electric-pair-mode 1)))))
#+END_SRC

*** Insert Date/Time
#+BEGIN_SRC emacs-lisp
(defun cpped-insert-timestamp ()
  "Insert date and time according to the locale's date and time format."
  (interactive)
  (insert (format-time-string "%c" (current-time))))

(defun cpped-insert-date ()
  "Insert the date according to the locale's date format."
  (interactive)
  (insert (format-time-string "%x" (current-time))))

(defun cpped-insert-time ()
  "Insert the time according to the locale's time format."
  (interactive)
  (insert (format-time-string "%X" (current-time))))

(defun cpped-insert-iso-date ()
  "Insert the date according to the ISO date format."
  (interactive)
  (insert (format-time-string "%F" (current-time))))

(defun cpped-insert-iso-timestamp ()
  "Insert the date according to the ISO date format."
  (interactive)
  (insert (format-time-string "%FT%T%z" (current-time))))
#+END_SRC

*** Insert UUID
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "util-linux")
(defun cpped-insert-uuid ()
  "Insert a UUID at point."
  (interactive)
  (insert (replace-regexp-in-string "\n" "" (shell-command-to-string (executable-find "uuidgen")))))
#+END_SRC

*** Thesaurus
#+BEGIN_SRC emacs-lisp
(use-package synosaurus
  :ensure-system-package wordnet
  :hook (after-init . synosaurus-mode)
  :custom (synosaurus-choose-method 'default)
  :config (setq-default synosaurus-backend 'synosaurus-backend-wordnet))
#+END_SRC

*** [[https://github.com/magnars/change-inner.el][Change inner]]
#+BEGIN_SRC emacs-lisp
(use-package change-inner)
#+END_SRC

*** Utilities
**** [[https://github.com/mhayashi1120/Emacs-wgrep][Edit grep buffers]]
#+BEGIN_SRC emacs-lisp
(use-package wgrep
  :hook (rg-mode . wgrep-rg-setup)
  :custom (wgrep-enable-key "e"))
#+END_SRC

** [[http://www-sop.inria.fr/members/Manuel.Serrano/flyspell/flyspell.html][Spell checking]]
#+BEGIN_SRC emacs-lisp
(use-package flyspell
  :after (consult system-packages)
  :ensure-system-package (aspell aspell-en aspell-de)
  :custom
  (flyspell-issue-welcome-flag nil)
  (flyspell-issue-message-flag nil)
  (flyspell-sort-corrections t)
  (flyspell-default-dictionary nil)
  (flyspell-abbrev-p t)
  (flyspell-use-global-abbrev-table-p t)
  (ispell-dictionary "en_US")
  (ispell-local-dictionary "en_US")
  (ispell-personal-dictionary "~/.emacs.d/.aspell.en.pws")
  (ispell-program-name "/usr/bin/aspell")
  (ispell-silently-savep t)
  (ispell-extra-args '("--sug-mode=ultra"
                       "--lang=en_US"))
  :config
  (when (string-match-p "--camel-case"
                        (shell-command-to-string (concat ispell-program-name " --help")))
    (push "--camel-case" ispell-extra-args))
  (push "\\`\\*flypell.*\\*\\'" consult-buffer-filter)
  (defvar-local cpped-flyspell-errors 0 "The number of spelling errors in the document.")
  (advice-add 'flyspell-after-change-function :after (lambda (&rest arguments)
                                                       (setq cpped-flyspell-errors 0)
                                                       (dolist (buffer-overlay (overlays-in (point-min) (point-max)))
                                                         (when (flyspell-overlay-p buffer-overlay)
                                                             (setq cpped-flyspell-errors (1+ cpped-flyspell-errors))))
                                                       (force-mode-line-update)))
  (defun cpped-modeline-flyspell-status()
    "Format the modeline flyspell information."
    (when (and flyspell-mode
               (> cpped-flyspell-errors 0))
      (propertize (format " %d" cpped-flyspell-errors)
                          'face 'cpped-check-status-error)))
  (add-to-list 'cpped-modeline-check-status-functions 'cpped-modeline-flyspell-status))
#+END_SRC

https://github.com/d12frosted/flyspell-correct
#+BEGIN_SRC emacs-lisp
(use-package flyspell-correct
  :after flyspell)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package consult-flyspell
  :straight (consult-flyspell
             :type git
             :host gitlab
             :repo "OlMon/consult-flyspell")
  :after (consult flyspell-correct)
  :custom
  (consult-flyspell-select-function (lambda () (flyspell-correct-at-point) (consult-flyspell)))
  (consult-flyspell-set-point-after-word t)
  (consult-flyspell-always-check-buffer t))
#+END_SRC

** Utilities
*** [[https://github.com/fourier/loccur][Filter]]
#+BEGIN_SRC emacs-lisp
(use-package loccur)
#+END_SRC

*** [[https://github.com/akicho8/string-inflection][Change lower/upper case]]
#+BEGIN_SRC emacs-lisp
(use-package string-inflection)
#+END_SRC

*** [[https://github.com/abo-abo/define-word][Define word]]
#+BEGIN_SRC emacs-lisp
(use-package define-word)
#+END_SRC

*** [[https://github.com/atykhonov/google-translate][Translate text]]
#+BEGIN_SRC emacs-lisp
(use-package google-translate
  :custom
  (google-translate-show-phonetic t)
  (google-translate-output-destination 'popup)
  (google-translate-default-source-language "auto")
  :config
  (defun cpped-translate-word-or-region (&optional target-language replace)
    "Replace the current region or word with its translation."
    (interactive)
    (let* ((bounds (cpped-word-or-region-bounds))
           (begin (car bounds))
           (end (cdr bounds))
           (text (buffer-substring-no-properties begin
                                                 end))
           (target-language (google-translate-language-abbreviation (or target-language
                                                                        (google-translate-completing-read "Translate to: "
                                                                                                          (google-translate-supported-languages)
                                                                                                          "English"))))
           (google-translate-output-destination (if replace
                                                    'current-buffer
                                                  google-translate-output-destination)))
      (when replace
        (delete-region begin end))
      (google-translate-translate "auto" target-language text))))
#+END_SRC

*  Binaries
Open binary files in hexl-mode
#+BEGIN_SRC emacs-lisp
(defvar cpped-no-hexedit-extensions nil "File extensions for which automatic hex editing is disabled")

(add-hook 'find-file-hook (lambda ()
                            (when (and (eq buffer-file-coding-system 'no-conversion)
                                       (not (catch 'found
                                              (mapc (lambda (pattern)
                                                      (when (and (stringp buffer-file-name)
                                                                 (string-match pattern buffer-file-name))
                                                        (throw 'found pattern)))
                                                    cpped-no-hexedit-extensions)
                                              nil)))
                              (hexl-mode))))
#+END_SRC

** Support cpio
#+BEGIN_SRC emacs-lisp
(use-package cpio-mode
  :bind (:map cpio-mode-map ("q" . kill-this-buffer))
  :config
  (push "\\.cpio\\'" cpped-no-hexedit-extensions)
  (push '("070707" . cpio-mode) magic-mode-alist)
  (push '("0123456789abcdef" . cpio-mode) magic-mode-alist)
  (push '("0123456789abcdefCPIO archive" . cpio-mode) magic-mode-alist))
#+END_SRC

*  Images
** Disable hex edit mode for images
#+BEGIN_SRC emacs-lisp
(push "\\.jpg\\'" cpped-no-hexedit-extensions)
(push "\\.jpeg\\'" cpped-no-hexedit-extensions)
(push "\\.png\\'" cpped-no-hexedit-extensions)
(push "\\.gif\\'" cpped-no-hexedit-extensions)
(push "\\.svg\\'" cpped-no-hexedit-extensions)
#+END_SRC

*  Programming
** Projects
*** Find file in project
#+BEGIN_SRC emacs-lisp
(defun cpped-find-project-file (file)
  "Find a file in source or build directory."
  (or
   (let* ((source-dir (cpped-project-dir))
          (source-file (when source-dir
                         (expand-file-name file source-dir))))
     (when (and source-file
                (file-exists-p source-file))
       source-file))
   (let* ((build-dir (cpped-build-dir))
          (build-file (when build-dir
                        (expand-file-name file build-dir))))
     (when (and build-file
                (file-exists-p build-file))
       source-file))))
#+END_SRC

*** Use docker to run tools for docker-based projects
#+BEGIN_SRC emacs-lisp
(system-packages-ensure "docker")

(defvar default-docker-compose-file "docker-compose.yml" "The default name for the docker-compose file.")
(defvar default-docker-start-script "docker-run.sh" "The default path to a script to start applications in a docker container.")

(defun cpped-docker-compose-file ()
  "Find the compose file in the project root."
  (let ((compose-file (cpped-find-project-file default-docker-compose-file)))
    (when (and compose-file
             (file-exists-p compose-file))
        compose-file)))

(defun cpped-is-docker-project-p ()
  "Check if the current project supports docker."
  (or (cpped-docker-compose-file)
      (cpped-find-project-file ".docker-project")))

(defun cpped-maybe-run-in-docker (command)
  "Run a command in docker if supported by the project."
  (let* ((compose-file (cpped-docker-compose-file)))
    (if compose-file
        (append `(docker-compose --file ,compose-file --exec) command)
      (if (and (cpped-is-docker-project-p)
               default-docker-start-script)
          (append default-docker-start-script command)
        command))))

(with-eval-after-load "flycheck"
  (setq flycheck-command-wrapper-function #'(lambda (command)
                                              (cpped-maybe-run-in-docker command))))
#+END_SRC

*** CMake
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "cmake")
(cpped-install-system-package "ccmake")
(cpped-install-system-package "ninja-build")
#+END_SRC

**** Re-/Configure CMake
Handler to close buffer after quitting ccmake.
#+BEGIN_SRC emacs-lisp
(advice-add 'term-sentinel :after (lambda (proc msg)
                                    (when (and (equal (buffer-name (process-buffer proc)) "*CMake Cache*")
                                               (memq (process-status proc) '(signal exit))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defvar cpped-build-base-directory "~/Build" "The default build directory.")
(defvar cpped-build-directories nil "An alist of all build directories per source directory.")
(defvar cpped-current-build-directories nil "An alist of the selected build directory per source directory.")
(defvar cpped-dependencies-file "dependencies.dot" "The name of the file containig the target dependencies graph.")

(defun cpped-cmake-configure (source-dir build-dir)
  "Configure the CMake project for the current file."
  (interactive (let ((source-directory (if (and (boundp 'source-dir)
                                                source-dir
                                                (file-directory-p source-dir))
                                           source-dir
                                           (read-directory-name "Source Directory: "
                                                                (cpped-project-dir)))))
                 (list source-directory
                       (if (and (boundp 'build-dir)
                                build-dir)
                           build-dir
                           (read-directory-name "Build-directory: "
                                                (expand-file-name (file-name-nondirectory (directory-file-name (file-name-directory source-directory))) cpped-build-base-directory))))))
    (when (and build-dir
               source-dir)
      (if (file-directory-p source-dir)
          (if (cpped-cmake-source-directory-p source-dir)
              (progn
                (when (not (file-directory-p build-dir))
                  (make-directory build-dir t))
                (let ((default-directory build-dir))
                  (ansi-term (getenv "SHELL") (concat "*CMake Cache (" build-dir ")*"))
                  (let* ((full-command (cpped-maybe-run-in-docker source-dir `(ccmake -DGRAPHVIZ_CUSTOM_TARGETS=TRUE ,(concat "--graphviz=" cpped-dependencies-file) -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -G Ninja ,source-dir)))
                         (command (car full-command))
                         (arguments (cdr full-command)))
                    (term-exec (current-buffer) command command nil arguments))
                  (cpped-load-project build-dir)))
            (error "`%s' does not contain a CMake project" source-dir))
        (error "`%s' is not a directory" source-dir))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-reconfigure (build-dir)
  "Reconfigure the CMake project for the current file and build directory."
  (interactive (list (or (cpped-build-dir)
                         (read-directory-name "Build-directory: "
                                              (file-name-as-directory cpped-build-base-directory)))))
  (if (and build-dir
           (file-directory-p build-dir))
      (if (cpped-cmake-build-directory-p build-dir)
          (let ((default-directory build-dir))
            (ansi-term (getenv "SHELL") "CMake Cache")
            (let* ((full-command (cpped-maybe-run-in-docker (cpped-cmake-source-dir build-dir) '(ccmake -DGRAPHVIZ_CUSTOM_TARGETS=TRUE ,(concat "--graphviz=" cpped-dependencies-file) .)))
                   (command (car full-command))
                   (arguments (cdr full-command)))
              (term-exec (current-buffer) command command nil arguments))
            (cpped-load-project build-dir))
        (error "`%s' is not a CMake build directory" build-dir))
    (error "`%s' is not a directory" build-dir)))
#+END_SRC

**** Clear CMake Cache
#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-reset (build-dir)
  "Reset the current CMake configuration."
  (interactive (list (or (cpped-build-dir)
                         (read-directory-name "Build-directory: "
                                              (file-name-as-directory cpped-build-base-directory)))))
  (if (and build-dir
           (file-directory-p build-dir))
      (let ((cache-file (expand-file-name "CMakeCache.txt" build-dir)))
        (if (file-exists-p cache-file)
            (progn (delete-file cache-file)
                   (cpped-cmake-configure (cpped-cmake-source-dir build-dir) build-dir))
          (error "`%s' is not a CMake build directory" build-dir)))
    (error "`%s' is not a directory" build-dir)))
#+END_SRC

**** Open Project
#+BEGIN_SRC emacs-lisp
(defvar cpped-after-project-load-hook nil "Hook called after a project is loaded. ")
(defvar cpped-after-project-load-update-project-file-hook nil "Hook called for each project file after a project is loaded. ")

(defun cpped-load-project (build-dir)
  "Load a project."
  (interactive (list (read-directory-name "Build-directory: "
                                          (file-name-as-directory cpped-build-base-directory))))
  (if (cpped-build-directory-p build-dir)
      (let ((source-dir (if (cpped-cmake-build-directory-p build-dir)
                            (cpped-cmake-source-dir build-dir)
                          build-dir)))
        (projectile-discover-projects-in-directory source-dir)
        (when (not (boundp cpped-cmake-current-target))
                                        (setq cpped-cmake-current-target 'all))
        (push '(source-dir . build-dir) cpped-current-build-directories)
        (run-hooks 'cpped-after-project-load-hook)
        (mapc (lambda (buffer)
                (with-current-buffer buffer
                  (run-hooks 'cpped-after-project-load-update-project-file-hook)))
              (projectile-project-buffers)))
    (error "`%s' is not a build directory" build-dir)))
#+END_SRC

**** Select configuration
#+BEGIN_SRC emacs-lisp
(setq cpped-build-directories '(("/home/player/.dotfiles/" . "/home/player/test") ("/home/player" . "/home/player/bla")))

#+END_SRC

**** Delete configuration
#+BEGIN_SRC emacs-lisp
(defun cpped-delete-cmake-build-dir (build-dir)
  "Delete the currently set build directory."
  (interactive (list (or (cpped-build-dir)
                         (read-directory-name "Build-directory: "
                                              (file-name-as-directory cpped-build-base-directory)))))
  (when (cpped-cmake-build-directory-p build-dir)
    (delete-directory build-dir t t)
    (projectile-remove-known-project (cpped-cmake-source-dir build-dir))))
#+END_SRC


**** List targets
#+BEGIN_SRC emacs-lisp
(defvar cpped-current-targets nil "An alist of the currently selected build target per build directory.")

(defun cpped-get-cmake-targets (build-dir)
  "List all CMake targets for build-dir."
  (save-match-data
    (let ((output (shell-command-to-string (cpped-maybe-run-in-docker (cpped-cmake-source-dir build-dir) `(cmake --build ,build-dir --target help))))
          (position 0)
          (targets (list "all")))
      (while (string-match "^[\\. ]*\\([^\\[: ]+\\)" output position)
        (let ((target (match-string 1 output)))
          (unless (or (not target)
                      (string= target "edit_cache"))
            (push target targets))
          (setq position (match-end 0))))
      targets)))

(defun cpped-get-make-targets (build-dir)
  "List all make targets for build-dir."
  (let ((targets (list "all")))
    (with-temp-buffer
      (insert (shell-command-to-string (cpped-maybe-run-in-docker (cpped-cmake-source-dir build-dir) `(LANG=C make -C ,build-dir -nqp .DEFAULT 2>/dev/null))))
      (goto-char (point-min))
      (save-match-data
        (when (re-search-forward "^# Files" nil t)
          (while (re-search-forward "^\\([^/%$:#\n\t ]+\\):\\([^=]\\|$\\)" nil t)
            (setq target (match-string 1))
            (unless (or (save-excursion
                          (goto-char (match-beginning 0))
                          (forward-line -1)
                          (looking-at "^# Not a target:"))
                        (string-match "\\.[hoc]p*$" target))
              (push target targets))))
        targets))))


(defun cpped-build-target ()
  "Get the selected build target for the curent build directory."
  (cdr (assoc (cpped-build-dir) cpped-current-targets)))
#+END_SRC

**** Show target dependencies
(defun cpped-show-target-dependencies (build-dir)
  "Show the target dependencies."
  (interactive (list (or (cpped-build-dir)
                         (read-directory-name "Build-directory: "
                                              (file-name-as-directory cpped-build-base-directory)))))
  (let ((dot (executable-find "dot"))
        (inhibit-read-only t))
    (if dot
        (progn
          (pop-to-buffer (get-buffer-create "*Target Dependencies*"))
          (erase-buffer)
          (insert (shell-command-to-string (format "%s -Tsvg %s"
                                                   dot
                                                   (helm :sources (helm-build-sync-source "Target Dependencies"
                                                                    :candidates
                                                                    (let ((candidates (list (cons "all" (expand-file-name cpped-dependencies-file build-dir)))))
                                                                      (mapc (lambda (element)
                                                                              (when (string-match (rx (literal cpped-dependencies-file) "." (group (+ (not "."))) (group (? ".dependers")) eol) element)
                                                                                (push (cons (concat (match-string 1 element)
                                                                                                    (if (match-string 3 element)
                                                                                                        " (dependents)"
                                                                                                       ""))
                                                                                            element)
                                                                                      candidates)))
                                                                            (directory-files build-dir t (format "^%s.*" cpped-dependencies-file)))
                                                                      candidates))
                                                         :prompt "Target: "
                                                         :preselect (or (cdr (assoc build-dir cpped-current-targets))
                                                                        "all")
                                                         :buffer "*helm target dependencies*"))))
          (image-mode))
      (error "The dot tool is not installed."))))

**** Utilities
***** Find source directory
#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-source-dir (build-dir)
  "Find the corresponding source directory for build-dir."
  (interactive (list (read-directory-name "Build-directory: "
                                          (file-name-as-directory cpped-build-base-directory))))
  (let ((cache-file (expand-file-name "CMakeCache.txt" build-dir)))
    (if (file-exists-p cache-file)
        (let ((source-dir (with-temp-buffer
                            (insert-file-contents cache-file)
                            (beginning-of-buffer)
                            (save-match-data
                              (and
                               (search-forward-regexp "CMAKE_HOME_DIRECTORY[^=]*=[:blank:]*\\(.*\\)[:blank:]*$"
                                                      (point-max) nil 1)
                               (match-string 1))))))
          (if (and source-dir
                   (cpped-cmake-source-directory-p source-dir))
              (if (called-interactively-p 'any)
                  (message (format "The source directory for `%s' is `%s'." build-dir source-dir))
                source-dir)
            (error "Source directory information not found in cache")))
      (error "`%s' is not a CMake build directory" build-dir))))
#+END_SRC

***** Get build directory
#+BEGIN_SRC emacs-lisp
(defun cpped-build-dir ()
  "Get the current build directory."
  (interactive)
  (cdr (assoc (cpped-project-dir) cpped-current-build-directories)))
#+END_SRC

***** Check if directory is source directory
#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-source-directory-p (source-dir)
  "Check if source-dir is a CMake source directory."
  (file-exists-p (expand-file-name "CMakeLists.txt" source-dir)))
#+END_SRC

***** Check if directory is build directory
#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-build-directory-p (build-dir)
  "Check if build-dir is a CMake build directory."
  (or (file-exists-p (expand-file-name "CMakeCache.txt" build-dir))))

(defun cpped-ninja-build-directory-p (build-dir)
  "Check if build-dir is a ninja build directory."
  (or (file-exists-p (expand-file-name "build.ninja" build-dir))))

(defun cpped-make-build-directory-p (build-dir)
  "Check if build-dir is a make build directory."
  (or (file-exists-p (expand-file-name "Makefile" build-dir))))

(defun cpped-build-directory-p (build-dir)
  "Check if build-dir is a build directory."
  (or (cpped-cmake-build-directory-p build-dir)
      (cpped-ninja-build-directory-p build-dir)
      (cpped-make-build-directory-p build-dir)))
#+END_SRC

***** Check if directory is build directory for the current project
#+BEGIN_SRC emacs-lisp
(defun cpped-project-build-directory-p (build-dir)
  "Check if build-dir is a build directory for the current project."
  (and (cpped-cmake-build-directory-p build-dir)
       (if (cpped-cmake-build-directory-p build-dir)
           (string-equal (cpped-cmake-source-dir build-dir)
                         (cpped-project-dir))
         (string-equal build-dir
                       (cpped-project-dir)))))
#+END_SRC

*** Build
#+BEGIN_SRC emacs-lisp
(defun cpped-build-target (target)
  "Build the current target in the current build directory. Ask for target if not set."
  (interactive (list (or (or (cpped-build-target)
                             (call-interactively 'cpped-select-target)))))
  (let ((build-dir (cpped-build-dir)))
    (when (and build-dir target)
      (cond
       ((cpped-cmake-build-directory-p) (compile (string-join
                                                  (cpped-maybe-run-in-docker
                                                   (cpped-cmake-source-dir build-dir)
                                                   `(cmake --build ,build-dir --target ,target)))))
       ((cpped-ninja-build-directory-p) (compile (string-join
                                                  (cpped-maybe-run-docker
                                                   (cpped-cmake-source-dir build-dir)
                                                   `(ninja -C ,build-dir ,target)))))
       ((cpped-cmake-build-directory-p) (compile (string-join
                                                  (cpped-maybe-run-docker
                                                   (cpped-cmake-source-dir build-dir)
                                                   `(make -C ,build-dir ,target)))))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-clean-build-directory ()
  "Build the clean target in the current build directory."
  (interactive)
  (cpped-build-target "clean"))
#+END_SRC

*** Run/Debug
#+BEGIN_SRC emacs-lisp
(defun cpped-run-target (target)
  "Build and run the current target in the current build directory. Ask for target if not set."
  (interactive (list (or (or (cpped-build-target)
                             (call-interactively 'cpped-select-target)))))
  (cpped-build-target target)
  (let ((executable (locate-file target exec-path exec-suffixes 'executable)))
    (when executable
      (let ((default-directory(file-name-directory executable)))
        (call-process (cpped-maybe-run-in-docker executable))))))

(defun cpped-debug-target (target)
  "Build and run the current target in the current build directory. Ask for target if not set."
  (interactive (list (or (or (cpped-build-target)
                             (call-interactively 'cpped-select-target)))))
  (cpped-build-target target)
  (let ((executable (locate-file target exec-path exec-suffixes 'executable)))
    (when executable
      (realgud:gdb (cpped-maybe-run-in-docker (concat "gdb -cd=" (file-name-directory executable) " " executable))))))
#+END_SRC

** Languages
*** Common
#+BEGIN_SRC emacs-lisp
(use-package lsp-mode
  :after consult
  :hook prog-mode
  :custom
  (lsp-auto-configure t)
  (lsp-use-plists t)
  (lsp-completion-show-detail nil)
  (lsp-completion-show-kind nil)
  (lsp-log-io nil)
  (lsp-log-max 100)
  (lsp-restart 'auto-restart)
  (lsp-signature-mode t)
  (lsp-signature-function 'lsp-signature-posframe)
  (lsp-headerline-breadcrumb-enable nil)
  (lsp-idle-delay 0.5)
  (lsp-lens-enable t)
  (lsp-semantic-tokens-enable t)
  (lsp-modeline-code-actions-enable nil)
  (lsp-modeline-diagnostics-enable nil)
  (lsp-modeline-workspace-status-enable nil)
  :config (push "\\`\\*lsp-.+" consult-buffer-filter))

(use-package lsp-ui
  :bind (([remap xref-find-definitions] . lsp-ui-peek-find-definitions)
         ([remap xref-find-references] . lsp-ui-peek-find-references))
  :custom
  (lsp-ui-doc-include-signature t)
  (lsp-ui-doc-enable t)
  (lsp-ui-doc-show-with-cursor t)
  (lsp-ui-doc-show-with-mouse nil)
  (lsp-ui-doc-border "#303030")
  (lsp-ui-sideline-show-diagnostics nil)
  (lsp-ui-sideline-show-hover nil)
  (lsp-ui-sideline-show-code-actions t)
  (lsp-ui-sideline-show-symbol nil))
#+END_SRC

[[https://github.com/gagbo/consult-lsp][Consult support]]
#+BEGIN_SRC emacs-lisp
(use-package consult-lsp
  :after (consult lsp-mode marginalia)
)
#+END_SRC

**** Highlighting
***** [[https://codeberg.org/ideasman42/emacs-hl-indent-scope][Show Indentation]]
#+BEGIN_SRC emacs-lisp :tangle no
(use-package hl-indent-scope
  :hook (prog-mode . hl-indent-scope-mode)
  :custom
  (hl-indent-scope-fixed-width t)
  (hl-indent-scope-fill-empty-lines t)
  (hl-indent-scope-fill-over-text t))
#+END_SRC

***** [[https://github.com/ankurdave/color-identifiers-mode][Unique colors for identifiers]]
#+BEGIN_SRC emacs-lisp
(use-package color-identifiers-mode
  :hook prog-mode)
#+END_SRC

***** [[https://github.com/Fanael/rainbow-delimiters][Unique colors for parentheses]]
#+BEGIN_SRC emacs-lisp
(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))
#+END_SRC

***** [[https://github.com/dgutov/highlight-escape-sequences][Escape sequences]]
#+BEGIN_SRC emacs-lisp
(use-package highlight-escape-sequences
  :hook (prog-mode . hes-mode))
#+END_SRC

***** Pretty symbols
#+BEGIN_SRC emacs-lisp
(add-hook 'prog-mode-hook
          (lambda ()
            (push '("return" . ?) prettify-symbols-alist)
            (push '("true" . ?) prettify-symbols-alist)
            (push '("TRUE" . ?) prettify-symbols-alist)
            (push '("false" . ?) prettify-symbols-alist)
            (push '("FALSE" . ?) prettify-symbols-alist)
            (push '("function" . ?) prettify-symbols-alist)
            (push '("macro" . ?) prettify-symbols-alist)))
#+END_SRC

***** [[https://github.com/tarsius/hl-todo][Highlight TODO/FIXME/…]]
#+BEGIN_SRC emacs-lisp
(defface hl-todo-info '((t :inherit info))
  "Face used for info text."
  :group 'hl-todo)

(defface hl-todo-warning '((t :inherit warning))
  "Face used for warning text."
  :group 'hl-todo)

(defface hl-todo-error '((t :inherit error))
  "Face used for error text."
  :group 'hl-todo)

(use-package hl-todo
  :hook ((find-file . (lambda ()
                        (push '("???" . ?) prettify-symbols-alist)
                        (push '("FAIL" . ?) prettify-symbols-alist)
                        (push '("FIXME" . ?) prettify-symbols-alist)
                        (push '("HACK" . ?ྸ) prettify-symbols-alist)
                        (push '("INFO" . ?) prettify-symbols-alist)
                        (push '("NOTE" . ?) prettify-symbols-alist)
                        (push '("TODO" . ?) prettify-symbols-alist)
                        (push '("XXX" . ?) prettify-symbols-alist))))
  :custom
  (hl-todo-include-modes '(prog-mode text-mode org-mode))
  (hl-todo-exclude-modes nil)
  (hl-todo-keyword-faces '(("???" . hl-todo-info)
                           ("FAIL" . hl-todo-error)
                           ("FIXME" . hl-todo-error)
                           ("HACK" . hl-todo-error)
                           ("INFO" . hl-todo-info)
                           ("NOTE" . hl-todo-info)
                           ("TODO" . hl-todo-warning)
                           ("XXX" . hl-todo-warning)))
  :config (global-hl-todo-mode 1))
#+END_SRC

***** Find ToDos in file or project
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "consult"
  (defun cpped-find-todos-in-file ()
    "Show all ToDo items in thqe file and allow jumping to specific item."
    (interactive)
    (let ((imenu-generic-expression (mapcar (lambda (element)
                                              (let ((type (car element)))
                                                (list type (rx (literal type) (one-or-more space) (group (one-or-more any)) eol) 1)))
                                            hl-todo-keyword-faces)))
      (call-interactively 'consult-imenu))))
#+END_SRC

***** Show current function in mode-line
#+BEGIN_SRC emacs-lisp
(use-package which-func
  :custom (which-func-unknown "n/a")
  :config (which-function-mode 1))
#+END_SRC

***** [[https://github.com/AdamNiederer/cov][Code coverage]]
#+BEGIN_SRC emacs-lisp
(use-package cov
  :after all-the-icons
  :hook ((prog-mode . cov-mode)
         (cpped-after-project-load . (lambda ()
                                       (add-to-list 'cov-coverage-file-paths (cpped-build-dir)))))
  :custom (cov-coverage-mode t)
  :config
  (make-variable-buffer-local 'cov-coverage-file-paths)
  (defvar-local cpped-cov-lines-covered 0 "The number of lines covered in tests and/or application runs.")
  (defvar-local cpped-cov-percentage-covered 0 "The percentage of lines covered in tests and/or application runs.")
  (advice-add 'cov--get-face :after (lambda (percentage)
                                      (when (> percentage 0)
                                        (setq cpped-cov-lines-covered (1+ cpped-cov-lines-covered)))))
  (advice-add 'cov-update :around (lambda (wrapped-function &rest arguments)
                                    (setq lines-covered 0)
                                    (apply wrapped-function arguments)
                                    (setq cpped-cov-percentage-covered (* (/ cpped-cov-lines-covered (string-to-number (format-mode-line "%l"))) 100)
                                      (force-mode-line-update))))
  (defun cpped-coverage-status-face ()
    "Calculate the face for the coverage status."
    (cond ((> cpped-cov-percentage-covered 90) 'cpped-check-status-info)
          ((> cpped-cov-percentage-covered 30) 'cpped-check-status-warning)
          (t 'cpped-check-status-error)))
  (defun cpped-modeline-coverage()
    "Format the modeline coverage information."
    (when cov-coverage-file
      (let ((face (cpped-coverage-status-face)))
        (propertize (format " %d%%" cpped-cov-percentage-covered)
                    'face face))))
  (add-to-list 'cpped-modeline-check-status-functions 'cpped-modeline-coverage))
#+END_SRC

**** Navigation
***** [[https://github.com/gregsexton/origami.el][Folding]]
#+BEGIN_SRC emacs-lisp
(use-package origami
  :hook (prog-mode . origami-mode)
  :custom (origami-fold-replacement "…"))

(use-package lsp-origami
  :hook (lsp-mode . lsp-origami-mode))
#+END_SRC

***** Subword-navigation in camelCase words
#+BEGIN_SRC emacs-lisp
(add-hook 'prog-mode-hook (lambda () (subword-mode 1)))
#+END_SRC

***** [[https://github.com/magnars/smart-forward.el][Smart forward/backward]]
#+BEGIN_SRC emacs-lisp
(use-package smart-forward)
#+END_SRC

***** Limit view to function when navigating
#+BEGIN_SRC emacs-lisp
(add-hook 'imenu-after-jump-hook #'(lambda ()
                                     (when (derived-mode-p 'prog-mode)
                                       (narrow-to-defun))))
#+END_SRC

***** Bug references

Set bug-reference-url-format to open in browser.

#+BEGIN_SRC emacs-lisp
(add-hook 'text-mode-hook 'bug-reference-mode)
(add-hook 'prog-mode-hook 'bug-reference-prog-mode)
#+END_SRC

**** Editing
***** [[https://github.com/lassik/emacs-format-all-the-code][Formatting]]
#+BEGIN_SRC emacs-lisp
(use-package format-all
  :hook ((prog-mode . format-all-mode)
         (format-all-mode . format-all-ensure-formatter)))
#+END_SRC

****** Fill function calls
#+BEGIN_SRC emacs-lisp
(use-package prog-fill
  :custom
  (prog-fill-break-method-immediate-p t)
  (prog-fill-floating-open-paren-p nil)
  (prog-fill-floating-close-paren-p nil)
  (prog-fill-auto-indent-p t))
#+END_SRC

Use [[https://editorconfig.org/][EditorConfig]] via [[https://github.com/editorconfig/editorconfig-emacs]] if available
#+BEGIN_SRC emacs-lisp
(use-package editorconfig
  :config (editorconfig-mode 1))
#+END_SRC

***** [[https://github.com/remyferre/comment-dwim-2][Smarter commenting]]
#+BEGIN_SRC emacs-lisp
(use-package comment-dwim-2
  :config
  (defun cpped-comment-line ()
    "Comment SEXPs instead of region in lisp code."
    (if (cd2/empty-line-p)
        (comment-dwim nil)
      (if (derived-mode-p 'emacs-lisp-mode)
          (comment-or-uncomment-sexp)
        (comment-region (line-beginning-position) (line-end-position)))))
  (advice-add 'cd2/comment-line :override 'cpped-comment-line))
#+END_SRC

***** [[https://github.com/victorhge/iedit][Edit all occurences within function]]
#+BEGIN_SRC emacs-lisp
(defvar-local cpped-mark-function 'mark-defun "The function to call to mark the current function.")
(defvar-local cpped-beginning-of-function 'beginning-of-defun "The function to call to jump to the beginning of the current function.")
(defvar-local cpped-end-of-function 'end-of-defun "The function to call to jump to the end of the current function.")

(use-package iedit)

(defun cpped-iedit-scoped (orig-fn)
  "Call `iedit-mode' with function-local scope, or global scope if called with a universal prefix."
  (interactive)
  (pcase-exhaustive current-prefix-arg
    ('nil (funcall orig-fn '(0)))
    ('(4) (funcall orig-fn))))

(advice-add #'iedit-mode :around #'cpped-iedit-scoped)
#+END_SRC

***** Change numbers
#+BEGIN_SRC emacs-lisp
(use-package shift-number)
#+END_SRC

***** [[https://github.com/AdamNiederer/0xc][Convert number formats]]
#+BEGIN_SRC emacs-lisp
(use-package 0xc
  :config
  (defun cpped-convert-number (base)
    (interactive (list (string-to-number (completing-read "Base" '("2" "8" "10" "16")))))
    (0xc-convert-point base))
  (defun cpped-show-number-info ()
    (interactive)
    (let ((number (0xc-string-to-number (apply 'buffer-substring-no-properties (0xc--bounds-of-number-at-point)))))
      (message "%s 0x%s 0b%s"
               (0xc-number-to-string number 10)
               (0xc-number-to-string number 16)
               (0xc-number-to-string number 2)))))
#+END_SRC

***** [[https://github.com/emacsfodder/kurecolor][Modify colors]]
#+BEGIN_SRC emacs-lisp
(use-package kurecolor)
#+END_SRC

***** [[https://github.com/minad/corfu][Autocompletion]]
#+BEGIN_SRC emacs-lisp
(use-package corfu
    :custom
    (corfu-cycle nil)
    (corfu-auto t)
    (corfu-auto-prefix 2)
    (corfu-auto-delay 0.2)
    (corfu-separator ?\s)
    (corfu-quit-at-boundary nil)
    (corfu-quit-no-match nil)
    ;(corfu-quit-no-match 'separator)
    (corfu-preview-current nil)
    (corfu-preselect-first nil)
    (corfu-on-exact-match nil)
    (corfu-echo-documentation nil)
    (corfu-scroll-margin 5)
    :init
    (corfu-global-mode))
#+END_SRC

****** [[https://github.com/jdtsmith/kind-icon][Completion icons]]
#+BEGIN_SRC emacs-lisp
(use-package kind-icon
  :after corfu
  :custom
  (kind-icon-default-face 'corfu-default) ; to compute blended backgrounds correctly
  :config
  (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+END_SRC

****** [[https://github.com/minad/cape][Add more CAPF]]
#+BEGIN_SRC emacs-lisp
(use-package cape
  :after yasnippet
  :custom
  (cape-dabbrev-check-other-buffers nil)
  :config
  ;;(add-to-list 'completion-at-point-functions #'cape-tex)
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-abbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-keyword)
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-silent)
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-purify))
#+END_SRC

***** [[https://github.com/davidshepherd7/electric-operator][Automatic spacing]]
#+BEGIN_SRC emacs-lisp
(use-package electric-operator
  :hook ((text-mode . electric-operator-mode)
         (prog-mode . electric-operator-mode))
  :custom (electric-operator-enable-in-docs t))
#+END_SRC

***** [[https://github.com/snosov1/dummyparens][Automatic parens]]
#+BEGIN_SRC emacs-lisp
(use-package dummyparens
  :config
  (global-dummyparens-mode))
#+END_SRC

***** [[http://www.flycheck.org/en/latest/][Syntax checking]]
#+BEGIN_SRC emacs-lisp
(use-package flycheck
  :after consult; popwin)
  :hook (after-init . global-flycheck-mode)
  :custom
  (flycheck-idle-change-delay 2.0)
  (flycheck-display-errors-delay 0.2)
  (flycheck-checker-error-threshold nil)
  (flycheck-indication-mode nil)
  (flycheck-highlighting-mode nil)
  (flycheck-display-errors-function nil)
  (flycheck-help-echo-function nil)
  (flycheck-process-error-functions nil)
  (flycheck-check-syntax-automatically '(mode-enabled save))
  :config
  (push "\\`\\*Flycheck.+\\*\\'" consult-buffer-filter)
  (defun cpped-modeline-flycheck-status-face ()
    (pcase flycheck-last-status-change
      (`errored 'cpped-check-status-error)
      (`finished
       (if flycheck-current-errors
           (let-alist (flycheck-count-errors flycheck-current-errors)
             (cond (.error 'cpped-check-status-error)
                   (.warning 'cpped-check-status-warning)
                   (.info 'cpped-check-status-info)))
         'cpped-check-status-info))
      (_ 'cpped-check-status-warning)))
  (defun cpped-modeline-flycheck-status ()
    (when (and (boundp 'flycheck-last-status-change)
               (equal flycheck-last-status-change 'finished))
      (let ((issues (let-alist (flycheck-count-errors flycheck-current-errors)
                      (+ (or .warning 0) (or .error 0) (or .info 0))))
            (face (cpped-modeline-flycheck-status-face)))
        (propertize (format " %d" issues)
                     'face face))))
  (add-to-list 'cpped-modeline-check-status-functions 'cpped-modeline-flycheck-status))
#+END_SRC

Custom error highlighting (colored line under location)
#+BEGIN_SRC emacs-lisp
(defun cpped-flycheck-clear (status)
  "Clear the highlights if appropriate."
  (let ((clear nil))
    (when (boundp 'flycheck-last-status-change)
      (pcase flycheck-last-status-change
        (`not-checked (setq clear t))
        (`errored (setq clear t))
        (`interrupted (setq clear t))
        (_ (setq clear nil))))
    (when clear
      (remove-overlays nil nil 'cpped-flycheck-inline-error t))))

(defun cpped-flycheck-inline-error-messages ()
  "Show Flycheck errors in a new line below the problematic line."
  (remove-overlays nil nil 'cpped-flycheck-inline-error t)
  (mapc #'(lambda (error)
            (let* ((begin (save-excursion
                            (goto-char (flycheck-error-pos error))
                            (forward-line)
                            (point)))
                   (level (symbol-name (flycheck-error-level error)))
                   (face (pcase level
                           ("error" 'flycheck-error)
                           ("warning" 'flycheck-warning)
                           ("info" 'flycheck-info)
                           (_ 'default)))
                   (overlay (make-overlay begin begin)))
              (overlay-put overlay 'before-string (propertize (format " %s %s\n"
                                                                      (pcase level
                                                                        ("error" "")
                                                                        ("warning" "")
                                                                        ("info" "")
                                                                        (_ ""))
                                                                      (flycheck-error-message error))
                                                              'face face))
            (overlay-put overlay 'cpped-flycheck-inline-error t))) flycheck-current-errors))

(add-hook 'flycheck-after-syntax-check-hook #'cpped-flycheck-inline-error-messages)
(add-hook 'flycheck-status-changed-functions #'cpped-flycheck-clear)
#+END_SRC

***** Consult integration
#+BEGIN_SRC emacs-lisp
(use-package consult-flycheck
    :after (consult flycheck))
#+END_SRC

***** [[https://github.com/michaeljb/bool-flip][Flip booleans]]
#+BEGIN_SRC emacs-lisp
(use-package bool-flip
  :custom
  (bool-flip-alist '(("T" . "F")
                     ("t" . "f")
                     ("TRUE" . "FALSE")
                     ("True" . "False")
                     ("true" . "false")
                     ("Y" . "N")
                     ("y" . "n")
                     ("YES" . "NO")
                     ("Yes" . "No")
                     ("yes" . "no")
                     ("1" . "0")
                     ("ON" . "OFF")
                     ("On" . "Off")
                     ("ENABLED" . "DISABLED")
                     ("Enabled" . "Disabled")
                     ("NOT" . "")
                     ("not" . "")
                     ("!" . "")
                     ("!=" . "==")
                     ("==" . "!=")
                     ("<" . "<=")
                     ("<=" . ">=")
                     (">=" . ">")
                     (">" . "<"))))
#+END_SRC

***** [[https://github.com/atykhonov/emacs-howdoi][Code suggestions]]
#+BEGIN_SRC emacs-lisp
(use-package howdoi)
#+END_SRC

**** Compilation
***** [[https://github.com/abo-abo/helm-make][Select make target with helm]]

TODO

#+BEGIN_SRC emacs-lisp
#+END_SRC

***** Always kill running compilation when starting another
#+BEGIN_SRC emacs-lisp
(setq compilation-always-kill t)
#+END_SRC

***** Do not ask to save unsaved buffers
#+BEGIN_SRC emacs-lisp
(setq compilation-ask-about-save nil)
#+END_SRC

***** Jump to first error/Move to errors
#+BEGIN_SRC emacs-lisp
(setq compilation-auto-jump-to-first-error t
      compilation-scroll-output 'first-error
      compilation-skip-threshold 2)
#+END_SRC

***** [[https://github.com/EricCrosson/bury-successful-compilation][Hide compilation buffer if successful]]
#+BEGIN_SRC emacs-lisp
(use-package bury-successful-compilation
  :config (bury-successful-compilation 1))
#+END_SRC

***** Support ANSI escape codes
#+BEGIN_SRC emacs-lisp
(defun cpped-colorize-compilation ()
  "Colorize compilation output."
  (let ((inhibit-read-only t))
    (ansi-color-apply-on-region compilation-filter-start (point))))

(add-hook 'compilation-filter-hook #'cpped-colorize-compilation)
#+END_SRC

***** Show status in mode line
#+BEGIN_SRC emacs-lisp
(defvar-local compilation-run-p nil "Flag to indicate if a compilation was run for the current buffer.")
(defvar-local compilation-finished-successfully-p nil "Flag to indicate if a compilation finished successfully.")

(add-hook 'compilation-start-hook (lambda (process)
                                    (setq cpped-process-running t
                                          cpped-current-process-start-time (current-time))))

(add-to-list 'compilation-finish-functions '(lambda (buffer message)
                                              (setq cpped-process-running nil
                                                    compilation-run-p t
                                                    compilation-finished-successfully-p (string-match "^finished" message))
                                              (force-mode-line-update)))

(defun cpped-modeline-compilation-status ()
  "Format the mode line compilation information."
  (when compilation-run-p
    (mapconcat 'identity
               (remove nil (list (propertize (all-the-icons-faicon5 "hammer")
                                             'face (list ':inherit (if compilation-finished-successfully-p
                                                                       (cond ((> compilation-num-errors-found 0) 'cpped-check-status-error)
                                                                             ((> compilation-num-warnings-found 0) 'cpped-check-status-warning)
                                                                             ((> compilation-num-infos-found 0) 'cpped-check-status-info)
                                                                             (t 'cpped-check-status-info))
                                                                     'cpped-check-status-error)
                                                         ':family (all-the-icons-faicon5-family))
                                             'display '(raise -0.0))
                                 (mapconcat 'identity
                                            (remove nil (list (when (> compilation-num-errors-found 0)
                                                                (propertize compilation-num-errors-found
                                                                            'face 'cpped-check-status-error))
                                                              (when (> compilation-num-warnings-found 0)
                                                                (propertize compilation-num-warnings-found
                                                                            'face 'cpped-check-status-warning))
                                                              (when (> compilation-num-infos-found 0)
                                                                (propertize compilation-num-infos-found
                                                                            'face 'cpped-check-status-info))))
                                            " / ")))
               " ")))

(add-to-list 'cpped-modeline-check-status-functions 'cpped-modeline-compilation-status)
#+END_SRC

***** Show notification
#+BEGIN_SRC emacs-lisp
(add-to-list 'compilation-finish-functions '(lambda (buffer message)
                                              (notifications-notify :title "Compilation finished")))
#+END_SRC

**** Documentation
***** [[https://github.com/blahgeek/emacs-devdocs-browser][API]]
Show API info via [[https://devdocs.io][devdocs.io]]
#+BEGIN_SRC emacs-lisp
(use-package devdocs-browser
  :after consult
  :straight (devdocs-browser
             :type git
             :host github
             :repo "blahgeek/emacs-devdocs-browser")
  :hook (eww-mode . devdocs-browser-eww-mode)
  :config
  (defun cpped-add-apidocs (mode doclist)
    "Install API documentation and enable for mode."
    (mapcar (lambda (doc)
              (devdocs-browser-install-doc doc))
            doclist)
    (push `(,mode . ,doclist) devdocs-browser-major-mode-docs-alist))
  (push "\`\\*devdocs-" consult-buffer-filter))
#+END_SRC

***** Change Log
#+BEGIN_SRC emacs-lisp
(setq change-log-default-name "CHANGELOG")
#+END_SRC

**** Comments
***** Comment style
#+BEGIN_SRC emacs-lisp
(defvar c-doc-comment-style '((c-mode . gtkdoc)
                              (c++-mode . javadoc)))
#+END_SRC

***** Insert comment characters in new line when pressing enter inside a comment
#+BEGIN_SRC emacs-lisp
(add-hook 'c-mode-common-hook (lambda()
                                (local-set-key (kbd "RET") 'c-context-line-break)))
#+END_SRC

***** Insert license comment
#+BEGIN_SRC emacs-lisp
(use-package legalese
  :hook (prog-mode . (lambda ()
                       (when (= (buffer-size (current-buffer)) 0)
                         (legalese nil))))
  :custom
  (legalese-date-format "%Y-%m-%d")
  (legalese-default-license 'gpl)
  (legalese-templates '((emacs-lisp-mode (nil ";;; " legalese-file-name " --- " _ "\n;;\n"
                                              ";; Copyright © " legalese-year "  " legalese-copyright "\n;;\n"
                                              ";; Author: " legalese-author "\n;;\n"
                                              & -2 "\n"
                                              ";; Created: " legalese-date "\n"
                                              @
                                              '(legalese-license)
                                              @ ";;\n;;\n"
                                                ";;; Commentary: \n;;\n"
                                                ";;; Code: \n\n"
                                                "(provide '" legalese-file ")\n\n"
                                                ";;; " legalese-file-name " ends here\n"))))
  :config
  (if (and (boundp 'company-full-name)
           (not (= 0 (length company-full-name))))
      (progn
        (add-to-list 'legalese-templates '(c++-mode (nil
                                                     "/**\n"
                                                     " * " legalese-file-name "\n\n"
                                                     " * @date " legalese-date "\n"
                                                     " * @author " legalese-author "\n"
                                                     " * @copyright Copyright © " company-full-name ". All rights reserved.\n"
                                                     " */")))
        (add-to-list 'legalese-templates '(default (nil @ legalese-file-name "\n\n"
                                                          "Date: " legalese-date "\n"
                                                          "Author: " legalese-author "\n"
                                                          "Copyright © " company-full-name ". All rights reserved.\n"
                                                          @ "\n")) t))
    (add-to-list 'legalese-templates '(default (nil @ legalese-file-name "\n\n"
                                                      "Copyright © " legalese-year " " legalese-copyright "\n\n"
                                                      "Author: "
                                                      legalese-author "\n\n"
                                                      '(legalese-license)
                                                      @ "\n")))))
#+END_SRC

**** Braces
#+BEGIN_SRC emacs-lisp
(defvar c-hanging-braces-alist '((defun-open before after)
                                 (defun-close before after)
                                 (class-open before after)
                                 (class-close before)
                                 (inline-open before after)
                                 (inline-close before after)
                                 (block-open before after)
                                 (block-close . c-snug-do-while)
                                 (statement-cont before after)
                                 (substatement-open before after)
                                 (statement-case-open before after)
                                 (brace-list-open)
                                 (brace-entry-open)
                                 (extern-lang-open after)
                                 (namespace-open before after)
                                 (namespace-close before after)
                                 (module-open after)
                                 (composition-open after)
                                 (inexpr-class-open after)
                                 (inexpr-class-close before)
                                 (arglist-cont-nonempty)))
(defvar c-hanging-colons-alist '((case-label after) (label after)))
(defvar c-hanging-semi&comma-criteria '(c-semi&comma-inside-parenlist))
#+END_SRC

**** LOC counting/Metrics
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "cloc")

(defun cpped-cloc-project ()
  "Count lines of code in project."
  (interactive)
  (let ((project-root (cpped-project-dir)))
    (when project-root
      (shell-command (concat  "cloc --quiet " project-root " &") "*Cloc*")
      (pop-to-buffer "*Cloc*"))))

(defun cpped-cloc-file ()
  "Count lines of code in file."
  (interactive)
  (let ((cloc-input (make-temp-file "cloc-" nil (replace-regexp-in-string "[\\\\']" "" (car (rassq major-mode auto-mode-alist))))))
    (write-region (point-min) (point-max) cloc-input)
    (shell-command (concat  "cloc --quiet --skip-uniqueness " cloc-input) "*Cloc*")
    (pop-to-buffer "*Cloc*")
    (delete-file cloc-input)))

(with-eval-after-load "consult"
  (push "\\`\\*Cloc\\*\\'" consult-buffer-filter)
  (push "*Cloc*" cpped-bury-buffers-list))
#+END_SRC

*** Assembler
#+BEGIN_SRC emacs-lisp
(use-package asm-mode)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package nasm-mode
  :mode "\\.[n]*\\(asm\\|s\\)\\'")
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package x86-lookup
  :after pdf-tools
  :custom
  (x86-lookup-pdf (expand-file-name "~/.docsets/IntelASM.pdf"))
  (x86-lookup-browse-pdf-function 'x86-lookup-browse-pdf-pdf-tools))
#+END_SRC

*** C/C++
#+BEGIN_SRC emacs-lisp
(defconst cpped-c++-source-file-pattern "\\.[Cc]([Cc]|[Pp][Pp]|[Xx][Xx]|++)\\'")
(defconst cpped-c++-header-file-pattern "\\.[Hh]([Hh]|[Pp][Pp]|[Xx][Xx]|++)\\'")

(add-to-list 'auto-mode-alist '("\\.a\\'" . c-mode))
(add-to-list 'auto-mode-alist `(,cpped-c++-source-file-pattern . c++-mode))
(add-to-list 'auto-mode-alist `(,cpped-c++-header-file-pattern . c++-mode))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package ccls
  :after lsp
  :custom
  (ccls-executable (expand-file-name "~/.local/bin/ccls"))
  (ccls-sem-highlight-method 'font-lock)
  :config
  (ccls-use-default-rainbow-sem-highlight))

(add-hook 'c-mode-common-hook 'lsp-deferred)
#+END_SRC

**** Highlighting
#+BEGIN_SRC emacs-lisp
(add-hook 'c++-mode-hook (lambda ()
                           (push '("//" . ?🗩) prettify-symbols-alist)
                           (push '("/*" . ?🗩) prettify-symbols-alist)
                           (push '("*/" . ?​) prettify-symbols-alist)
                           (push '("void" . ?∅) prettify-symbols-alist)
                           (push '("const" . ?) prettify-symbols-alist)
                           (push '("mutable" . ?) prettify-symbols-alist)
                           (push '("default" . ?) prettify-symbols-alist)
                           (push '("delete" . ?) prettify-symbols-alist)
                           (push '("final" . ?) prettify-symbols-alist)
                           (push '("virtual" . ?) prettify-symbols-alist)
                           (push '("override" . ?) prettify-symbols-alist)
                           (push '("[]" . ?λ) prettify-symbols-alist)
                           (push '("#pragma once" . ?❶) prettify-symbols-alist)))
                           (push '("#include" . ?+) prettify-symbols-alist)
#+END_SRC

**** Navigation
***** Show includes/namespaces/preprocessor directives in imenu
#+BEGIN_SRC emacs-lisp
(require 'cc-menus)

(defvar cpped-imenu-c-generic-expression nil)
(defvar cpped-imenu-c++-generic-expression nil)

(defconst cpped-cc-imenu-include '("Include" "^[[:space:]]*#include[[:space:]]+[<\"]\\([^>\"]+\\)" 1) "A C/C++ include pattern for imenu")
(add-to-list 'cpped-imenu-c-generic-expression cpped-cc-imenu-include)
(add-to-list 'cpped-imenu-c++-generic-expression cpped-cc-imenu-include)

(defconst cpped-cc-imenu-pragma '("Preprocessor Pragma" "^[[:space:]]*#pragma \\(.+\\)$" 1) "A C/C++ preprocessor pragma pattern for imenu")
(add-to-list 'cpped-imenu-c-generic-expression cpped-cc-imenu-pragma)
(add-to-list 'cpped-imenu-c++-generic-expression cpped-cc-imenu-pragma)

(defconst cpped-cc-imenu-define '("Preprocessor Define" "^[[:space:]]*#define \\(.+\\)$" 1) "A C/C++ preprocessor define pattern for imenu")
(add-to-list 'cpped-imenu-c-generic-expression cpped-cc-imenu-define)
(add-to-list 'cpped-imenu-c++-generic-expression cpped-cc-imenu-define)

(defconst cpped-cc-imenu-undefine '("Preprocessor Undefine" "^[[:space:]]*#undef \\(.+\\)$" 1) "A C/C++ preprocessor undefine pattern for imenu")
(add-to-list 'cpped-imenu-c-generic-expression cpped-cc-imenu-undefine)
(add-to-list 'cpped-imenu-c++-generic-expression cpped-cc-imenu-undefine)

(defconst cpped-cc-imenu-condition '("Preprocessor Condition" "^[[:space:]]*#\\(ifn?\\(def\\)?.+\\)$" 1) "A C/C++ preprocessor condition pattern for imenu")
(add-to-list 'cpped-imenu-c-generic-expression cpped-cc-imenu-condition)
(add-to-list 'cpped-imenu-c++-generic-expression cpped-cc-imenu-condition)

(defconst cpped-cc-imenu-namespace '("Namespace" "^[[:space:]]*namespace[[:space:]]+\\([^/{]+\\)[[:space:]]*$" 1) "A C++ namespace pattern for imenu")
(add-to-list 'cpped-imenu-c++-generic-expression cpped-cc-imenu-namespace)

(nconc cc-imenu-c-generic-expression cpped-imenu-c-generic-expression)
(nconc cc-imenu-c++-generic-expression cpped-imenu-c++-generic-expression)

(defun cpped-custom-c-imenu-index (function)
  "Add additional entries to C/C++ imenu. "
  (nconc (funcall function)
         (imenu--generic-function (cond ((equal major-mode 'c-mode)
                                         cpped-imenu-c-generic-expression)
                                        ((equal major-mode 'c++-mode)
                                         cpped-imenu-c++-generic-expression)))))

(with-eval-after-load "lsp-mode"
  (advice-add 'lsp--imenu-create-index :around #'cpped-custom-c-imenu-index))
#+END_SRC

**** Editing
***** Mark/navigation functions
#+BEGIN_SRC emacs-lisp
(add-hook 'c-mode-common-hook (lambda ()
                                (setq cpped-mark-function 'c-mark-function)
                                (setq cpped-beginning-of-function 'c-beginning-of-defun)
                                (setq cpped-end-of-function 'c-end-of-defun)))
#+END_SRC

***** Clang include fixer
#+BEGIN_SRC emacs-lisp
(require 'clang-include-fixer)
(add-hook 'after-save-hook #'(lambda()
                               (when (or (equal major-mode 'c-mode)
                                         (equal major-mode 'c++-mode))
                                 (let ((directory (cpped-build-dir)))
                                   (when directory
                                     (call-process "find-all-symbols" nil nil nil (concat "-merge-dir=" directory) (concat "-output-dir=" directory) (concat "-p" directory) (file-truename buffer-file-name))
                                   (clang-include-fixer))))))
#+END_SRC

***** Auto-newline
#+BEGIN_SRC emacs-lisp
(add-hook 'c-mode-common-hook '(lambda ()
                                 (c-toggle-auto-newline 1)))
#+END_SRC

***** [[https://www.gnu.org/software/emacs/manual/html_node/ccmode/Clean_002dups.html][Auto-clean whitespace]]
#+BEGIN_SRC emacs-lisp
(defvar c-cleanup-list '(scope-operator empty-defun-braces defun-close-semi list-close-comma comment-close-slash))
#+END_SRC

***** Indentation
#+BEGIN_SRC emacs-lisp
(c-add-style "cpped-style"
             `("bsd"
               (c-progress-interval . nil)                   ; do not echo progress when indenting)
               (c-basic-offset . ,cpped-default-indentation)
               (comment-empty-lines . t)
               (c-electric-pound-behavior . '(alignleft))    ; do not indent macros
               (c-auto-align-backslashes . t)                ; align line end escape characters
               (c-offsets-alist . ((innamespace . [0])       ; do not indent namespaces
                                   (brace-list-open . 0)
                                   (substatement-open . 0)
                                   (statement-cont . (add c-lineup-cascaded-calls
                                                          c-lineup-string-cont
                                                          c-lineup-streamop))
                                   (arglist-cont-nonempty . (add c-lineup-argcont
                                                                 c-lineup-cascaded-calls
                                                                 c-lineup-string-cont))))))

(setq c-default-style '((c-mode . "cpped-style")
                        (c++-mode . "cpped-style")
                        (java-mode . "java")
                        (awk-mode . "awk")
                        (other . "bsd")))

(add-hook 'c-mode-common-hook '(lambda ()
                                 (c-toggle-syntactic-indentation 1)
                                 (c-toggle-electric-state 1)))
#+END_SRC

***** Wrap Region
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "wrap-region"
  (wrap-region-add-wrappers
   '(("{" "}" nil (c-mode c++-mode)))))
#+END_SRC

***** Flip words
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "bool-flip"
  (progn
    (defun cpped-setup-c++-flip ()
      (make-local-variable 'bool-flip-alist)
      (push '("class" . "struct") bool-flip-alist)
      (push '("struct" . "class") bool-flip-alist)
      (push '("public" . "protected") bool-flip-alist)
      (push '("protected" . "private") bool-flip-alist)
      (push '("private" . "public") bool-flip-alist))
    (add-hook 'c++-mode-hook 'cpped-setup-c++-flip)))
#+END_SRC

***** Abbreviations
#+BEGIN_SRC emacs-lisp
(define-abbrev-table 'c++-mode-abbrev-table '(
                                              ("breif" "brief")
                                              ("au" "auto")
                                              ("co" "const")
                                              ("cosnt" "const")
                                              ("#d" "#define")
                                              ("#e" "#endif")
                                              ("fa" "// fall-through")
                                              ("#i" "#if")
                                              ("pro" "protected:")
                                              ("#o" "#pragma once")
                                              ("#1" "#pragma once")
                                              ("prs" "protected slots:")
                                              ("pu" "public:")
                                              ("pus" "public slots:")
                                              ("pri" "private:")
                                              ("vir" "virtual")
                                              ("ov" "overwrite")
                                              ("fi" "final")
                                              ("nx" "noexcept")
                                              ("nox" "noexcept")
                                              ("noex" "noexcept")
                                              ("QSrting" "QString")
                                              ("qstr" "QString")
                                              ("si" "signals:")
                                              ("vd" "void")
                                              ))
#+END_SRC

***** Automatically change dash to underscore in identifiers
#+BEGIN_SRC emacs-lisp
(use-package smart-dash
  :hook (c-mode-common . smart-dash-mode))
#+END_SRC

***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "flycheck"
  (setq flycheck-clang-pedantic t
        flycheck-clang-warnings '("all" "extra" "ctor-dtor-privacy" "effc++" "old-style-cast" "overloaded-virtual" "format=2" "null-dereference" "missing-include-dirs" "switch-default" "switch-enum" "unused-parameter" "uninitialized" "float-equal" "shadow" "cast-qual" "conversion" "extra-tokens" "ambiguous-member-template" "bind-to-temporary-copy"))
  (add-hook 'c-mode-common-hook (lambda ()
                                  (flycheck-select-checker 'c/c++-clang)))
  (add-hook 'c++-mode-hook (lambda ()
                             (setq flycheck-clang-language-standard "c++17")))

  (setq flycheck-gcc-pedantic t
        flycheck-gcc-pedantic-errors nil
        flycheck-gcc-warnings '("all" "extra" "ctor-dtor-privacy" "effc++" "old-style-cast" "overloaded-virtual" "format=2" "missing-include-dirs" "switch-default" "switch-enum" "unused-parameter" "uninitialized" "float-equal" "shadow" "cast-qual" "conversion" "double-promotion" "zero-as-null-pointer-constant" "useless-cast" "logical-op"))
  (flycheck-add-next-checker 'c/c++-clang '(t . c/c++-gcc))
  (add-hook 'c++-mode-hook (lambda ()
                             (setq flycheck-gcc-language-standard "c++17")))

  (use-package flycheck-clang-analyzer
    :after flycheck
    :config (flycheck-add-next-checker 'c/c++-gcc '(warning . clang-analyzer)))

  (with-eval-after-load "system-packages"
    (cpped-install-system-package "cppcheck")
    (setq flycheck-cppcheck-checks '("warning" "style" "performance" "portability" "information" "missingInclude"))
    (flycheck-add-next-checker 'clang-analyzer '(t . c/c++-cppcheck))
    (add-hook 'c++-mode-hook (lambda ()
                               (setq flycheck-cppcheck-standards "c++11"))))

  (use-package flycheck-clang-tidy
    :after flycheck
    :hook (cpped-after-project-load-update-project-file-hook . (lambda ()
                                                                 (setq-local flycheck-clang-tidy-build-path (cpped-build-dir))))
    :config (flycheck-add-next-checker 'c/c++-cppcheck '(t . c/c++-clang-tidy))))

(with-eval-after-load "consult"
  (push "\\`\\*clang-.*\\*'" consult-buffer-filter))
#+END_SRC


**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
    (cpped-add-apidocs 'c-mode '("c"))
    (cpped-add-apidocs 'c++-mode '("cpp" "c" "qt~5.15")))
#+END_SRC

**** Utilities
***** Namespaces
#+BEGIN_SRC emacs-lisp
(use-package outrespace)
#+END_SRC

***** Qt Support
Resource Files
#+BEGIN_SRC emacs-lisp
(push '("\\.qrc\\'" . nxml-mode) auto-mode-alist)
#+END_SRC

Translation Files
#+BEGIN_SRC emacs-lisp
(push '("\\.ts\\'" . nxml-mode) auto-mode-alist)
#+END_SRC

**** Google Test support
https://github.com/google/googletest

#+BEGIN_SRC emacs-lisp
(define-derived-mode gtest-mode
  c++-mode
  "Google Test file"
  "Google Test mode is a major mode for editing Google Test unit test files.")

(provide 'gtest-mode)

(push '("T[Ee][Ss][Tt]_?.*\\.c(c\\|pp\\|xx)\\'" . gtest-mode) auto-mode-alist)
#+END_SRC

*** CMake
#+BEGIN_SRC emacs-lisp
(use-package cmake-mode
  :custom (cmake-tab-width tab-width)
  :config
  (push '("CMakeLists\\.txt\\'" . cmake-mode) auto-mode-alist)
  (push '(".\\cmake\\'" . cmake-mode) auto-mode-alist)
  (with-eval-after-load "aggressive-fill-paragraph"
    (add-to-list 'afp-fill-comments-only-mode-list 'cmake-mode))
  (with-eval-after-load "all-the-icons"
    (push '(cmake-mode all-the-icons-fileicon "cmake" :v-adjust 0.0) all-the-icons-mode-icon-alist)
    (push '("CMakeLists.txt$" all-the-icons-fileicon "cmake" :v-adjust 0.0) all-the-icons-icon-alist)
    (push '("\\.cmake$" all-the-icons-fileicon "cmake" :v-adjust 0.0) all-the-icons-icon-alist)))
#+END_SRC

**** Imenu integration
#+BEGIN_SRC emacs-lisp
(add-hook 'cmake-mode-hook (lambda ()
                             (setq-local imenu-generic-expression '(("Function" "^ *function *( *\\([^) ]+\\).*$" 1)
                                                                    ("Macro"  "^ *macro *( *\\([^) ]+\\).*$" 1)))))
#+END_SRC

**** [[https://github.com/Lindydancer/cmake-font-lock][Highlighting]]
#+BEGIN_SRC emacs-lisp
(use-package cmake-font-lock
  :hook (cmake-mode . cmake-font-lock-activate)
  :config (font-lock-add-keywords 'cmake-mode
                                  `((,(rx (group "end" (or "function" "macro" "if" "foreach" "while") (0+ " ") "()")) 1 '(face nil display "")))))
#+END_SRC

**** Editing
***** Abbreviations
#+BEGIN_SRC emacs-lisp
(define-abbrev-table 'cmake-mode-abbrev-table '(
                                                ("cmkae" "cmake")
                                                ("CMKAE" "CMAKE")
                                                ("CMkae" "CMake")
                                                ("cmd" "${CMAKE_COMMAND}")
                                                ("sd" "${CMAKE_SOURCE_DIR}")
                                                ("bd" "${CMAKE_BINARY_DIR}")
                                                ("cld" "${CMAKE_CURRENT_LIST_DIR}")
                                                ("csd" "${CMAKE_CURRENT_SOURCE_DIR}")
                                                ("cbd" "${CMAKE_CURRENT_BINARY_DIR}")
                                                ("cf" "CMAKE_C_FLAGS")
                                                ("cfd" "CMAKE_C_FLAGS_DEBUG")
                                                ("cfdi" "CMAKE_C_FLAGS_DEBUG_INIT")
                                                ("cfi" "CMAKE_C_FLAGS_INIT")
                                                ("cfr" "CMAKE_C_FLAGS_RELEASE")
                                                ("cfri" "CMAKE_C_FLAGS_RELEASE_INIT")
                                                ("ccf" "CMAKE_CXX_FLAGS")
                                                ("ccfd" "CMAKE_CXX_FLAGS_DEBUG")
                                                ("ccfdi" "CMAKE_CXX_FLAGS_DEBUG_INIT")
                                                ("ccfi" "CMAKE_CXX_FLAGS_INIT")
                                                ("ccfr" "CMAKE_CXX_FLAGS_RELEASE")
                                                ("ccfri" "CMAKE_CXX_FLAGS_RELEASE_INIT")))
#+END_SRC

***** Wrap Region
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "wrap-region"
  (wrap-region-add-wrappers
   '(("{" "}" nil cmake-mode)
     ("${" "}" "$" (cmake-mode c-mode c++-mode))
     ("\"${" "}\"" "\'" (cmake-mode))
     ("@" "@" nil (cmake-mode c-mode c++-mode))))
  (add-hook 'cmake-mode-hook 'wrap-region-mode))
#+END_SRC

***** Language Server
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "cmake-language-server" :package-manager 'pip)
(add-hook 'cmake-mode-hook 'lsp-deferred)
#+END_SRC

***** Formatting
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "cmake-format" :package-manager 'pip)
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
  (cpped-add-apidocs 'cmake-mode '("bash" "cmake~3.20" "gcc~11" "git")))
#+END_SRC

*** CSS
#+BEGIN_SRC emacs-lisp
(push '("\\.css\\'". css-mode) auto-mode-alist)
#+END_SRC

**** Editing
***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "csslint")
  (cpped-install-system-package "stylelint" :package-manager 'npm)
  (add-hook 'css-mode-hook (lambda ()
                             (flycheck-select-checker 'css-csslint)
                             (flycheck-add-next-checker 'css-csslint '(t . css-stylelint)))))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
    (cpped-add-apidocs 'css-mode '("css")))
#+END_SRC

*** [[http://elpa.gnu.org/packages/csv-mode.html][CSV]]
#+BEGIN_SRC emacs-lisp
(use-package csv-mode
  :mode ("\\.[Cc][Ss][Vv]\\'" . csv-mode))
#+END_SRC

*** [[https://github.com/schspa/dtb-mode][DTB]]
#+BEGIN_SRC emacs-lisp
(use-package dtb-mode
  :ensure-system-package dtc)
#+END_SRC

*** Docker
#+BEGIN_SRC emacs-lisp
(use-package dockerfile-mode)
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
    (cpped-add-apidocs 'dockerfile-mode '("bash" "docker~19" "git")))
#+END_SRC

**** [[https://github.com/Silex/docker.el][Control]]
#+BEGIN_SRC emacs-lisp
(use-package docker)
#+END_SRC

**** [[https://github.com/emacs-pe/docker-tramp.el][TRAMP support]]
#+BEGIN_SRC emacs-lisp
(use-package docker-tramp
  :after tramp)
#+END_SRC

**** Editing
***** Language server
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "lsp-mode"
  (add-hook 'dockerfile-mode-hook 'lsp-deferred))
#+END_SRC

***** [[https://github.com/redcoolbeans/dockerlint][Syntax checker]]

TODO use [[https://github.com/hadolint/hadolint/][hadolint]
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "dockerlint" :package-manager 'npm)
  (with-eval-after-load "flycheck"
    (flycheck-define-checker cpped-dockerlint
      "Dockerfile checker (https://github.com/redcoolbeans/dockerlint)"
      :command ("dockerlint" source-original)
      :error-patterns ((error line-start "ERROR: " (message) " on line " line line-end)
                       (warning line-start "WARN: " (message) " on line " line line-end)
                       (info line-start "INFO: " (message) " on line " line line-end))
      :modes (dockerfile-mode))
    (add-to-list 'flycheck-checkers 'cpped-dockerlint)
    (add-hook 'dockerfile-mode-hook (lambda ()
                                      (flycheck-select-checker 'cpped-dockerlint)))))
#+END_SRC

*** Dot
#+BEGIN_SRC emacs-lisp
(use-package graphviz-dot-mode
  :after (org system-packages)
  :custom
  (graphviz-dot-auto-indent-on-braces t)
  (graphviz-dot-indent-width cpped-default-indentation)
  (graphviz-dot-auto-preview-on-save t)
  :config
  (cpped-install-system-package "graphviz")
  (add-to-list 'org-src-lang-modes '("dot" . graphviz-dot)))
#+END_SRC

*** GCode
#+BEGIN_SRC emacs-lisp
(defvar gcode-mode-font-lock-keywords
  '(("\\(([^)]+)\\)"
     (1 font-lock-string-face))
    ("^\\([NnMm][0-9]+\\)"
     (1 font-lock-constant-face))
    ("\\(\\*[0-9]+\\) *$"
     (1 font-lock-constant-face))
    ("\\([Gg][0-9]+\\)"
     (1 font-lock-function-name-face))
    ("\\([AaBbCcEeFfHhIiJjKkLlPpQqRrSsTtUuVvWwXxYyZz][+-]*[0-9\\.]*\\)"
     (1 font-lock-variable-name-face))
    ("\\([+-]*[0-9\\.]*\\)"
     (1 font-lock-variable-name-face)))
  "Highlight rules for `gcode-mode'.")

(defun gcode-mode-indent-line ()
  "Indent current line."
  (interactive)
  (beginning-of-line))

(define-derived-mode gcode-mode prog-mode "GCode-Mode"
  "A major mode for editing gcode files."
  (setq-local comment-start "(")
  (setq-local comment-start-skip "([^)]+)")
  (setq-local font-lock-defaults '(gcode-mode-font-lock-keywords)))

(push '("\\.cnc\\'" . gcode-mode) auto-mode-alist)
(push '("\\.din\\'" . gcode-mode) auto-mode-alist)
(push '("\\.dnc\\'" . gcode-mode) auto-mode-alist)
(push '("\\.eia\\'" . gcode-mode) auto-mode-alist)
(push '("\\.fan\\'" . gcode-mode) auto-mode-alist)
(push '("\\.f[gn]c\\'" . gcode-mode) auto-mode-alist)
(push '("\\.gc[do]?\\'" . gcode-mode) auto-mode-alist)
(push '("\\.gcode\\'" . gcode-mode) auto-mode-alist)
(push '("\\.hnc\\'" . gcode-mode) auto-mode-alist)
(push '("\\.maz\\'" . gcode-mode) auto-mode-alist)
(push '("\\.mpf\\'" . gcode-mode) auto-mode-alist)
(push '("\\.nc[fgp]?\\'" . gcode-mode) auto-mode-alist)
(push '("\\.ngc\\'" . gcode-mode) auto-mode-alist)
(push '("\\.pim\\'" . gcode-mode) auto-mode-alist)
(push '("\\.plt\\'" . gcode-mode) auto-mode-alist)
(push '("\\.ptp\\'" . gcode-mode) auto-mode-alist)
(push '("\\.tap\\'" . gcode-mode) auto-mode-alist)

(provide 'gcode-mode)
#+END_SRC

*** GLSL
#+BEGIN_SRC emacs-lisp
(use-package glsl-mode
  :mode (("\\.vert\\'" . glsl-mode)
         ("\\.frag\\'" . glsl-mode)
         ("\\.geom\\'" . glsl-mode)
         ("\\.glsl\\'" . glsl-mode)))
#+END_SRC

*** Groovy
#+BEGIN_SRC emacs-lisp
(use-package groovy-mode
  :mode "Jenkinsfile")
#+END_SRC

**** Jenkinsfile
***** Imenu support
#+BEGIN_SRC emacs-lisp
(add-hook 'groovy-mode-hook (lambda()
                              (setq imenu-create-index-function #'imenu-default-create-index-function)
                              (setq-local imenu-generic-expression `(("Stages" ,(rx (0+ space)
                                                                                    "stage"
                                                                                    (0+ space)
                                                                                    (? "(")
                                                                                    (in "'\"")
                                                                                    (group (+ (not (in "'\""))))
                                                                                    (in "'\"")
                                                                                    (? ")")
                                                                                    (0+ space)
                                                                                    (? "{")
                                                                                    (0+ space))
                                                                      1)))))
#+END_SRC

***** Syntax check
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "flycheck"
  (defvar cpped-jenkins-url nil "The URL of the Jenkins installation.")
  (cpped-install-system-package "curl")
  (flycheck-define-checker jenkins
    "A Jenkins pipeline syntax checker."
    :command ("/usr/bin/curl"
              "-s" "-X" "POST" "-H" (eval (shell-command-to-string "/usr/bin/curl '-s' 'localhost:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)'"))
              "-F" (eval (concat "jenkinsfile=<" (car (flycheck-substitute-argument 'source 'jenkins))))
              (eval (concat cpped-jenkins-url "/pipeline-model-converter/validate")))
    :error-patterns ((warning line-start (file-name) ":" (message) "@ line " line ", column " column))
    :modes (groovy-mode))
  (add-to-list 'flycheck-checkers 'jenkins))
#+END_SRC

*** HTML
#+BEGIN_SRC emacs-lisp
(push '("\\.x?html?\\'" . html-mode) auto-mode-alist)
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
  (cpped-add-apidocs 'html-mode '("css" "dom" "html" "http")))
#+END_SRC

**** Editing
***** Language server
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "vscode-html-languageserver-bin" :package-manager 'npm)
  (add-hook 'html-mode 'lsp-deferred))
#+END_SRC

***** [[https://github.com/thedaviddias/HTMLHint][Syntax checker]]
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "htmlhint" :package-manager 'npm)
  (with-eval-after-load "flycheck"
    (flycheck-define-checker cpped-htmlhint
      "HTML file checker (https://github.com/thedaviddias/HTMLHint)"
      :command ("htmlhint" "--nocolor" "--format" "compact" source-original)
      :error-patterns ((error line-start (file-name) ": line " line ", col " column ", error - " (message) line-end)
(warning line-start (file-name) ": line " line ", col " column ", warning - " (message) line-end)
(info line-start (file-name) ": line " line ", col " column ", info - " (message) line-end))
      :modes (html-mode))
    (add-to-list 'flycheck-checkers 'cpped-htmlhint)))
#+END_SRC

*** Ini
#+BEGIN_SRC emacs-lisp
(defvar ini-mode-syntax-table
  (let ((table (make-syntax-table)))
    (modify-syntax-entry ?\; "< b" table)
    (modify-syntax-entry ?# "< b" table)
    (modify-syntax-entry ?\n "> b" table)
    table)
  "Syntax table for `ini-mode'.")

(defvar ini-mode-font-lock-keywords
  '(("^\\[\\(.*\\)\\]"
     (1 font-lock-function-name-face))
    ("^\\([^ \t\n=]+\\) *="
     (1 font-lock-variable-name-face)))
  "Highlight rules for `ini-mode'.")

(defun ini-mode-indent-line ()
  "Indent current line."
  (interactive)
  (beginning-of-line))

(define-derived-mode ini-mode prog-mode "Ini-Mode"
  "A major mode for editing ini files."
  (setq-local comment-start "; ")
  (setq-local comment-start-skip "[#;] *")
  (setq-local font-lock-defaults '(ini-mode-font-lock-keywords))
  (setq-local imenu-generic-expression '(("Section" "^\\[\\([a-zA-Z0-9 ]+\\)\\] *" 1)
                                         ("Entry" "^\\([a-zA-Z0-9_-]+\\)= ?*" 1)))
  (setq-local outline-regexp "\\["))

(push '("\\.conf\\'" . ini-mode) auto-mode-alist)
(push '("\\.ini\\'" . ini-mode) auto-mode-alist)
(push '("\\.service\\'" . ini-mode) auto-mode-alist)

(provide 'ini-mode)

;    Detection of duplicate properties and sections
;(defun flycheck-ini--start (checker callback)
;  "Flycheck start function for CHECKER, invoking CALLBACK."
;  (funcall callback
;           'finished
;           (flycheck-increment-error-columns
;            (mapcar (lambda (x)
;                      (apply #'flycheck-error-new-at `(,@x :checker ,checker)))
;                    (condition-case err
;                        (when (package-lint-looks-like-a-package-p)
;                          (package-lint-buffer (current-buffer)))
;                      (error
;                       (funcall callback 'errored (error-message-string err))
;                       (signal (car err) (cdr err))))))))
;;; Checker definition

;(flycheck-define-generic-checker 'ini-file
;  "A checker for ini files."
;  :start #'flycheck-ini--start
;  :modes '(ini))

;(add-to-list 'flycheck-checkers 'ini t)
;; (flycheck-add-next-checker 'ini 'ini-file t)
#+END_SRC

*** Javascript
**** Language Server
#+BEGIN_SRC emacs-lisp
(add-hook 'js-mode 'lsp-deferred)
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
  (cpped-add-apidocs 'js-mode '("javascript")))
#+END_SRC

**** Editing
***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "standard" :package-manager 'npm)
  (cpped-install-system-package "jscs" :package-manager 'npm)
  (cpped-install-system-package "eslint" :package-manager 'npm)
  (cpped-install-system-package "jshint" :package-manager 'npm)
  (cpped-install-system-package "jslint" :package-manager 'npm)
  (add-hook 'js-mode-hook (lambda ()
                          (flycheck-select-checker 'javascript-standard)
                          (flycheck-add-next-checker 'javascript-standard '(t . javascript-jscs))
                          (flycheck-add-next-checker 'javascript-jscs '(t . javascript-eslint))
                          (flycheck-add-next-checker 'javascript-eslint '(t . javascript-jshint)))))
#+END_SRC

*** JSON
#+BEGIN_SRC emacs-lisp
(use-package json-mode
  :mode "\\.js\\(on\\|[hl]int\\(rc\\)?\\)\\'"
  :config (push '("{" . json-mode) magic-mode-alist))
#+END_SRC

**** Language Server
#+BEGIN_SRC emacs-lisp
(add-hook 'json-mode-hook 'lsp-deferred)
#+END_SRC

**** Path handling
#+BEGIN_SRC emacs-lisp
(use-package json-snatcher
  :straight (json-snatcher
             :type git
             :host github
             :repo "Sterlingg/json-snatcher")
  :config
  (defun  cpped-json-path ()
    "Return the JSON element hierarchy as a path."
    (interactive)
    (when (and (derived-mode-p 'json-mode)
               (fboundp 'jsons-get-path))
      (mapconcat  (lambda (element)
                    (if (numberp element)
                        (format "[%d]" element)
                      (replace-regexp-in-string "\"" "" element)))
                  (reverse (jsons-get-path))
                  "/")))
  (with-eval-after-load "which-func"
    (add-to-list 'which-func-functions 'cpped-json-path)))
#+END_SRC

**** Editing

*** Latex
#+BEGIN_SRC emacs-lisp
(push '("\\.tex\\'" . latex-mode) auto-mode-alist)
(push '("\\.txi\\'" . texinfo-mode) auto-mode-alist)
(push '("\\.bib\\'" . bibtex-mode) auto-mode-alist)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(add-hook 'latex-mode-hook 'lsp-deferred)
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
  (cpped-add-apidocs 'latex-mode '("latex"))
  (cpped-add-apidocs 'texinfo-mode '("latex"))
  (cpped-add-apidocs 'bibtex-mode '("latex")))
#+END_SRC

*** Lisp
#+BEGIN_SRC emacs-lisp
(push '("\\.emacs\\'" . emacs-lisp-mode) auto-mode-alist)
(push '("\\.el\\'" . emacs-lisp-mode) auto-mode-alist)
(push '("\\.lisp\\'" . lisp-mode) auto-mode-alist)
(push '("\\.lsp\\'" . lisp-mode) auto-mode-alist)
#+END_SRC

**** [[https://github.com/alphapapa/highlight-function-calls][Highlight function calls]]
#+BEGIN_SRC emacs-lisp
(use-package highlight-function-calls
  :hook (emacs-lisp-mode . highlight-function-calls-mode)
  :custom (highlight-function-calls-not t))
#+END_SRC

**** [[https://github.com/Fanael/highlight-defined][Highlight undefined symbols]]
#+BEGIN_SRC emacs-lisp
(defun cpped-highlight-defined--determine-face (symbol)
  "Return the face SYMBOL should be fontified with. If SYMBOL is not one of the recognized types, return nil."
  (if (not (or (fboundp symbol) (special-variable-p symbol) (facep symbol)))
      'warning
    nil))

(use-package highlight-defined
  :hook (emacs-lisp-mode . highlight-defined-mode)
  :config
  (advice-add 'highlight-defined--determine-face :override #'cpped-highlight-defined--determine-face))
#+END_SRC

**** [[https://github.com/cpitclaudel/easy-escape][Simplify Regular Expressions]]
#+BEGIN_SRC emacs-lisp
(use-package easy-escape
  :hook ((lisp-mode . easy-escape-minor-mode)
         (emacs-lisp-mode . easy-escape-minor-mode)))
#+END_SRC

**** Flip words
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "bool-flip"
  (progn
    (defun cpped-setup-elisp-flip ()
      (make-local-variable 'bool-flip-alist)
      (push '("t" . "nil") bool-flip-alist)
      (push '("nil" . "t") bool-flip-alist)
      (push '("let" . "let*") bool-flip-alist)
      (push '("let*" . "let") bool-flip-alist)
      (push '("when" . "unless") bool-flip-alist)
      (push '("unless" . "when") bool-flip-alist)
      (push '("advice-add" . "advice-remove") bool-flip-alist)
      (push '("advice-remove" . "advice-add") bool-flip-alist)
      (push '("add-hook" . "remove-hook") bool-flip-alist)
      (push '("remove-hook" . "add-hook") bool-flip-alist))
    (add-hook 'lisp-mode-hook 'cpped-setup-elisp-flip)
    (add-hook 'emacs-lisp-mode-hook 'cpped-setup-elisp-flip)))
#+END_SRC

**** [[https://github.com/Malabarba/comment-or-uncomment-sexp][Un-/Comment SEXPs]]
#+BEGIN_SRC emacs-lisp
(use-package comment-or-uncomment-sexp
  :straight (comment-or-uncomment-sexp
             :type git
             :host github
             :repo "Malabarba/comment-or-uncomment-sexp"))
#+END_SRC

#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
    (cpped-add-apidocs 'emacs-lisp-mode '("elisp")))
#+END_SRC

*** Make
#+BEGIN_SRC emacs-lisp
(push '("Makefile\\'" . makefile-mode) auto-mode-alist)
(push '("\\.mak\\'" . makefile-mode) auto-mode-alist)
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
  (cpped-add-apidocs 'makefile-mode '("gcc~11")))
#+END_SRC

*** Perl
#+BEGIN_SRC emacs-lisp
(push '("#!/usr/bin/perl" . perl-mode) magic-mode-alist)
#+END_SRC

*** Prolog
#+BEGIN_SRC emacs-lisp
(push '("\\.pl\\'" . prolog-mode) auto-mode-alist)
#+END_SRC

*** Python
#+BEGIN_SRC emacs-lisp
(push '("\\.py\\'" . python-mode) auto-mode-alist)
#+END_SRC


   python-shell-switch-to-shell
   python-shell-send-buffer
   python-shell-send-region
   python-shell-send-defun


(defun projectile-pyenv-mode-set ()
  "Set pyenv version matching project name."
  (let ((project (projectile-project-name)))
    (if (member project (pyenv-mode-versions))
        (pyenv-mode-set project)
      (pyenv-mode-unset))))

(add-hook 'projectile-after-switch-project-hook 'projectile-pyenv-mode-set)


  (setq pyvenv-post-deactivate-hooks
        (list (lambda ()
                (setq python-shell-interpreter "python3")))))

(with-eval-after-load "devdocs-browser"
  (cpped-add-apidocs 'python-mode . '(python~3.9))


https://github.com/wbolster/emacs-python-pytest
https://github.com/pwalsh/pipenv.el
https://github.com/marcwebbie/auto-virtualenv





(defun +python/optimize-imports ()
  "organize imports"
  (interactive)
  (pyimport-remove-unused)
  (py-isort-buffer))


(defun +python/open-repl ()
  "Open the Python REPL."
  (interactive)
  (require 'python)
  (unless python-shell-interpreter
    (user-error "`python-shell-interpreter' isn't set"))
  (pop-to-buffer
   (process-buffer
    (if-let* ((pipenv (+python-executable-find "pipenv"))
              (pipenv-project (pipenv-project-p)))
        (let ((default-directory pipenv-project)
              (python-shell-interpreter-args
               (format "run %s %s"
                       python-shell-interpreter
                       python-shell-interpreter-args))
              (python-shell-interpreter pipenv))
          (run-python nil nil t))
      (run-python nil nil t)))))


(use-package! pyimport
  :defer t
  :init
  (map! :after python
        :map python-mode-map
        :localleader
        (:prefix ("i" . "imports")
          :desc "Insert missing imports" "i" #'pyimport-insert-missing
          :desc "Remove unused imports"  "r" #'pyimport-remove-unused
          :desc "Optimize imports"       "o" #'+python/optimize-imports)))


          ;; Package `pip-requirements' provides a major mode for
;; requirements.txt files used by Pip.
(use-package pip-requirements


*** QML
#+BEGIN_SRC emacs-lisp
(use-package qml-mode
  :after rainbow-mode
  :mode "\\.qml\\'"
  :config (add-to-list 'rainbow-html-colors-major-mode-list 'qml-mode))
#+END_SRC

**** Imenu integration
#+BEGIN_SRC emacs-lisp
(defun cpped-qml-imenu-create-index()
  (append (imenu-default-create-index-function)
          (js--imenu-create-index)))

(add-hook 'js-mode-hook (lambda()
                          (when (derived-mode-p 'qml-mode)
                            (setq imenu-create-index-function #'cpped-qml-imenu-create-index)
                            (setq-local imenu-generic-expression '(("Items" "^[[:space:]]*\\([a-zA-Z0-9]+\\)[[:space:]\n]*{" 1))))))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
    (cpped-add-apidocs 'qml-mode '("qt~5.15")))
#+END_SRC

*** Shell
#+BEGIN_SRC emacs-lisp
(push '("\\.sh\\'" . sh-mode) auto-mode-alist)
#+END_SRC

**** Prettification
#+BEGIN_SRC emacs-lisp
(setq cpped-font-lock-shebang `((,(rx bol (group "#!/" (? "usr/") (? "s") "bin/")) 1 '(face nil display " "))))

(font-lock-add-keywords 'sh-mode cpped-font-lock-shebang)
(font-lock-add-keywords 'shell-mode cpped-font-lock-shebang)
#+END_SRC

**** Editing
***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(use-package flycheck-checkbashisms
  :after flycheck
  :ensure-system-package ((checkbashisms . devscripts-checkbashisms) (shellcheck . ShellCheck))
  :hook (sh-mode . (lambda ()
                     (flycheck-select-checker 'sh-bash)
                     (flycheck-add-next-checker 'sh-bash '(t . sh-zsh))
                     (flycheck-add-next-checker 'sh-zsh '(t . sh-checkbashisms))
                     (flycheck-add-next-checker 'sh-checkbashisms '(t . sh-shellcheck))))
  :config
  (add-to-list 'flycheck-checkers 'sh-checkbashisms t))
#+END_SRC

***** Formatting
#+BEGIN_SRC emacs-lisp
(system-packages-ensure "shfmt")
#+END_SRC

***** Automatically set shell scripts to executable
#+BEGIN_SRC emacs-lisp
(add-hook 'after-save-hook 'executable-make-buffer-file-executable-if-script-p)
#+END_SRC

**** BASH
Set correct major mode
#+BEGIN_SRC emacs-lisp
(push '("#!/bin/bash" . bash-mode) magic-mode-alist)
(push '("#!/bin/busybox" . bash-mode) magic-mode-alist)
(push '("\\.bash\\'" . bash-mode) auto-mode-alist)
#+END_SRC

***** Prettification
#+BEGIN_SRC emacs-lisp
(font-lock-add-keywords 'bash-mode cpped-font-lock-shebang)
#+END_SRC

***** Language server
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "bash-language-server" :package-manager 'npm)
(add-hook 'bash-mode-hook 'lsp-deferred)
#+END_SRC

**** ZSH
Set correct major mode
#+BEGIN_SRC emacs-lisp
(push '("#!/usr/bin/zsh" . sh-mode) magic-mode-alist)
(push '("\\.zsh\\'" . sh-mode) auto-mode-alist)
(push '("zlogin\\'" . sh-mode) auto-mode-alist)
(push '("zlogout\\'" . sh-mode) auto-mode-alist)
(push '("zprofile\\'" . sh-mode) auto-mode-alist)
(push '("zshenv\\'" . sh-mode) auto-mode-alist)
(push '("zshrc\\'" . sh-mode) auto-mode-alist)

(add-to-list 'interpreter-mode-alist
             '("zsh" . sh-mode))
#+END_SRC

***** Prettification
#+BEGIN_SRC emacs-lisp
(font-lock-add-keywords 'zsh-mode cpped-font-lock-shebang)
#+END_SRC

**** DOS-Batch
#+BEGIN_SRC emacs-lisp
(push '("\\.bat\\'" . bat-mode) auto-mode-alist)
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
  (cpped-add-apidocs 'sh-mode '("bash" "elisp" "gcc~11" "git"))
  (cpped-add-apidocs 'bash-mode '("bash" "elisp" "gcc~11" "git")))
#+END_SRC


*** SSH Config
#+BEGIN_SRC emacs-lisp
(use-package ssh-config-mode)
#+END_SRC

*** Systemd
#+BEGIN_SRC emacs-lisp
(use-package systemd)
#+END_SRC

[[https://github.com/SebastianMeisel/journalctl-mode][Journalctl-Mode]]
#+BEGIN_SRC emacs-lisp
(use-package journalctl-mode)
#+END_SRC

*** [[https://github.com/skuro/plantuml-mode][UML]]
#+BEGIN_SRC emacs-lisp
(use-package plantuml-mode
  :after (org popwin)
  :ensure-system-package (plantuml graphviz)
  :mode "\\.p\\(lant\\)?uml\\'"
  :custom
  (plantuml-jar-path "/usr/share/java/plantuml.jar")
  (org-plantuml-jar-path "/usr/share/java/plantuml.jar")
  :config
  (push '("*PLANTUML Preview*" :dedicated t :width 60 :position right :noselect :stick) popwin:special-display-config)
  (add-to-list 'org-src-lang-modes '("plantuml" . plantuml)))

(defun cpped-preview-plantuml-file ()
  "Preview a plantuml file."
  (when (equal major-mode 'plantuml-mode)
    (plantuml-preview-string 4 (buffer-string))))

(add-hook 'find-file-hook 'cpped-preview-plantuml-file)
(add-hook 'after-save-hook 'cpped-preview-plantuml-file)
#+END_SRC

**** [[https://github.com/alexmurray/flycheck-plantuml][Syntax checker]]
#+BEGIN_SRC emacs-lisp
(use-package flycheck-plantuml
  :after plantuml-mode
  :config (flycheck-plantuml-setup))
#+END_SRC

*** XML
#+BEGIN_SRC emacs-lisp
(push '("<\\?xml" . nxml-mode) magic-mode-alist)
#+END_SRC

Show current XML path as current function
#+BEGIN_SRC emacs-lisp
(defun cpped-xml-path ()
  "Return the XML element hierarchy as a path."
  (interactive)
  (when (derived-mode-p 'nxml-mode)
    (let ((path nil))
      (save-excursion
        (save-restriction
          (widen)
          (while (and (< (point-min) (point))
                      (condition-case nil
                          (progn
                            (nxml-backward-up-element)
                            t)
                        (error nil)))
            (setq path (cons (xmltok-start-tag-local-name) path)))
          (format "/%s" (mapconcat 'identity path "/")))))))

(with-eval-after-load "which-func"
  (add-to-list 'which-func-functions 'cpped-xml-path))
#+END_SRC

**** Navigation
***** Jump to element
#+BEGIN_SRC emacs-lisp
(use-package x-path-walker)
#+END_SRC

**** Editing
***** Always add XML declaration
#+BEGIN_SRC emacs-lisp
(defvar nxml-auto-insert-xml-declaration-flag t)
#+END_SRC

***** Language Server
#+BEGIN_SRC emacs-lisp
(add-hook 'nxml-mode-hook 'lsp-deferred)
#+END_SRC

***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "xmllint")
  (cpped-install-system-package "xmlstarlet")
  (with-eval-after-load "flycheck"
    (flycheck-add-next-checker 'xml-xmllint '(t . xml-xmlstarlet))
    (add-hook 'nxml-mode-hook (lambda ()
                                (flycheck-select-checker 'xml-xmllint)))))
#+END_SRC

***** Formatting
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "format-all"
  (cpped-install-system-package "xmllint")
  (define-format-all-formatter xmllint-fmt
    (:executable "xmllint")
    (:install)
    (:languages "XML")
    (:features)
    (:format (format-all--buffer-easy executable
                                      "--format"
                                      "--nowarning"
                                      "-"))))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
    (cpped-add-apidocs 'nxml-mode '("dom" "html" "svg" "xslt_xpath")))
#+END_SRC

*** [[https://github.com/yoshiki/yaml-mode][YAML]]
#+BEGIN_SRC emacs-lisp
(use-package yaml-mode
  :hook (yaml-mode . lsp-deferred)
  :mode "\.yml\'")
#+END_SRC

**** [[https://github.com/krzysztof-magosa/flycheck-yamllint][Syntax checker]]
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "js-yaml" :package-manager 'npm))

(use-package flycheck-yamllint
  :after flycheck
  :ensure-system-package yamllint
  :config (flycheck-yamllint-setup)
          (flycheck-add-next-checker 'yaml-jsyaml '(t . yaml-yamllint)))
#+END_SRC

** Debugging
#+BEGIN_SRC emacs-lisp
(defvar gdb-many-windows t)
(defvar gdb-show-main nil)
(setq gud-tooltip-mode t)

(use-package realgud
  :custom (realgud-bp-fringe-indicator-style '(realgud-bp-filled . realgud-bp-hollow)))
#+END_SRC

*** Show symbols of ELF files
#+BEGIN_SRC emacs-lisp
(use-package elf-mode
  :config
  (elf-setup-default)
  (push "\\.so\\'" cpped-no-hexedit-extensions))
#+END_SRC

**** [[https://github.com/liblit/demangle-mode][Demangle symbols in ELF files]]
#+BEGIN_SRC emacs-lisp
(use-package demangle-mode
  :config
  (advice-add 'elf-mode :after 'demangle-mode))
#+END_SRC

** Diff/Merge
*** Diff support
Use smerge-mode
#+BEGIN_SRC emacs-lisp
(add-hook 'diff-mode-hook 'smerge-mode)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(push '("\\.diff\\'" . diff-mode) auto-mode-alist)
(push '("\\.patch\\'" . diff-mode) auto-mode-alist)

(setq diff-default-read-only t)
#+END_SRC

Auto-highlight details
#+BEGIN_SRC emacs-lisp
(setq diff-refine 'font-lock)
#+END_SRC

*** Quit smerge-mode after last resolved conflict
#+BEGIN_SRC emacs-lisp
(setq smerge-auto-leave t)
#+END_SRC

*** Re-use current frame for all diff contents (including command frame)
#+BEGIN_SRC emacs-lisp
(setq ediff-window-setup-function 'ediff-setup-windows-plain)
#+END_SRC

*** Quit diff view without confirmation if buffer is unchanged
#+BEGIN_SRC emacs-lisp
(defun cpped-ediff-smart-quit ()
  "Ask for confirmation only before quitting changed ediff buffers"
  (interactive)
  (ediff-barf-if-not-control-buffer)
  (let* ((buffer-a ediff-buffer-A)
         (buffer-b ediff-buffer-B)
         (buffer-c ediff-buffer-C)
         (buffer-control (current-buffer))
         (modified-buffers (cl-remove-if-not 'buffer-modified-p
                                             (list buffer-a buffer-b buffer-c))))
    (let ((save (if modified-buffers
                    (yes-or-no-p "Save changes?")
                  nil)))
      (loop for buffer in modified-buffers do
            (progn
              (set-buffer buffer)
              (if save
                  (save-buffer)
                (set-buffer-modified-p nil))))
      (set-buffer buffer-control)
      (ediff-really-quit nil))))

(add-hook 'ediff-startup-hook (lambda ()
                                (local-set-key (kbd "q") 'cpped-ediff-smart-quit)))
#+END_SRC

*** Split windows horizontally
#+BEGIN_SRC emacs-lisp
(defvar ediff-merge-split-window-function 'split-window-horizontally)
(defvar ediff-split-window-function 'split-window-horizontally)
#+END_SRC

*** [[https://github.com/mgalgs/diffview-mode][Show unified diff as normal diff]]
#+BEGIN_SRC emacs-lisp
(use-package diffview)
#+END_SRC

*** [[https://github.com/fourier/ztree][Tree diff]]
#+BEGIN_SRC emacs-lisp
(use-package ztree
  :custom
  (ztree-draw-unicode-lines t)
  (ztree-show-number-of-children t))
#+END_SRC

** Version Control
*** Common
**** Limit version control systems to most used ones
#+BEGIN_SRC emacs-lisp
(setq vc-handled-backends '(git svn))
#+END_SRC

**** Always open actual file under source control when visited through a symbolic link
#+BEGIN_SRC emacs-lisp
(setq vc-follow-symlinks t)
#+END_SRC

**** [[https://github.com/emacsorphanage/git-gutter-fringe][Show uncommitted lines in the fringe]]
#+BEGIN_SRC emacs-lisp
(use-package git-gutter
  :custom
  (git-gutter:hide-gutter t)
  (git-gutter:update-interval 0.2)
  (git-gutter:visual-line t)
  :config (global-git-gutter-mode))

(use-package git-gutter-fringe
  :after git-gutter
  :config
  (fringe-helper-define 'git-gutter-fr:added nil
    "...XX..."
    "...XX..."
    "...XX..."
    "XXXXXXXX"
    "XXXXXXXX"
    "...XX..."
    "...XX..."
    "...XX...")
  (fringe-helper-define 'git-gutter-fr:deleted nil
    "........"
    "........"
    "........"
    "XXXXXXXX"
    "XXXXXXXX"
    "........"
    "........"
    "........")
  (fringe-helper-define 'git-gutter-fr:modified nil
    ".XX....X"
    "XXXXX.X."
    "XXXX.X.."
    ".XX.X..."
    "...X...."
    "..X.XXXX"
    ".X..XXXX"
    "X......."))
#+END_SRC


*** Git
**** [[https://github.com/magit/magit][Magit]]
#+BEGIN_SRC emacs-lisp
(use-package magit
  :after (consult projectile super-save)
  :custom
  (magit-clone-set-remote.pushDefault t)
  (git-commit-style-convention-checks nil)
  (git-commit-summary-max-length 80)
  (magit-auto-revert-mode t)
  (magit-diff-expansion-threshold 3)
  (magit-diff-highlight-hunk-region-functions '(magit-diff-highlight-hunk-region-dim-outside magit-diff-highlight-hunk-region-using-underline))
  (magit-diff-highlight-indentation '((".*" . tabs)))
  (magit-diff-refine-hunk 'all)
  (magit-display-buffer-function 'magit-display-buffer-fullframe-status-v1)
  (magit-log-auto-more t)
  (magit-popup-manpage-package 'woman)
  (magit-popup-show-common-commands nil)
  (magit-process-popup-time 3)
  (magit-repolist-columns '(("Name"    25 magit-repolist-column-ident ())
                            (""       40 magit-repolist-column-version ())
                            (""        1 magit-repolist-column-dirty ())
                            ("⇣"        3 magit-repolist-column-unpulled-from-upstream ((:right-align t)
                                                                                        (:help-echo "Upstream changes not in branch")))
                            ("⇡"        3 magit-repolist-column-unpushed-to-upstream ((:right-align t)
                                                                                      (:help-echo "Local changes not in upstream")))
                            (""       99 magit-repolist-column-path ())))
  (magit-save-repository-buffers 'dontask)
  (magit-section-initial-visibility-alist '((stashes . hide) (untracked . hide) (unpushed . hide)))
  (magit-status-show-hashes-in-headers nil)
  (magit-log-arguments '("--graph"
                         "--color"
                         "--decorate"
                         "-n200"))
  (magit-diff-arguments '("--function-context" "--stat" "-M" "-C"))
  :config

(use-package magit-popup)
#+END_SRC

You can easily create git scripts with magit commands. For instance, for auto rebasing a branch "MY-BRANCH" and push
forcing it by running
#+BEGIN_SRC emacs-lisp :tangle no
(magit-checkout "MY-BRANCH")
(magit-rebase-onto-upstream nil)
(magit-push-current-to-pushremote "-f")
#+END_SRC

***** Full screen magit-status
#+BEGIN_SRC emacs-lisp
(defadvice magit-status (around magit-fullscreen activate)
  (window-configuration-to-register :magit-fullscreen)
  ad-do-it
  (delete-other-windows))
#+END_SRC

***** Restore previous window configuration on quit
#+BEGIN_SRC emacs-lisp
(defun magit-quit-session ()
  "Restores the previous window configuration and kills the magit buffer"
  (interactive)
  (kill-buffer)
  (jump-to-register :magit-fullscreen))
#+END_SRC

***** Show ToDos in status window
#+BEGIN_SRC emacs-lisp
(use-package magit-todos
  :ensure-system-package ripgrep
  :custom
  (magit-todos-auto-group-items 'always)
  (magit-todos-group-by '(magit-todos-item-keyword magit-todos-item-filename))
  (magit-todos-ignore-case t)
  (magit-todos-ignored-keywords '("NOTE" "INFO" "DONE"))
  (magit-todos-insert-at 'untracked)
  (magit-todos-keyword-suffix "")
  (magit-todos-nice nil)
  (magit-todos-update 10)
  :config (magit-todos-mode))
#+END_SRC

***** Highlight Bug References
#+BEGIN_SRC emacs-lisp
(add-hook 'magit-mode-hook 'bug-reference-mode)
#+END_SRC

***** [[https://github.com/magit/forge][Git forge integration]]
#+BEGIN_SRC emacs-lisp
(use-package forge
  :after magit)
#+END_SRC

[[https://github.com/charignon/github-review][GitHub review]]
#+BEGIN_SRC emacs-lisp
(use-package github-review
  :after magit forge
  :config
  (transient-append-suffix 'forge-dispatch "c u"
    '("c r" "Review pull request" github-review-forge-pr-at-point)))
#+END_SRC

***** [[https://github.com/terranpro/magit-gerrit][Gerrit integration]]
#+BEGIN_SRC emacs-lisp
(use-package magit-gerrit
  :after (magit magit-popup)
  :straight (magit-gerrit
             :type git
             :host github
             :repo "ispras/magit-gerrit")
  :custom
  (magit-gerrit-remote "")
  (magit-gerrit-ssh-creds ""))
#+END_SRC

***** Find other projects
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "projectile"
  (setq magit-repository-directories (mapcar (lambda (element)
                                               (cons (directory-file-name element) 10))
                                             (cl-remove-if-not (lambda (project)
                                                                 (magit-git-repo-p project))
                                                               (projectile-relevant-known-projects)))))
#+END_SRC

***** Icons for changes
#+BEGIN_SRC emacs-lisp
(defvar prettify-magit-alist (list (list (rx (= 8 (in "0-9a-f")) space (+ (in space punctuation "*" "/" "\\" "|")) (group "|")) "│")
                                   (list (rx (= 8 (in "0-9a-f")) space (+ (in space punctuation "*" "/" "\\" "|")) (group "/")) "╱")
                                   (list (rx (= 8 (in "0-9a-f")) space (+ (in space punctuation "*" "/" "\\" "|")) (group "\\")) "╲")
                                   (list (rx (= 8 (in "0-9a-f")) space (+ (in space punctuation "*" "/" "\\" "|")) (group "*")) "┝")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "add" (? (or "s" "ed"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "allow" (? (or "s" "ed"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group (or "remove" "delete") (? (in "sd"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group (? "bug") "fix" (? (or "up" (group "e" (in "sd"))))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "call" (? (or "s" "ed"))) eow) "↴")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "fixup" (? "!"))) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "clea" (or "n" "r") (? (or "s" "ed")) (? (? " ") "up")) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "update" (? (in "sd"))) eow) "⇪")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "sync" (? (or "s" "ed"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "refactor" (? (or "s" "ed"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group (or "replace" "exchange") (? (in "sd"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "import" (? (or "s" "ed"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "increase" (? (in "sd"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "decrease" (? (in "sd"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group (or "enable" "activate") (? (in "sd"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group (or "disable" "deactivate") (? (in "sd"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "move" (? (in "sd"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "optimize" (? (in "sd"))) eow) "輪")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "set" (? "s")) eow) "=" '(:weight 'black :height 1.3))
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "show" (? (in "s"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "hide" (? (in "s"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "lock" (? (or "s" "ed"))) eow) "𓄗")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "unlock" (? (or "s" "ed"))) eow) "")
                                   (list (rx bol (= 8 (in "0-9a-f")) space (+ (in space punctuation)) bow (group "use" (? (or "s" "ed"))) eow) "")
                                   (list (rx bol (not (in "+@-")) (+ any) bow (group "master") eow) "")
                                   (list (rx bol (not (in "+@-")) (+ any) bow (group "origin") eow) "")
                                   (list (rx bol (not (in "+@-")) (+ any) bow (group "HEAD") eow) "")
                                   (list (rx bol (not (in "+@-")) (+ any) bow (group "Merge" (? " branch")) eow) "")
                                   (list (rx bol (group (or (group "edit" (? (or "s" "ed"))) (group "modif" (or "y" (group "ie" (in "sd")))))) eow) "")
                                   (list (rx bol (group "new file") eow) "ﱐ")
                                   (list (rx bol (group "delete" (? (in "sd"))) eow) "")
                                   (list (rx bol (group "rename" (? (in "sd"))) eow) "")
                                   (list (rx bol (group "@@")) "𓄥")
                                   (list (rx bol "@@" (+ any) (group "@@")) "")
                                   (list (rx bol (group "pick")) "")
                                   (list (rx bol (group "kill")) "")
                                   (list (rx bol (group "squash")) "ﲐ")
                                   (list (rx bol (group "exec")) "")
                                   (list (rx bol (group "break")) ""))
  "An alist of expressions and icon properties to replace strings with icons in magit logs.")

(defun cpped-prettify-magit (&rest arguments)
  "Add face properties and compose symbols for buffer from pretty-magit."
  (interactive)
  (with-silent-modifications
    (dolist (entry prettify-magit-alist)
      (let ((expression (nth 0 entry))
            (icon (nth 1 entry))
            (properties (nth 2 entry)))
        (save-excursion
          (goto-char (point-min))
          (while (search-forward-regexp expression nil t)
            (when (and (match-beginning 1)
                       (match-end 1))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (when properties
                (add-face-text-property (match-beginning 1) (match-end 1) properties)))))))))

(advice-add 'magit-status :after 'cpped-prettify-magit)
(advice-add 'magit-refresh-buffer :after 'cpped-prettify-magit)
(add-hook 'diff-mode-hook #'cpped-prettify-magit)
#+END_SRC

***** Import file from stash or branch
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun cpped-list-refs-and-stashes (wrapped-function &rest arguments)
    "Create a list of branches and stashes."
    (append
     (apply wrapped-function arguments)
     (magit-list-stashes)))

  (defun cpped-import-git-file ()
    "Import a git-versioned file from either a branch or the stash."
    (interactive)
    (advice-add #'magit-list-refnames :around #'cpped-list-refs-and-stashes)
    (call-interactively #'magit-file-checkout)
    (advice-remove #'magit-list-refnames #'cpped-list-refs-and-stashes))

  (magit-define-popup-action 'magit-dispatch-popup
    ?I "Import" 'cpped-import-git-file ?!)
  (define-key magit-status-mode-map
    "I" 'cpped-import-git-file))
#+END_SRC

***** Open file from stash or branch
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun cpped-open-git-file ()
    "Open a git-versioned file from either a branch or the stash."
    (interactive)
    (advice-add #'magit-list-refnames :around #'cpped-list-refs-and-stashes)
    (let* ((rev (magit-read-branch-or-commit
                 "Open from revision" magit-buffer-revision))
           (file (magit-read-file-from-rev rev "Open file"))
           (project (magit-toplevel)))
      (magit-find-file rev file)
      (let ((name (concat file "-" rev)))
        (setq buffer-file-name (expand-file-name name project))
        (rename-buffer (file-name-nondirectory name)))
      (read-only-mode t)))

  (magit-define-popup-action 'magit-dispatch-popup
    ?Z "Open" 'cpped-open-git-file ?!)
  (define-key magit-status-mode-map
    "Z" 'cpped-open-git-file))
#+END_SRC

***** Automatically commit changes to WIP branches
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (magit-wip-after-save-mode))
#+END_SRC

**** [[https://github.com/syohex/emacs-git-messenger][Show commit message of line on request]]
#+BEGIN_SRC emacs-lisp
(use-package git-messenger
  :custom
  (git-messenger:handled-backends 'git)
  (git-messenger:use-magit-popup t))
#+END_SRC

**** [[https://github.com/pidu/git-timemachine][Switch to previous version]]
#+BEGIN_SRC emacs-lisp
(use-package git-timemachine
  :straight (git-timemachine
             :type git
             :host nil
             :repo "https://codeberg.org/pidu/git-timemachine"
             :build t)
  :custom (git-timemachine-abbreviation-length 8))
#+END_SRC

**** [[https://github.com/jwiegley/git-undo-el][Git undo]]
#+BEGIN_SRC emacs-lisp
(use-package git-undo
  :straight (git-undo
             :type git
             :host github
             :repo "jwiegley/git-undo-el"))
#+END_SRC

**** [[https://github.com/defunkt/gist.el][Gist support]]
#+BEGIN_SRC emacs-lisp
(use-package gist
  :custom (gist-ask-for-description t))
#+END_SRC

**** Config file support
#+BEGIN_SRC emacs-lisp
(use-package gitconfig-mode)
(use-package gitignore-mode)
(use-package gitattributes-mode)
#+END_SRC

**** [[https://github.com/sei40kr/gitignore-snippets][Snippets]]
#+BEGIN_SRC emacs-lisp
(use-package gitignore-snippets
  :config (gitignore-snippets-init))
#+END_SRC

**** Show contributors
#+BEGIN_SRC emacs-lisp
(defun cpped-get-contributor-info (files &optional start end)
  "Get contributor information for file(s) or region."
  (let ((lines (if (and start end)
                   (format "-L %d,%d" (line-number-at-pos start t) (line-number-at-pos end t))
                 ""))
        (contributor-list)
        (linecount 0)
        (output "Contributors:\n"))
    (setq contributor-list (sort (dolist (file files contributor-list)
                                   (dolist (entry (split-string (shell-command-to-string (concat "git blame " lines " --line-porcelain " file))
                                                                "\n"
                                                                t))
                                     (when (string-match (rx bol "author " (group (+ any))) entry)
                                       (let* ((contributor (match-string 1 entry))
                                              (count (alist-get contributor contributor-list 0 nil 'string=)))
                                         (setf (alist-get contributor contributor-list 0 nil 'string=) (1+ count)))
                                       (setq linecount (1+ linecount)))))
                                 (lambda (first second) (> (cdr first) (cdr second)))))
    (dolist (entry contributor-list output)
      (setq output (format "%s    %s (%d%%)\n" output (car entry) (/ (* (cdr entry) 100) linecount))))
    (concat output "\n")))

(defun cpped-get-change-info (files &optional start end)
  "Get last change date for file(s) or region."
  (cadar (sort (mapcar (lambda (file)
                        (split-string (shell-command-to-string (concat "git log -1 "
                                                                       (if (and start end)
                                                                           (format "-L %d,%d" (line-number-at-pos start t) (line-number-at-pos end t))
                                                                         "")
                                                                       " --format=\"%aI; %ar by %an (commit %h %s)\" -- "
                                                                       file))
                                      ";"))
                      files)
              (lambda (first second) (> (iso8601-parse (car first) (iso8601-parse (car second))))))))

(defun cpped-show-contributor-info (files position type &optional start end)
  "Show contributor information."
  (remove-overlays nil nil type t)
  (let* ((overlay (make-overlay position position)))
    (overlay-put overlay 'before-string (concat (cpped-get-contributor-info files start end)
                                                (cpped-get-change-info files start end)))
    (overlay-put overlay type t)))


(defun cpped-show-project-contributor-info ()
  "Show contributor information for current project."
  (interactive)
  (let* ((backend (vc-deduce-backend))
         (project-root (when backend
                         (ignore-errors (vc-call-backend backend 'root default-directory))))
         (default-directory project-root))
    (when project-root
      (cpped-show-contributor-info (mapcar (lambda (file)
                                             (expand-file-name file project-root))
                                           (split-string (shell-command-to-string (concat "git ls-files --full-name")) "\n" t))
                                   (save-excursion
                                       (save-restriction
                                         (point-min)))
                                   'cpped-project-contributor-info))))

(defun cpped-show-file-contributor-info ()
  "Show contributor information for current file."
  (interactive)
  (when (and buffer-file-name
             (vc-state buffer-file-name)
             (not (string-equal (vc-state buffer-file-name) 'unregistered)))
    (cpped-show-contributor-info `(,buffer-file-name)
                                 (save-excursion
                                     (save-restriction
                                       (point-min)))
                                 'cpped-file-contributor-info)))

(defun cpped-show-region-contributor-info ()
  "Show contributor information for current region. If no region is selected, defaults to current function"
  (interactive)
  (when (and buffer-file-name
             (vc-state buffer-file-name)
             (not (string-equal (vc-state buffer-file-name) 'unregistered)))
    (let ((start (if (region-active-p)
                     (region-beginning)
                   (save-excursion
                     (save-restriction
                       (funcall cpped-beginning-of-function)
                       (point)))))
          (end (if (region-active-p)
                   (region-end)
                 (save-excursion
                   (save-restriction
                     (funcall cpped-end-of-function)
                     (point))))))
      (cpped-show-contributor-info `(,buffer-file-name)
                                   (save-excursion
                                     (save-restriction
                                       (goto-char start)
                                       (line-beginning-position)))
                                   'cpped-region-contributor-info
                                   start
                                   end))))

(add-hook 'find-file-hook 'cpped-show-file-contributor-info)
(add-hook 'after-save-hook 'cpped-show-file-contributor-info)
(add-hook 'magit-post-commmit-hook 'cpped-show-file-contributor-info)
(add-hook 'magit-post-refresh-hook 'cpped-show-file-contributor-info)
#+END_SRC

**** [[https://github.com/syohex/emacs-smeargle][Highlight file change age]]
#+BEGIN_SRC emacs-lisp
(defun cpped-maybe-enable-smeargle ()
    "Enable smeargle for version-controlled files."
    (if (and buffer-file-name
             (vc-state buffer-file-name)
             (not (string-equal (vc-state buffer-file-name) 'unregistered)))
        (ignore-errors (smeargle))
      (smeargle-clear)))

(use-package smeargle
  :hook ((find-file after-save magit-post-commmit magit-post-refresh) . cpped-maybe-enable-smeargle)
  :custom (smeargle-colors '((older-than-1day   . "#1e0000")
                             (older-than-3day   . "#1e1500")
                             (older-than-1week  . "#1e1e00")
                             (older-than-2week  . "#021e00")
                             (older-than-1month . "#1e0000")
                             (older-than-3month . "#001e16")
                             (older-than-6month . "#00171e")
                             (older-than-1year  . "#00001e"))))
#+END_SRC

*  Viewer
** Man Pages
#+BEGIN_SRC emacs-lisp
(setq woman-fill-frame t
      woman-imenu t
      woman-use-topic-at-point t
      woman-use-topic-at-point-default t)
#+END_SRC

** Info Pages
Hide info buffer in buffer list
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "consult"
  (push "\\`\\*info\\*\\'" consult-buffer-filter))
#+END_SRC

*** [[https://github.com/ubolonton/info-colors][Add extra coloring]]
#+BEGIN_SRC emacs-lisp
(use-package info-colors
  :hook (Info-selection . info-colors-fontify-node))
#+END_SRC

** [[https://github.com/politza/pdf-tools][PDF]]
#+BEGIN_SRC emacs-lisp
(use-package pdf-tools
  :after (popwin)
  :ensure-system-package (poppler-devel poppler-glib-devel)
  :bind (:map pdf-view-mode-map ("q" . kill-this-buffer))
  :mode ("\\.pdf\\'" . pdf-view-mode)
  :hook (pdf-view-mode . pdf-view-midnight-minor-mode)
  :custom
  (pdf-info-epdfinfo-program "/usr/local/bin/epdfinfo")
  (pdf-view-display-size 'fit-page)
  (pdf-annot-activate-created-annotations t)
  (pdf-view-resize-factor 1.1)
  (pdf-view-midnight-colors `(,(face-attribute 'default :foreground) . ,(face-attribute 'default :background)))
  :config
  (push '("%PDF" . pdf-view-mode) magic-mode-alist)
  (pdf-tools-install t t t)
  (push "\\.pdf\\'" cpped-no-hexedit-extensions)
  (push '("*PDF-Metadata*" :width 60 :position right :noselect t :stick t) popwin:special-display-config)
  (advice-add 'pdf-view-mode :before (lambda (&rest arguments)
                                       (nlinum-mode -1))))
#+END_SRC

[[https://github.com/nicolaisingh/saveplace-pdf-view][Save last position]]
#+BEGIN_SRC emacs-lisp
(use-package saveplace-pdf-view
  :after pdf-tools doc-view)
#+END_SRC

** Doc-View
#+BEGIN_SRC emacs-lisp
(require 'doc-view)

(setq doc-view-continuous t
      doc-view-scale-internally nil)

(define-key doc-view-mode-map (kbd "q") 'doc-view-kill-proc-and-buffer)
#+END_SRC

*** ODF
#+BEGIN_SRC emacs-lisp
(push '("\\.odt\\'" . doc-view-mode) auto-mode-alist)
(push "\\.odt\\'" cpped-no-hexedit-extensions)
#+END_SRC

*** DOC
#+BEGIN_SRC emacs-lisp
(push '("\\.doc\\'" . doc-view-mode) auto-mode-alist)
(push "\\.doc\\'" cpped-no-hexedit-extensions)
#+END_SRC

*** DVI
#+BEGIN_SRC emacs-lisp
(push '("\\.dvi\\'" . doc-view-mode) auto-mode-alist)
(push "\\.dvi\\'" cpped-no-hexedit-extensions)
#+END_SRC

*** Postscript
#+BEGIN_SRC emacs-lisp
(push '("\\.ps\\'" . doc-view-mode) auto-mode-alist)
(push "\\.ps\\'" cpped-no-hexedit-extensions)
#+END_SRC

** [[https://github.com/doublep/logview][System Logs]]
#+BEGIN_SRC emacs-lisp
(use-package logview
  :mode "\\.log\\'"
  :hook (logview-mode . (lambda()
                          (auto-revert-tail-mode)
                          (read-only-mode)))
  :custom (logview-auto-revert-mode 'auto-revert-tail-mode))
#+END_SRC

** STrace Logs
#+BEGIN_SRC emacs-lisp
(use-package strace-mode)
#+END_SRC

** Certificates
#+BEGIN_SRC emacs-lisp
(defvar certificate-mode-font-lock-keywords
  '(("^\\(-----[^-]*-----\\)"
     (1 font-lock-comment-face)))
  "Highlight rules for `certificate-mode'.")

(define-derived-mode certificate-mode text-mode "Certificate-Mode"
  "A major mode for viewing certificate files."
  (setq-local comment-start "-----")
  (setq-local comment-end "-----")
  (setq-local comment-start-skip "-----")
  (setq-local comment-end-skip "-----")
  (setq-local font-lock-defaults '(certificate-mode-font-lock-keywords))

  (setq-local outline-regexp "-----"))

(push '("-----BEGIN CERTIFICATE-----" . certificate-mode) magic-mode-alist)

(define-key certificate-mode-map (kbd "q") 'cpped-kill-default-buffer)

(provide 'certificate-mode)

(defun cpped-show-certificate-info ()
  "Show certificate information"
  (remove-overlays  nil nil 'cpped-certificate-info t)
  (let* ((begin (save-excursion
                  (save-restriction
                    (point-min))))
         (overlay (make-overlay begin begin)))
    (overlay-put overlay 'before-string (replace-regexp-in-string "issuer=" "  "
                                                                  (replace-regexp-in-string "subject=" "  "
                                                                                            (replace-regexp-in-string "notBefore=" "  "
                                                                                                                      (replace-regexp-in-string "notAfter=" "  "
                                                                                                                                                (replace-regexp-in-string "SHA1 Fingerprint=" "  "
                                                                                                                                                                          (concat (shell-command-to-string (concat "openssl x509 -in '" buffer-file-name "' -noout -issuer -subject -dates -fingerprint")) "\n")))))))
    (overlay-put overlay 'cpped-certificate-info t)))

(add-hook 'certificate-mode-hook '(lambda ()
                                    (cpped-show-certificate-info)
                                    (read-only-mode)))
#+END_SRC

*  Org-Mode
#+BEGIN_SRC emacs-lisp
(use-package org
  :after (consult rainbow-mode); popwin)
  :mode ("\\.org\\'" . org-mode)
  :bind (("C-c l" . org-store-link))
  :custom
  (org-blank-before-new-entry '((heading . t)))
  (org-catch-invisible-edits 'error)
  (org-columns-default-format "%50ITEM(Task) %2PRIORITY %10Effort(Effort){:} %10CLOCKSUM")
  (org-cycle-separator-lines 0)
  (org-default-notes-file (file-truename "~/.notes.org"))
  (org-duration-format 'h:mm)
  (org-ellipsis " ")
  (org-enforce-todo-checkbox-dependencies t)
  (org-enforce-todo-dependencies t)
  (org-fast-tag-selection-single-key t)
  (org-global-properties '((Effort_ALL . "0:00 0:10 0:30 1:00 2:00 4:00 8:00 16:00 24:00 40:00 80:00")))
  (org-hide-emphasis-markers t)
  (org-highlight-latex-and-related '(native latex script entities))
  (org-imenu-depth 10)
  (org-image-actual-width t)
  (org-indent-indentation-per-level cpped-default-indentation)
  (org-log-redeadline 'time)
  (org-log-reschedule 'time)
  (org-log-into-drawer t)
  (org-outline-path-complete-in-steps nil)
  (org-pretty-entities t)
  (org-refile-targets '((nil . (:maxlevel . 6))
                        (org-agenda-files . (:maxlevel . 5))))
  (org-refile-use-outline-path 'file)
  (org-refile-allow-creating-parent-nodes 'confirm)
  (org-src-fontify-natively t)
  (org-hidden-keywords '(title author date email))
  (org-fontify-done-headline t)
  (org-fontify-quote-and-verse-blocks t)
  (org-fontify-whole-heading-line t)
  (org-remove-highlights-with-change t)
  (org-return-follows-link t)
  (org-special-ctrl-a/e nil)
  (org-special-ctrl-k nil)
  (org-src-preserve-indentation t)
  (org-src-tab-acts-natively t)
  (org-src-window-setup 'current-window)
  (org-startup-with-inline-images t)
  (org-startup-folded nil)
  (org-startup-indented t)
  (org-support-shift-select t)
  (org-use-sub-superscripts '{})
  (org-use-speed-commands t)
  (org-yank-adjusted-subtrees t)
  :config
  (defvar org-default-todos-file (file-truename "~/.todos.org") "The default file for todo tasks.")
  (defvar org-default-bugs-file (file-truename "~/.bugs.org") "The default file for bug tasks.")
  (defvar org-default-events-file (file-truename "~/.events.org") "The default file for events.")
  (font-lock-add-keywords 'org-mode `(("^[ \t]*\\(?:[-+*]\\|[0-9]+[).]\\)[ \t]+\\(\\(?:\\[@\\(?:start:\\)?[0-9]+\\][ \t]*\\)?\\[\\(?:X\\|\\([0-9]+\\)/\\2\\)\\][^\n]*\n\\)" 1 'org-headline-done prepend)) 'append)
  (add-hook 'org-mode-hook #'org-update-all-dblocks)
  (push "\\`\\*Org Agenda\\*\\'" consult-buffer-filter)
  (defun cpped-org-update-all-dblocks ()
    "Update all dynamic blocks in org-mode."
    (when (equal major-mode 'org-mode)
      (org-update-all-dblocks)))
  (add-hook 'after-save-hook #'cpped-org-update-all-dblocks)
  (add-hook 'window-state-change-hook #'cpped-org-update-all-dblocks) )

#+END_SRC

** Default files
*** Create agenda files if necessary
#+BEGIN_SRC emacs-lisp
(defun cpped-create-default-file (file &optional content)
  "Create a file with given default content."
  (when (not (file-exists-p file))
    (with-temp-buffer
      (when content
        (insert content))
      (write-file file)
      (cpped-kill-default-buffer))))

(cpped-create-default-file org-default-bugs-file "#+CATEGORY: Bugs\n#+BEGIN: clocktable :maxlevel 5 :scope file :block thisweek :step day :compact nil :narrow 80\n#+END:\n\n")
(cpped-create-default-file org-default-todos-file "#+CATEGORY: ToDos\n#+BEGIN: clocktable :maxlevel 5 :scope file :block thisweek :step day :compact nil :narrow 80\n#+END:\n\n")
(cpped-create-default-file org-default-events-file)
(cpped-create-default-file org-default-notes-file "#+CATEGORY: Notes\n\n")
#+END_SRC

*** Hide default org files in buffer list
#+BEGIN_SRC emacs-lisp
#+END_SRC

*** Show special name for default buffers in mode line
#+BEGIN_SRC emacs-lisp
(push `(,(file-name-nondirectory org-default-bugs-file) . "*Bugs*") cpped-special-buffer-names-alist)
(push `(,(file-name-nondirectory org-default-todos-file) . "*ToDos*") cpped-special-buffer-names-alist)
(push `(,(file-name-nondirectory org-default-events-file) . "*Events*") cpped-special-buffer-names-alist)
(push `(,(file-name-nondirectory org-default-notes-file) . "*Notes*") cpped-special-buffer-names-alist)
#+END_SRC

*** Never kill special buffers
#+BEGIN_SRC emacs-lisp
(push (file-name-nondirectory org-default-bugs-file) cpped-bury-buffers-list)
(push (file-name-nondirectory org-default-events-file) cpped-bury-buffers-list)
(push (file-name-nondirectory org-default-todos-file) cpped-bury-buffers-list)
#+END_SRC

Remove check on buffer close
#+BEGIN_SRC emacs-lisp
(defun cpped-silence-org-clock (wrapped-function &rest arguments)
  "Do not ask to clock out when closing todo buffer."
  (when (not (string= (substring-no-properties (buffer-name)) (file-name-nondirectory org-default-todos-file)))
    (apply wrapped-function arguments)))

(advice-add 'org-check-running-clock :around #'cpped-silence-org-clock)
#+END_SRC

*** Show clock information
#+BEGIN_SRC emacs-lisp
(add-hook 'org-mode-hook #'org-clock-display)
#+END_SRC

** Tangling
#+BEGIN_SRC emacs-lisp
(use-package org-auto-tangle
  :hook (org-mode . org-auto-tangle-mode))
#+END_SRC

** Lists
*** Automatically create lists
#+BEGIN_SRC emacs-lisp
(use-package org-autolist
  :after org
  :hook (org-mode . org-autolist-mode))
#+END_SRC

*** Hide stars for header items
#+BEGIN_SRC emacs-lisp
(use-package org-superstar
  :after org
  :hook (org-mode . (lambda () (org-superstar-mode 1)))
  :custom
  (org-superstar-headline-bullets-list '(""))
  (org-superstar-leading-bullet ?\s)
  (org-superstar-item-bullet-alist '((?* . ?•)
                                     (?+ . ?•)
                                     (?- . ?•)))
  (org-superstar-special-todo-items t))
#+END_SRC

** Use current heading as function name
#+BEGIN_SRC emacs-lisp
(defun cpped-org-log-current-defun ()
  (save-excursion
    (org-back-to-heading)
    (when (looking-at org-complex-heading-regexp)
      (match-string 4))))

(add-hook 'org-mode-hook (lambda ()
                           (make-variable-buffer-local 'add-log-current-defun-function)
                           (setq add-log-current-defun-function 'cpped-org-log-current-defun)))
#+END_SRC

** Links
*** [[https://orgmode.org/manual/Link-Abbreviations.html#Link-Abbreviations][Shortcuts]]
#+BEGIN_SRC emacs-lisp
(push '("google" . "https://www.google.de/?gws_rd=ssl#q=%s") org-link-abbrev-alist)
(push '("wikipedia" . "https://en.wikipedia.org/wiki/%s") org-link-abbrev-alist)
(push '("github" . "https://github.com/%s") org-link-abbrev-alist)
#+END_SRC

*** Insertion
#+BEGIN_SRC emacs-lisp
(defun cpped-url-to-title (url)
  "Returns the content of the <title> tag of the page at url."
  (with-temp-buffer
    (url-insert-file-contents url)
    (beginning-of-buffer)
    (let ((begin (search-forward "<title>"))
          (end (progn
                 (search-forward "</title>")
                 (search-backward "<"))))
      (buffer-substring-no-properties begin end))))

(defun cpped-org-insert-link-dwim (url)
  "Insert an org link with the target page title as description. The URL is taken from either argument, region, thing-at-point or user input."
  (interactive (list (let (url begin end)
                       (if (region-active-p)
                           (setq begin (region-beginning)
                                 end (region-end)
                                 url (buffer-substring-no-properties begin end))
                         (progn
                           (setq url (thing-at-point 'url))
                           (if (not (= 0 (length url)))
                               (let ((bounds (bounds-of-thing-at-point 'url)))
                                 (setq begin (car bounds)
                                       end (cdr bounds)))
                             (let ((bounds (bounds-of-thing-at-point 'word)))
                               (setq url (if (string-match-p "^http" (current-kill 0))
                                             (current-kill 0)
                                           (read-string "URL: "))
                                     begin (car bounds)
                                     end (cdr bounds))))))
                       (when (and begin
                                  end)
                         (delete-region begin end))
                       url)))
  (when (not (string-match-p (rx line-start "http" (zero-or-one "s") "://") url))
      (setq url (concat "https://" url)))
  (org-insert-link nil url (cpped-url-to-title url)))

(defun cpped-org-convert-to-link-dwim (url title)
  "Convert the region or thing-at-point to a link with thing-at-point as the description."
  (interactive (list (read-string "URL: " "http://www.")
                     (let (title begin end)
                       (if (region-active-p)
                           (setq begin (region-beginning)
                                 end (region-end)
                                 title (buffer-substring-no-properties begin end))
                         (let* ((bounds (bounds-of-thing-at-point 'word)))
                           (setq title (buffer-substring-no-properties (car bounds) (cdr bounds))
                                 begin (car bounds)
                                 end (cdr bounds)))
                         (delete-region begin end)
                         title))))
  (org-insert-link nil url title))
#+END_SRC

** Inline code
*** Auto-save
#+BEGIN_SRC emacs-lisp
(setq org-edit-src-auto-save-idle-delay super-save-idle-duration)
#+END_SRC

*** Allow evaluation
Disable evaluation confirmation for some languages
#+BEGIN_SRC emacs-lisp
(defun cpped-org-confirm-babel-evaluate (lang body)
  "Do not confirm evaluation for these languages."
  (not (or (string= lang "bash")
           (string= lang "calc")
           (string= lang "dot")
           (string= lang "gnuplot")
           (string= lang "latex")
           (string= lang "emacs-lisp")
           (string= lang "plantuml")
           (string= lang "python")
           (string= lang "sed")
           (string= lang "shell")
           (string= lang "zsh"))))
#+END_SRC

Note: For this to work, Org must be version 8.3 or higher. Org is bundled with emacs and must be updated manually from the repository.
#+BEGIN_SRC emacs-lisp
(org-babel-do-load-languages 'org-babel-load-languages
                             '((calc . t)
                               (dot . t)
                               (gnuplot . t)
                               (latex . t)
                               (lisp . t)
                               (plantuml . t)
                               (python . t)
                               (sed . t)
                               (shell . t)))

(setq org-confirm-babel-evaluate 'cpped-org-confirm-babel-evaluate)
(org-babel-shell-initialize)
(add-hook 'org-babel-after-execute-hook 'org-display-inline-images)
#+END_SRC

*** Set file name for edit buffer
#+BEGIN_SRC emacs-lisp
(defadvice org-edit-src-code (around set-buffer-file-name activate compile)
  (let ((file-name (buffer-file-name)))
    ad-do-it
    (setq buffer-file-name file-name)))
#+END_SRC

*** Support Dockerfiles
#+BEGIN_SRC emacs-lisp
(use-package ob-docker-build
  :after org
  :ensure-system-package podman
  :straight (ob-docker-build
             :type git
             :host github
             :repo "ifitzpat/ob-docker-build")
  :config
  (add-to-list 'org-babel-load-languages '(docker-build . t))
  (org-babel-do-load-languages 'org-babel-load-languages org-babel-load-languages))
#+END_SRC

** Structure Templates
#+BEGIN_SRC emacs-lisp
(setq org-structure-template-alist '(("a" . "ASCII")
                                     ("b" . "SRC bash")
                                     ("*" . "SRC calc")
                                     ("c" . "CENTER")
                                     ("+" . "SRC c++")
                                     ("d" . "SRC dot :file :cmdline -Kdot -Tpng")
                                     ("e" . "EXAMPLE")
                                     ("h" . "HTML")
                                     ("l" . "SRC emacs-lisp")
                                     ("p" . "SRC gnuplot :file")
                                     ("/" . "COMMENT")
                                     ("q" . "QUOTE")
                                     ("r" . "SRC")
                                     ("s" . "SRC shell")
                                     ("u" . "SRC plantuml :file ")
                                     ("v" . "VERBATIM")
                                     ("z" . "SRC zsh")))
#+END_SRC

** TODO-States
#+BEGIN_SRC emacs-lisp
(setq cpped-org-todo-keyword-todo "ToDo"
      cpped-org-todo-keyword-done "Done"
      cpped-org-todo-keyword-bug "Bug"
      cpped-org-todo-keyword-analysis "Analysis"
      cpped-org-todo-keyword-correction "Correction"
      cpped-org-todo-keyword-fixed "Fixed"
      cpped-org-todo-keyword-fixme "Fixme"
      cpped-org-todo-keyword-in-progress "InProgress"
      cpped-org-todo-keyword-waiting "Waiting"
      cpped-org-todo-keyword-suspended "Suspended"
      cpped-org-todo-keyword-review "Review"
      cpped-org-todo-keyword-canceled "Canceled"
      org-todo-keywords `((sequence ,(concat cpped-org-todo-keyword-todo "(t)")
                                    ,(concat cpped-org-todo-keyword-in-progress "(p!)")
                                    ,(concat cpped-org-todo-keyword-review "(r!/@)")
                                    "|"
                                    ,(concat cpped-org-todo-keyword-done "(d!/@)"))
                          (sequence ,(concat cpped-org-todo-keyword-bug "(b)")
                                    ,(concat cpped-org-todo-keyword-analysis "(a!/@)")
                                    ,(concat cpped-org-todo-keyword-correction "(c!)")
                                    "|"
                                    ,(concat cpped-org-todo-keyword-fixed "(f!/@)"))
                          (sequence ,(concat cpped-org-todo-keyword-fixme "(m)")
                                    "|"
                                    ,(concat cpped-org-todo-keyword-done "(f/@)"))
                          (sequence ,(concat cpped-org-todo-keyword-waiting "(w@/!)")
                                    ,(concat cpped-org-todo-keyword-suspended "(s@/!)"))
                          (sequence "|" ,(concat cpped-org-todo-keyword-canceled "(x@/@)"))))
#+END_SRC

Format according to the state.
#+BEGIN_SRC emacs-lisp
(defface org-todo-keyword-todo '((t :inherit default)) "Face used for todo items." :group 'org)
(defface org-todo-keyword-in-progress '((t :inherit default)) "Face used for in-progress items." :group 'org)
(defface org-todo-keyword-waiting '((t :inherit default)) "Face used for waiting items." :group 'org)
(defface org-todo-keyword-suspended '((t :inherit default)) "Face used for suspended items." :group 'org)
(defface org-todo-keyword-done '((t :inherit default)) "Face used for done items." :group 'org)
(defface org-todo-keyword-canceled '((t :inherit default)) "Face used for canceled items." :group 'org)

(setq org-todo-keyword-faces `((,cpped-org-todo-keyword-todo . org-todo-keyword-todo)
                               (,cpped-org-todo-keyword-done . org-todo-keyword-done)
                               (,cpped-org-todo-keyword-bug . org-todo-keyword-todo)
                               (,cpped-org-todo-keyword-analysis . org-todo-keyword-in-progress)
                               (,cpped-org-todo-keyword-correction . org-todo-keyword-in-progress)
                               (,cpped-org-todo-keyword-fixed . org-todo-keyword-done)
                               (,cpped-org-todo-keyword-fixme . org-todo-keyword-todo)
                               (,cpped-org-todo-keyword-in-progress . org-todo-keyword-in-progress)
                               (,cpped-org-todo-keyword-review . org-todo-keyword-in-progress)
                               (,cpped-org-todo-keyword-waiting . org-todo-keyword-waiting)
                               (,cpped-org-todo-keyword-suspended . org-todo-keyword-suspended)
                               (,cpped-org-todo-keyword-canceled . org-todo-keyword-canceled)))

(with-eval-after-load "org-superstar"
  (setq org-superstar-todo-bullet-alist `((,cpped-org-todo-keyword-todo . ?)
                                          (,cpped-org-todo-keyword-done . ?)
                                          (,cpped-org-todo-keyword-bug . ?)
                                          (,cpped-org-todo-keyword-analysis . ?)
                                          (,cpped-org-todo-keyword-correction . ?)
                                          (,cpped-org-todo-keyword-fixed . ?)
                                          (,cpped-org-todo-keyword-fixme . ?)
                                          (,cpped-org-todo-keyword-in-progress . ?)
                                          (,cpped-org-todo-keyword-waiting . ?)
                                          (,cpped-org-todo-keyword-suspended . ?鈴)
                                          (,cpped-org-todo-keyword-review . ?)
                                          (,cpped-org-todo-keyword-canceled . ?ﰸ)))
  (org-superstar-restart))
#+END_SRC

Archive when done, remove flag if reset to todo.
#+BEGIN_SRC emacs-lisp
(setq org-archive-mark-done nil
      org-archive-location "%s_archive::* Archived")
#+END_SRC

** Priorities
#+BEGIN_SRC emacs-lisp
(defface org-priority-high '((t :inherit default)) "Face used for high priority." :group 'org)
(defface org-priority-medium '((t :inherit default)) "Face used for medium priority." :group 'org)
(defface org-priority-low '((t :inherit default)) "Face used for low priority." :group 'org)

(setq org-priority-faces '((?A . org-priority-high)
                           (?B . org-priority-medium)
                           (?C . org-priority-low)))

(use-package org-fancy-priorities
  :hook ((org-mode org-agenda-mode) . org-fancy-priorities-mode)
  :custom (org-fancy-priorities-list '((?A . "")
                                       (?B . "")
                                       (?C . "⏾"))))
#+END_SRC

** Prettify symbols
#+BEGIN_SRC emacs-lisp
(add-hook 'org-mode-hook (lambda ()
                           (push '("[ ]" . ?) prettify-symbols-alist)
                           (push '("[X]" . ?) prettify-symbols-alist)
                           (push '("[-]" . ?) prettify-symbols-alist)
                           (push '("#+BEGIN_SRC" . ?) prettify-symbols-alist)
                           (push '("#+begin_src" . ?) prettify-symbols-alist)
                           (push '("#+END_SRC" . ?) prettify-symbols-alist)
                           (push '("#+end_src" . ?) prettify-symbols-alist)
                           (push '("#+RESULTS" . ?⇒) prettify-symbols-alist)
                           (push '("#+results" . ?⇒) prettify-symbols-alist)
                           (push '("#+BEGIN_EXAMPLE" . ?﬒) prettify-symbols-alist)
                           (push '("#+begin_example" . ?﬒) prettify-symbols-alist)
                           (push '("#+END_EXAMPLE" . ?﬒) prettify-symbols-alist)
                           (push '("#+end_example" . ?﬒) prettify-symbols-alist)
                           (push '("#+BEGIN_HTML" . ?爵) prettify-symbols-alist)
                           (push '("#+begin_html" . ?爵) prettify-symbols-alist)
                           (push '("#+END_HTML" . ?爵) prettify-symbols-alist)
                           (push '("#+end_html" . ?爵) prettify-symbols-alist)
                           (push '("#+BEGIN_QUOTE" . ?“) prettify-symbols-alist)
                           (push '("#+begin_quote" . ?“) prettify-symbols-alist)
                           (push '("#+END_QUOTE" . ?”) prettify-symbols-alist)
                           (push '("#+end_quote" . ?”) prettify-symbols-alist)
                           (push '("#+BEGIN_VERBATIM" . ?) prettify-symbols-alist)
                           (push '("#+begin_verbatim" . ?) prettify-symbols-alist)
                           (push '("#+END_VERBATIM" . ?) prettify-symbols-alist)
                           (push '("#+end_verbatim" . ?) prettify-symbols-alist)
                           (push '(":LOGBOOK:" . ?) prettify-symbols-alist)
                           (push '("#+BEGIN:" . ?⌜) prettify-symbols-alist)
                           (push '("#+END:" . ?⌞) prettify-symbols-alist)
                           (push '("#+CAPTION:" . ?🗩) prettify-symbols-alist)
                           (push '(":END:" . ?⌞) prettify-symbols-alist)
                           (push '("CLOCK:" . ?) prettify-symbols-alist)
                           (push '("clocktable" . ?) prettify-symbols-alist)
                           (push '("\\_" . ?⮩) prettify-symbols-alist)
                           (prettify-symbols-mode)))
#+END_SRC

** Capture Templates
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "org"
  (defun shark-bytes/select-agenda-file (name)
  "Select a customer agenda file."
  (if-let ((file (shark-bytes/agenda-file (cpped-project-dir) name)))
      (progn (find-file file)
             (goto-char (point-max))
             (org-capture-put-target-region-and-position)
             (widen))
    (error "No file found")))

(defun shark-bytes/select-tasks-file ()
  "Select the customer tasks file."
  (interactive)
  (shark-bytes/select-agenda-file "tasks.org"))

(defun shark-bytes/select-events-file ()
  "Select the customer events file."
  (interactive)
  (shark-bytes/select-agenda-file "events.org"))

(defun shark-bytes/select-notes-file ()
  "Select the customer notes file."
  (interactive)
  (shark-bytes/select-agenda-file "notes.org"))

(defun org-src-language-from-major-mode (local-major-mode)
  "Infer an 'org-mode' source block type from the major mode LOCAL-MAJOR-MODE."
  (car (rassq (intern (replace-regexp-in-string "-mode"
                                                ""
                                                (format "%s"
                                                        local-major-mode)))
              org-src-lang-modes)))

(setq org-capture-templates
      `(("t" "To Do" entry (function shark-bytes/select-tasks-file) ,(concat "* " cpped-org-todo-keyword-todo " [#B] %?\n%U\n%i\n") :empty-lines 1 :kill-buffer t)
        ("p" "Priority To Do" entry (function shark-bytes/select-tasks-file) ,(concat "* " cpped-org-todo-keyword-todo " [#A] %?\n%T\nDEADLINE: %t\n%i\n") :empty-lines 1 :kill-buffer t)
        ("b" "Bug" entry (function shark-bytes/select-tasks-file) ,(concat "* " cpped-org-todo-keyword-bug " [#B] %?\n%U\n%i\n") :empty-lines 1 :kill-buffer t)
        ("f" "Fixme" entry (function shark-bytes/select-tasks-file) ,(concat "* " cpped-org-todo-keyword-fixme " [#A] %?\n%U\nSCHEDULED: %t\nIn function *[[file:%F::%(with-current-buffer (org-capture-get :original-buffer) (number-to-string (line-number-at-pos)))][%(with-current-buffer (org-capture-get :original-buffer) (which-function))()]]*\n#+BEGIN_SRC %(with-current-buffer (org-capture-get :original-buffer) (org-src-language-from-major-mode major-mode))\n%i\n#+END_SRC\n") :empty-lines 1 :kill-buffer t)
        ("s" "Support" entry (function shark-bytes/select-tasks-file) ,(concat "* " cpped-org-todo-keyword-in-progress " [#B] %?\n%U\n%i\n") :empty-lines 1 :kill-buffer t :clock-in t :clock-keep t)
        ("n" "Note" entry (function shark-bytes/select-notes-file) "* %?\n%U\n%i\n" :empty-lines 1 :kill-buffer t)
        ("m" "Meeting" entry (function shark-bytes/select-events-file) ,(concat "* " cpped-org-todo-keyword-todo " [#A] %?\n%T\n%i\n") :empty-lines 1 :kill-buffer t)
        ("i" "Instant Meeting" entry (function shark-bytes/select-events-file) ,(concat "* " cpped-org-todo-keyword-in-progress " [#A] %?\ns%T\n%i\n") :empty-lines 1 :kill-buffer t :clock-in t :clock-keep t)
        ("c" "Source Code" entry (function shark-bytes/select-notes-file) ,(concat "* %?\n%U\n\nIn function *[[file:%F::%(with-current-buffer (org-capture-get :original-buffer) (number-to-string (line-number-at-pos)))][%(with-current-buffer (org-capture-get :original-buffer) (which-function))()]]*\n#+BEGIN_SRC %(with-current-buffer (org-capture-get :original-buffer) (org-src-language-from-major-mode major-mode))\n%i\n#+END_SRC\n") :empty-lines 1 :kill-buffer t)))
)
#+END_SRC

** Agenda
#+BEGIN_SRC emacs-lisp
(setq org-agenda-compact-blocks t
      org-agenda-current-time-string "now ────────────────────────────────────────"
      org-agenda-deadline-faces '((0.7 . error)
                                  (0.5 . warning)
                                  (0.0 . default))
      org-agenda-files (list org-default-bugs-file
                             org-default-todos-file
                             org-default-events-file
                             org-default-notes-file)
      org-agenda-format-date "%A, %e.%m.%Y"
      org-agenda-include-diary t
      org-agenda-prefix-format '((agenda  . "  %(org-format-outline-path (org-get-outline-path)) %?-6T%?-12t")
                                 (timeline  . "  %l")
                                 (todo  . "  %(org-format-outline-path (org-get-outline-path)) %?-6T%?-12t")
                                 (tags  . "  %(org-format-outline-path (org-get-outline-path)) %?-6T")
                                 (search . "  %(org-format-outline-path (org-get-outline-path))%?-6T"))
      org-agenda-remove-tags 'prefix
      org-agenda-restore-windows-after-quit t
      org-agenda-show-all-dates nil
      org-agenda-skip-unavailable-files t
      org-agenda-skip-deadline-if-done t
      org-agenda-skip-deadline-prewarning-if-scheduled t
      org-agenda-skip-scheduled-if-done t
      org-agenda-skip-timestamp-if-done t
      org-agenda-skip-scheduled-delay-if-deadline t
      org-agenda-skip-scheduled-if-deadline-is-shown t
      org-agenda-start-on-weekday nil
      org-agenda-time-grid '((daily today require-timed)
                             (800 930 1000 1230 1300 1600 1800)
                             "──────────" "──────────")
      org-agenda-todo-keyword-format "%-14s")
#+END_SRC

*** Custom Views
#+BEGIN_SRC emacs-lisp
(setq org-agenda-custom-commands '(("D" "Default agenda view"
                                    ((agenda "" ((org-agenda-skip-function '(let ((tags (save-excursion
                                                                                          (outline-back-to-heading)
                                                                                          (org-get-tags))))
                                                                              (if (or (member "Appointment" tags)
                                                                                      (member "Birthday" tags)
                                                                                      (member "Holiday" tags))
                                                                                  nil
                                                                                (org-agenda-skip-entry-if 'done 'todo `(,cpped-org-todo-keyword-waiting ,cpped-org-todo-keyword-suspended)))))
                                                 (org-agenda-span (if (= 5 (nth 6 (decode-time)))
                                                                      4
                                                                    2))))
                                     (todo (concat cpped-org-todo-keyword-bug "|" cpped-org-todo-keyword-fixme "|" cpped-org-todo-keyword-analysis "|" cpped-org-todo-keyword-correction "|" cpped-org-todo-keyword-review)
                                           ((org-agenda-skip-function '(org-agenda-skip-entry-if 'done 'scheduled))
                                            (org-agenda-overriding-header cpped-org-todo-keyword-bug)
                                            (org-agenda-prefix-format '((todo  . "  %(org-format-outline-path (org-get-outline-path))%?-12t")))
                                            (org-agenda-todo-keyword-format "")))
                                     (todo cpped-org-todo-keyword-waiting
                                           ((org-agenda-overriding-header cpped-org-todo-keyword-waiting)
                                            (org-agenda-todo-keyword-format "")))
                                     (todo cpped-org-todo-keyword-suspended
                                           ((org-agenda-overriding-header cpped-org-todo-keyword-suspended)
                                            (org-agenda-todo-keyword-format "")))
                                     (todo (concat cpped-org-todo-keyword-todo "|" cpped-org-todo-keyword-in-progress)
                                           ((org-agenda-skip-function '(org-agenda-skip-entry-if 'scheduled 'deadline 'done))
                                            (org-agenda-overriding-header cpped-org-todo-keyword-todo)
                                            (org-agenda-todo-keyword-format "")))))
                                   ("n" "Notes" tags "+CATEGORY=\"Notes\""
                                    ((org-agenda-overriding-header "Notes")
                                     (org-agenda-prefix-format '((tags . "%(org-format-outline-path (org-get-outline-path)) ")))))
                                   ("d" "Scrum Daily Timesheet" agenda ""
                                    ((org-agenda-overriding-header "Last Day")
                                     (org-agenda-span (if (= 1 (nth 6 (decode-time)))
                                                          4
                                                        2))
                                     (org-agenda-start-day (if (= 1 (nth 6 (decode-time)))
                                                               "-3d"
                                                             "-1d"))
                                     (org-agenda-start-on-weekday nil)
                                     (org-agenda-start-with-clockreport-mode t)
                                     (org-agenda-time-grid nil)
                                     (org-agenda-include-diary nil)
                                     (org-agenda-clockreport-parameter-plist '(:scope agenda-with-archives :indent t :link t :emphasize t :tcolumns 1 :maxlevel 6 :fileskip0 t :formula %))))
                                   ("D" "Today's Timesheet" agenda ""
                                    ((org-agenda-overriding-header "Today")
                                     (org-agenda-span 'day)
                                     (org-agenda-start-on-weekday nil)
                                     (org-agenda-start-with-clockreport-mode t)
                                     (org-agenda-time-grid nil)
                                     (org-agenda-include-diary nil)
                                     (org-agenda-clockreport-parameter-plist '(:scope agenda-with-archives :indent t :link t :emphasize t :tcolumns 1 :maxlevel 6 :fileskip0 t :formula %))))
                                   ("p" "This Month's Timesheet" agenda ""
                                    ((org-agenda-overriding-header (concat (if (< (nth 3 (decode-time)) 25)
                                                                               "Last"
                                                                             "This")
                                                                           " Month"))
                                     (org-agenda-span 'month)
                                     (org-agenda-start-day (let* ((time (decode-time))
                                                                  (day (nth 3 time))
                                                                  (month (nth 4 time))
                                                                  (year (nth 5 time)))
                                                             (when (< day 25)
                                                               (setq month (if (= 1 month)
                                                                               (progn
                                                                                 (setq year (- year 1))
                                                                                 12)
                                                                             (- month 1))))
                                                             (format "%04d-%02d-01" year month)))
                                     (org-agenda-start-on-weekday nil)
                                     (org-agenda-start-with-clockreport-mode t)
                                     (org-agenda-time-grid nil)
                                     (org-agenda-include-diary nil)
                                     (org-agenda-clockreport-parameter-plist '(:scope agenda-with-archives :indent t :link t :emphasize t :tcolumns 1 :maxlevel 2 :fileskip0 t :formula %))))
                                   ("y" "This Year's Timesheet" agenda ""
                                    ((org-agenda-span 'year)
                                     (org-agenda-start-day (format "%04d-01-01" (nth 5 (decode-time))))
                                     (org-agenda-start-on-weekday nil)
                                     (org-agenda-start-with-clockreport-mode t)
                                     (org-agenda-time-grid nil)
                                     (org-agenda-include-diary nil)
                                     (org-agenda-clockreport-parameter-plist '(:scope agenda-with-archives :indent t :link t :emphasize t :tcolumns 1 :maxlevel 5 :fileskip0 t :formula %))))))
#+END_SRC

*** Reschedule to today
#+BEGIN_SRC emacs-lisp
(defun cpped-org-agenda-reschedule-to-today ()
  "Reschedule the selected item to today."
  (interactive)
  (cl-letf (((symbol-function 'org-read-date) '(lambda (&rest args)
                                                 (current-time))))
    (call-interactively 'org-agenda-schedule)))
#+END_SRC

** [[https://github.com/bard/org-dashboard/blob/master/org-dashboard.el][Progress Report]]
#+BEGIN_SRC emacs-lisp
(require 'url)
(setq url-privacy-level 'high)

(use-package org-dashboard
  :custom (org-dashboard-omit-completed t))
#+END_SRC

** Alert messages
#+BEGIN_SRC emacs-lisp
(use-package org-alert
  :after org
  :hook (after-make-frame-functions . (lambda (_)
                                        (org-alert-enable)))
  :custom
  (alert-default-style 'libnotify)
  (org-alert-interval 86400)
  (org-alert-notification-title "TODO"))
#+END_SRC

** EDiff Compatibility
#+BEGIN_SRC emacs-lisp
(defun cpped-run-in-org-buffer (buffer command &rest arguments)
  "Execute command if given buffer is in org mode"
  (when (and buffer
             (eq (buffer-local-value 'major-mode (get-buffer buffer)) 'org-mode)
             (save-excursion
               (set-buffer buffer)
               (apply command arguments)))))

(defun cpped-ediff-org-unfold ()
  "Unfold at diff location"
  (cpped-run-in-org-buffer ediff-buffer-A 'org-reveal)
  (cpped-run-in-org-buffer ediff-buffer-B 'org-reveal)
  (cpped-run-in-org-buffer ediff-buffer-C 'org-reveal))

(defun cpped-ediff-org-fold ()
  "Fold back to top level"
  (cpped-run-in-org-buffer ediff-buffer-A 'hide-sublevels 1)
  (cpped-run-in-org-buffer ediff-buffer-B 'hide-sublevels 1)
  (cpped-run-in-org-buffer ediff-buffer-C 'hide-sublevels 1))

(add-hook 'ediff-select-hook 'cpped-ediff-org-unfold)
(add-hook 'ediff-unselect-hook 'cpped-ediff-org-fold)
#+END_SRC

** Magit compatibility
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun cpped-expand-org-entry ()
  "Expand all entries leading to the selected entry."
  (when (derived-mode-p 'org-mode)
    (org-reveal '(4)))))

(add-hook 'magit-diff-visit-file-hook 'cpped-expand-org-entry)
#+END_SRC

** Change todo state of subtree
#+BEGIN_SRC emacs-lisp
(defun cpped-todo-subtree ()
  "Change the todo state of a subtree."
  (interactive)
  (org-mark-subtree)
  (let ((state (org-fast-todo-selection))
        (begin (point)))
    (when state
      (save-excursion
        (exchange-point-and-mark)
        (while (> (point) begin)
          (org-todo state)
          (outline-previous-visible-heading 1))
        (org-todo state)))))
#+END_SRC

** Mark heading done when all subheadings are done
#+BEGIN_SRC emacs-lisp
(defun cpped-org-summary-change-todo (done todo)
  "Switch entry to DONE when all subentries are done, to TODO otherwise."
  (let (org-log-done org-log-states) ; turn off logging
    (org-todo (if (= todo 0)
                  cpped-org-todo-keyword-done
                cpped-org-todo-keyword-todo))))

(add-hook 'org-after-todo-statistics-hook 'cpped-org-summary-change-todo)
#+END_SRC

** Mark heading done when all checkboxes are checked.
#+BEGIN_SRC emacs-lisp
(defun cpped-checkbox-list-complete ()
  (interactive)
  (save-excursion
    (org-back-to-heading t)
    (let ((begin (point)))
      (end-of-line)
      (when (re-search-backward "\\[\\([0-9]+%\\)\\]\\|\\[\\([0-9]+\\)/\\([0-9]+\\)\\]" begin t)
        (if (or (equal (match-string 1) "100%")
                (and (match-string 2)
                     (equal (match-string 2) (match-string 3))))
            (org-todo cpped-org-todo-keyword-done)
          (org-todo cpped-org-todo-keyword-todo))))))

(add-hook 'org-checkbox-statistics-hook 'cpped-checkbox-list-complete)
#+END_SRC

** Wrap Region
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "wrap-region"
  (wrap-region-add-wrappers
   '(("*" "*" nil org-mode)
     ("~" "~" nil org-mode)
     ("/" "/" nil org-mode)
     ("=" "=" nil org-mode)
     ("_" "_" nil org-mode)
     ("$" "$" nil org-mode)))
  (add-hook 'org-mode-hook 'wrap-region-mode))
#+END_SRC

** Clocking
#+BEGIN_SRC emacs-lisp
(setq org-clock-history-length 25
      org-clock-idle-time nil
      org-clock-in-resume t
      org-clock-in-switch-to-state cpped-org-todo-keyword-in-progress
      org-clock-into-drawer t
      org-clock-out-remove-zero-time-clocks t
      org-clock-out-when-done t
      org-clock-persist 'history
      org-clock-persist-query-resume nil
      org-clock-auto-clock-resolution nil
      org-clock-report-include-clocking-task t)

(org-clock-persistence-insinuate)

(add-hook 'org-clock-in-hook 'org-save-all-org-buffers)
(add-hook 'org-clock-out-hook 'org-save-all-org-buffers)
#+END_SRC

*** Remaining work time
#+BEGIN_SRC emacs-lisp
(defvar cpped-show-work-time t "Whether to show work time in the mode line.")
(defvar cpped-daily-work-hours 8 "The number of hours of work per day.")

(defun cpped-daily-work-minutes ()
  "The number of minutes of work per day."
  (* cpped-daily-work-hours 60))

(defun cpped-weekly-work-minutes ()
  "The number of minutes of work per week."
  (* 5 (cpped-daily-work-minutes)))

(defun cpped-monthly-work-minutes ()
  "The number of minutes of work per month."
  (* 4 (cpped-weekly-work-minutes)))

(defun cpped-clocked-time (range)
  "Return the clocked time for range."
  (interactive)
  (let ((cpped-clocked-time 0)
        (org-range (org-clock-special-range range))
        (files (org-agenda-files)))
    (org-agenda-prepare-buffers files)
    (dolist (file files)
      (with-current-buffer (find-buffer-visiting file)
        (setq cpped-clocked-time (+ cpped-clocked-time (org-clock-sum (car org-range) (cadr org-range))))))
    cpped-clocked-time))

(defun cpped-remaining-work-minutes (range &optional clocked-time)
  "Return the remaining minutes between clocked time and work time."
  (interactive)
  (- (or clocked-time
         (cpped-clocked-time range))
     (pcase range
       ('today (cpped-daily-work-minutes))
       ('thisweek (cpped-weekly-work-minutes))
       ('thismonth (cpped-monthly-work-minutes)))))

(defun cpped-format-remaining-minutes (minutes)
  "Format the remaining minutes."
  (propertize (concat (if (< minutes 0)
                          "-"
                        "+")
                      (org-duration-from-minutes (abs minutes)))
              'face
              (list ':foreground (if (< minutes 0)
                                     (face-attribute 'error :foreground)
                                   (face-attribute 'info :foreground)))))

(defun cpped-print-remaining-work-time ()
  "Return the remaining time to work today/this week/this month."
  (interactive)
  (when cpped-show-work-time
    (let ((clocked-time-today (cpped-clocked-time 'today))
          (clocked-time-this-week (cpped-clocked-time 'thisweek))
          (clocked-time-this-month (cpped-clocked-time 'thismonth)))
      (format " %s (%s/%s) 📅 %s (%s/%s) %s (%s/%s)"
              (cpped-format-remaining-minutes (cpped-remaining-work-minutes 'today clocked-time-today))
              (org-duration-from-minutes clocked-time-today)
              (org-duration-from-minutes (cpped-daily-work-minutes))
              (cpped-format-remaining-minutes (cpped-remaining-work-minutes 'thisweek clocked-time-this-week))
              (org-duration-from-minutes clocked-time-this-week)
              (org-duration-from-minutes (cpped-weekly-work-minutes))
              (cpped-format-remaining-minutes (cpped-remaining-work-minutes 'thismonth clocked-time-this-month))
              (org-duration-from-minutes clocked-time-this-month)
              (org-duration-from-minutes (cpped-monthly-work-minutes))))))
#+END_SRC

*** Current task
#+BEGIN_SRC emacs-lisp
(defun cpped-print-current-task ()
  "Return the currently clocked-in task and clocked time."
  (interactive)
  (when (org-clock-is-active)
    (format "⏱ %s%s %s"
            (org-duration-from-minutes (org-clock-get-clocked-time))
            (if org-clock-effort
                (concat "/" (org-duration-from-minutes (org-clock-effort)))
              "")
            (shark-bytes/truncate org-clock-heading 15))))
#+END_SRC

*** Do not show default clocking information in mode line
#+BEGIN_SRC emacs-lisp
(advice-add 'org-clock-update-mode-line :override #'force-mode-line-update)
#+END_SRC

*** Automatically stop clocking when exiting emacs.
#+BEGIN_SRC emacs-lisp
(add-hook 'kill-emacs-hook #'org-clock-out)
#+END_SRC

*** Automatically stop clocking when entering system suspend/lock and restart on resume/unlock
#+BEGIN_SRC emacs-lisp
(defvar cpped-was-clocking nil "Indicates whether it was clocked-in before screensaver ran.")

(defun cpped-org-clock-in-out (stop-clocking)
  (if stop-clocking
      (progn
        (setq cpped-was-clocking (org-clock-is-active))
        (org-clock-save)
        (let ((cpped-keep-clock-running nil))
          (org-clock-out)))
    (when cpped-was-clocking
      (org-clock-in-last))))

(dbus-register-signal :session
                      "org.freedesktop.ScreenSaver"
                      "/org/freedesktop/ScreenSaver"
                      "org.freedesktop.ScreenSaver"
                      "ActiveChanged"
                      #'cpped-org-clock-in-out)
(dbus-register-signal :system
                      "org.freedesktop.login1"
                      "/org/freedesktop/login1"
                      "org.freedesktop.login1.Manager"
                      "PrepareForSleep"
                      #'cpped-org-clock-in-out)
#+END_SRC

*** Clock in/out of task when starting/stopping
#+BEGIN_SRC emacs-lisp
(defun cpped-org-clock-in-if-starting ()
  "Clock in when a task is started."
  (when (and (string= org-state cpped-org-todo-keyword-in-progress)
             (not (string= org-last-state org-state)))
    (org-clock-in)))

(add-hook 'org-after-todo-state-change-hook #'cpped-org-clock-in-if-starting)

(defun cpped-org-clock-out-if-inactive ()
  "Clock out when a task is stopped."
  (when (and (member org-state '(cpped-org-todo-keyword-done
                                 cpped-org-todo-keyword-fixed
                                 cpped-org-todo-keyword-waiting
                                 cpped-org-todo-keyword-suspended
                                 cpped-org-todo-keyword-canceled))
             (equal (marker-buffer org-clock-marker) (current-buffer))
             (< (point) org-clock-marker)
             (> (save-excursion
                  (outline-next-heading)
                  (point))
                org-clock-marker)
             (not (string= org-last-state org-state)))
    (org-clock-out)))

(add-hook 'org-after-todo-state-change-hook #'cpped-org-clock-out-if-inactive)
#+END_SRC

*** [[https://github.com/unhammer/org-mru-clock][Switch to last used clock]]
#+BEGIN_SRC emacs-lisp
(use-package org-mru-clock
  :custom
  (org-mru-clock-how-many 100)
  (org-mru-clock-predicate #'org-mru-clock-exclude-done-and-archived))
#+END_SRC

*  Utilities
** System
*** [[https://github.com/tecosaur/emacs-everywhere][Use emacs for editing everywhere]]
Add global shortcut with
#+BEGIN_SRC shell :tangle no
emacsclient --eval "(emacs-everywhere)"
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package emacs-everywhere)
#+END_SRC

*** Process Management
#+BEGIN_SRC emacs-lisp
(setq proced-auto-update-flag t)
(setq proced-auto-update-interval 5)
(setq proced-descend t)
(setq proced-filter 'user)
(setq proced-tree-flag t)

(with-eval-after-load "consult"
  (push "\\*Proced\\*" consult-buffer-filter))
#+END_SRC

*** Services

** Use rx syntax for regular expression builder
#+BEGIN_SRC emacs-lisp
(setq reb-re-syntax 'rx)
#+END_SRC

** Calculator
Do not use scientific form so quickly
#+BEGIN_SRC emacs-lisp
(setq calc-display-sci-low -5)
#+END_SRC

** Calendar
#+BEGIN_SRC emacs-lisp
(use-package german-holidays
  :straight (german-holidays
             :type git
             :host github
             :repo  "rudolfochrist/german-holidays")
  :custom (calendar-holidays holiday-german-HH-holidays))

(setq calendar-date-style 'european
      calendar-week-start-day 1
      european-calendar-style t
      mark-diary-entries-in-calendar t
      mark-holidays-in-calendar t
      calendar-mark-holidays-flag t
      calendar-view-holidays-initially-flag t
      calendar-time-display-form '(24-hours ":" minutes (and time-zone (concat " (" time-zone ")"))))
#+END_SRC

** GNUPlot
#+BEGIN_SRC emacs-lisp
(use-package gnuplot
  :ensure-system-package gnuplot
  :mode ("\\.gnuplot\\'" . gnuplot-mode)
  :hook (gnuplot-mode . flyspell-prog-mode)
  :custom
  (gnuplot-eldoc-mode t)
  (gnuplot-image-format "svg")
  (gnuplot-inline-image-mode 'dedicated)
  (gnuplot-tab-completion t))
#+END_SRC

*** Documentation
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "devdocs-browser"
  (cpped-add-apidocs 'gnuplot-mode '("gnuplot")))
#+END_SRC

* ﯱ Remote
** Serial Devices
#+BEGIN_SRC emacs-lisp
(defcustom shark-bytes/serial-port nil "The last used serial port.")
(defcustom shark-bytes/serial-port-baudrate 115200 "The last used serial port baud rate.")

(defun shark-bytes/serial-terminal (port baudrate)
  (interactive (let ((ports (directory-files "/dev/" nil "ttyUSB[0-9]+" t)))
                 (list (cond ((= (length ports) 0) nil)
                             ((= (length ports) 1) (car ports))
                             (t (completing-read "Serial Port: " (directory-files "/dev/" nil "ttyUSB[0-9]+" t) nil t shark-bytes/serial-port)))
                       (when (> (length ports) 0)
                         (completing-read "Baudrate: " '(300 600 1200 2400 4800 9600 19200 38400 57600 115200 230400 460800 576000 921600) nil nil shark-bytes/serial-port-baudrate)))))
  (if port
      (progn
        (serial-term (expand-file-name port "/dev") baudrate)
        (rename-buffer (format "*Serial Terminal %s*" port))
        (set-buffer-process-coding-system 'utf-8-unix 'utf-8-unix)
        (customize-save-variable 'shark-bytes/serial-port port)
        (customize-save-variable 'shark-bytes/serial-port-baudrate baudrate))
    (message "No serial port found.")))
#+END_SRC

** [[https://www.emacswiki.org/emacs/TrampMode][Network Devices]]
#+BEGIN_SRC emacs-lisp
(use-package tramp
  :custom
  (tramp-adb-connect-if-not-connected t)
  (tramp-connection-properties nil)
  (tramp-connection-timeout 10)
  (tramp-default-method "ssh")
  (tramp-default-host nil)
  (tramp-default-user "root")
  (tramp-histfile-override nil))
#+END_SRC

** [[https://github.com/cjohansson/emacs-ssh-deploy][Automatic Deployment]]
#+BEGIN_SRC emacs-lisp
(use-package ssh-deploy
  :commands (ssh-deploy-upload-handler
             ssh-deploy-upload-handler-forced
             ssh-deploy-diff-handler
             ssh-deploy-browse-remote-handler
             ssh-deploy-remote-changes-handler)
  :init (setq ssh-deploy-revision-folder (file-name-as-directory (expand-file-name "ssh-revisions" user-emacs-directory)))
  :custom
  (ssh-deploy-async 1)
  (ssh-deploy-async-with-threads 1)
  :config
  (dolist (variable '((ssh-deploy-root-local . stringp)
                      (ssh-deploy-root-remote . stringp)
                      (ssh-deploy-script . functionp)
                      (ssh-deploy-on-explicit-save . booleanp)
                      (ssh-deploy-async . booleanp)
                      (ssh-deploy-exclude-list . listp)))
    (put (car variable) 'safe-local-variable (cdr variable)))
  (advice-add 'ssh-deploy-rename-handler :around 'cpped-post-rename))
#+END_SRC

* [[https://github.com/abo-abo/hydra][ Keybindings]]
** Quit from any context
#+BEGIN_SRC emacs-lisp
(defun cpped-keyboard-quit-context ()
  "Quit from any context."
  (interactive)
  (cond ((region-active-p)
         (setq saved-region-selection nil)
         (let (select-active-region-regions)
           (deactivate-mark)))
        ((eq last-command 'mode-exited) nil)
        (current-prefix-arg nil)
        ((active-minibuffer-window)
         (when (get-buffer-window "*Completions*")
           (minibuffer-hide-completions))
         (abort-recursive-edit))
        (t
         (keyboard-quit))))

(global-set-key [remap keyboard-quit] #'cpped-keyboard-quit-context)
#+END_SRC

** Use Escape instead of C-g
#+BEGIN_SRC emacs-lisp
(define-key key-translation-map (kbd "ESC") (kbd "C-g"))
#+END_SRC

** Smart close
#+BEGIN_SRC emacs-lisp
(defun cpped-close-editor ()
  "Close the editor (either frame or emacs), depending on the current mode of operation."
  (interactive)
  (if (= (length (cl-remove-if (lambda (frame)
                                 (frame-parent frame))
                               (frame-list)))
                 1)
      (kill-emacs)
    (delete-frame)))
#+END_SRC

** Hydra
#+BEGIN_SRC emacs-lisp
(use-package hydra)
#+END_SRC

** Projects
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-projects (:exit t :hint nil)
  "
☰ Project %s(cpped-powerline-project-id)%s(let ((build-dir (cpped-build-dir)))
                                            (if build-dir
                                              (concat \"  \" build-dir)
                                             \"\"))

  _x_: Close           _v_: Clone
                     ^^_V_: Clone from GitHub
CMake                           ^^Git                           ^^Directories                ^^Shell                    ^^Other
  _o_: Load                         _g_: Status                     _/_: Project                 _#_: Project directory     _f_: Find
  _c_: Configure                    _G_: Other Project Status       _._: Current                 _:_: Current directory     _L_: Add change log entry
  _r_: Reconfigure                  _l_: Log                        _d_: Subdirectory            _B_: Build directory       _C_: Count lines of code
  _-_: Reset                                                      ^^_b_: Build                                            ^^_t_: Show ToDos
  _T_: Show target dependencies
"
  ("o" cpped-load-project)
  ("c" cpped-cmake-configure)
  ("r" cpped-cmake-reconfigure)
  ("-" cpped-cmake-reset)
  ("x" projectile-kill-buffers)
  ("T" cpped-show-target-dependencies)
  ("g" magit-status)
  ("G" magit-list-repositories)
  ("l" magit-log)
  ("v" magit-clone)
  ("/" projectile-dired)
  ("." dired-jump)
  ("d" projectile-find-dir)
  ("b" (if cmake-ide-build-dir
           (dired cmake-ide-build-dir)))

  ("#" (let ((default-directory (cpped-project-dir)))
         (if default-directory
             (helm-switch-shell))))
  (":" helm-switch-shell)
  ("B" (let ((build-dir (cpped-build-dir)))
         (when build-dir
           (let ((default-directory (cpped-cmake-build-dir)))
             (helm-switch-shell)))))
  ("t" magit-todos-list)
  ("L" add-change-log-entry)
  ("C" cpped-cloc-project)
  ("t" cpped-find-todos-in-project))

(global-set-key (kbd "C-p") #'cpped-hydra-projects/body)
#+END_SRC

** Files
#+BEGIN_SRC emacs-lisp
(defun cpped-create-scratch-buffer ()
  "Create a scratch buffer."
  (interactive)
  (switch-to-buffer (get-buffer-create "*scratch*"))
  (lisp-interaction-mode))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-buffersize ()
  (when (not vlf-mode)
    (format " %s  %s"
     (format-mode-line " %I ")
     (save-excursion
       (goto-char (point-max))
       (format-mode-line " %l")))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-file-encoding ()
  (format " %s %s"
          (symbol-name (coding-system-type buffer-file-coding-system))
          (pcase (coding-system-eol-type buffer-file-coding-system)
                 (`0 "")
                 (`1 "")
                 (`2 "")
                 (_ ""))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-files (:exit t :hint nil)
  "
☰ File %s(concat (cpped-powerline-project-id) \"/\" (cpped-powerline-mode-icon 'default) \" \" (cpped-powerline-buffer-id 'default) \" \" (cpped-buffersize) \" \"  (cpped-file-encoding))

Open                             ^^Save                      ^^Close                  ^^Switch             ^^Version                    ^^Display                       ^^File                           ^^^^^^Encoding
      _o_: Open                      _s_: Save                   _x_: File                _l_: Last file       _v_: Show old version        _V_: Filter                 _<DEL>_: Delete                      ^^^^_C-d_: DOS
      _O_: From docker container     _S_: Save as                _X_: Other files         _f_: Find            _d_: Diff                    _!_: Toggle read-only mode      _m_: Rename                      ^^^^_C-u_: UNIX
      _n_: New                                                 ^^_w_: File and window                        ^^_g_: Log                     _h_: Hexadecimal mode           _D_: Diff to
      _N_: New scratch buffer        _i_: Public gist            _u_: Unused files                           ^^_G_: Autocommit-Log                                        ^^_z_: Clear content
                                   ^^_I_: Private gist           _a_: Close editor                           ^^_b_: Blame                   _6_: Decode Base64              _r_: Run command
      _j_: Header/Source                                                                                 ^^^^^^_T_: Trace lines             _&_: Encode Base64              _c_: Copy name to clipboard
      _t_: Test                      _e_: Encrypt                                                                                                                   ^^^^^^^^_._: Open directory
  _<RET>_: File under cursor                                                                                                                                      ^^^^^^^^^^_+_: Show Directory Tree
      _k_: Gist                      _F_: Toggle auto-format
"
  ("o" cpped-helm-find-files)
  ("O" docker-container-find-file)
  ("n" helm-find-files)
  ("N" cpped-create-scratch-buffer)
  ("j" helm-projectile-find-other-file :exit nil)
  ("t" projectile-toggle-between-implementation-and-test :exit nil)
  ("<RET>" helm-projectile-find-file-dwim)
  ("k" gist-list)

  ("s" save-buffer)
  ("S" cpped-save-copy)
  ("i" (when (yes-or-no-p "Upload as gist?")
         (gist-region-or-buffer)))
  ("I" (when (yes-or-no-p "Upload as private gist?")
         (gist-region-or-buffer-private)))
  ("F" (format-all-mode 'toggle))
  ("e" epa-encrypt-file)

  ("x" cpped-kill-default-buffer)
  ("X" crux-kill-other-buffers)
  ("w" kill-buffer-and-window)
  ("u" clean-buffer-list)
  ("a" cpped-close-editor)

  ("l" cpped-previous-buffer :exit nil)

  ("v" git-timemachine)
  ("d" magit-diff-buffer-file)
  ("g" magit-log-buffer-file)
  ("G" magit-log)
  ("b" magit-blame)
  ("T" magit-log-trace-definition)

  ("<DEL>" crux-delete-file-and-buffer)
  ("m" crux-rename-file-and-buffer)
  ("z" erase-buffer)
  ("r" cpped-execute-command-on-buffer-file)
  ("D" ediff-files)
  ("C-d" cpped-unix2dos)
  ("C-u" cpped-dos2unix)
  ("V" (let ((word (thing-at-point 'word)))
         (if word
             (loccur word)
           (call-interactively 'loccur))))
  ("!" (read-only-mode))
  ("h" hexl-mode)
  ("6" (base64-decode-region (point-min) (point-max)))
  ("&" (base64-encode-region (point-min) (point-max)))
  ("c" cpped-copy-file-name-to-clipboard)
  ("." dired-jump)
  ("C" cpped-cloc-file)
  ("+" treemacs-toggle))

(global-set-key (kbd "C-f") 'cpped-hydra-files/body)
(global-set-key (kbd "M-^") 'cpped-switch-buffer)

;(define-key term-raw-map (kbd "C-f") 'cpped-hydra-files/body)
#+END_SRC

** Info
#+BEGIN_SRC emacs-lisp
(defun cpped-search-github-code ()
  "Search for code on GitHub."
  (interactive)
  (eww (format "https://github.com/search?q=%s&type=Code" (or (when (region-active-p)
                                                                (buffer-substring-no-properties (region-beginning) (region-end)))
                                                              (read-string "Code: ")))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-info (:exit t :hint nil)
  "
☰ Information %s(format \"%s %s\" (cpped-print-date) (cpped-print-time))

Text                    ^^Code                                ^^Version Control               ^^System             ^^Other
  _._: Character            _d_: Documentation                    _c_: Commit Message             _p_: Processes       _t_: ToDos
  _#_: Number               _r_: References                       _b_: Blame                      _B_: Boot log        _w_: Weather
  _f_: Define               _h_: Caller hierarchy                                               ^^_S_: System log
  _x_: Translate            _m_: Member hierarchy                 _C_: Region Contributors
  _s_: Synonym              _i_: Inheritance hierarchy                                          ^^_M_: Man page
  _g_: Google                                                                                 ^^^^_I_: Info page
  _G_: Find on GitHub       _+_: Preprocess
  _o_: Preview markdown     _l_: Count lines of code
  _R_: Compare Regions      _j_: Copy JSON path

                          ^^_D_: Toggle shell documentation
"
  ("#" cpped-show-number-info)
  ("f" define-word-at-point)
  ("x" cpped-translate-word-or-region)
  ("s" synosaurus-lookup)
  ("g" helm-google-suggest)
  ("G" cpped-search-github-code)
  ("o" flymd-flyit)
  ("." what-cursor-position)
  ("R" (ediff-regions-linewise (current-buffer) (current-buffer)))

  ("d" (if (or (derived-mode-p 'asm-mode)
               (derived-mode-p 'nasm-mode))
           (call-interactively 'x86-lookup)
         (call-interactively 'devdocs-browser-open)))
  ("r" lsp-ui-peek-find-references)
  ("h" (cquery-call-hierarchy nil))
  ("m" cquery-member-hierarchy)
  ("i" cquery-inheritance-hierarchy)

  ("+" cquery-preprocess-file)
  ("l" cpped-sloccount)
  ("j" jsons-print-path)
  ("D" shelldoc-toggle-doc-window)

  ("c" git-messenger:popup-message)
  ("b" magit-blame)
  ("C" cpped-show-region-contributor-info)

  ("p" helm-top)
  ("B" journalctl-boot)
  ("S" journalctl-unit)
  ("M" helm-man-woman)
  ("I" info)

  ("t" cpped-find-todos-in-file)
  ("w" wttrin))

(global-set-key (kbd "C-ß") 'cpped-hydra-info/body)

(global-set-key (kbd "C-c m") (lambda ()
                                (interactive)
                                (popwin:display-buffer "*Messages*")))
#+END_SRC

** Navigation
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-flyspell (:exit nil :columns 1)
  "
☰ Spell Check
"
  ("C-y" flyspell-goto-next-error "Next error")
  ("C-c" helm-flyspell-auto-correct "Correct"))

(defhydra cpped-hydra-flycheck (:exit nil :columns 1)
"
☰ Code Check
"
  ("C-S-e" flycheck-previous-error  "Previous error")
  ("C-e" flycheck-next-error "Next error")
  ("C-w" flycheck-copy-errors-as-kill "Copy errors" :exit t)
  ("C-x" flycheck-clear "Clear errors" :exit t))

(defhydra cpped-hydra-navigation (:exit nil :hint nil)
  "
☰ Navigation

Text                           ^^Code                                 Marker                     ^^Diff                 ^^Other
   _<left>_: Left                  _C-S-s_: Previous S-EXPR          _C-S-i_: Previous instance      _C-S-h_: Previous hunk   _C-c_: Last change
  _<right>_: Right                   _C-s_: Next S-EXPR                _C-i_: Next instance          _C-h_: Next hunk         _M-c_: Select location
 _C-<left>_: Previous word             _w_: Up block                 _C-S-t_: Previous ToDo                                 ^^_C-u_: URL
_C-<right>_: Next word                 _y_: Down block                 _C-t_: Next ToDo                                     ^^_C-x_: XPath
   _<home>_: Beginning of line         _q_: Left block                   _t_: Select ToDo
    _<end>_: End of line           _C-S-f_: Beginning of function    _C-S-e_: Previous error
     _<up>_: Previous line           _C-f_: End of function            _C-e_: Next error
   _<down>_: Next line               _C-s_: Symbol declaration       _C-S-a_: Previous Annotation
   _<C-up>_: Previous paragraph      _C-m_: Function                   _C-a_: Next Annotation
 _<C-down>_: Next paragraph        _C-S-m_: Function (all buffers)
 _<C-home>_: Begining of file      _C-S-n_: Previous namespace
  _<C-end>_: End of file             _C-n_: Next namespace
    _C-S-l_: Previous list           _M-n_: Namespace
      _C-l_: Next list
      _C-j_: jump to character
      _C-l_: Line
   _C-S-c_ : Character
"
  ("<left>" left-char)
  ("<right>" right-char)
  ("C-<left>" left-word)
  ("C-<right>" right-word)
  ("<home>" crux-move-beginning-of-line)
  ("<end>" end-of-visual-line)
  ("<up>" previous-line)
  ("<down>" next-line)
  ("<C-up>" backward-paragraph)
  ("<C-down>" forward-paragraph)
  ("<C-home>" beginning-of-buffer)
  ("<C-end>" end-of-buffer)
  ("C-S-l" backward-up-list)
  ("C-l" down-list)
  ("C-j" avy-goto-char-timer :exit t)
  ("C-S-c" goto-char-preview :exit t)

  ("C-S-s" backward-sexp)
  ("C-s" forward-sexp)
  ("w" smart-up)
  ("y" smart-down)
  ("q" smart-left)
  ("d" smart-right)
  ("C-S-f" beginning-of-defun)
  ("C-f" end-of-defun)
  ("C-s" lsp-ui-peek-find-definitions :exit t)
  ("C-m" helm-imenu :exit t)
  ("C-S-m" helm-imenu-anywhere :exit t)
  ("C-S-n" outre-goto-namespace-previous)
  ("C-n" outre-goto-namespace-next)
  ("M-n" outrespace-jump-to-ns)

  ("C-S-t" hl-todo-previous)
  ("C-t" hl-todo-next)
  ("t" cpped-find-todos-in-file)
  ("C-S-e" (progn (flycheck-previous-error)
                  (cpped-hydra-flycheck/body) :exit t))
  ("C-e" (progn (flycheck-next-error)
                (cpped-hydra-flycheck/body) :exit t))
  ("C-y" (progn (flyspell-goto-next-error)
                (cpped-hydra-flyspell/body)) :exit t)
  ("C-S-a" annotate-previous-annotation)
  ("C-a" annotate-next-annotation)

  ("C-S-h" diff-hl-previous-hunk)
  ("C-h" diff-hl-next-hunk)

  ("C-c" goto-last-change :exit t)
  ("M-c" cpped-gumshow-list :exit t)
  ("C-u" cpped-jump-to-url :exit t)
  ("C-x" helm-x-path-walker :exit t))

(global-set-key (kbd "C-<left>") 'left-word)
(global-set-key (kbd "C-<right>") 'right-word)
(global-set-key (kbd "<home>") 'crux-move-beginning-of-line)
(global-set-key (kbd "<end>") 'end-of-visual-line)
(global-set-key (kbd "C-<up>") 'backward-paragraph)
(global-set-key (kbd "C-<down>") 'forward-paragraph)
(global-set-key (kbd "C-<home>") 'beginning-of-buffer)
(global-set-key (kbd "C-<end>") 'end-of-buffer)

(global-set-key (kbd "C-n") 'cpped-hydra-navigation/body)
(global-set-key (kbd "C-j") 'avy-goto-char-timer)
#+END_SRC

** Folding
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-fold (:exit t :columns 1)
  "
☰ Fold
"
  ("f" origami-forward-toggle-node "(un)fold")
  ("r" origami-recursive-toggle-node "(un)fold recursive")
  ("a" origami-toggle-all-nodes "(un)fold all nodes")
  ("n" cpped-narrow-or-widen-dwim "narrow/widen"))

(global-set-key (kbd "C-+") 'cpped-hydra-fold/body)
#+END_SRC

** Finding
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "C-s") 'helm-occur)
#+END_SRC

** Mark
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-mark (:exit nil :hint nil :foreign-keys run :pre (set-mark (point)))
  "
☰ Mark

Mark                            ^^Modify                        ^^Act
  _w_: Word                         _+_: Expand region              _c_: Copy
  _W_: Rest of word                 _x_: Exchange mark and point    _d_: Delete
  _s_: S-EXPR                       _j_: Jump to character          _k_: Kill
  _f_: Function
  _n_: Namespace
  _l_: Rest of line
  _L_: Line up to here
  _b_: Everything before cursor
  _a_: Everything after cursor
  _e_: Everything
"
  ("w" (progn
         (backward-word)
         (mark-word)))
  ("W" mark-word)
  ("s" mark-sexp)
  ("f" (funcall cpped-mark-function))
  ("n" outre-highlight-ns-by-name)
  ("r" rectangle-mark-mode)
  ("+" er/expand-region)
  ("x" exchange-point-and-mark)
  ("j" avy-goto-char-timer)
  ("l" end-of-line)
  ("L" beginning-of-line)
  ("b" mark-buffer-before-point)
  ("a" mark-buffer-after-point)
  ("e" mark-whole-buffer)
  ("c" (kill-ring-save nil nil t) :exit t)
  ("d" (call-interactively #'delete-region) :exit t)
  ("k" (kill-region nil nil t) :exit t))

(global-set-key (kbd "C-SPC") #'cpped-hydra-mark/body)
#+END_SRC

** Editing
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-edit-case (:exit t :columns 1)
  "
☰ Change Case
"
  ("u" fix-word-upcase "Upper case")
  ("l" fix-word-downcase "Lower case")
  ("c" fix-word-capitalize "Capitalize")
  ("i" string-inflection-cycle "Change inflection" :exit nil))

(defhydra cpped-hydra-edit-insert (:exit t :hint nil)
  "
☰ Insert

Date         ^^Time         ^^Timestamp    ^^Block                    ^^Special
  _d_: local     _t_: local     _s_: local     _3_: License               _l_: Link
  _D_: ISO                    ^^_S_: ISO       _f_: File                  _u_: Unicode Character
                                         ^^^^^^_c_: Snippet               _e_: Emoji
                                         ^^^^^^_C_: Automatic snippet     _i_: UUID
                                                                  ^^^^^^^^_T_: Markdown table of contents
                                                                  ^^^^^^^^_H_: Org-mode Heading
                                                                  ^^^^^^^^_h_: Org-mode Subheading
"
  ("d" cpped-insert-date)
  ("D" cpped-insert-iso-date)
  ("t" cpped-insert-time)
  ("s" cpped-insert-timestamp)
  ("S" cpped-insert-iso-timestamp)
  ("3" legalese)
  ("f" insert-file)
  ("c" yas-insert-snippet)
  ("C" aya-expand)
  ("l" cpped-org-insert-link-dwim)
  ("u" helm-ucs :exit nil)
  ("e" emojify-insert-emoji)
  ("i" cpped-insert-uuid)
  ("T" markdown-toc-generate-or-refresh-toc)
  ("H" org-insert-heading)
  ("h" org-insert-subheading))

(defhydra cpped-hydra-edit-sort (:exit t :columns 1)
  "
☰ Sort
"
  ("L" sort-lines "Lines")
  ("l" cpped-sort-lines-case-insensitive "Lines (case insensitive)")
  ("w" sort-words "Words"))

(defhydra cpped-hydra-edit-move (:exit nil :hint nil)
  "
☰ Move

    ^^↑
    ^_w_
← _a_   _d_ →
    ^_s_
    ^^↓
"
  ("w" smart-shift-up)
  ("<up>" smart-shift-up)
  ("s" smart-shift-down)
  ("<down>" smart-shift-down)
  ("a" smart-shift-left)
  ("<left>" smart-shift-left)
  ("d" smart-shift-right)
  ("<right>" smart-shift-right))

(defhydra cpped-hydra-edit-transpose (:exit t :columns 1)
  "
☰ Transpose
"
  ("c" transpose-chars "Characters")
  ("w" (if (equal major-mode 'org-mode)
           org-transpose-words
         transpose-words) "Words")
  ("l" transpose-lines "Lines")
  ("s" transpose-sentences "Sentences")
  ("e" org-transpose-elements "Org mode elements")
  ("p" transpose-paragraphs "Paragraphs")
  ("t" org-table-transpose-table-at-point "Org mode table"))

(defhydra cpped-hydra-color (:exit nil :hint nil)
  "
☰ Modify color

Brightness ^^Saturation ^^Hue
  _b_: +       _s_: +       _h_: +
  _B_: -       _S_: -       _H_: -
"
  ("b" kurecolor-increase-brightness-by-step)
  ("B" kurecolor-decrease-brightness-by-step)
  ("s" kurecolor-increase-saturation-by-step)
  ("S" kurecolor-decrease-saturation-by-step)
  ("h" kurecolor-increase-hue-by-step)
  ("H" kurecolor-decrease-hue-by-step))

(defhydra cpped-hydra-refactor (:exit t :hint nil)
  "
☰ Refactor

Identifier    ^^Namespace
  _r_: Rename     _w_: Wrap function/region
                ^^_n_: Rename enclosing
                ^^_N_: Rename
                ^^_d_: Delete enclosing
                ^^_D_: Delete
"
  ("r" lsp-rename)
  ("w" (progn
         (when (not (region-active-p))
           (c-mark-function))
         (call-interactively 'outrespace-wrap-namespace-region)))
  ("n" outrespace-change-enclosing-ns-name)
  ("N" outrespace-change-ns-name)
  ("d" outrespace-delete-enclosing-ns)
  ("D" outrespace-delete-ns-by-name))

(defhydra cpped-hydra-edit (:exit t :hint nil)
  "
☰ Edit

                                ^^Rename           ^^Replace                     ^^Change          ^^^Format                        ^^Text             ^^Transform            ^^Code
  _d_: Duplicate                    _n_: Local         _r_: String/Regex             _c_: Case          _>_: Indentation                _t_: Translate     _6_: Encode Base64     _/_: Comment
  _D_: Duplicate & Comment                           ^^_p_: in Project               _\"_: String        _m_: Move                       _y_: Synonym       _&_: Decode Base64     _f_: Refactor
  _i_: Insert                                        ^^_G_: With previous commit     _+_: Value +       _j_: Join lines                 _l_: Spelling                           ^^_e_: Evaluate
  _'_: Quoted insert                                                             ^^^^_-_: Value -       _:_: Fill paragraph             _s_: Sort          _k_: Encrypt           _E_: Evaluate & Replace
  _R_: Remove duplicate lines                                                    ^^^^_#_: Base          _<tab>_: Spaces → Tabs          _x_: Transpose     _K_: Decrypt           _._: Suggestion
  _<_: Complete                                                                  ^^^^_!_: Flip      _<backtab>_: Tabs → Spaces
  _g_: Edit area                                                                 ^^^^_C_: Color         _=_: Align                                                            ^^^^_o_: Split org-mode code block
  ___: Overwrite Mode                                                            ^^^^_L_: To Link
  _&_: Typographic Mode

  _a_: Create Automatic snippet
"
  ("d" crux-duplicate-current-line-or-region)
  ("D" crux-duplicate-and-comment-current-line-or-region)
  ("i" cpped-hydra-edit-insert/body)
  ("'" quoted-insert)
  ("R" cpped-remove-duplicate-lines)
  ("g" (if (equal major-mode 'org-mode)
           (org-edit-special)
         (narrow-to-defun)))
  ("_" overwrite-mode)
  ("&" typo-mode)
  ("a" aya-create)

  ("n" iedit-mode)

  ("r" vr/query-replace)
  ("p" projectile-replace)
  ("G" git-undo)

  ("c" cpped-hydra-edit-case/body :exit t)
  ("\"" string-edit-at-point)
  ("#" cpped-convert-number)
  ("+" shift-number-up)
  ("-" shift-number-down)
  ("!" bool-flip-do-flip :exit nil)
  ("C" cpped-hydra-color/body :exit t)
  ("L" cpped-org-convert-to-link-dwim :exit t)

  (">" indent-tools-hydra/body :exit t)
  ("m" cpped-hydra-edit-move/body :exit t)
  ("j" cpped-join-lines)
  ("=" ialign)
  (":" (if (derived-mode-p 'prog-mode)
           (if (nth 4 (syntax-ppss))
               (fill-paragraph)
             (prog-fill))
         (fill-paragraph)))
  ("<tab>" (let* ((region (region-active-p))
                  (begin (if region
                            (region-beginning)
                          (point-min)))
                 (end (if region
                          (region-end)
                        (point-max))))
             (tabify begin end)
             (indent-region begin end)))
  ("<backtab>" (let* ((region (region-active-p))
                      (begin (if region
                                 (region-beginning)
                               (point-min)))
                      (end (if region
                               (region-end)
                             (point-max))))
                 (untabify begin end)
                 (indent-region begin end)))

  ("t" (cpped-translate-word-or-region nil t))
  ("y" synosaurus-choose-and-replace)
  ("." howdoi-query-line-at-point-replace-by-code-snippet)
  ("l" flyspell-auto-correct-previous-word)
  ("s" cpped-hydra-edit-sort/body :exit t)
  ("x" cpped-hydra-edit-transpose/body :exit t)
  ("k" epa-encrypt-region :exit t)
  ("K" epa-decrypt-region :exit t)

  ("6" base64-encode-region)
  ("&" base64-decode-region)

  ("/" comment-dwim-2)
  ("f" cpped-hydra-refactor/body :exit t)
  ("e" (if (region-active-p)
           (eval-region (region-beginning) (region-end))
         (eval-last-sexp)))
  ("E" (if (region-active-p)
           (let* ((beginning (region-beginning))
                  (end (region-end))
                  (expression (buffer-substring-no-properties beginning end)))
             (kill-region beginning end)
             (eval-expression (car (read-from-string (format "(progn %s)" expression))) t))
           (crux-eval-and-replace)))
  ("o" org-babel-demarcate-block))

(global-set-key (kbd "C-e") 'cpped-hydra-edit/body)
#+END_SRC

*** Indent new lines
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "RET") 'newline-and-indent)
(global-set-key (kbd "<C-return>") 'cpped-newline-after-current-line)
#+END_SRC

*** Undo/Redo
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "C-z") #'undo-tree-undo)
(global-set-key (kbd "C-S-z") #'undo-tree-redo)
(global-set-key (kbd "M-z") #'undo-tree-visualize)
#+END_SRC

*** Kill/yank
Insert at position
#+BEGIN_SRC emacs-lisp
(cua-selection-mode 1)
(delete-selection-mode 0)
(setq cua-global-mark-keep-visible nil)

(global-set-key (kbd "C-M-y") #'cua-toggle-global-mark)

(defun cpped-yank-to-global-mark (prefix)
  (interactive "P")
  (if cua--global-mark-active
      (with-current-buffer (marker-buffer cua--global-mark-marker)
        (goto-char (marker-position cua--global-mark-marker))
        (yank)
        (cua--activate-global-mark)
        (message "Copied to global mark in %s:%d"
	         (buffer-name (marker-buffer cua--global-mark-marker))
	         (marker-position cua--global-mark-marker)))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-copy (:exit t :hint nil)
  "
☰ Copy

Copy                     ^^Other
  _k_: line or region        _a_: Append next copy
  _K_: line (back)
  _w_: word
  _W_: word (back)
  _s_: sentence
  _S_: sentence (back)
  _x_: expression
  _X_: expression (back)
  _e_: enclosed area
"
  ("k" whole-line-or-region-kill-ring-save :exit nil)
  ("K" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (cpped-backward-kill-dwim)
         (cpped-yank-to-global-mark)))
  ("w" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (kill-word 1)
         (cpped-yank-to-global-mark)))
  ("W" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (backward-kill-word 1)
         (cpped-yank-to-global-mark)))
  ("s" (let ((kill-read-only-ok t)
           (buffer-read-only t))
         (kill-sentence)
         (cpped-yank-to-global-mark)))
  ("S" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (backward-kill-sentence)
         (cpped-yank-to-global-mark)))
  ("x" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (kill-sexp)
         (cpped-yank-to-global-mark)))
  ("X" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (backward-kill-sexp)
         (cpped-yank-to-global-mark)))
  ("e" (let ((kill-read-only-ok)
             (buffer-read-only t))
         (call-interactively 'change-inner)
         (cpped-yank-to-global-mark)))
  ("a" append-next-kill :exit nil))

(global-set-key (kbd "M-w") '(lambda(prefix)
                               (interactive "P")
                               (call-interactively #'whole-line-or-region-kill-ring-save)
                               (cpped-yank-to-global-mark prefix)))
(global-set-key (kbd "M-k") #'cpped-hydra-copy/whole-line-or-region-kill-ring-save)

(defhydra cpped-hydra-kill (:exit t :hint nil)
  "
☰ Cut / Delete

Cut                   ^^Delete                               ^^Other
  _k_: line or region     _SPC_: limit to one space              _a_: Append next kill
  _K_: line (back)        _C-SPC_: blank lines
  _w_: word               _d_: Duplicate lines
  _W_: word (back)        _r_: Lines not matching expression
  _s_: sentence
  _S_: sentence (back)
  _x_: expression
  _X_: expression (back)
  _e_: enclosed area
"
  ("k" whole-line-or-region-kill-region :exit nil)
  ("K" (progn
         (cpped-backward-kill-dwim)
         (cpped-yank-to-global-mark)))
  ("w" (progn
         (kill-word)
         (cpped-yank-to-global-mark)))
  ("W" (progn
         (backward-kill-word)
         (cpped-yank-to-global-mark)))
  ("s" (progn
         (kill-sentence)
         (cpped-yank-to-global-mark)))
  ("S" (progn
         (backward-kill-sentence)
         (cpped-yank-to-global-mark)))
  ("x" (progn
         (kill-sexp)
         (cpped-yank-to-global-mark)))
  ("X" (progn
         (backward-kill-sexp)
         (cpped-yank-to-global-mark)))
  ("e" (progn
         (change-inner)
         (cpped-yank-to-global-mark)))
  ("SPC" just-one-space)
  ("C-SPC" delete-blank-lines)
  ("d" delete-duplicate-lines)
  ("r" keep-lines)
  ("a" append-next-kill :exit nil))

(global-set-key (kbd "C-w") '(lambda(prefix)
                               (interactive "P")
                               (call-interactively #'whole-line-or-region-kill-region)
                               (cpped-yank-to-global-mark prefix)))
(global-set-key (kbd "C-k") #'cpped-hydra-kill/body)

(defhydra cpped-hydra-yank (:hint nil :exit nil)
  "Yank"
  ("C-y" yank :exit nil)
  ("M-y" helm-show-kill-ring :exit t))

(global-set-key (kbd "C-y") #'cpped-hydra-yank/yank)
(global-set-key (kbd "M-y") #'helm-show-kill-ring)

(with-eval-after-load "term"
  (define-key term-raw-map (kbd "C-c C-y") 'term-paste)
  (define-key term-raw-map (kbd "C-c M-y") (lambda ()
                                             (interactive)
                                             (term-send-raw-string (substring-no-properties (helm-show-kill-ring))))))
#+END_SRC

** Org-Mode
*** Structure templates
#+BEGIN_SRC emacs-lisp
(defun cpped-org-expand-template (shortcut)
  "Expand org structure templates."
  (org-insert-structure-template (cdr (assoc shortcut org-structure-template-alist))))

(defhydra cpped-hydra-org-structure-template (:exit t :hint nil)
  "
☰ Structure templates

Format          ^^Markup         ^^Script            ^^Diagram        ^^Other
  _c_: Center       _a_: ASCII       _l_: Emacs Lisp     _d_: Dot         _*_: Calculator
  _e_: Example      _h_: HTML        _z_: Zsh            _u_: UML
  _q_: Quote        _/_: Comment     _+_: C++            _p_: Gnuplot
  _v_: Verbatim                    ^^_b_: Bash
                                 ^^^^_s_: Shell
                                 ^^^^_r_: Source
"
  ("c" (cpped-org-expand-template "c"))
  ("e" (cpped-org-expand-template "e"))
  ("q" (cpped-org-expand-template "q"))
  ("v" (cpped-org-expand-template "v"))
  ("a" (cpped-org-expand-template "a"))
  ("h" (cpped-org-expand-template "h"))
  ("/" (cpped-org-expand-template "/"))
  ("l" (cpped-org-expand-template "l"))
  ("z" (cpped-org-expand-template "z"))
  ("+" (cpped-org-expand-template "+"))
  ("b" (cpped-org-expand-template "b"))
  ("s" (cpped-org-expand-template "s"))
  ("r" (cpped-org-expand-template "r"))
  ("d" (cpped-org-expand-template "d"))
  ("u" (cpped-org-expand-template "u"))
  ("p" (cpped-org-expand-template "p"))
  ("*" (cpped-org-expand-template "*")))

(define-key org-mode-map (kbd "#") (lambda ()
                                     (interactive)
                                     (if (looking-back "^")
                                         (cpped-hydra-org-structure-template/body)
                                       (self-insert-command 1))))
#+END_SRC

** PDF-View-Mode
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "pdf-tools"
  (progn
    (defhydra cpped-hydra-pdf-view (:exit nil :hint nil)
      "
☰ PDF

Navigation           ^^Zoom                 ^^Annotations               ^^Information
  _p_: Previous page     _+_: Zoom in           _l_: List                   _m_: Show metadata
  _n_: Next page         _-_: Zoom out          _._: List attachments

  _a_: First page        _f_: Fit to page       _t_: Add text
  _e_: Last page         _w_: Fit to width      _#_: Highlight
                       ^^_h_: Fit to height     _\__: Underline
  _g_: Go to page                             ^^_~_: Squiggly underline
                                            ^^^^_/_: Strikethrough
  _o_: Show outline
                                            ^^^^_d_: Delete
"
      ("p" pdf-view-previous-page)
      ("<prior>" pdf-view-previous-page)
      ("n" pdf-view-next-page)
      ("<next>" pdf-view-next-page)
      ("a" pdf-view-first-page)
      ("<home>" pdf-view-first-page)
      ("e" pdf-view-last-page)
      ("<end>" pdf-view-last-page)
      ("g" pdf-view-goto-page)
      ("o" pdf-outline)

      ("+" pdf-view-enlarge)
      ("-" pdf-view-shrink)
      ("f" pdf-view-fit-page-to-window)
      ("w" pdf-view-fit-width-to-window)
      ("h" pdf-view-fit-height-to-window)

      ("l" pdf-annot-list-annotations)
      ("." pdf-annot-attachment-dired)
      ("t" pdf-annot-add-text-annotation)
      ("#" pdf-annot-add-highlight-markup-annotation)
      ("_" pdf-annot-add-underline-markup-annotation)
      ("~" pdf-annot-add-squiggly-markup-annotation)
      ("/" pdf-annot-add-strikeout-markup-annotation)
      ("d" pdf-annot-delete)

      ("m" (if (get-buffer "*PDF-Metadata*")
               (kill-buffer "*PDF-Metadata*")
             (pdf-misc-display-metadata))))

    (add-hook 'pdf-view-mode-hook 'cpped-hydra-pdf-view/body)))
#+END_SRC

** DocView-Mode
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-doc-view (:exit nil :hint nil)
  "
☰ Document

Navigation           ^^Zoom
  _p_: Previous page     _+_: Zoom in
  _n_: Next page         _-_: Zoom out

  _a_: First page        _f_: Fit to page
  _e_: Last page         _w_: Fit to width
                       ^^_h_: Fit to height
  _g_: Go to page
"
  ("p" doc-view-previous-page)
  ("<prior>" doc-view-previous-page)
  ("n" doc-view-next-page)
  ("<next>" doc-view-next-page)
  ("a" doc-view-first-page)
  ("<home>" doc-view-first-page)
  ("e" doc-view-last-page)
  ("<end>" doc-view-last-page)
  ("g" doc-view-goto-page)

  ("+" doc-view-enlarge)
  ("-" doc-view-shrink)
  ("f" doc-view-fit-page-to-window)
  ("w" doc-view-fit-width-to-window)
  ("h" doc-view-fit-height-to-window))

(add-hook 'doc-view-minor-mode-hook 'cpped-hydra-doc-view/body)

;(define-key doc-view-mode-map (kbd "C-s") #'doc-view-search)
#+END_SRC

** Logview-Mode
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-logview (:exit nil :hint nil :foreign-keys run)
  "
☰ Log

Navigation                      ^^Levels                       ^^Filter
  _p_: Previous entry               _1_: Errors                    _f_: Edit
  _n_: Next entry                   _2_: Warnings                  _x_: Reset
                                  ^^_3_: Information
  _P_: Previous important entry     _4_: Debug                     _h_: Hide entries
  _N_: Next important entry         _5_: All                       _s_: Show entries

                                  ^^_+_: Show all as important     _d_: Toggle details
"
  ("n" logview-next-entry)
  ("p" logview-previous-entry)
  ("N" logview-next-as-important-entry)
  ("P" logview-previous-as-important-entry)
  ("1" logview-show-only-errors)
  ("2" logview-show-errors-and-warnings)
  ("3" logview-show-errors-warnings-and-information)
  ("4" logview-show-errors-warnings-information-and-debug)
  ("5" logview-show-all-levels)
  ("+" logview-show-only-as-important)
  ("f" logview-edit-filters)
  ("x" logview-reset-all-filters)
  ("h" logview-hide-entry)
  ("s" (if (region-active-p)
           (logview-show-entries)
         (logview-show-region-entries)))
  ("d" (if (region-active-p)
           (logview-toggle-entry-details)
         (logview-toggle-region-entry-details)))
  ("q" cpped-kill-default-buffer :exit t)
  ("ESC" cpped-kill-default-buffer :exit t))

(add-hook 'logview-mode-hook 'cpped-hydra-logview/body)
#+END_SRC

** Remote
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-remote (:exit t :columns 1)
  "
☰ Remote
"
  ("t" cpped-serial-terminal "Serial Terminal")
  ("s" helm-tramp "Remote Shell"))

(global-set-key (kbd "C-r") 'cpped-hydra-remote/body)

(defun shark-bytes/zoom-in ()
  "Increase the font size by 10 points."
  (interactive)
  (cond ((and (boundp 'doc-view-mode)
              (derived-mode-p 'doc-view-mode))
         (doc-view-enlarge))
        ((and (boundp 'pdf-view-mode)
              (derived-mode-p 'pdf-view-mode))
         (pdf-view-enlarge))
        (t
         (set-face-attribute 'default nil :height (+ (face-attribute 'default :height) 10)))))

(defun shark-bytes/zoom-out ()
  "Decrease the font size by 10 points."
  (interactive)
  (cond ((and (boundp 'doc-view-mode)
           (derived-mode-p 'doc-view-mode))
         (doc-view-shrink))
        ((and (boundp 'pdf-view-mode)
              (derived-mode-p 'pdf-view-mode))
         (pdf-view-shrink))
        (t
         (set-face-attribute 'default nil :height (- (face-attribute 'default :height) 10)))))
#+END_SRC

** Windows
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-windows (:exit nil :hint nil)
  "
☰ Window Management

Focus                  ^^^^Close                ^^Split               ^^Align               ^^View                                ^^Zoom               ^^Size                    ^^Misc
  _\\^_: Switch window       _x_: Window            ^_v_: Vertically       _t_: Swap windows     _<left>_: Scroll left                 _C-+_: Zoom in       _f_: Toggle fullscreen    _l_: Lock screen
                         ^^^^_X_: Other windows     _h_: Horizontally     _+_: Enlarge         _<right>_: Scroll right                _C--_: Zoom out
                         ^^^^_q_: Frame                                 ^^_-_: Shrink           _<C-up>_: Scroll other window up
                                                                                    ^^^^^^^^^^_<C-down>_: Scroll other window down
                                                                                    ^^^^^^^^^^_<C-home>_: Beginning of other window
                                                                                     ^^^^^^^^^^_<C-end>_: End of other window
                                                                                           ^^^^^^^^^^_1_: Toggle line numbers
                                                                                           ^^^^^^^^^^_#_: Toggle relative line numbers
                                                                                           ^^^^^^^^^^_w_: Widen
"
  ("x" delete-window :exit t)
  ("X" delete-other-windows :exit t)
  ("^" (call-interactively #'switch-window) :exit t)
  ("q" cpped-close-editor)
  ("v" split-window-below)
  ("h" split-window-right)
  ("t" crux-transpose-windows)
  ("+" enlarge-window-horizontally)
  ("-" shrink-window-horizontally)
  ("<left>" scroll-left)
  ("<right>" scroll-right)
  ("<up>" scroll-up)
  ("<down>" scroll-down)
  ("<home>" beginning-of-buffer)
  ("<end>" end-of-buffer)
  ("<C-up>" scroll-other-window)
  ("<C-down>" scroll-other-window-down)
  ("<C-home>" beginning-of-buffer-other-window)
  ("<C-end>" end-of-buffer-other-window)
  ("1" display-line-numbers-mode)
  ("#" (if (eq display-line-numbers 'relative)
           (setq display-line-numbers t)
         (setq display-line-numbers 'relative)))
  ("w" widen)
  ("f" toggle-frame-fullscreen :exit t)
  ("l" cpped-lock-screen :exit t))

(global-set-key (kbd "C-^") #'cpped-hydra-windows/body)
(global-set-key (kbd "C-x C-c") #'cpped-close-editor)
#+END_SRC

** Settings
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "ob-tangle"
(defun cpped-check-emacs-config ()
  "Test if emacs starts correctly."
  (interactive)
  (require 'async)
  (async-start (lambda ()
                 (shell-command-to-string (format "emacs --quick --batch --eval \"(condition-case e
                                                                              (progn
                                                                                (load \\\"%s\\\")
                                                                                (message \\\"-OK-\\\"))
                                                                              (error
                                                                                (message \\\"ERROR!\\\")
                                                                                (signal (car e) (cdr e))))\""
                                                  (let ((kill-buffer-query-functions))
                                                    (with-temp-buffer
                                                      (insert-file-contents (expand-file-name cpped-config-file))
                                                      (beginning-of-buffer)
                                                      (mapcar #'expand-file-name (org-babel-tangle nil (expand-file-name (make-temp-name "emacs-config-test") temporary-file-directory)))))))
                 `(lambda (output)
                    (if (string-match "-OK-" output)
                        (when ,(called-interactively-p 'any)
                          (message "Config file is valid."))
                      (switch-to-buffer-other-window "*Config Error*")
                      (delete-region (point-min) (point-max))
                      (insert output)
                      (search-backward "ERROR!")))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-settings (:exit t :hint nil)
  "
☰ Settings

Settings                       ^^Projects                      ^^Snippets            ^^Abbreviations
  _c_: Open config file            _t_: Edit Treemacs projects     _Y_: New snippet      _A_: New abbreviation
  _m_: Open customization file                                   ^^_y_: Edit snippet     _a_: Edit abbreviations
  _t_: Edit theme
  _v_: Customize variable
  _g_: Customize group

  _s_: Set variable

  _#_: Profile startup

  _d_: %s(if debug-on-error
             \"Disable\"
           \"Enable\") debug on error
"
  ("c" (find-file cpped-config-file))
  ("m" (find-file custom-file))
  ("y" yas-visit-snippet-file)
  ("Y" yas-new-snippet)
  ("a" edit-abbrevs)
  ("A" add-inverse-global)
  ("t" (custom-theme-visit-theme cpped-theme))
  ("v" customize-variable)
  ("g" customize-group)
  ("s" set-variable)
  ("d" (setq debug-on-error (not debug-on-error)
             eval-expression-debug-on-error (not eval-expression-debug-on-error)))
  ("#" esup)

  ("t" treemacs-edit-workspaces))

(global-set-key (kbd "C-S-s") #'cpped-hydra-settings/body)
#+END_SRC

** Help
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-help (:exit t :columns 1)
  "
☰ Help
"
  ("h" helm-apropos "Help")
  ("k" describe-key "Key")
  ("p" finder-commentary "Package")
  ("y" describe-syntax "Syntax")
  ("m" helm-man-woman "Man Page")
  ("i" info "Info Page"))

(global-set-key (kbd "C-h") #'helpful-at-point)
(global-set-key (kbd "C-S-h") #'cpped-hydra-help/body)
#+END_SRC

** Tools
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-tools-docker (:exit t :hint nil)
  "
☰ Docker

  _i_: Images
  _c_: Containers
  _v_: Volumes
  _n_: Networks
  _m_: Machines
"
  ("i" docker-images)
  ("c" docker-containers)
  ("v" docker-volumes)
  ("n" docker-networks)
  ("m" docker-machines)
  ("l" docker-container-logs-popup))

(defhydra cpped-hydra-tools (:exit t :hint nil)
  "
☰ Tools

Tools                      ^^Last Command    ^^System
  _c_: Calculator              _r_: Repeat       _a_: Run application
  _u_: Convert unit            _f_: Resume       _p_: Show processes
  _b_: Bookmarks                               ^^_s_: Show system services
  _x_: Regex Builder                           ^^_P_: Manage system packages
  _e_: Evaluate expression                     ^^_d_: Docker
  _/_: Open directory                          ^^_t_: Trash

_=_: Directory Diff
"
  ("c" helm-calcul-expression)
  ("u" helm-convert-unit)
  ("b" helm-bookmarks)
  ("x" re-builder)
  ("e" eval-expression)
  ("/" dired)
  ("=" ztree-diff)
  ("r" repeat)
  ("f" (let ((current-prefix-arg '(4)))
         (call-interactively 'helm-resume)))
  ("a" cpped-run-application)
  ("p" helm-top)
  ("s" helm-systemd)
  ("P" helm-system-packages)
  ("d" cpped-hydra-tools-docker/body)
  ("t" trashed))

(global-set-key (kbd "C-t") #'cpped-hydra-tools/body)
#+END_SRC

*** Docker
**** Images
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-docker-images (:exit nil :hint nil :foreign-keys run)
  "
☰ Docker Images

              ^^Sync        ^^Info
  _r_: Run        _f_: Pull     _ß_: Inspect
              ^^^^_p_: Push
  _k_: Remove     _t_: Tag
"
  ("r" docker-images-run-popup)
  ("k" docker-images-rmi-popup)
  ("f" docker-images-pull-popup)
  ("p" docker-images-push-popup)
  ("t" docker-images-tag-entry)
  ("ß" docker-images-inspect-popup)
  ("q" nil :exit t))

(add-hook 'docker-images-mode-hook 'cpped-hydra-docker-images/body)
#+END_SRC

**** Containers
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-docker-containers (:exit nil :hint nil :foreign-keys run)
  "
☰ Docker Containers

Run            ^^Info
  _s_: Start       _ß_: Inspect
  _t_: Stop        _d_: Diff
  _p_: Pause
  _r_: Restart
  _k_: Kill
"
  ("s" docker-containers-start-popup)
  ("t" docker-containers-stop-popup)
  ("p" docker-containers-pause-popup)
  ("r" docker-containers-restart-popup)
  ("k" docker-containers-kill-popup)
  ("ß" docker-containers-inspect-popup)
  ("d" docker-containers-diff-popup)
  ("q" nil :exit t))

(add-hook 'docker-containers-mode-hook 'cpped-hydra-docker-containers/body)
#+END_SRC

**** Machines
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-docker-machines (:exit nil :hint nil :foreign-keys run)
  "
☰ Docker Machines

              ^^Run           ^^Info
  _c_: Create    _s_: Start       _ß_: Inspect
               ^^_t_: Stop        _e_: Environment
  _k_: Remove    _r_: Restart
"
  ("c" docker-machine-create)
  ("k" docker-machine-rm-popup)
  ("s" docker-machine-start-popup)
  ("t" docker-machine-stop-popup)
  ("r" docker-machine-restart-popup)
  ("ß" docker-machine-inspect)
  ("e" docker-machine-env-popup)
  ("q" nil :exit t))

(add-hook 'docker-machines-mode-hook 'cpped-hydra-docker-machines/body)
#+END_SRC

** Build
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-build (:exit t :columns 1)
  "
☰ Build 🞋 %s(if cpped-cmake-current-target
     cpped-cmake-current-target
    \"none\")
"
  ("t" cpped-cmake-select-target "Select Target")
  ("b" cpped-build-target "Build target")
  ("B" (let ((cpped-cmake-current-target nil))
         (call-interactively #'cpped-build-target)) "Select and build target")
  ("c" cpped-cmake-clean-build-directory "Clean build directory"))

(global-set-key (kbd "C-b") #'cpped-hydra-build/body)
#+END_SRC

** Planning
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-planning (:exit t :hint nil)
  "
☰ Planning %s(s-join \" \" (list (cpped-print-time) (cpped-print-remaining-work-time) (cpped-print-current-task)))

Open                ^^Create       ^^Work         ^^Task                        ^^Timesheet
  _a_: Agenda           _c_: Entry     _b_: Break     _r_: Clock in recent task     _d_: Daily Scrum
  _u_: Current Task                               ^^^^_i_: Clock in                 _D_: Today
                                                ^^^^^^_o_: Clock out                _m_: This Month
  _t_: ToDos                                      ^^^^_E_: Set estimate             _y_: This Year
  _b_: Bugs                                       ^^^^_+_: Increase estimate
  _n_: Notes
  _e_: Events
"
  ("a" (org-agenda nil "D"))
  ("u" org-clock-goto)
  ("t" (find-file org-default-todos-file))
  ("b" (find-file org-default-bugs-file))
  ("n" (find-file org-default-notes-file))
  ("e" (find-file org-default-events-file))

  ("c" helm-org-capture-templates)

  ("b" (cpped-lock-screen))

  ("r" org-mru-clock-in)
  ("i" org-clock-in)
  ("o" org-clock-out)
  ("E" (when (and (org-clocking-p)
                  org-clock-marker)
         (with-current-buffer (marker-buffer org-clock-marker)
           (goto-char (marker-position org-clock-marker))
           (org-set-effort (helm :sources (helm-build-sync-source "Effort"
                                            :candidates (split-string (cdr (assoc 'Effort_ALL org-global-properties)) " "))
                                 :prompt "Effort: "
                                 :preselect org-clock-effort
                                 :buffer "*helm effort*")))))
  ("+" (when (and (org-clocking-p)
                  org-clock-marker)
         (with-current-buffer (marker-buffer org-clock-marker)
           (goto-char (marker-position org-clock-marker))
           (org-set-effort nil t))))

  ("d" (org-agenda nil "d"))
  ("D" (org-agenda nil "D"))
  ("m" (org-agenda nil "p"))
  ("y" (org-agenda nil "y")))

(global-set-key (kbd "C-l") #'cpped-hydra-planning/body)
#+END_SRC

#+BEGIN_SRC emacs-lisp
#+END_SRC
