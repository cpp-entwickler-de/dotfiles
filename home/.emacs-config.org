#+TITLE: Emacs config
#+OPTIONS: toc:4
#+PROPERTY: header-args :results silent :tangle yes :comments yes
#+STARTUP: showeverything

* Custom configuration
#+BEGIN_SRC emacs-lisp
(load "~/.emacs.user" t t)
#+END_SRC

* Package Management
** [[https://github.com/tarsius/auto-compile][Automatically compile packages]]
Do not load outdated byte code
#+BEGIN_SRC emacs-lisp
(setq load-prefer-newer t)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package auto-compile
  :custom
  (auto-compile-ding nil)
  (auto-compile-display-buffer nil)
  (auto-compile-use-mode-line nil)
  :config
  (auto-compile-on-load-mode)
  (auto-compile-on-save-mode))
#+END_SRC

** Use Quelpa
#+BEGIN_SRC emacs-lisp
(use-package quelpa
  :after use-package
  :demand t
  :custom
  (quelpa-build-verbose nil)
  (quelpa-stable-p nil)
  (quelpa-upgrade-p t)
  (quelpa-verbose nil))

(use-package quelpa-use-package
  :after quelpa
  :demand t
  :config (quelpa-use-package-activate-advice))
#+END_SRC

** [[https://github.com/rranelli/auto-package-update.el][Automatically update packages]]
#+BEGIN_SRC emacs-lisp 
(defvar cpped-auto-update-packages nil "Enable auto-updating of packages.")

(if cpped-auto-update-packages
    (use-package auto-package-update
      :hook (after-make-frame-functions . (lambda (_)
                                            (auto-package-update-maybe)))
      :custom
      (auto-package-update-interval 14)
      (auto-package-update-delete-old-versions t)))
#+END_SRC

** [[https://github.com/Malabarba/paradox/][Paradox]]
#+BEGIN_SRC emacs-lisp
(use-package paradox
  :config
  (setq paradox-execute-asynchronously t
        paradox-display-star-count nil)
  (paradox-enable))
#+END_SRC

** [[https://github.com/jabranham/system-packages][System packages]]
#+BEGIN_SRC emacs-lisp
(require 'tramp)
(use-package system-packages
  :after tramp
  :custom (system-packages-noconfirm t)
  :config
  (defun cpped-run-command-sync-logged (wrapped-function &rest arguments)
    "Run a command synchronously and return the output."
    (shell-command-to-string (car arguments)))
  (defun cpped-install-system-package (package &rest arguments)
    "Wrapper around system-packages-install to install only missing packages."
    (let ((system-packages-packagemanager (or (plist-get arguments :package-manager)
                                              system-packages-packagemanager)))
      (advice-add 'async-shell-command :around #'cpped-run-command-sync-logged)
      (if (not (or (executable-find (or (plist-get arguments :executable)
                                        package))
                   (string-match (concat ".*" package ".*") (system-packages--run-command 'list-installed-packages nil package))))
          (progn
            (message (concat "Installing system package '" package "'."))
            (system-packages-install package))
        (message (concat "System package '" package "' is already installed. Skipping.")))
      (advice-remove 'async-shell-command #'cpped-run-command-sync-logged))
    nil)
  (add-to-list 'system-packages-supported-package-managers
               '(dnf .
                     ((default-sudo . t)
                      (install . "dnf install --assumeyes")
                      (search . "dnf search")
                      (uninstall . "dnf remove --assumeyes")
                      (update . ("dnf upgrade --assumeyes"))
                      (clean-cache . "dnf clean all --assumeyes")
                      (log . "dnf history")
                      (get-info . "rpm -qi")
                      (get-info-remote . "dnf info")
                      (list-files-provided-by . "rpm -ql")
                      (verify-all-packages . "rpm -Va")
                      (verify-all-dependencies . "dnf repoquery --requires")
                      (remove-orphaned . "dnf autoremove")
                      (list-installed-packages . "dnf list --installed")
                      (list-installed-packages-all . nil)
                      (list-dependencies-of . "rpm -qR"))))
  (add-to-list 'system-packages-supported-package-managers
               '(pip .
                     ((default-sudo . t)
                      (install . "pip3 install")
                      (search . "pip3 search")
                      (uninstall . "pip3 uninstall")
                      (update . nil)
                      (clean-cache . nil)
                      (log . nil)
                      (get-info . nil)
                      (get-info-remote . nil)
                      (list-files-provided-by . nil)
                      (verify-all-packages . nil)
                      (verify-all-dependencies . nil)
                      (remove-orphaned . nil)
                      (list-installed-packages . "pip3 list")
                      (list-installed-packages-all . nil)
                      (list-dependencies-of . nil)))
               t)
  (cpped-install-system-package "python3-pip" :executable "pip3")
  (add-to-list 'system-packages-supported-package-managers
               '(npm .
                     ((default-sudo . t)
                      (install . "npm --global install")
                      (search . "npm --global search")
                      (uninstall . "npm --global uninstall")
                      (update . "npm --global update")
                      (clean-cache . "npm --global cache clean")
                      (log . nil)
                      (get-info . nil)
                      (get-info-remote . nil)
                      (list-files-provided-by . nil)
                      (verify-all-packages . nil)
                      (verify-all-dependencies . nil)
                      (remove-orphaned . nil)
                      (list-installed-packages . "npm --global list")
                      (list-installed-packages-all . nil)
                      (list-dependencies-of . nil)))
               t)
  (cpped-install-system-package "npm")
  (add-to-list 'system-packages-supported-package-managers
               '(gem .
                     ((default-sudo . nil)
                      (install . "gem install")
                      (search . "gem query")
                      (uninstall . "gem uninstall")
                      (update . "gem update")
                      (clean-cache . "npm cache clean")
                      (log . nil)
                      (get-info . "gem query")
                      (get-info-remote . "gem search")
                      (list-files-provided-by . nil)
                      (verify-all-packages . nil)
                      (verify-all-dependencies . nil)
                      (remove-orphaned . nil)
                      (list-installed-packages . "gem list")
                      (list-installed-packages-all . nil)
                      (list-dependencies-of . "gem dependency")))
               t)
  (cpped-install-system-package "rubygems" :executable "gem"))
#+END_SRC

* Internals
** Include cl package
#+BEGIN_SRC emacs-lisp
(use-package cl)
#+END_SRC

** Utilities
#+BEGIN_SRC emacs-lisp
(defun cpped-word-or-region-bounds()
  "Get the bounds of the current region or word under point."
  (if (use-region-p)
      (cons (region-beginning) (region-end))
    (bounds-of-thing-at-point 'word)))
#+END_SRC

* User Interface
** Startup
*** Disable startup screen
#+BEGIN_SRC emacs-lisp
(setq inhibit-startup-screen t)
#+END_SRC

*** Disable startup message
#+BEGIN_SRC emacs-lisp
(when (boundp 'username)
  (setq inhibit-startup-echo-area-message username))
#+END_SRC

*** Fullscreen
#+BEGIN_SRC emacs-lisp
(set-frame-parameter nil 'fullscreen 'fullboth)
#+END_SRC

** Frame Setup
Show normal for single monitor, fullscreen on right side on dual-monitor
#+BEGIN_SRC emacs-lisp
(defvar cpped-is-dual-monitor nil "Indicates if a dual monitor setup is available.")

(add-hook 'before-make-frame-hook '(lambda ()
                                     (setq default-frame-alist `((title . "IDE")
                                                                 (name . "IDE")))
                                     (let* ((screen-width (x-display-pixel-width))
                                            (screen-height (x-display-pixel-height))
                                            (aspect-ratio (/ screen-width screen-height)))
                                       (when (> aspect-ratio 2) ; dual-monitor-setup
                                         (setq cpped-is-dual-monitor t)
                                         (push `(left . ,screen-width) default-frame-alist)
                                         (push `(width . ,(/ screen-width 2)) default-frame-alist)
                                         (push '(fullscreen . fullboth) default-frame-alist)))))
#+END_SRC

Show below other windows
#+BEGIN_SRC emacs-lisp
(defun cpped-move-frame-below-others (&optional frame)
  "Move frame below others in window system."
  (interactive)
  (with-selected-frame (or frame (selected-frame))
    (when (and window-system
               cpped-is-dual-monitor)
      (x-send-client-message nil 0 nil "_NET_WM_STATE" 32 '(1 "_NET_WM_STATE_BELOW" 0)))))

(add-hook 'after-make-frame-functions #'cpped-move-frame-below-others t)
#+END_SRC

** Do not auto-raise minibuffer
#+BEGIN_SRC emacs-lisp
(setq minibuffer-auto-raise nil)
#+END_SRC

** GTK+ interface
*** Disable Menus, Toolbars, Scrollbars and Dialogs
#+BEGIN_SRC emacs-lisp
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)
(setq use-file-dialog nil
      use-dialog-box nil)
#+END_SRC

*** Use GTK+ Tooltips
#+BEGIN_SRC emacs-lisp
(setq x-gtk-use-system-tooltips t)
#+END_SRC

** Notifications
#+BEGIN_SRC emacs-lisp
(use-package notifications)
#+END_SRC

** Disable bell
#+begin_src emacs-lisp
(setq ring-bell-function 'ignore)
#+end_src

** Disable messages
#+begin_src emacs-lisp
(setq inhibit-message t)
#+end_src

** Disable mouse
#+BEGIN_SRC emacs-lisp
(use-package disable-mouse
  :config (global-disable-mouse-mode))
#+END_SRC

*** Hide mouse pointer
#+BEGIN_SRC emacs-lisp
(setq make-pointer-invisible t)
#+END_SRC

*** Do not copy highlighted text to the kill ring
#+BEGIN_SRC emacs-lisp
(setq mouse-drag-copy-region nil)
#+END_SRC

** Use y/n instead of yes/no
#+BEGIN_SRC emacs-lisp
(fset 'yes-or-no-p 'y-or-n-p)
#+END_SRC

** Show keystrokes earlier
#+BEGIN_SRC emacs-lisp
(setq echo-keystrokes 0.1)
#+END_SRC

** History
#+BEGIN_SRC emacs-lisp
(use-package savehist
  :custom
  (history-length 10000)
  (history-delete-duplicates t)
  (savehist-save-minibuffer-history t)
  (savehist-additional-variables '(kill-ring
                                   search-ring
                                   regexp-search-ring
                                   extended-command-history))
  (savehist-autosave-interval 180)
  :config
  (savehist-mode t))
#+END_SRC

** Fonts
*** Set fallback font for symbols
#+BEGIN_SRC emacs-lisp
(set-fontset-font "fontset-default" 'unicode "Symbola")
#+END_SRC

*** Show pretty symbols
Disable prettification if cursor is at edge of expression
#+BEGIN_SRC emacs-lisp
(setq prettify-symbols-unprettify-at-point nil)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(add-hook 'find-file-hook (lambda ()
                            (push '("\t" . ?⇥) prettify-symbols-alist)
                            (push '("lambda" . ?λ) prettify-symbols-alist)
                            (push '("\r" . ?↵) prettify-symbols-alist)))

(global-prettify-symbols-mode)
#+END_SRC

** Faces
*** Info
#+BEGIN_SRC emacs-lisp
(defface info '((t :inherit default))
  "Face used for info text."
  :group 'basic-faces)
#+END_SRC

*** Increase/decrease font size
#+BEGIN_SRC emacs-lisp
(defun cpped-zoom-in ()
  "Increase the font size by 10 points"
  (interactive)
  (set-face-attribute 'default nil :height (+ (face-attribute 'default :height) 10)))

(defun cpped-zoom-out ()
  "Decrease the font size by 10 points"
  (interactive)
  (set-face-attribute 'default nil :height (- (face-attribute 'default :height) 10)))
#+END_SRC

** Icons
*** [[https://github.com/domtronn/all-the-icons.el][Show icons]]
#+BEGIN_SRC emacs-lisp
(defconst cpped-faicon5-data-file (expand-file-name "data-faicon5.el" user-emacs-directory) "The data file for FontAwesome 5 icon names.")

(defun cpped-update-faicon5-data ()
  (delete-file cpped-faicon5-data-file)
  (write-region "(defvar fa5-icon-alist\n'(\n" nil cpped-faicon5-data-file 'append)
  (with-current-buffer (url-retrieve-synchronously "https://raw.githubusercontent.com/FortAwesome/Font-Awesome/master/css/all.css")
    (widen)
    (goto-char 1)
    (save-match-data
      (while (search-forward-regexp (rx bol (0+ space) ".fa-" (group (+ (not (in ":")))) ":before" (0+ space) "{" (+ space) "content:" (0+ space) "\"\\" (group (+ (not (in "\""))))) nil t)
        (write-region (format "(\"%s\" . \"\\x%s\")\n" (match-string 1) (match-string 2)) nil cpped-faicon5-data-file 'append)))
    (kill-buffer))
  (write-region "\n))\n(provide 'data-faicon5)" nil cpped-faicon5-data-file 'append))

(defconst cpped-material-icon-data-file (expand-file-name "data-material-icon.el" user-emacs-directory) "The data file for material icon names.")

(defun cpped-update-material-icon-data ()
  (delete-file cpped-material-icon-data-file)
  (write-region "(defvar material-icon-alist\n'(\n" nil cpped-material-icon-data-file 'append)
  (with-current-buffer (url-retrieve-synchronously "https://raw.githubusercontent.com/google/material-design-icons/master/iconfont/codepoints")
    (widen)
    (goto-char 1)
    (save-match-data
      (while (search-forward-regexp (rx bol (0+ space) (group (+ (or (in alphanumeric) "_"))) (+ space) (group (+ (in hex-digit)))) nil t)
        (write-region (format "(\"%s\" . \"\\x%s\")\n" (match-string 1) (match-string 2)) nil cpped-material-icon-data-file 'append)))
    (kill-buffer))
  (write-region "\n))\n(provide 'data-material-icon)" nil cpped-material-icon-data-file 'append))

(use-package all-the-icons
  :config
  (unless (file-exists-p cpped-faicon5-data-file)
    (cpped-update-faicon5-data))
  (require 'data-faicon5 cpped-faicon5-data-file)
  (define-icon faicon5 fa5-icon-alist "Font Awesome 5 Free" "fa-regular-400")
  (define-icon faicon-brands fa5-icon-alist "Font Awesome 5 Brands" "fa-brands-400")
  (unless (file-exists-p cpped-material-icon-data-file)
    (cpped-update-material-icon-data))
  (require 'data-material-icon cpped-material-icon-data-file)
  (define-icon material-icon material-icon-alist "Material Icons" "MaterialIcons-Regular"))
#+END_SRC

** Theme
#+BEGIN_SRC emacs-lisp
(defvar cpped-theme 'cpp-entwickler.de "The default theme")

(load-theme cpped-theme t)
#+END_SRC

** [[https://github.com/rakanalh/emacs-dashboard][Dashboard]]
#+BEGIN_SRC emacs-lisp
(use-package dashboard
  :after helm-buffers
  :custom
  (dashboard-startup-banner (let ((image-url (with-current-buffer (url-retrieve-synchronously (format-time-string "http://dilbert.com/%Y-%m-%d"))
                                               (goto-char (point-min))
                                               (when (re-search-forward (rx "src=\"" (group "//assets.amuniversal.com/" (+ hex-digit)) "\"")
                                                                        nil t)
                                                 (setq url (concat "http:" (match-string 1))))
                                               (kill-buffer)
                                               url))
                                  (image-file (make-temp-file "emacs-dilbert" nil ".png")))
                              (when image-file
                                (url-copy-file image-url image-file t)
                                (add-hook 'kill-emacs-hook `(lambda()
                                                              (delete-file ,image-file))))
                              image-file))
  (dashboard-banner-logo-title "")
  (dashboard-page-separator "\n\n")
  (dashboard-items '((recents . 20)
                     (projects . 5)
                     (agenda . 10)))
  :config
  (push (regexp-quote dashboard-buffer-name) helm-boring-buffer-regexp-list)
  (dashboard-setup-startup-hook))
#+END_SRC

** Mode Line
*** Base Location
#+BEGIN_SRC emacs-lisp
(defun cpped-tramp-file-remote-p (file)
  "Checks if a tramp file is actually remote."
  (and (tramp-tramp-file-p file)
       (not (string-equal (tramp-file-name-host (tramp-dissect-file-name file)) "localhost"))))

(with-eval-after-load "projectile"
  (defun cpped-project-dir ()
    (interactive)
    (or (when (and (ignore-errors (projectile-project-p))
                   (fboundp 'projectile-project-root))
          (projectile-project-root))
        (when vc-mode
          (let ((backend (vc-deduce-backend)))
            (when backend
              (ignore-errors (vc-call-backend backend 'root default-directory)))))))

(defun cpped-powerline-project-id (icon-face)
    (when buffer-file-name
      (let ((project-name (if (and (ignore-errors (projectile-project-p))
                                   (fboundp 'projectile-project-name)
                                   (projectile-project-name))
                              (projectile-project-name)
                            (when vc-mode
                              (let ((backend (vc-deduce-backend)))
                                (when backend
                                  (file-name-nondirectory (directory-file-name (file-name-directory (ignore-errors (vc-call-backend backend 'root default-directory)))))))))))
        (concat
         (propertize (all-the-icons-faicon5 (cond ((not (= 0 (length project-name))) "folder")
                                                 ((and (not (cpped-tramp-file-remote-p buffer-file-name))
                                                       (string-prefix-p (getenv "HOME")
                                                                        (if (tramp-tramp-file-p buffer-file-name)
                                                                            (tramp-file-name-localname (tramp-dissect-file-name buffer-file-name))
                                                                          buffer-file-name))) "home")
                                                 ((cpped-tramp-file-remote-p buffer-file-name) "cloud")
                                                 (t "desktop")))
                                'face (list ':family (all-the-icons-faicon5-family)
                                            ':background (face-attribute icon-face :background))
                                'display '(raise -0.0))
         (let ((location (if (cpped-tramp-file-remote-p buffer-file-name)
                             tramp-current-host
                           (when (not (= 0 (length project-name)))
                             (propertize project-name
                                         'help-echo (cpped-project-dir))))))
           (unless (= 0 (length location))
               (concat " " location))))))))
#+END_SRC

*** Major mode icon
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-mode-icon (icon-face)
  (let ((icon (all-the-icons-icon-for-buffer)))
    (unless (symbolp icon)
      (propertize icon
                  'face `(:family ,(all-the-icons-icon-family-for-buffer)
                          :background ,(face-attribute icon-face :background)
                          :height 1.2)
                  'display '(raise -0.1)
                  'help-echo (format "%s" major-mode)))))
#+END_SRC

*** Buffer name
Helper function to figure out version control root directory
#+BEGIN_SRC emacs-lisp
(defvar cpped-special-buffer-names-alist nil "A list of buffer name transformations.")

(with-eval-after-load "projectile"
  (defun cpped-powerline-buffer-id (icon-face)
    (let* ((home-dir (getenv "HOME"))
           (buffer-name (let ((name (if (and buffer-file-name
                                             (tramp-tramp-file-p buffer-file-name))
                                        (tramp-file-name-localname (tramp-dissect-file-name buffer-file-name))
                                      (format-mode-line "%b"))))
                          (or (cdr (assoc name cpped-special-buffer-names-alist))
                              name)))
           (filename (when buffer-file-name
                       (file-truename buffer-name)))
           (project-root (or (cpped-project-dir)
                             (when (and filename
                                        home-dir
                                        (string-equal (substring filename 0 (length home-dir)) home-dir))
                               home-dir)))
           (relative-path (when filename
                            (file-name-directory (if project-root
                                                     (file-relative-name filename project-root)
                                                   filename))))

           (special-buffer (string-match "^\\*.*\\*?$" buffer-name)))
      (if special-buffer
          (propertize (replace-regexp-in-string "^\\*\\([^\*]*\\)\\*?$" "\\1" buffer-name)
                      'face `(:background ,(face-attribute icon-face :background)
                              :weight normal
                              :slant italic))
        (concat
         (when relative-path
           (propertize relative-path
                       'face `(:background ,(face-attribute icon-face :background)
                               :weight light)))
         (propertize (file-name-nondirectory buffer-name)
                     'face `(:background ,(face-attribute icon-face :background)
                             :weight black)))))))
#+END_SRC

*** Docker project
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "docker")

(defun cpped-powerline-docker-project (icon-face)
  (when (cpped-is-docker-project-p)
    (propertize (all-the-icons-faicon5 "docker")
                'face (list ':family (all-the-icons-faicon5-family)
                            ':background (face-attribute icon-face :background))
                'display '(raise -0.0))))
#+END_SRC

*** Git Info
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun cpped-powerline-version-control ()
    (when (magit-inside-worktree-p t)
      (let* ((branch (magit-get-current-branch))
             (branch-head (magit-rev-parse "--short" branch))
             (revision (magit-rev-parse "--short" "HEAD")))
        (concat
         (propertize (all-the-icons-octicon "git-branch")
                     'face `(:family ,(all-the-icons-octicon-family))
                     'display '(raise -0.1))
         (format " %s" branch)
         (unless (string= revision branch-head)
           (format " · %s (%s)" revision (magit-git-string "rev-list"
                                                           "--count"
                                                           (concat revision ".." branch-head)))))))))
#+END_SRC

*** Running process
#+BEGIN_SRC emacs-lisp
(defvar-local cpped-eshell-process-running nil "Flag to indicate if a process is running for the current buffer.")
(defvar-local cpped-eshell-current-command-start-time nil)

(defun cpped-get-run-time ()
  (time-subtract (current-time)
                 cpped-eshell-current-command-start-time))

(defun cpped-format-run-time (time)
  (let* ((run-time (truncate (float-time time)))
         (days (/ run-time 60 60 24))
         (hours (% (/ run-time 60 60) 24))
         (minutes (% (/ run-time 60) 60))
         (seconds (% run-time 60)))
    (concat (when (> days 0)
              (format "%d days " days))
            (when (or (> days 0)
                      (> hours 0))
              (format "%d:" hours))
            (if (or (> days 0)
                    (> hours 0))
                (format "%02d:" minutes)
              (when (> minutes 0)
                (format "%d:" minutes)))
            (if (or (> days 0)
                    (> hours 0)
                    (> minutes 0))
                (format "%02ds" seconds)
              (format "%ds" seconds)))))

(defun cpped-powerline-eshell-process-running ()
  (when cpped-eshell-process-running
    (concat (propertize "\xf085" ; cogs
                        'face `(:family ,(all-the-icons-faicon5-family))
                        'display '(raise -0.1))
            " "
            (cpped-format-run-time (cpped-get-run-time)))))
#+END_SRC

*** Show if file is remote
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-remote (icon-face)
  (when (cpped-tramp-file-remote-p default-directory)
    (propertize (all-the-icons-faicon5 "cloud")
                'face (list ':family (all-the-icons-faicon5-family)
                            ':background (face-attribute icon-face :background))
                'display '(raise -0.0))))
#+END_SRC

*** Show if file is opened in su-mode
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-su (icon-face)
  (when (string-match "^/su\\(do\\)?:" default-directory)
    (propertize (all-the-icons-faicon5 "user-plus")
                'face (list ':family (all-the-icons-faicon5-family)
                            ':foreground (face-attribute 'warning :foreground)
                            ':background (face-attribute icon-face :background))
                'display '(raise -0.0))))
#+END_SRC

*** Modification
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-modified (icon-face)
  (propertize (pcase (format-mode-line "%*")
                (`"*" (all-the-icons-faicon5 "pencil-alt"))
                (`"-"
                 (if buffer-file-name
                     (if vc-mode
                         (if (string-equal (vc-state buffer-file-name) 'edited)
                             (all-the-icons-faicon5 "save")
                           (all-the-icons-faicon5 "cloud"))
                       (all-the-icons-faicon5 "save"))
                   (all-the-icons-faicon5 "star")))
                (`"%" (all-the-icons-faicon5 "lock"))
                (_ (all-the-icons-faicon5 "question")))
              'face (list ':family (all-the-icons-faicon5-family)
                          ':background (face-attribute icon-face :background))
              'display '(raise -0.0)))
#+END_SRC

*** Auto-format
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-auto-format (icon-face)
  (when (and cpped-auto-format-enabled-p
             cpped-format-buffer-function)
    (propertize (all-the-icons-faicon5 "indent")
                'face (list ':family (all-the-icons-faicon5-family)
                            ':background (face-attribute icon-face :background))
                'display '(raise -0.0))))
#+END_SRC

*** Cursor position
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-position-info (icon-face)
  (concat
   (propertize (all-the-icons-faicon5 "arrows-alt-v")
               'face (list ':family (all-the-icons-faicon5-family)
                           ':background (face-attribute icon-face :background))
               'display '(raise -0.0))
   (format-mode-line "%4l ")
   (propertize (all-the-icons-faicon5 "arrows-alt-h")
               'face (list :family (all-the-icons-faicon5-family)
                           ':background (face-attribute icon-face :background))
               'display '(raise -0.0))
   (format-mode-line "%3c")))
#+END_SRC

*** Selected region
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-region-info (icon-face)
  (when mark-active
    (format "%s %s/%s/%s"
            (propertize (all-the-icons-faicon5 "crop")
                        'face (list ':family (all-the-icons-faicon5-family)
                                    ':background (face-attribute icon-face :background))
                        'display '(raise -0.0))
            (count-lines (region-beginning) (region-end))
            (count-words (region-end) (region-beginning))
            (- (region-end) (region-beginning)))))
#+END_SRC
*** Show if overwrite mode is active
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-overwrite-mode (icon-face)
  (when overwrite-mode
    (propertize (all-the-icons-faicon5 "eraser")
                'face (list ':family (all-the-icons-faicon5-family)
                            ':background (face-attribute icon-face :background))
                'display '(raise -0.0))))
#+END_SRC

*** Show if typo mode is active
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "typo"
  (defun cpped-powerline-typo-mode (icon-face)
    (when typo-mode
      (propertize (all-the-icons-faicon5 "book")
                  'face (list ':family (all-the-icons-faicon5-family)
                              ':background (face-attribute icon-face :background))
                  'display '(raise -0.0)))))
#+END_SRC

*** Show if buffer is narrowed
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-narrowed (icon-face)
    (when (buffer-narrowed-p)
      (propertize (all-the-icons-octicon "fold")
                  'face (list ':family (all-the-icons-octicon-family)
                              ':background (face-attribute icon-face :background))
                  'display '(raise -0.0))))
#+END_SRC

*** Show if buffer is filtered
#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-filtered (icon-face)
    (when loccur-mode
      (propertize (all-the-icons-faicon5 "filter")
                  'face (list ':family (all-the-icons-faicon5-family)
                              ':background (face-attribute icon-face :background))
                  'display '(raise -0.0))))
#+END_SRC

*** Key Lock
#+BEGIN_SRC emacs-lisp
(defvar cpped-caps-lock-active nil "Indicates if caps lock is enabled.")
(defvar cpped-num-lock-active nil "Indicates if num lock is enabled.")

(run-with-timer 0 3 '(lambda ()
                       (with-temp-buffer
                         (call-process "xset" nil t nil "q")
                         (let ((led-mask (string-to-number (save-match-data
                                                             (and (string-match ".*LED mask:[[:space:]]*\\([[:alnum:]]+\\).*" (buffer-string))
                                                                  (match-string 1 (buffer-string))))
                                                           16)))
                           (setq cpped-caps-lock-active (eq (logand led-mask 1) 1)
                                 cpped-num-lock-active (eq (logand led-mask 2) 2))))))

(defun cpped-powerline-key-lock (lock icon icon-face)
   (when lock
     (propertize (all-the-icons-faicon5 icon)
                 'face `(:family ,(all-the-icons-faicon5-family)
                         :background ,(face-attribute icon-face :background)
                         :height 1.1)
                 'display '(raise -0.0))))
#+END_SRC

*** Line/Character Mode
#+BEGIN_SRC emacs-lisp
(make-local-variable 'cpped-term-char-mode)

(advice-add 'term-char-mode :after (lambda ()
                                     (setq cpped-term-char-mode t)))

(advice-add 'term-line-mode :after (lambda ()
                                     (setq cpped-term-char-mode nil)))

(defun cpped-powerline-term-input-mode (icon-face)
  (when (and (equal major-mode 'term-mode)
             cpped-term-char-mode)
    (propertize (all-the-icons-faicon5 "terminal")
                'face `(:family ,(all-the-icons-faicon5-family)
                                :background ,(face-attribute icon-face :background)
                                :height 1.1)
                'display '(raise -0.0))))
#+END_SRC

*** Current function
Find path of current position in XML docuement
#+BEGIN_SRC emacs-lisp
(defun cpped-nxml-where ()
  "Display the hierarchy of XML elements the point is on as a path."
  (interactive)
  (let ((path nil))
    (save-excursion
      (save-restriction
        (widen)
        (while (and (< (point-min) (point))
                    (condition-case nil
                        (progn
                          (nxml-backward-up-element)
                          t)
                      (error nil)))
          (setq path (cons (xmltok-start-tag-local-name) path)))
        (if (called-interactively-p t)
            (message "/%s" (mapconcat 'identity path "/"))
          (format "/%s" (mapconcat 'identity path "/")))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-powerline-which-function (icon-face)
  (when which-function-mode
    (let ((current-function (if (equal major-mode 'nxml-mode)
                                (cpped-nxml-where)
                                (which-function))))
      (unless (= 0 (length current-function))
        (concat
         (propertize (all-the-icons-faicon5 "puzzle-piece")
                     'face (list ':family (all-the-icons-faicon5-family)
                                 ':background (face-attribute icon-face :background))
                     'display '(raise -0.0))
         " "
         current-function)))))
#+END_SRC

*** Check Status
#+BEGIN_SRC emacs-lisp
(defvar cpped-powerline-check-status-functions nil "A list of functions that format mode line status data.")

(defface cpped-check-status-info `((t :inherit info
                                      :weight ultra-bold))
  "Face used for modeline check info status."
  :group 'cpped-powerline-check-status)

(defface cpped-check-status-warning `((t :inherit warning
                                         :weight ultra-bold))
  "Face used for modeline check warning status."
  :group 'cpped-powerline-check-status)

(defface cpped-check-status-error `((t :inherit error
                                       :weight ultra-bold))
  "Face used for modeline check error status."
  :group 'cpped-powerline-check-status)

(defun cpped-powerline-check-status (face)
  "Collect check status information."
  (let ((status (mapconcat 'identity
                           (remove nil (mapcar 'funcall cpped-powerline-check-status-functions))
                           " ")))
    (add-face-text-property 0 (length status) (list ':background (face-attribute face :background)) nil status)
    status))
#+END_SRC

*** Powerline
#+BEGIN_SRC emacs-lisp
(use-package powerline
  :custom
  (powerline-default-separator 'slant)
  (powerline-display-hud nil)
  (powerline-height 20))

(defun cpped-powerline-theme ()
  "Setup the default mode-line."
  (interactive)
  (setq-default mode-line-format
                '("%e"
                  (:eval
                   (let* ((active (powerline-selected-window-active))
                          (mode-line (if active
                                         'mode-line
                                       'mode-line-inactive))
                          (face1 (if active
                                     'powerline-active1
                                   'powerline-inactive1))
                          (face2 (if active
                                     'powerline-active2
                                   'powerline-inactive2))
                          (separator-left (intern (format "powerline-%s-%s"
                                                          (powerline-current-separator)
                                                          (cdr powerline-default-separator-dir))))
                          (separator-right (intern (format "powerline-%s-%s"
                                                           (powerline-current-separator)
                                                           (car powerline-default-separator-dir))))
                          (project-id (cpped-powerline-project-id (symbol-value 'mode-line)))
                          (show-project (not (= 0 (length project-id))))
                          (version (when (fboundp 'cpped-powerline-version-control)
                                     (cpped-powerline-version-control)))
                          (current-function (cpped-powerline-which-function (symbol-value 'mode-line)))
                          (show-function (not (= 0 (length current-function))))
                          (check-status (cpped-powerline-check-status (symbol-value 'face2)))
                          (show-check-status (and check-status
                                                  (not (= (length check-status) 0))))
                          (lhs (list
                                (when show-project
                                  (powerline-raw project-id mode-line 'l))
                                (when show-project
                                  (powerline-raw (cpped-powerline-docker-project (symbol-value 'mode-line)) mode-line 'l))
                                (when show-project
                                  (funcall separator-left mode-line face1))
                                (powerline-raw (cpped-powerline-mode-icon face1) face1)
                                (powerline-raw (cpped-powerline-buffer-id face1) face1 'l)
                                (powerline-raw (cpped-powerline-eshell-process-running) face1 'l)
                                (if version
                                    (funcall separator-left face1 mode-line)
                                  (funcall separator-left face1 face2))
                                (when version
                                  (powerline-raw version mode-line))
                                (when version
                                  (funcall separator-left mode-line face2))
                                (powerline-raw (cpped-powerline-remote (symbol-value 'face2)) face2)
                                (powerline-raw (cpped-powerline-su (symbol-value 'face2)) face2 'r)
                                (powerline-raw (cpped-powerline-modified (symbol-value 'face2)) face2)
                                (powerline-raw (cpped-powerline-overwrite-mode (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-auto-format (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-typo-mode (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-narrowed (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-filtered (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-key-lock (symbol-value 'cpped-caps-lock-active) "sort-alpha-down" (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-key-lock (symbol-value 'cpped-num-lock-active) "sort-numeric-down" (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-term-input-mode (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-position-info (symbol-value 'face2)) face2 'l)
                                (powerline-raw (cpped-powerline-region-info (symbol-value 'face2)) face2 'l)
                                (when show-check-status
                                  (powerline-raw check-status face2 'l))
                                (funcall separator-left face2 mode-line)
                                (when show-function
                                  (powerline-raw current-function mode-line))
                                (powerline-raw (format-mode-line 'global-mode-string) mode-line))))
                     (concat (powerline-render lhs)))))))

(cpped-powerline-theme)
#+END_SRC

*** Update every second
#+BEGIN_SRC emacs-lisp
(run-with-timer 0 1 '(lambda()
                       (force-mode-line-update t)))
#+END_SRC

** [[https://github.com/bbatsov/projectile][Projectile]]
#+BEGIN_SRC emacs-lisp
(defvar cpped-project-directories (list "~/Projects" "~/projects") "A list of directories to check for projects.")

(use-package ag
  :after system-packages
  :custom
  (ag-arguments '("--smart-case"))
  (ag-context-lines 3)
  (ag-highlight-search t)
  (ag-project-root-function nil)
  (ag-reuse-window t)
  :config
  (cpped-install-system-package "the_silver_searcher" :executable "ag"))

(use-package projectile
  :after ag
  :custom
  (projectile-completion-system 'helm)
  (projectile-dynamic-mode-line nil)
  (projectile-enable-caching nil)
  (projectile-find-dir-includes-top-level t)
  (projectile-git-submodule-command nil)
  (projectile-idle-timer-hook nil)
  (projectile-project-search-path (remove-if (lambda (directory)
                                               (not (file-directory-p directory)))
                                             (mapcar #'expand-file-name cpped-project-directories)))
  (projectile-sort-order 'recently-active)
  (projectile-switch-project-action 'helm-projectile)
  (projectile-verbose nil)
  :config
  (projectile-global-mode))
#+END_SRC

** [[https://github.com/emacs-helm/helm][Helm UI]]
#+BEGIN_SRC emacs-lisp
(use-package helm
  :after popwin
  :bind (:map helm-map (("M-SPC" . helm-toggle-all-marks)
                        ("C-M-y" . helm-copy-to-buffer)))
  :custom
  (helm-adaptive-mode t)
  (helm-apropos-fuzzy-match t)
  (helm-buffer-max-length nil)
  (helm-buffers-fuzzy-matching t)
  (helm-candidate-number-limit 1000)
  (helm-candidate-separator "────────────────────────────────────────────────────────────────────────────────────────────────────────────────")
  (helm-case-fold-search t)
  (helm-comp-read-case-fold-search 'Ignore\ case)
  (helm-completion-in-region-fuzzy-match t)
  (helm-default-external-file-browser "dolphin")
  (helm-ff-delete-files-function 'helm-delete-marked-files-async)
  (helm-ff-file-name-history-use-recentf t)
  (helm-ff-history-max-length 1000)
  (helm-ff-initial-sort-method 'newest)
  (helm-ff-search-library-in-sexp t)
  (helm-ff-transformer-show-only-basename nil)
  (helm-file-cache-fuzzy-match t)
  (helm-find-files-ignore-thing-at-point t)
  (helm-follow-mode-persistent nil)
  (helm-google-suggest-use-curl-p t)
  (helm-grep-ignored-directories '("SCCS" "RCS" "CVS" "MCVS" ".svn" ".git" ".hg" ".bzr" "_MTN" "_darcs" "{arch}" ".gvfs" "branches" "tags"))
  (helm-imenu-fuzzy-match t)
  (helm-input-idle-delay 0.01)
  (helm-lisp-fuzzy-completion t)
  (helm-M-x-always-save-history t)
  (helm-M-x-fuzzy-match t)
  (helm-mode-fuzzy-match t)
  (helm-move-to-line-cycle-in-source t)
  (helm-occur-auto-update-on-resume 'noask)
  (helm-recentf-fuzzy-match t)
  (helm-scroll-amount 8)
  (helm-session-fuzzy-match t)
  (helm-split-window-in-side-p t)
  :config
  (cpped-install-system-package "curl")
  (advice-add 'helm-ff-filter-candidate-one-by-one
              :around (lambda (fcn file)
                        (unless (string-match "\\(?:/\\|\\`\\)\\.\\{1,2\\}\\'" file)
                          (funcall fcn file)))) ;; hide current directory/parent directory in file list
  (with-eval-after-load "popwin"
    (progn
      (push '("*helm kill ring*" :dedicated t :position bottom :height 40) popwin:special-display-config)
      (push '("*helm calcul*" :dedicated t :position bottom :height 10) popwin:special-display-config)))
  (helm-mode 1)
  (require 'helm-config))
#+END_SRC

*** Projectile Integration
#+BEGIN_SRC emacs-lisp
(use-package helm-projectile
  :after (helm projectile)
  :config (helm-projectile-on))
#+END_SRC

*** Grep
#+BEGIN_SRC emacs-lisp
(use-package helm-ag
  :after (helm ag)
  :custom
  (helm-ag-base-command "ag --smart-case --nocolor --nogroup")
  (helm-ag-use-grep-ignore-list t)
  (helm-ag-use-agignore t)
  (helm-ag-fuzzy-match t)
  (helm-ag-insert-at-point 'symbol))
#+END_SRC

*** Popwin Fix
#+BEGIN_SRC emacs-lisp
(defun cpped-popwin-help-mode-off ()
       "Turn `popwin-mode' off for *Help* buffers."
       (when (boundp 'popwin:special-display-config)
             (customize-set-variable 'popwin:special-display-config
                                     (delq 'help-mode popwin:special-display-config))))

(defun cpped-popwin-help-mode-on ()
       "Turn `popwin-mode' on for *Help* buffers."
       (when (boundp 'popwin:special-display-config)
             (customize-set-variable 'popwin:special-display-config
                                     (add-to-list 'popwin:special-display-config 'help-mode nil #'eq))))

(with-eval-after-load "popwin"
  (progn
    (add-hook 'helm-minibuffer-set-up-hook #'cpped-popwin-help-mode-off)
    (add-hook 'helm-cleanup-hook #'cpped-popwin-help-mode-on)))
#+END_SRC

** Imenu
*** Automatically rescan
#+BEGIN_SRC emacs-lisp
(set-default 'imenu-auto-rescan t)
#+END_SRC

*** Show results from all buffers
#+BEGIN_SRC emacs-lisp
(use-package imenu-anywhere
  :custom (imenu-anywhere-friendly-modes '((c-mode c++-mode cmake-mode qml-mode gtest-mode)
                                           (clojure-mode clojurex-mode clojurec-mode clojurescript-mode cider-repl-mode cider-clojure-interaction-mode)
                                           (emacs-lisp-mode inferior-emacs-lisp-mode lisp-interaction-mode)
                                           (ess-mode inferior-ess-mode)
                                           (python-mode inferior-python-mode))))
#+END_SRC

** Buffers
*** Do not adjust auto-window-vscroll
This optimizes line-scrolling.
#+BEGIN_SRC emacs-lisp
(setq auto-window-vscroll nil)
#+END_SRC

*** Disable bidirectional support
#+BEGIN_SRC emacs-lisp
(setq-default bidi-display-reordering nil)
#+END_SRC

*** Remember open buffers
#+BEGIN_SRC emacs-lisp
(defun cpped-yes (_)
  t)

(defun cpped-always-yes (wrapped-function &rest arguments)
  (advice-add 'yes-or-no-p :override #'cpped-yes)
  (advice-add 'y-or-n-p :override #'cpped-yes)
  (let ((result (apply wrapped-function arguments)))
    (advice-remove 'yes-or-no-p #'cpped-yes)
    (advice-remove 'y-or-n-p #'cpped-yes)
    result))

(use-package desktop
  :custom
  (desktop-dirname user-emacs-directory)
  (desktop-lazy-idle-delay 10)
  (desktop-lazy-verbose nil)
  (desktop-load-locked-desktop t)
  (desktop-path (list user-emacs-directory))
  (desktop-restore-eager 5)
  (desktop-restore-eager 5)
  (desktop-restore-forces-onscreen nil)
  (desktop-restore-frames t)
  :config
  (desktop-save-mode 1)
  (run-with-idle-timer 300 t '(lambda ()
                                (desktop-save user-emacs-directory)))
  (advice-add 'desktop-save :around #'cpped-always-yes)
  (advice-add 'desktop-read :around #'cpped-always-yes))
#+END_SRC

*** Go to last position when opening buffer
#+BEGIN_SRC emacs-lisp
(save-place-mode 1)
#+END_SRC

*** Buffer switching
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "helm"
  (require 'helm-buffers)
  (push "\\*Messages\\*" helm-boring-buffer-regexp-list)
  (push "\\*Warnings\\*" helm-boring-buffer-regexp-list)
  (push "\\*Completions\\*" helm-boring-buffer-regexp-list)
  (push "\\*Help\\*" helm-boring-buffer-regexp-list)
  (push "\\*compilation\\*" helm-boring-buffer-regexp-list)
  (push "\\*compile.*\\*" helm-boring-buffer-regexp-list)
  (push "\\*Compilation Log\\*" helm-boring-buffer-regexp-list))
#+END_SRC

Switch to previous buffer
#+BEGIN_SRC emacs-lisp
(defun cpped-previous-buffer ()
  (interactive)
  (switch-to-buffer (other-buffer (current-buffer) 1)))
#+END_SRC

*** [[https://github.com/ShingoFukuyama/helm-swoo][In-buffer search]]
#+BEGIN_SRC emacs-lisp
(use-package helm-swoop
  :custom (helm-swoop-use-fuzzy-match t))
#+END_SRC

*** Scratch Buffer
**** Always use text mode
#+BEGIN_SRC emacs-lisp
(setq initial-major-mode 'text-mode)
#+END_SRC

**** Start with empty scratch buffer (no message)
#+BEGIN_SRC emacs-lisp
(setq initial-scratch-message nil)
#+END_SRC

**** [[https://github.com/Fanael/persistent-scratch][Save scratch buffers between sessions]]
#+BEGIN_SRC emacs-lisp
(use-package persistent-scratch
  :config (persistent-scratch-setup-default))
#+END_SRC

*** Popup Windows
#+BEGIN_SRC emacs-lisp
(use-package popwin
  :config
  (push '("*Messages*" :dedicated t :position bottom :height 40 :tail) popwin:special-display-config)
  (push '(compilation-mode :dedicated t :position bottom :height 30) popwin:special-display-config)
  (push '(help-mode :dedicated t :position bottom :height 40) popwin:special-display-config)
  (popwin-mode 1))
#+END_SRC

*** Add path if required to make buffer name unique
#+BEGIN_SRC emacs-lisp
(setq uniquify-buffer-name-style 'forward
      uniquify-separator "/"
      uniquify-after-kill-buffer-p t
      uniquify-ignore-buffers-re "^\\*")
#+END_SRC

*** [[https://github.com/dimitri/switch-window][Use smarter window switching (numbered windows)]]
#+BEGIN_SRC emacs-lisp
(use-package switch-window
  :custom (switch-window-background t))
#+END_SRC

*** Do not show buffer boundaries in fringe
#+BEGIN_SRC emacs-lisp
(setq-default indicate-buffer-boundaries nil)
#+END_SRC

*** [[https://github.com/mina86/auto-dim-other-buffers.el][Dim inactive buffers]]
#+BEGIN_SRC emacs-lisp
(use-package auto-dim-other-buffers
  :hook (after-init . auto-dim-other-buffers-mode))
#+END_SRC

*** Use recursive minibuffer
#+BEGIN_SRC emacs-lisp
(setq enable-recursive-minibuffers t)
#+END_SRC

Indicate recursive minibuffer
#+BEGIN_SRC emacs-lisp
(minibuffer-depth-indicate-mode 1)
#+END_SRC

*** Highlight minibuffer when in use
#+BEGIN_SRC emacs-lisp
(defface cpped-minibuffer-active '((t :inherit default))
  "Face used for active minibuffer."
  :group 'basic-faces)

(add-hook 'minibuffer-setup-hook (lambda ()
                                   (make-local-variable 'face-remapping-alist)
                                   (add-to-list 'face-remapping-alist '(default cpped-minibuffer-active))))
#+END_SRC

*** Kill current buffer by default
#+BEGIN_SRC emacs-lisp
(defvar cpped-bury-buffers-list nil "A list of buffer names to bury instead of kill.")

(defun cpped-kill-default-buffer ()
  "Kill the currently active buffer."
  (interactive)
  (let ((kill-buffer-query-functions)
        (name (substring-no-properties (buffer-name))))
    (if (or (string= name "*scratch*")
            (string= name "*Messages*")
            (member name cpped-bury-buffers-list))
        (bury-buffer)
      (when (and buffer-file-name
               (buffer-modified-p))
        (save-buffer))
      (kill-buffer))))
#+END_SRC

*** Do not ask before killing buffer with running processes
#+BEGIN_SRC emacs-lisp
(setq kill-buffer-query-functions
      (remq 'process-kill-buffer-query-function
            kill-buffer-query-functions))
#+END_SRC

*** Multi-buffer kill
#+BEGIN_SRC emacs-lisp
(defvar clean-buffer-list-delay-general 1)
#+END_SRC

*** Kill unused buffers automatically
#+BEGIN_SRC emacs-lisp
(defun cpped-clean-buffer-list-delay-3hours (name)
  "Wrapper around clean-buffer-list-delay to allow delays in hours instead of days"
  (or (assoc-default name clean-buffer-list-kill-buffer-names #'string=
                     clean-buffer-list-delay-special)
      (assoc-default name clean-buffer-list-kill-regexps
                     (lambda (regex input)
                       (if (functionp regex)
                           (funcall regex input) (string-match regex input)))
                     clean-buffer-list-delay-special)
      (* 60 60)))

(fset 'clean-buffer-list-delay 'cpped-clean-buffer-list-delay-3hours)
(run-with-timer 0 (* 60 60) 'clean-buffer-list)
#+END_SRC

*** Allow erasing
#+BEGIN_SRC emacs-lisp
(put 'erase-buffer 'disabled nil)
#+END_SRC

*** Lines
**** Highlight current line
#+BEGIN_SRC emacs-lisp
(use-package hl-line
  :config
  (advice-add 'hl-line-highlight :after (lambda ()
                                          (unless (window-minibuffer-p)
	                                    (when hl-line-overlay
                                              (overlay-put hl-line-overlay 'priority 1000)))))
  (advice-add 'global-hl-line-highlight :after (lambda ()
                                                 (unless (window-minibuffer-p)
                                                   (when hl-line-overlay
                                                     (overlay-put hl-line-overlay 'priority 1000)))))
  (global-hl-line-mode))
#+END_SRC

**** Break long lines
#+BEGIN_SRC emacs-lisp
(setq visual-line-fringe-indicators '(nil nil))
(global-visual-line-mode 1)
#+END_SRC

**** [[https://github.com/purcell/page-break-lines][Show page breaks as line instead of '^L']]
#+BEGIN_SRC emacs-lisp
(use-package page-break-lines
  :config
  (global-page-break-lines-mode))
#+END_SRC

**** Show line numbers
#+BEGIN_SRC emacs-lisp
(setq display-line-numbers nil
      display-line-numbers-grow-only t
      display-line-numbers-widen nil
      display-line-numbers-width-start t)

(add-hook 'prog-mode-hook 'display-line-numbers-mode)
#+END_SRC

*** Utilities
**** Copy buffer file name to clipboard
#+BEGIN_SRC emacs-lisp
(defun cpped-copy-file-name-to-clipboard ()
  "Copy the current buffer file name to the clipboard."
  (interactive)
  (let ((filename (if (equal major-mode 'dired-mode)
                      default-directory
                    (buffer-file-name))))
    (when filename
      (kill-new filename))))
#+END_SRC

** Screen
*** Lock screen
#+BEGIN_SRC emacs-lisp
(require 'dbus)

(defun cpped-lock-screen ()
  "Lock the screen."
  (interactive)
  (dbus-call-method :session "org.freedesktop.ScreenSaver" "/org/freedesktop/ScreenSaver" "org.freedesktop.ScreenSaver" "Lock"))
#+END_SRC

** Cursor
*** Center Cursor
#+BEGIN_SRC emacs-lisp
(use-package centered-cursor-mode
  :config (global-centered-cursor-mode +1))
#+END_SRC

*** Show cursor as bar in insert mode and block in overwrite mode
#+BEGIN_SRC emacs-lisp
(use-package bar-cursor
  :config (bar-cursor-mode 1))
#+END_SRC

** [[https://www.emacswiki.org/emacs/UndoTree][Undo]]
#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :after popwin
    :custom
    (undo-tree-visualizer-timestamps t)
    (undo-tree-visualizer-diff t)
    (undo-tree-auto-save-history t)
    (undo-tree-history-directory-alist `(("." . ,(expand-file-name "~/.cache/emacs-undo"))))
    :config
    (global-undo-tree-mode)
    (push '(" *undo-tree*" :dedicated t :width 60 :position right) popwin:special-display-config))
#+END_SRC

*** Keep selection when undoing
#+BEGIN_SRC emacs-lisp
(defadvice undo-tree-undo (around keep-region activate)
  (if (use-region-p)
      (let ((mark-position (set-marker (make-marker) (mark)))
            (point-position (set-marker (make-marker) (point))))
        ad-do-it
        (goto-char point-position)
        (set-mark mark-position)
        (set-marker point-position nil)
        (set-marker mark-position nil))
    ad-do-it))
#+END_SRC

** Shell
#+BEGIN_SRC emacs-lisp
(setq comint-buffer-maximum-size 10000
      comint-scroll-show-maximum-output t
      comint-input-ring-size 500
      comint-input-ignoredups t
      comint-completion-addsuffix t
      comint-output-filter-functions '(ansi-color-process-output
                                       comint-strip-ctrl-m
                                       comint-postoutput-scroll-to-bottom
                                       comint-watch-for-password-prompt
                                       comint-truncate-buffer)
      eshell-scroll-to-bottom-on-input 'this
      eshell-scroll-to-bottom-on-output 'this
      eshell-kill-processes-on-exit t
      term-buffer-maximum-size 100000)
(add-hook 'term-exec-hook #'term-char-mode)

(use-package eshell
  :custom
  (eshell-banner-message "")
  (eshell-scroll-to-bottom-on-input 'this)
  (eshell-scroll-to-bottom-on-output 'this)
  (eshell-kill-processes-on-exit t)
  (eshell-error-if-no-glob t)
  (eshell-hist-ignoredups t)
  (eshell-history-size 20000)
  (eshell-save-history-o7n-exit t)
  (eshell-input-filter 'eshell-input-filter-initial-space)
  (eshell-prefer-lisp-functions nil)
  (eshell-list-files-after-cd t)
  (eshell-destroy-buffer-when-process-dies t)
  (eshell-cmpl-cycle-completions t)
  (eshell-buffer-maximum-lines 2000)
  (eshell-cd-shows-directory t)
  (eshell-cmpl-autolist t)
  (eshell-cmpl-dir-ignore "\\`\\(\\.\\.?\\|CVS\\|.git\\|.svn\\|.bzr\\)/\\'")
  (eshell-cmpl-expand-before-complete t)
  (eshell-cmpl-ignore-case t)
  (eshell-command-completions-alist '(("e" . "\\.pdf\\'")
                                      ("ar" . "\\.[ao]\\'")
                                      ("e" . "\\.[Cc]\\([Cc]\\|[PpXx][PpXx]\\)?\\'")
                                      ("e" . "\\.[Hh]\\([Hh]\\|[PpXx][PpXx]\\)?\\'")
                                      ("readelf" . "\\(\\`[^.]*\\|\\.\\([ao]\\|so\\)\\)\\'")
                                      ("objdump" . "\\(\\`[^.]*\\|\\.\\([ao]\\|so\\)\\)\\'")
                                      ("nm" . "\\(\\`[^.]*\\|\\.\\([ao]\\|so\\)\\)\\'")
                                      ("gdb" . "\\`\\([^.]*\\|a\\.out\\)\\'")
                                      ("e" . "\.txt\'")
                                      ("e" . "\.md\'")
                                      ("e" . "\.bat\'")
                                      ("e" . "\.bin\'")
                                      ("e" . "\.cfg\'")
                                      ("e" . "\.config\'")
                                      ("e" . "\.ini\'")
                                      ("e" . "\.el\'")
                                      ("e" . "\.org\'")
                                      ("e" . "\.log\'")
                                      ("gv" . "\.ps\'")
                                      ("xdvi" . "\.dvi\'")
                                      ("e" . "\.png\'")
                                      ("e" . "\.jpe?g\'")
                                      ("e" . "\.svg\'")
                                      ("e" . "\.xml\'")
                                      ("e" . "\.xslt?\'")
                                      ("unzip -l" . "\.zip\'")
                                      ("unrar l" . "\.rar\'")
                                      ("tar tf" . "\.tar\'")
                                      ("tar ztf" . "\.tar.gz\'")
                                      ("tar jtf" . "\.tar.bz2\'")
                                      ("unace l" . "\.ace\'")))
  (eshell-glob-include-dot-files t)
  (eshell-ls-initial-args '("-A"
                            "-F"
                            "-h"
                            "-l"
                            "-1"
                            "-v"
                            "--color"
                            "--group-directories-first"))
  (eshell-modules-list '(eshell-alias
                         eshell-banner
                         eshell-basic
                         eshell-cmpl
                         eshell-dirs
                         eshell-glob
                         eshell-hist
                         eshell-ls
                         eshell-pred
                         eshell-prompt
                         eshell-script
                         eshell-smart
                         eshell-term
                         eshell-tramp
                         eshell-unix))
  (eshell-output-filter-functions '(eshell-truncate-buffer
                                    eshell-postoutput-scroll-to-bottom
                                    eshell-handle-control-codes
                                    eshell-handle-ansi-color
                                    eshell-watch-for-password-prompt))
  (eshell-review-quick-commands t)
  (eshell-scroll-to-bottom-on-output 'all)
  (eshell-show-lisp-completions t))
#+END_SRC

*** Environment
#+BEGIN_SRC emacs-lisp
(setenv "PAGER" "cat")
(setenv "BROWSER" "eww")
#+END_SRC

https://github.com/purcell/exec-path-from-shell
#+BEGIN_SRC emacs-lisp
(use-package exec-path-from-shell
  :custom (exec-path-from-shell-variables '("PATH" "MANPATH" "LANG" "LC_CTYPE" "LC_NUMERIC" "LC_TIME" "LC_MONETARY" "LC_PAPER" "LC_NAME" "LC_ADDRESS" "LC_TELEPHONE" "LC_MEASUREMENT" "NINJA_STATUS"))
  :config (exec-path-from-shell-initialize))
#+END_SRC

*** Aliases
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "em-alias"
  (eshell/alias "d" "dired $1")
  (eshell/alias "cd.." "cd ..")
  (eshell/alias "cp" "cp -i $*")
  (eshell/alias "du" "du -h $*")
  (eshell/alias "gti" "git $*")

  (eshell/alias "dnf" "sudo dnf $*")
  (eshell/alias "log" "sudo lnav")
  (eshell/alias "sysinfo" "glances -1 --tree --fs-free-space --process-short-name -C ~/.config/glances")
  (eshell/alias "lstree" "l -R $*")
  (eshell/alias "make" "make -j $*")
  (eshell/alias "mkdir" "mkdir -p $*")
  (eshell/alias "mv" "mv -i $*")
  (eshell/alias "p" "ps aux $*")
  (eshell/alias "x" "extract $*")
  (eshell/alias "ag" "ag --smart-case $*")

  (when (executable-find "ninja-build")
    (eshell/alias "ninja" "ninja-build $*"))

  (eshell/alias "dos2unix" "recode ibmpc..lat1 $*")
  (eshell/alias "unix2dos" "recode lat1..ibmpc $*")
  (eshell/alias "unix2mac" "recode lat1..mac $*")
  (eshell/alias "mac2unix" "recode mac..lat1 $*")
  (eshell/alias "dos2mac" "recode ibmpc..mac $*")
  (eshell/alias "mac2dos" "recode mac..ibmpc $*"))

(defun eshell/l (&rest args)
  (eshell/ls args))

(defun eshell/e (file)
  (find-file file))

(defun eshell/mcd (directory)
  "Create a directory and enter it."
  (eshell/mkdir directory)
  (eshell/cd directory))

(defun eshell/top ()
  "Use helm-top instead of top."
  (helm-top))

(defun eshell/kill ()
  "Use helm-top to kill processes."
  (helm-top))
#+END_SRC

**** Git support
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun eshell/gitroot ()
    "chnage directory to current project root."
    (eshell/cd (vc-git-root default-directory)))

  (defun eshell/git-log (&rest arguments)
    "Use magit instead of git log."
    (magit-mode-setup #'magit-log-mode arguments)
    (magit-log-goto-same-commit)
    (eshell/echo))

  (defun eshell/git (command &rest arguments)
    "use magit for git status and log commands."
    (pcase command
      ("log" (apply #'eshell/git-log arguments))
      ("status" (progn
                  (magit-status)
                  (eshell/echo)))
      (_ (shell-command-to-string (s-join " " (append (list "git"
                                                            command)
                                                      arguments)))))))
#+END_SRC

*** Smart-open new eshell buffers
#+BEGIN_SRC emacs-lisp
(defun cpped-eshell-maybe-new-session (&optional argument)
  "Create a new interactive Eshell buffer if the current buffer is an Eshell buffer."
  (interactive "P")
  (if (eq major-mode 'eshell-mode)
      (eshell (or argument
                  t))
    (eshell argument)))
#+END_SRC

*** Prompt
#+BEGIN_SRC emacs-lisp
(defun cpped-eshell-prompt-concat (&rest contents)
  (let ((items (-flatten (-non-nil contents))))
    (when items
      (s-join " " items))))

(defun cpped-eshell-prompt-section (section-face next-section-face &rest contents)
  (when contents
    (concat (propertize (cpped-eshell-prompt-concat " "
                                                    contents
                                                    " ")
                        'face section-face)
            (propertize ""
                        'face `(:foreground ,(face-attribute section-face :background)
                                            :background ,(face-attribute next-section-face :background))))))

(defun cpped-eshell-prompt-result ()
  (unless (= 0 0)
    (propertize (cpped-eshell-prompt-concat (propertize (all-the-icons-faicon5 "exclamation-triangle")
                                                        'face `(:family ,(all-the-icons-faicon5-family))
                                                        'display '(raise -0.1))
                                            eshell-last-command-status)
                'face '(:foreground ,(face-attribute 'warning :foreground)
                                    :weight 'bold))))

(defun cpped-eshell-prompt-user ()
  (if (string= "root"
               (getenv "USER"))
      (concat (propertize (all-the-icons-faicon5 "user-plus")
                          'face `(:family ,(all-the-icons-faicon5-family)
                                          :foreground ,(face-attribute 'warning :foreground))
                          'display '(raise -0.0)))
    (unless (string= (getenv "LOGNAME")
                     (getenv "USER"))
        (cpped-eshell-prompt-concat (propertize (all-the-icons-faicon5 "user")
                                                'face `(:family ,(all-the-icons-faicon5-family))
                                                'display '(raise -0.0))
                                    (user-login-name)))))

(defun cpped-eshell-prompt-host ()
  (when (let ((host (getenv "SSH_CONNECTION")))
          (and host
               (not (string= "" host))))
    (cpped-eshell-prompt-concat (propertize (all-the-icons-faicon5 "desktop")
                                            'face `(:family ,(all-the-icons-faicon5-family))
                                            'display '(raise -0.1))
                                (system-name))))

(defun cpped-eshell-prompt-docker ()
  (let* ((id (shell-command-to-string "cat /proc/self/cgroup | grep docker | head -n 1 | cut -d '/' -f3"))
         (container (when (and id
                               (not (string= "" id)))
                      (shell-command-to-string (concat "docker inspect -f '{{.Config.Image}}' "
                                                       id)))))
    (when container
      (cpped-eshell-prompt-concat (propertize (all-the-icons-faicon5 "docker")
                                              'face `(:family ,(all-the-icons-faicon5-family))
                                              'display '(raise -0.1))
                                  container))))

(defun cpped-eshell-prompt-path ()
  (cpped-eshell-prompt-concat (propertize (all-the-icons-faicon5 "folder-open")
                                          'face `(:family ,(all-the-icons-faicon5-family))
                                          'display '(raise -0.1))
                              (propertize (eshell/pwd)
                                          'face `(:weight 'ultra-bold))))

(setq eshell-prompt-function (lambda ()
                               (concat (cpped-eshell-prompt-section 'powerline-active1
                                                                    'powerline-active2
                                                                    (cpped-eshell-prompt-result)
                                                                    (cpped-eshell-prompt-user)
                                                                    (cpped-eshell-prompt-host)
                                                                    (cpped-eshell-prompt-docker)
                                                                    (cpped-powerline-version-control))
                                       (cpped-eshell-prompt-section 'powerline-active2
                                                                    'mode-line
                                                                    (cpped-eshell-prompt-path))
                                       "\n▶ "))
      eshell-highlight-prompt nil
      eshell-prompt-regexp (rx line-start (0+ (not (in "▶"))) line-end "▶ "))
#+END_SRC

*** Clear buffer
#+BEGIN_SRC emacs-lisp
(defun cpped-clear-comint-buffer ()
  "Remove content of comint buffer."
  (interactive)
  (delete-region (point-min) (point-max))
  (comint-send-input))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun eshell/clear ()
  "Clear the eshell buffer."
  (let ((inhibit-read-only t))
    (erase-buffer)
    (eshell-send-input)))
#+END_SRC

*** Close buffer after process exits
#+BEGIN_SRC emacs-lisp
(advice-add 'term-sentinel :after (lambda (proc msg)
                                    (when (memq (process-status proc) '(signal exit))
                                      (kill-buffer (process-buffer proc)))))
#+END_SRC

*** Visual commands
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "em-term"
  (add-to-list 'eshell-visual-commands "top")
  (add-to-list 'eshell-visual-commands "glances")
  (add-to-list 'eshell-visual-commands "lnav")
  (add-to-list 'eshell-visual-commands "ccmake")

  (add-to-list 'eshell-visual-options '("git" "--help")))
#+END_SRC

*** Open shell in project directory
#+BEGIN_SRC emacs-lisp
(defun cpped-shell-project-dir ()
  "Open eshell in project directory."
  (interactive)
  (let ((default-directory (cpped-project-dir)))
    (if default-directory
        (cpped-eshell-maybe-new-session))))
#+END_SRC

*** [[https://github.com/kyagi/shell-pop-el][Popup]]
#+BEGIN_SRC emacs-lisp
(use-package shell-pop
  :after helm-buffers
  :bind ("C-#" . shell-pop)
  :custom
  (shell-pop-shell-type '("eshell" "*eshell*" (lambda nil
                                                (cpped-eshell-maybe-new-session))))
  (shell-pop-universal-key "C-#")
  (shell-pop-window-size 60)
  (shell-pop-full-span t)
  (shell-pop-window-position "bottom"))
#+END_SRC

*** Navigation
**** [[https://github.com/Fuco1/eshell-bookmark][Bookmarks]]
#+BEGIN_SRC emacs-lisp
(use-package eshell-bookmark
  :hook (eshell-mode . eshell-bookmark-setup))
#+END_SRC

**** [[https://github.com/peterwvj/eshell-up][Go to parent directories]]
#+BEGIN_SRC emacs-lisp
(use-package eshell-up
  :custom (eshell-up-ignore-case nil)
  :config
  (defun eshell/up (directory)
    "Alias for eshell-up."
    (eshell-up directory)))
#+END_SRC

**** [[https://github.com/coldnew/eshell-autojump][Jump to directories]]
#+BEGIN_SRC emacs-lisp
(use-package eshell-autojump
  :config
  (defun cpped-helm-eshell-autojump (wrapped-function &rest arguments)
    "Select autojump directory via helm."
    (let ((j-arguments (list (or arguments
                           (helm :sources (helm-build-sync-source "Common Directories"
                                            :candidates (eshell-autojump-candidates))
                                 :prompt "Directory: "
                                 :buffer "*helm eshell-autojump*")))))
      (apply wrapped-function j-arguments)))
  (advice-add 'eshell/j :around #'cpped-helm-eshell-autojump))
#+END_SRC

**** Jump over directories without files and one subdirectory
#+BEGIN_SRC emacs-lisp
(add-hook 'eshell-directory-change-hook #'(lambda ()
                                            (let* ((content (directory-files default-directory))
                                                   (directories (seq-remove '(lambda (directory)
                                                                               (string-match "\\.\\.?" directory))
                                                                            (seq-filter 'file-directory-p content)))
                                                   (files (seq-filter 'file-regular-p content)))
                                              (when (and (not files)
                                                         directories
                                                         (= 1 (length directories))
                                                         (not (string-match "^cd +[\./]+$" (eshell-get-history 0))))
                                                (let ((eshell-list-files-after-cd nil))
                                                  (eshell/cd (car directories)))))))
#+END_SRC

**** Re-enter directory if necessary
#+BEGIN_SRC emacs-lisp
(defun cpped-eshell-reenter ()
  "Re-enter current directory if necessary."
  (unless (> (file-nlinks default-directory) 0)
    (eshell/cd (if (file-directory-p default-directory)
                   default-directory
                 (expand-file-name "~")))))

(add-hook 'eshell-mode-hook #'(lambda ()
                                (add-hook 'eshell-pre-command-hook #'cpped-eshell-reenter nil t)))
#+END_SRC

*** [[https://github.com/mhayashi1120/Emacs-shelldoc][Show man page for shell commands]]
#+BEGIN_SRC emacs-lisp
(use-package shelldoc
  :after (helm-buffers popwin)
  :hook ((eshell-mode sh-mode shell-mode) . shelldoc-minor-mode-on)
  :custom (shelldoc-keep-man-locale nil)
  :config
  (push "\\*Shelldoc\\*" helm-boring-buffer-regexp-list)
  (push '("*Shelldoc*" :position bottom :height 30) popwin:special-display-config))
#+END_SRC

*** Auto-completion
**** Company (commands)
#+BEGIN_SRC emacs-lisp
(add-hook 'eshell-mode-hook (lambda()
                              (set (make-local-variable 'company-backends) '((company-yasnippet company-shell company-keywords company-files company-capf company-dabbrev-code)))))
#+END_SRC

**** Helm (files/folders)
#+BEGIN_SRC emacs-lisp
(add-hook 'eshell-mode-hook (lambda ()
                              (eshell-cmpl-initialize)
                              (define-key eshell-mode-map [remap eshell-pcomplete] 'helm-esh-pcomplete)))
#+END_SRC

**** Autosuggest
#+BEGIN_SRC emacs-lisp
(use-package esh-autosuggest
  :hook eshell-mode)
#+END_SRC

*** Add sudo to command line
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "eshell"
(defun cpped-add-sudo ()
  "Add sudo to the curent command."
  (interactive)
  (save-excursion
    (eshell-bol)
    (insert "sudo ")))

(add-hook 'eshell-mode-hook (lambda ()
                              (define-key eshell-mode-map (kbd "C-M-s") 'cpped-add-sudo))))
#+END_SRC

*** History
#+BEGIN_SRC emacs-lisp
(add-hook 'eshell-mode-hook (lambda ()
                              (define-key eshell-mode-map "M-l" 'helm-eshell-history)))
#+END_SRC

*** [[https://github.com/magit/with-editor][Use emacs as editor]]
#+BEGIN_SRC emacs-lisp
(use-package with-editor
  :hook ((shell-mode term-exec eshell-mode) . with-editor-export-editor)
  :config
  (define-key (current-global-map) [remap async-shell-command] 'with-editor-async-shell-command)
  (define-key (current-global-map) [remap shell-command] 'with-editor-shell-command))
#+END_SRC

*** [[https://github.com/riscy/bifocal-mode][Split buffer on scroll to show both scrolled position and tail]]
#+BEGIN_SRC emacs-lisp
(use-package bifocal
  :config (bifocal-global-mode 1))
#+END_SRC

*** Show running command status in mode line
#+BEGIN_SRC emacs-lisp
(advice-add 'eshell-command-started :before (lambda ()
                                              (setq cpped-eshell-process-running t)
                                              (force-mode-line-update t)))

(advice-add 'eshell-command-finished :before (lambda ()
                                               (setq cpped-eshell-process-running nil)
                                               (force-mode-line-update t)))
#+END_SRC

*** Notify when long-running command finishes
#+BEGIN_SRC emacs-lisp
(defcustom cpped-eshell-minimum-interesting-run-time 30 "The minimum time a command has to take to be interesting.")

(defun cpped-eshell-current-command-start ()
  "Save timestamp on command start."
  (setq cpped-eshell-current-command-start-time (current-time)))

(defun cpped-eshell-current-command-stop ()
  "Show notification when command stops."
  (when cpped-eshell-current-command-start-time
    (let ((run-time (truncate (float-time (cpped-get-run-time)))))
      (unless (< run-time cpped-eshell-minimum-interesting-run-time)
        (let ((time-string (cpped-format-run-time (cpped-get-run-time)))
              (command (s-join " " (eshell-flatten-list (list eshell-last-command-name eshell-last-arguments)))))
          (eshell-interactive-print (format "\nRunning time: %s\n"
                                            time-string))
          (notifications-notify :title (format "'%s' finished"
                                               command)
                                :body (format "The eshell command '%s' finished %s%s"
                                              command
                                              (if (= 0 eshell-last-command-status)
                                                  "successfully."
                                                "with error.")
                                              (if (= 0 eshell-last-command-status)
                                                  ""
                                                (format "<br><br>Error code: %d"
                                                        eshell-last-command-status)))
                                :app-icon (if (= 0 eshell-last-command-status)
                                              "utilities-terminal"
                                            "emblem-important")
                                :timeout (if (= 0 eshell-last-command-status)
                                             7200
                                           0)))))
    (setq cpped-eshell-current-command-start-time nil)))

(add-hook 'eshell-mode-hook #'(lambda ()
                                (add-hook 'eshell-pre-command-hook #'cpped-eshell-current-command-start nil t)
                                (add-hook 'eshell-post-command-hook #'cpped-eshell-current-command-stop nil t)))
#+END_SRC

** Help
*** [[https://github.com/Wilfred/helpful][Better Help Buffer]]
#+BEGIN_SRC emacs-lisp
(use-package helpful
  :after helm-buffers
  :custom (helpful-max-buffers 3)
  :config (push "\\*helpful.*\\*" helm-boring-buffer-regexp-list))
#+END_SRC

** Utilites
*** [[https://github.com/bbatsov/crux][A Collection of Ridiculously Useful eXtensions]]
#+BEGIN_SRC emacs-lisp
(use-package crux)
#+END_SRC

*** Date/time formatting
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "all-the-icons"
  (defun cpped-print-date ()
    (concat
     (propertize (all-the-icons-faicon5 "calendar-alt")
                 'face `(:family ,(all-the-icons-faicon5-family))
                 'display '(raise -0.0))
     (propertize (format-time-string " %W")
                 'face '(:weight ultra-light))
     (format-time-string " %e.%-m.%G")))

  (defun cpped-print-time ()
    (let* ((hour (string-to-number (format-time-string "%I")))
           (icon (all-the-icons-wicon (format "time-%s" hour))))
      (concat
       (propertize icon 'face (list ':family (all-the-icons-wicon-family))
                   'display '(raise -0.0))
       (format-time-string " %H:%M")))))
#+END_SRC

**** Run freedesktop applications
#+BEGIN_SRC emacs-lisp
(defun cpped-run-application ()
  "Run a freedesktop application."
  (interactive)
  (helm :sources (helm-build-sync-source "Applications"
                   :candidates (let ((candidates))
                                 (mapcar (lambda (directory)
                                           (let ((desktop-directory (expand-file-name "applications" directory)))
                                             (when (file-exists-p desktop-directory)
                                               (mapcar (lambda (desktop-file)
                                                         (with-temp-buffer
                                                           (insert-file-contents desktop-file)
                                                           (let ((content (buffer-string)))
                                                             (when (and (not (string-match (rx bol (or "Hidden" "NoDisplay") (0+ (in space)) "=" (0+ (in space)) "true") content))
                                                                        (string-match (rx bol "Type" (0+ (in space)) "=" (0+ (in space)) "Application") content)
                                                                        (or (not (string-match (rx bol "TryExec" (0+ (in space)) "=" (0+ (in space)) (group (+ any))) content))
                                                                            (executable-find (match-string-no-properties 1 content))))
                                                               (let ((simple-name)
                                                                     (name)
                                                                     (exec))
                                                                 (when (string-match (rx bol "Name" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                   (setq simple-name (match-string-no-properties 1 content))
                                                                   (setq name simple-name)
                                                                   (when (and (string-match (rx bol "GenericName" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                              (not (equal name (match-string-no-properties 1 content))))
                                                                     (setq name (format "%s %s" simple-name (propertize (match-string-no-properties 1 content) 'face '(:weight extra-light :slant italic)))))
                                                                   (when (string-match (rx bol "Keywords" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                     (setq name (format "%s %s" name (propertize (match-string-no-properties 1 content) 'invisible t))))
                                                                   (when (string-match (rx bol "Comment" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                     (setq name (propertize name 'help-echo (match-string-no-properties 1 content))))
                                                                   (when (string-match (rx bol "Exec" (0+ (in space)) "=" (0+ (in space)) (group (+ any)) eol) content)
                                                                     (setq exec (split-string (replace-regexp-in-string "%k" desktop-file (replace-regexp-in-string "%c" simple-name (replace-regexp-in-string "%[FfUuDdNnivm]" "" (match-string-no-properties 1 content))))))
                                                                     (push (cons name exec) candidates))))))))
                                                       (directory-files-recursively desktop-directory ".*\.desktop")))))
                                         (split-string (getenv "XDG_DATA_DIRS") ":"))
                                 candidates)
                   :action (helm-make-actions "Run" (lambda (selection)
                                                      (make-process :name (car selection)
                                                                    :buffer (format "*%s*" (car selection))
                                                                    :command selection))))
        :prompt "Run: "
        :buffer "*helm applications*"))
#+END_SRC

** Windows
*** Re-use frames
#+BEGIN_SRC emacs-lisp
(setq display-buffer-reuse-frames t)
#+END_SRC

*** Hide dividers between windows
#+BEGIN_SRC emacs-lisp
(setq window-divider-mode nil)
#+END_SRC

*** [[https://github.com/cyrus-and/zoom][Automatically zoom current window]]
#+BEGIN_SRC emacs-lisp
(use-package zoom
  :custom
  (zoom-size '(0.618 . 0.618))
  (zoom-ignored-major-modes '(dired-mode markdown-mode))
  (zoom-ignored-buffer-name-regexps '("^*calc"))
  :config
  (zoom-mode t))
#+END_SRC

* File Handling
** Config
#+BEGIN_SRC emacs-lisp
(defvar cpped-config-file "~/.emacs-config.org")
#+END_SRC

** Do not ask if file should be created
#+BEGIN_SRC emacs-lisp
(setq confirm-nonexistent-file-or-buffer nil
      helm-ff-newfile-prompt-p nil)
#+END_SRC

** Save backup files to /tmp
#+BEGIN_SRC emacs-lisp
(setq backup-directory-alist `((".*" . ,(expand-file-name "backups" user-emacs-directory)))
      backup-by-copying t
      version-control t
      delete-old-versions t
      kept-new-versions 20
      kept-old-versions 5)
#+END_SRC

** Move deleted files to trash instead of deleting
#+BEGIN_SRC emacs-lisp
(setq delete-by-moving-to-trash t)
#+END_SRC

** Automatically silently reload unmodified buffers when file has changed on disk
#+BEGIN_SRC emacs-lisp
(setq global-auto-revert-non-file-buffers t
      auto-revert-verbose nil)
(global-auto-revert-mode t)
#+END_SRC

** Save current region or buffer to different file
#+BEGIN_SRC emacs-lisp
(defun cpped-save-copy ()
  "Save the current buffer or region to a different file."
  (interactive)
  (let* ((original (buffer-file-name))
         (copy (read-file-name "Copy to file: " nil nil nil (and original
                                                                 (file-name-nondirectory original))))
         (begin (if (use-region-p)
                    (region-beginning)
                  (point-min)))
         (end (if (use-region-p)
                  (region-end)
                (point-max)))
         (mustbenew (if (and original (file-equal-p original copy))
                        'excl
                      t)))
    (write-region begin end copy nil nil nil mustbenew)))
#+END_SRC

** Auto-save buffers
#+BEGIN_SRC emacs-lisp
(defconst cpped-autosave-delay 1 "The number of seconds to wait before saving automatically.")

(setq auto-save-timeout cpped-autosave-delay
      auto-save-interval 100
      buffer-save-without-query t)

(auto-save-visited-mode)
#+END_SRC

*** [[https://github.com/bbatsov/super-save][Save when losing focus]]
#+BEGIN_SRC emacs-lisp
(use-package super-save
  :commands super-save-mode
  :custom (super-save-auto-save-when-idle nil)
  :config (super-save-mode +1))
#+END_SRC

** [[https://github.com/nflath/sudo-edit][Allow editing via sudo]]
#+BEGIN_SRC emacs-lisp
(use-package sudo-edit)
#+END_SRC

** [[https://github.com/m00natic/vlfi][Allow opening large files]]
#+BEGIN_SRC emacs-lisp
(setq large-file-warning-threshold (* 25 1024 1024))

(use-package vlf
  :custom (vlf-application 'dont-ask)
  :config (require 'vlf-setup))
#+END_SRC

** Execute command on file
#+BEGIN_SRC emacs-lisp
(defun cpped-execute-command-on-buffer-file (command)
  (interactive "sCommand: ")
  (when buffer-file-name
    (shell-command (concat command " " buffer-file-name))))
#+END_SRC

** Allow editing compressed files
#+BEGIN_SRC emacs-lisp
(auto-compression-mode 1)
#+END_SRC

** File Management
*** [[https://www.emacswiki.org/emacs/RecentFiles][Recent files]]
#+BEGIN_SRC emacs-lisp
(use-package recentf
  :custom
  (recentf-max-saved-items 200)
  (recentf-max-menu-items 15)
  (recentf-auto-save-timer (run-with-idle-timer 300 t
                                                '(lambda ()
                                                   (let ((warning-minimum-level :error))
                                                     (ignore-errors (recentf-save-list))))))
  :config (recentf-mode))
#+END_SRC

*** Helm integration
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "helm"
  (require 'helm-files)
  (define-key helm-find-files-map (kbd "C-d") 'helm-ff-persistent-delete)
  (define-key helm-find-files-map (kbd "C-M-y") 'helm-copy-to-buffer)

  (require 'helm-for-files)
  (require 'helm-locate)
  (with-eval-after-load "recentf"
    (defvar cpped-helm-source-recentf
      (helm-make-source "Recent files" ' helm-recentf-source
        :candidate-number-limit 15)
      "`helm-source-recentf' with candidate limit.")

    (require 'helm-buffers)
    (setq helm-buffers-end-truncated-string "…")
    (unless helm-source-buffers-list
      (setq helm-source-buffers-list
            (helm-make-source "Buffers" 'helm-source-buffers)))

    (defun cpped-helm-find-files ()
      (interactive)
      (let ((helm-ag--default-directory (or (when (ignore-errors (projectile-project-p))
                                              projectile-project-root)
                                            default-directory)))
        (helm :sources `(helm-source-buffers-list
                         cpped-helm-source-recentf
                         ,(if (ignore-errors (projectile-project-p))
                              helm-source-projectile-files-list
                            helm-source-files-in-current-dir)
                         helm-source-locate
                         helm-source-do-ag
                         helm-source-buffer-not-found))))))
#+END_SRC

*** Dired
#+BEGIN_SRC emacs-lisp
(setq dired-recursive-copies 'always
      dired-recursive-deletes 'top
      dired-dwim-target t)
#+END_SRC

**** Re-use dired buffers
#+BEGIN_SRC emacs-lisp
(put 'dired-find-alternate-file 'disabled nil)

(define-key dired-mode-map (kbd "RET") 'dired-find-alternate-file)
#+END_SRC

**** [[https://github.com/DamienCassou/dired-imenu][imenu Integration]]
#+BEGIN_SRC emacs-lisp
(use-package dired-imenu)
#+END_SRC

**** [[https://www.emacswiki.org/emacs/wdired.el][Editing]]
#+BEGIN_SRC emacs-lisp
(use-package wdired
  :bind (:map dired-mode-map ("r" . wdired-change-to-wdired-mode))
  :custom
  (wdired-allow-to-change-permissions t)
  (wdired-create-parent-directories t))
#+END_SRC

**** Use standard ls parameters for listing
#+BEGIN_SRC emacs-lisp
(setq dired-listing-switches "-aFhl1v --group-directories-first")
#+END_SRC

**** Coloring
#+BEGIN_SRC emacs-lisp
(use-package diredful
  :config
  (diredful-mode 1))
#+END_SRC

**** Show lines in alternating colors
#+BEGIN_SRC emacs-lisp
(use-package stripe-buffer
  :hook (dired-mode . turn-on-stripe-buffer-mode))
#+END_SRC

**** Show Icons
#+BEGIN_SRC emacs-lisp
(use-package all-the-icons-dired
  :hook dired-mode)
#+END_SRC

**** Collapse empty directories
#+BEGIN_SRC emacs-lisp
(use-package dired-collapse
  :hook dired-mode)
#+END_SRC

**** [[https://github.com/calancha/dired-du][Show directory sizes]]
#+BEGIN_SRC emacs-lisp
(use-package dired-du
  :quelpa (dired-du
           :fetcher github
           :repo "calancha/dired-du")
  :custom (dired-du-size-format t))
#+END_SRC

**** [[https://github.com/Fuco1/dired-hacks#dired-subtree][Show subtrees inline]]
#+BEGIN_SRC emacs-lisp
(use-package dired-subtree
  :bind (:map dired-mode-map
              ("<tab>" . dired-subtree-toggle)))
#+END_SRC

**** Filtering
#+BEGIN_SRC emacs-lisp
(use-package dired-narrow
  :bind (:map dired-mode-map ("f" . dired-narrow)))
#+END_SRC

**** Preview
#+BEGIN_SRC emacs-lisp
(use-package peep-dired
  :defer t
  :bind (:map dired-mode-map ("v" . peep-dired)))
#+END_SRC

**** [[https://github.com/clemera/dired-git-info][Show git information]]
#+BEGIN_SRC emacs-lisp
(use-package dired-git-info
  :quelpa (dired-git-info
           :fetcher github
           :repo "clemera/dired-git-info")
  :functions dired-git-info
  :hook dired-mode)
#+END_SRC

**** Diff files
#+BEGIN_SRC emacs-lisp
(defvar cpped-dired-ediff-window-configuration nil)

(defun cpped-dired-ediff-files ()
  "Show a diff of two files marked in dired."
  (interactive)
  (let* ((files (dired-get-marked-files))
         (file1 (car files))
         (file2 (if (cdr files)
                    (cadr files)
                  (read-file-name "Diff to: " (dired-dwim-target-directory)))))
    (setq cpped-dired-ediff-window-configuration (current-window-configuration))
    (ediff-files file1 file2 '((lambda ()
                                 (setq-local ediff-quit-hook (lambda ()
                                                               (ediff-kill-buffer-carefully ediff-buffer-A)
                                                               (ediff-kill-buffer-carefully ediff-buffer-B)
                                                               (set-window-configuration cpped-dired-ediff-window-configuration.))))))))

(define-key dired-mode-map "d" 'cpped-dired-ediff-files)
#+END_SRC

**** Compress files
#+BEGIN_SRC emacs-lisp
(define-key dired-mode-map "c" 'dired-do-compress)
(define-key dired-mode-map "C" 'dired-do-compress-to)
#+END_SRC

*** [[https://github.com/Alexander-Miller/treemacs][Treemacs]]
#+BEGIN_SRC emacs-lisp
(use-package treemacs
  :after helm-buffers
  :bind ("<f1>" . treemacs-toggle)
  :custom
  (treemacs-change-root-without-asking t)
  (treemacs-collapse-dirs 3)
  (treemacs-file-event-delay 2000)
  (treemacs-filewatch-mode t)
  (treemacs-follow-after-init t)
  (treemacs-follow-mode t)
  (treemacs-git-integration t)
  (treemacs-is-never-other-window t)
  (treemacs-silent-refresh t)
  (treemacs-header-function 'treemacs-projectile-create-header)
  :config
  (treemacs-follow-mode t)
  (treemacs-filewatch-mode t)
  (push "\\*Treemacs\\*" helm-boring-buffer-regexp-list)
  (push "\\*Desktop Treemacs Helper\\*" helm-boring-buffer-regexp-list))

(use-package treemacs-projectile
  :after treemacs projectile)
#+END_SRC

* Text
#+BEGIN_SRC emacs-lisp
(push '("\\.txt\\'" . text-mode) auto-mode-alist)
#+END_SRC

** Encoding
#+BEGIN_SRC emacs-lisp
(set-charset-priority 'unicode)
(set-language-environment 'utf-8)
(set-default-coding-systems 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
(setq locale-coding-system 'utf-8)
(setq default-process-coding-system '(utf-8-unix . utf-8-unix))

(defun cpped-dos2unix ()
  (interactive)
  (set-buffer-file-coding-system 'utf-8-unix nil))

(defun cpped-unix2dos ()
  (interactive)
  (set-buffer-file-coding-system 'utf-8-dos nil))
#+END_SRC

** Highlighting
*** Enable stealth fontification
#+BEGIN_SRC emacs-lisp
(setq jit-lock-stealth-time 1
      jit-lock-chunk-size 1000
      jit-lock-defer-time 0.05)
#+END_SRC

*** Pretty symbols
#+BEGIN_SRC emacs-lisp
(add-hook 'text-mode-hook (lambda()
                            (push '("=/=" . ?≠) prettify-symbols-alist)
                            (push '(">=" . ?≧) prettify-symbols-alist)
                            (push '("<=" . ?≦) prettify-symbols-alist)

                            (push '("->" . ?→) prettify-symbols-alist)
                            (push '("<-" . ?←) prettify-symbols-alist)
                            (push '("<->" . ?↔) prettify-symbols-alist)
                            (push '("<_->" . ?⇄) prettify-symbols-alist)
                            (push '("<-_>" . ?⇆) prettify-symbols-alist)

                            (push '("-->" . ?⤍) prettify-symbols-alist)
                            (push '("<--" . ?⤌) prettify-symbols-alist)

                            (push '("--->" . ?⤏) prettify-symbols-alist)
                            (push '("<---" . ?⤎) prettify-symbols-alist)

                            (push '("-|>" . ?⇾) prettify-symbols-alist)
                            (push '("<|-" . ?⇽) prettify-symbols-alist)
                            (push '("<|-|>" . ?⇿) prettify-symbols-alist)

                            (push '("==>" . ?⇒) prettify-symbols-alist)
                            (push '("<==" . ?⇐) prettify-symbols-alist)
                            (push '("=/=>" . ?⇏) prettify-symbols-alist)
                            (push '("<=/=" . ?⇍) prettify-symbols-alist)
                            (push '("=|=>" . ?⤃) prettify-symbols-alist)
                            (push '("<=|=" . ?⤂) prettify-symbols-alist)
                            (push '("<=>" . ?⇔) prettify-symbols-alist)
                            (push '("<=|=>" . ?⤄) prettify-symbols-alist)
                            (push '("<=/=>" . ?↮) prettify-symbols-alist)

                            (push '("..>" . ?⇢) prettify-symbols-alist)
                            (push '("<.." . ?⇠) prettify-symbols-alist)
                            (push '("^.." . ?⇡) prettify-symbols-alist)
                            (push '("v.." . ?⇣) prettify-symbols-alist)

                            (push '("->|" . ?⇥) prettify-symbols-alist)
                            (push '("|<-" . ?⇤) prettify-symbols-alist)
                            (push '("|<-_>|" . ?↹) prettify-symbols-alist)

                            (push '("-|->" . ?⇸) prettify-symbols-alist)
                            (push '("<-|-" . ?⇷) prettify-symbols-alist)
                            (push '("<-|->" . ?⇹) prettify-symbols-alist)

                            (push '("-||->" . ?⇻) prettify-symbols-alist)
                            (push '("<-||-" . ?⇺) prettify-symbols-alist)
                            (push '("<-||->" . ?⇼) prettify-symbols-alist)

                            (push '("^||v" . ?⇅) prettify-symbols-alist)
                            (push '("v||^" . ?⇵) prettify-symbols-alist)

                            (push '("~>" . ?⤳) prettify-symbols-alist)
                            (push '("<~>" . ?↭) prettify-symbols-alist)
                            (push '("\/v" . ?↯) prettify-symbols-alist)

                            (push '("|>" . ?▶) prettify-symbols-alist)
                            (push '("<|" . ?◀) prettify-symbols-alist)))
#+END_SRC

*** Syntax types
**** [[https://github.com/sensorflo/adoc-mode][AsciiDoc]]
#+BEGIN_SRC emacs-lisp
(use-package adoc-mode
  :mode ("\\.adoc\\'" . adoc-mode))
#+END_SRC

**** Markdown
#+BEGIN_SRC emacs-lisp
(use-package markdown-mode
  :mode
  (("README\\.md\\'" . gfm-mode)
   ("\\.md\\'" . markdown-mode)
   ("\\.markdown\\'" . markdown-mode))
  :hook (markdown-mode . (lambda ()
                           (typo-mode -1)))
  :custom (markdown-command "multimarkdown"))
#+END_SRC

***** Editing
****** Wrap Region
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "wrap-region"
  (wrap-region-add-wrappers
   '(("*" "*" "/" (gfm-mode markdown-mode))
     ("**" "**" "b" (gfm-mode markdown-mode))
     ("***" "***" "e" (gfm-mode markdown-mode))))
  (add-hook 'gfm-mode-hook 'wrap-region-mode)
  (add-hook 'markdown-mode-hook 'wrap-region-mode))
#+END_SRC

****** [[https://github.com/ardumont/markdown-toc][Table of contents]]
#+BEGIN_SRC emacs-lisp
(use-package markdown-toc
  :custom
  (markdown-toc-header-toc-start nil)
  (markdown-toc-header-toc-end nil))
#+END_SRC

***** Syntax checker
https://github.com/mivok/markdownlint
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "mdl" :package-manager 'gem))
#+END_SRC

***** [[https://github.com/mola-T/flymd][Preview]]
#+BEGIN_SRC emacs-lisp
(use-package flymd
  :custom
  (flymd-close-buffer-delete-temp-files t)
  (flymd-output-directory temporary-file-directory))
#+END_SRC

*** Highlight edited areas shortly
#+BEGIN_SRC emacs-lisp
(use-package volatile-highlights
  :custom
  (Vhl/highlight-zero-width-ranges t)
  (vhl/use-etags-extension-p nil)
  (vhl/use-hideshow-extension-p t)
  (vhl/use-nonincremental-search-extension-p nil)
  (vhl/use-occur-extension-p nil)
  :config (volatile-highlights-mode t))
#+END_SRC

*** Highlight current symbol
#+BEGIN_SRC emacs-lisp
(use-package auto-highlight-symbol
  :custom
  (ahs-case-fold-search nil)
  (ahs-default-range 'ahs-range-whole-buffer)
  (ahs-idle-interval 0.25)
  (ahs-inhibit-face-list nil)
  (ahs-suppress-log t)
  :config
  (push 'org-mode ahs-modes)
  (global-auto-highlight-symbol-mode t))
#+END_SRC

*** Highlight number packs
Use custom regex to ignore color definitions (numbers starting with a # sign)
#+BEGIN_SRC emacs-lisp
(use-package num3-mode
  :hook prog-mode
  :custom (num3--number-re (concat "[^#]0[xX]\\([[:xdigit:]]+\\)"
                                   "\\|"
                                   "[^#]\\(?1:\\b\\(?:[0-9]+[a-fA-F]\\|[a-fA-F]+[0-9]\\)[[:xdigit:]]*\\b\\)"
                                   "\\|"
                                   "[^#]\\([0-9]+\\)"
                                   "\\|"
                                   "\\.\\([0-9]+\\)")))
#+END_SRC

*** Highlight last screen content when navigating
#+BEGIN_SRC emacs-lisp
(use-package on-screen
  :custom
  (on-screen-auto-update t)
  (on-screen-delay 1.5)
  (on-screen-drawing-threshold 10)
  (on-screen-highlight-method 'shadow)
  (on-screen-remove-when-edit t)
  (on-screen-highlighting-to-background-delta 0.9)
  :config (on-screen-global-mode +1))
#+END_SRC

*** Smart narrowing/widening
#+BEGIN_SRC emacs-lisp
(defun cpped-narrow-or-widen-dwim (prefix)
  "Widen if buffer is narrowed, narrow otherwise. If a prefix is given, always narrow regardless of narrowed state."
  (interactive "P")
  (declare (interactive-only))
  (cond ((and (buffer-narrowed-p)
              (not prefix)
              (not (region-active-p)) (widen)))
        ((region-active-p)
         (narrow-to-region (region-beginning)
                           (region-end)))
        ((derived-mode-p 'org-mode)
         (cond ((ignore-errors (org-edit-src-code) t)
                (delete-other-windows))
               ((ignore-errors (org-narrow-to-block) t))
               (t (org-narrow-to-subtree))))
        ((derived-mode-p 'latex-mode)
         (LaTeX-narrow-to-environment))
        (t (narrow-to-defun))))
#+END_SRC

** Syntax checker
*** [[https://github.com/tmalsburg/guess-language.el][Guess language]]
#+BEGIN_SRC emacs-lisp
(use-package guess-language
  :hook text-mode-hook
  :custom (guess-language-languages '(en de)))
#+END_SRC

*** [[https://github.com/bnbeckwith/writegood-mode][Mark common language issues]]
#+BEGIN_SRC emacs-lisp
(use-package writegood-mode
  :hook fundamental-mode)
#+END_SRC

*** [[https://github.com/amperser/proselint][Prose Linter]]
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "proselint" :package-manager 'pip)
  (with-eval-after-load "flycheck"
    (flycheck-define-checker proselint
      "A linter for prose."
      :command ("proselint" source-inplace)
      :error-patterns
      ((warning line-start (file-name) ":" line ":" column ": "
                (id (one-or-more (not (any " "))))
                (message (one-or-more not-newline)
                         (zero-or-more "\n" (any " ") (one-or-more not-newline)))
                line-end))
      :modes (text-mode org-mode markdown-mode gfm-mode))
    (add-to-list 'flycheck-checkers 'proselint)))
#+END_SRC

*** Diction
#+BEGIN_SRC emacs-lisp
(defvar-local cpped-diction-language "en" "The language used for diction checks.")
#+END_SRC

#+BEGIN_SRC emacs-lisp
(with-eval-after-load "flycheck"
  (with-eval-after-load "guess-language"
    (defun cpped-guess-language-switch-diction-function (lang &optional beginning end)
      "Switch the diction dictionary and recheck the current paragraph."
      (let ((new-language (cadr (assq lang guess-language-langcodes))))
        (when (and (not (string= cpped-diction-language new-language))
                   (member new-language '("en" "de")))
          (setq cpped-diction-language new-language)
          (flyspell-buffer))))

    (add-to-list 'guess-language-after-detection-functions 'cpped-guess-language-switch-diction-function))

  (with-eval-after-load "system-packages"
    (cpped-install-system-package "diction")

    (flycheck-define-checker cpped-diction
      "Diction checker"
      :command ("diction" "-bs" "-L" (eval cpped-diction-language) source-original)
      :error-patterns ((info line-start (file-name) ":" line ": " (message) line-end))
      :modes (text-mode org-mode markdown-mode gfm-mode))

    (add-to-list 'flycheck-checkers 'cpped-diction)))
#+END_SRC

** Navigation
*** Smart begin/end
#+BEGIN_SRC emacs-lisp
(use-package beginend
  :config (beginend-global-mode))
#+END_SRC

*** End sentence with single space
#+BEGIN_SRC emacs-lisp
(setq sentence-end-double-space nil)
#+END_SRC

*** Jump to other instances of symbol
#+BEGIN_SRC emacs-lisp
(use-package smartscan
  :config (global-smartscan-mode 1))
#+END_SRC

*** [[https://github.com/jcs090218/goto-line-preview][Go to line with preview]]
#+BEGIN_SRC emacs-lisp
(use-package goto-line-preview)
#+END_SRC

*** [[https://github.com/elpa-host/goto-char-preview][Go to character with preview]]
#+BEGIN_SRC emacs-lisp
(use-package goto-char-preview)
#+END_SRC

*** [[https://github.com/tam17aki/ace-isearch][Jump to any symbol]]
#+BEGIN_SRC emacs-lisp
(use-package avy
  :custom (avy-all-windows t))

(use-package ace-isearch
  :custom
  (ace-isearch-function 'avy-goto-subword-1)
  (ace-isearch-input-length 2)
  :config (global-ace-isearch-mode +1))
#+END_SRC

*** [[https://github.com/camdez/goto-last-change.el][Jump to last change]]
#+BEGIN_SRC emacs-lisp
(use-package goto-last-change)
#+END_SRC

*** URIs
**** Allow clicking on URIs
#+BEGIN_SRC emacs-lisp
(goto-address-prog-mode 1)
#+END_SRC

**** [[https://github.com/abo-abo/ace-link][Jump to link address via keys]]
#+BEGIN_SRC emacs-lisp
(use-package ace-link
  :config
  (ace-link-setup-default)
  (defun cpped-jump-to-url ()
    "Jump to the URL at point."
    (interactive)
    (let ((url (url-get-url-at-point)))
      (if url
          (browse-url url)
        (ace-link-addr)))))
#+END_SRC

** Editing
*** Indentation
#+BEGIN_SRC emacs-lisp
(setq-default indent-tabs-mode nil)
(setq-default fill-column 160)
(setq comment-empty-lines t
      electric-indent-mode t
      electric-layout-mode t
      electric-pair-mode t
      show-trailing-whitespace t
      tab-always-indent 'complete
      text-mode-hook '(turn-on-auto-fill text-mode-hook-identify)
      require-final-newline nil)
(show-paren-mode)

(defvar cpped-default-indentation 4 "The default number of spaces to indent.")
(defvar autopair-skip-whitespace t)
(defvar electric-spacing-double-space-docs nil)
(defvar whitespace-action '(cleanup))
(defvar whitespace-global-modes t)
(defvar whitespace-line-column nil)
(defvar whitespace-style '(face))
#+END_SRC

*** [[https://gitlab.com/emacs-stuff/indent-tools][Indent tools]]
#+BEGIN_SRC emacs-lisp
(use-package indent-tools)
#+END_SRC

*** Upper/lower case
#+BEGIN_SRC emacs-lisp
(use-package fix-word)
#+END_SRC

*** [[https://github.com/davidshepherd7/aggressive-fill-paragraph-mode][Auto-fill paragraphs]]
#+BEGIN_SRC emacs-lisp
(use-package aggressive-fill-paragraph
  :custom (afp-fill-comments-only-mode-list '(prog-mode)))
#+END_SRC

*** Join lines
#+BEGIN_SRC emacs-lisp
(defun cpped-join-lines ()
  "Join lines, optionally with a separator and quotes."
  (interactive)
  (if (region-active-p)
      (let ((separator-character (read-string "Separator: "))
            (quote-character (read-string "Quote: ")))
        (save-restriction
          (narrow-to-region (region-beginning) (region-end))
          (let ((lines (split-string (buffer-string) "\n" t)))
            (delete-region (point-min) (point-max))
            (insert (concat quote-character
                            (s-join (concat quote-character separator-character quote-character)
                                    lines)
                            quote-character)))))
    (crux-top-join-line)))
#+END_SRC

*** Easier escaping
#+BEGIN_SRC emacs-lisp
(use-package string-edit)
#+END_SRC

*** Expand selection
#+BEGIN_SRC emacs-lisp
(use-package expand-region)
#+END_SRC

*** Clipboard
Keep up to 500 entries
#+BEGIN_SRC emacs-lisp
(setq kill-ring-max 500)
#+END_SRC

Ignore duplicates
#+BEGIN_SRC emacs-lisp
(setq kill-do-not-save-duplicates t)
#+END_SRC

Use system clipboard
#+BEGIN_SRC emacs-lisp
(setq select-enable-clipboard t)
#+END_SRC

Save system clipboard contents to kill ring before killing
#+BEGIN_SRC emacs-lisp
(setq save-interprogram-paste-before-kill t)
#+END_SRC

*** Do not delete selected text when inserting characters
#+BEGIN_SRC emacs-lisp
(delete-selection-mode nil)
#+END_SRC

*** Do not alert when killing read-only text
#+BEGIN_SRC emacs-lisp
(setq kill-read-only-ok t)
#+END_SRC

*** Move text
#+BEGIN_SRC emacs-lisp
(use-package smart-shift
  :config (global-smart-shift-mode 1))
#+END_SRC

*** [[https://github.com/nflath/hungry-delete][Delete adjoining whitespaces in all major modes]]
#+BEGIN_SRC emacs-lisp
(use-package hungry-delete
  :config (global-hungry-delete-mode))
#+END_SRC

*** Smart backward delete
#+BEGIN_SRC emacs-lisp
(defun cpped-backward-kill-dwim ()
  (interactive "p")
  (if (region-active-p)
      (call-interactively #'kill-region)
    (kill-region (line-beginning-position) (point))))
#+END_SRC

*** [[https://github.com/lewang/ws-butler][Remove trailing whitespace in changed lines]]
#+BEGIN_SRC emacs-lisp
(use-package ws-butler
  :custom
  (ws-butler-global-mode t)
  (ws-butler-keep-whitespace-before-point nil)
  :config (ws-butler-global-mode))
#+END_SRC

*** Allow adding a newline to the end of the current line, regardless of point position
#+BEGIN_SRC emacs-lisp
(defun cpped-newline-after-current-line ()
  "Moves to the end of the current line and inserts a newline."
  (interactive)
  (end-of-line)
  (newline-and-indent))
#+END_SRC

*** Cut/copy whole line if no region is active
#+BEGIN_SRC emacs-lisp
(use-package whole-line-or-region
  :config (whole-line-or-region-mode t))
#+END_SRC

*** [[https://github.com/ongaeshi/duplicate-thing][Duplicate lines/regions]]
#+BEGIN_SRC emacs-lisp
(use-package duplicate-thing)
#+END_SRC

*** Case-insensitive line sorting
#+BEGIN_SRC emacs-lisp
(defun cpped-sort-lines-case-insensitive ()
  (interactive)
  (let ((sort-fold-case t))
    (call-interactively 'sort-lines)))
#+END_SRC

*** Sort words
#+BEGIN_SRC emacs-lisp
(use-package sort-words)
#+END_SRC

*** [[https://github.com/benma/visual-regexp.el][Visual regular expressions]]
#+BEGIN_SRC emacs-lisp
(use-package visual-regexp
  :custom (vr/engine 'emacs))

(use-package visual-regexp-steroids
  :after visual-regexp)
#+END_SRC

*** Automatic insert
**** Typographic characters
#+BEGIN_SRC emacs-lisp
(use-package typo
  :hook (text-mode . (lambda ()
                       (when (not (string-equal (buffer-name) (file-name-nondirectory cpped-config-file)))
                         (typo-mode)))))
#+END_SRC

**** Abbreviations
Enable Abbrev-Mode by default
#+BEGIN_SRC emacs-lisp
(setq-default abbrev-mode t)
#+END_SRC

Always save abbreviations. Do not ask.
#+BEGIN_SRC emacs-lisp
(setq save-abbrevs 'silently)
#+END_SRC

Some useful abbreviations
#+BEGIN_SRC emacs-lisp
(define-abbrev-table 'global-abbrev-table '(("cpsign" "©")
                                            ("tmsign" "™")
                                            ("infsign" "∞")))
#+END_SRC

**** [[https://github.com/joaotavora/yasnippet][Templates]]
#+BEGIN_SRC emacs-lisp
(use-package yasnippet
  :bind (:map yas-keymap (("ESC" . yas-abort-snippet)
                          ("DEL" . yas-skip-and-clear-or-delete-char)))
  :custom
  (yas-snippet-dirs '("~/.yas-snippets"))
  (yas-wrap-around-region t)
  (yas-use-menu nil)
  (yas-triggers-in-field t)
  (yas-also-indent-empty-lines t)
  :config (yas-global-mode 1))
#+END_SRC

***** [[https://github.com/abo-abo/auto-yasnippet][Automatic snippets]]
#+BEGIN_SRC emacs-lisp
(use-package auto-yasnippet)
#+END_SRC

*** [[https://github.com/rejeep/wrap-region.el][Wrap Region]]
#+BEGIN_SRC emacs-lisp
(use-package wrap-region)
#+END_SRC

*** Insert Date/Time
#+BEGIN_SRC emacs-lisp
(defun cpped-insert-timestamp ()
  "Insert date and time according to the locale's date and time format."
  (interactive)
  (insert (format-time-string "%c" (current-time))))

(defun cpped-insert-date ()
  "Insert the date according to the locale's date format."
  (interactive)
  (insert (format-time-string "%x" (current-time))))

(defun cpped-insert-time ()
  "Insert the time according to the locale's time format."
  (interactive)
  (insert (format-time-string "%X" (current-time))))

(defun cpped-insert-iso-date ()
  "Insert the date according to the ISO date format."
  (interactive)
  (insert (format-time-string "%F" (current-time))))

(defun cpped-insert-iso-timestamp ()
  "Insert the date according to the ISO date format."
  (interactive)
  (insert (format-time-string "%FT%T%z" (current-time))))
#+END_SRC

*** Thesaurus
#+BEGIN_SRC emacs-lisp
(use-package synosaurus
  :after system-packages
  :hook (after-init . synosaurus-mode)
  :custom (synosaurus-choose-method 'default)
  :config
  (cpped-install-system-package "wordnet")
  (setq-default synosaurus-backend 'synosaurus-backend-wordnet))
#+END_SRC

*** [[https://github.com/magnars/change-inner.el][Change inner]]
#+BEGIN_SRC emacs-lisp
(use-package change-inner)
#+END_SRC

*** Autocompletion
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "company"
  (add-hook 'text-mode-hook (lambda()
                              (set (make-local-variable 'company-backends) '((company-files company-capf company-dabbrev company-ispell))))))
#+END_SRC

*** Utilities
**** [[https://github.com/mhayashi1120/Emacs-wgrep][Edit grep buffers]]
#+BEGIN_SRC emacs-lisp
(use-package wgrep
  :custom (wgrep-enable-key "e"))

(use-package wgrep-ag
  :after (wgrep ag)
  :hook (ag-mode . wgrep-ag-setup))

(use-package wgrep-helm
  :after (wgrep helm))
#+END_SRC

**** [[https://github.com/lateau/charmap][Unicode table]]
#+BEGIN_SRC emacs-lisp
(use-package charmap)
#+END_SRC

** [[http://www-sop.inria.fr/members/Manuel.Serrano/flyspell/flyspell.html][Spell checking]]
#+BEGIN_SRC emacs-lisp
(use-package flyspell
  :after (helm-buffers system-packages)
  :custom
  (flyspell-issue-welcome-flag nil)
  (flyspell-issue-message-flag nil)
  (flyspell-sort-corrections t)
  (flyspell-default-dictionary nil)
  (flyspell-abbrev-p t)
  (flyspell-use-global-abbrev-table-p t)
  (ispell-dictionary "en_US")
  (ispell-local-dictionary "en_US")
  (ispell-program-name "/usr/bin/aspell")
  :config
  (cpped-install-system-package "aspell")
  (cpped-install-system-package "aspell-en")
  (cpped-install-system-package "aspell-de")
  (when (string-match-p "--camel-case"
                        (shell-command-to-string (concat ispell-program-name " --help")))
    (push "--camel-case" ispell-extra-args))
  (push "\\*flypell.*\\*" helm-boring-buffer-regexp-list)
  (defvar-local cpped-flyspell-errors 0 "The number of spelling errors in the document.")
  (advice-add 'flyspell-after-change-function :after (lambda (&rest arguments)
                                                       (setq cpped-flyspell-errors 0)
                                                       (dolist (buffer-overlay (overlays-in (point-min) (point-max)))
                                                         (when (flyspell-overlay-p buffer-overlay)
                                                             (setq cpped-flyspell-errors (1+ cpped-flyspell-errors))))
                                                       (force-mode-line-update)))
  (defun cpped-powerline-flyspell-status()
    "Format the modeline flyspell information."
    (when (and flyspell-mode
               (> cpped-flyspell-errors 0))
      (concat (propertize (all-the-icons-faicon5 "comment")
                          'face (list ':inherit 'cpped-check-status-error
                                      ':family (all-the-icons-faicon5-family))
                          'display '(raise -0.0))
              (propertize (format " %d" cpped-flyspell-errors)
                          'face 'cpped-check-status-error))))
  (add-to-list 'cpped-powerline-check-status-functions 'cpped-powerline-flyspell-status))

(use-package helm-flyspell
  :after (helm flyspell)
  :config (advice-add #'flyspell-auto-correct-word :override #'helm-flyspell-correct))
#+END_SRC

*** [[https://github.com/redguardtoo/wucuo][Allow spell-checking for CamelCase word]]
#+BEGIN_SRC emacs-lisp
(use-package wucuo
  :after flyspell
  :hook (find-file . wucuo-start))
#+END_SRC

*** [[https://github.com/nschum/auto-dictionary-mode][Automatic dictionary selection]]
#+BEGIN_SRC emacs-lisp
(use-package guess-language
  :after flyspell
  :hook flyspell-mode
  :custom
  (guess-language-languages '(en de))
  (guess-language-min-paragraph-length 35))
#+END_SRC

** Utilities
*** [[https://github.com/fourier/loccur][Filter]]
#+BEGIN_SRC emacs-lisp
(use-package loccur)
#+END_SRC

*** [[https://github.com/akicho8/string-inflection][Change lower/upper case]]
#+BEGIN_SRC emacs-lisp
(use-package string-inflection)
#+END_SRC

*** [[https://github.com/netromdk/describe-number][Convert numbers]]
#+BEGIN_SRC emacs-lisp
(use-package describe-number)
#+END_SRC

*** [[https://github.com/abo-abo/define-word][Define word]]
#+BEGIN_SRC emacs-lisp
(use-package define-word)
#+END_SRC

*** [[https://github.com/atykhonov/google-translate][Translate text]]
#+BEGIN_SRC emacs-lisp
(use-package google-translate
  :custom
  (google-translate-show-phonetic t)
  (google-translate-output-destination 'popup)
  (google-translate-default-source-language "auto")
  :config
  (defun cpped-translate-word-or-region (&optional target-language replace)
    "Replace the current region or word with its translation."
    (interactive)
    (let* ((bounds (cpped-word-or-region-bounds))
           (begin (car bounds))
           (end (cdr bounds))
           (text (buffer-substring-no-properties begin
                                                 end))
           (target-language (google-translate-language-abbreviation (or target-language
                                                                        (google-translate-completing-read "Translate to: "
                                                                                                          (google-translate-supported-languages)
                                                                                                          "English"))))
           (google-translate-output-destination (if replace
                                                    'current-buffer
                                                  google-translate-output-destination)))
      (when replace
        (delete-region begin end))
      (google-translate-translate "auto" target-language text))))
#+END_SRC

* Binaries
Open binary files in hexl-mode
#+BEGIN_SRC emacs-lisp
(defvar cpped-no-hexedit-extensions nil "File extensions for which automatic hex editing is disabled")

(add-hook 'find-file-hook (lambda ()
                            (message(buffer-file-name))
                            (when (and (eq buffer-file-coding-system 'no-conversion)
                                       (not (catch 'found
                                              (mapc (lambda (pattern)
                                                      (message pattern)
                                                      (when (and (stringp buffer-file-name)
                                                                 (string-match pattern buffer-file-name))
                                                        (message "found")
                                                        (throw 'found pattern)))
                                                    cpped-no-hexedit-extensions)
                                              nil)))
                              (hexl-mode))))
#+END_SRC

* Images
** Disable hex edit mode for images
#+BEGIN_SRC emacs-lisp
(push "\\.jpg\\'" cpped-no-hexedit-extensions)
(push "\\.jpeg\\'" cpped-no-hexedit-extensions)
(push "\\.png\\'" cpped-no-hexedit-extensions)
(push "\\.gif\\'" cpped-no-hexedit-extensions)
(push "\\.svg\\'" cpped-no-hexedit-extensions)
#+END_SRC

* Programming
** Projects
*** Find file in project
#+BEGIN_SRC emacs-lisp
(defun cpped-find-project-file (file)
  "Find a file in source or build directory."
  (or
   (let* ((source-dir (cpped-project-dir))
          (source-file (when source-dir
                         (expand-file-name file source-dir))))
     (when (and source-file
                (file-exists-p source-file))
       source-file))
   (let* ((build-dir (cpped-build-dir))
          (build-file (when build-dir
                        (expand-file-name file build-dir))))
     (when (and build-file
                (file-exists-p build-file))
       source-file))))
#+END_SRC

*** Use docker to run tools for docker-based projects
#+BEGIN_SRC emacs-lisp
(defvar default-docker-compose-file "docker-compose.yml" "The default name for the docker-compose file.")
(defvar default-docker-start-script "docker-run.sh" "The default path to a script to start applications in a docker container.")

(defun cpped-docker-compose-file ()
  "Find the compose file in the project root."
  (let ((compose-file (cpped-find-project-file default-docker-compose-file)))
    (when (and compose-file
             (file-exists-p compose-file))
        compose-file)))

(defun cpped-is-docker-project-p ()
  "Check if the current project supports docker."
  (or (cpped-docker-compose-file)
      (cpped-find-project-file ".docker-project")))

(defun cpped-maybe-run-in-docker (command)
  "Run a command in docker if supported by the project."
  (let* ((compose-file (cpped-docker-compose-file)))
    (if compose-file
        (append `(docker-compose --file ,compose-file --exec) command)
      (if (and (cpped-is-docker-project-p)
               default-docker-start-script)
          (append default-docker-start-script command)
        command))))

(with-eval-after-load "flycheck"
  (setq flycheck-command-wrapper-function #'(lambda (command)
                                              (cpped-maybe-run-in-docker command))))
#+END_SRC

*** CMake
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "cmake")
(cpped-install-system-package "ccmake")
(cpped-install-system-package "ninja-build")
#+END_SRC

**** Re-/Configure CMake
Handler to close buffer after quitting ccmake.
#+BEGIN_SRC emacs-lisp
(advice-add 'term-sentinel :after (lambda (proc msg)
                                    (when (and (equal (buffer-name (process-buffer proc)) "*CMake Cache*")
                                               (memq (process-status proc) '(signal exit))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defvar cpped-build-base-directory "~/Build" "The default build directory.")
(defvar cpped-build-directories nil "An alist of all build directories per source directory.")
(defvar cpped-current-build-directories nil "An alist of the selected build directory per source directory.")

(defun cpped-cmake-configure (source-dir build-dir)
  "Configure the CMake project for the current file."
  (interactive (let ((source-directory (if (and (boundp 'source-dir)
                                                source-dir
                                                (file-directory-p source-dir))
                                           source-dir
                                           (read-directory-name "Source Directory: "
                                                                (cpped-project-dir)))))
                 (list source-directory
                       (if (and (boundp 'build-dir)
                                build-dir)
                           build-dir
                           (read-directory-name "Build-directory: "
                                                (expand-file-name (file-name-nondirectory (directory-file-name (file-name-directory source-directory))) cpped-build-base-directory))))))
    (when (and build-dir
               source-dir)
      (if (file-directory-p source-dir)
          (if (cpped-cmake-source-directory-p source-dir)
              (progn
                (when (not (file-directory-p build-dir))
                  (make-directory build-dir t))
                (let ((default-directory build-dir))
                  (ansi-term (getenv "SHELL") (concat "*CMake Cache (" build-dir ")*"))
                  (let* ((full-command (cpped-maybe-run-in-docker source-dir `(ccmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -G Ninja ,source-dir)))
                         (command (car full-command))
                         (arguments (cdr full-command)))
                    (term-exec (current-buffer) command command nil arguments))
                  (cpped-load-project build-dir)))
            (error "`%s' does not contain a CMake project" source-dir))
        (error "`%s' is not a directory" source-dir))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-reconfigure (build-dir)
  "Reconfigure the CMake project for the current file and build directory."
  (interactive (list (or (cpped-build-dir)
                         (read-directory-name "Build-directory: "
                                              (file-name-as-directory cpped-build-base-directory)))))
  (if (and build-dir
           (file-directory-p build-dir))
      (if (cpped-cmake-build-directory-p build-dir)
          (let ((default-directory build-dir))
            (ansi-term (getenv "SHELL") "CMake Cache")
            (let* ((full-command (cpped-maybe-run-in-docker (cpped-cmake-source-dir build-dir) '(ccmake .)))
                   (command (car full-command))
                   (arguments (cdr full-command)))
              (term-exec (current-buffer) command command nil arguments))
            (cpped-load-project build-dir))
        (error "`%s' is not a CMake build directory" build-dir))
    (error "`%s' is not a directory" build-dir)))
#+END_SRC

**** Clear CMake Cache
#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-reset (build-dir)
  "Reset the current CMake configuration."
  (interactive (list (or (cpped-build-dir)
                         (read-directory-name "Build-directory: "
                                              (file-name-as-directory cpped-build-base-directory)))))
  (if (and build-dir
           (file-directory-p build-dir))
      (let ((cache-file (expand-file-name "CMakeCache.txt" build-dir)))
        (if (file-exists-p cache-file)
            (progn (delete-file cache-file)
                   (cpped-cmake-configure (cpped-cmake-source-dir build-dir) build-dir))
          (error "`%s' is not a CMake build directory" build-dir)))
    (error "`%s' is not a directory" build-dir)))
#+END_SRC

**** Open Project
#+BEGIN_SRC emacs-lisp
(defvar cpped-after-project-load-hook nil "Hook called after a project is loaded. ")
(defvar cpped-after-project-load-update-project-file-hook nil "Hook called for each project file after a project is loaded. ")

(defun cpped-load-project (build-dir)
  "Load a project."
  (interactive (list (read-directory-name "Build-directory: "
                                          (file-name-as-directory cpped-build-base-directory))))
  (if (cpped-build-directory-p build-dir)
      (let ((source-dir (if (cpped-cmake-build-directory-p build-dir)
                            (cpped-cmake-source-dir build-dir)
                          build-dir)))
        (projectile-discover-projects-in-directory source-dir)
        (when (not (boundp cpped-cmake-current-target))
                                        (setq cpped-cmake-current-target 'all))
        (push '(source-dir . build-dir) cpped-current-build-directories)
        (run-hooks 'cpped-after-project-load-hook)
        (mapc (lambda (buffer)
                (with-current-buffer buffer
                  (run-hooks 'cpped-after-project-load-update-project-file-hook)))
              (projectile-project-buffers)))
    (error "`%s' is not a build directory" build-dir)))
#+END_SRC

**** Select configuration
#+BEGIN_SRC emacs-lisp
(setq cpped-build-directories '(("/home/player/.dotfiles/" . "/home/player/test") ("/home/player" . "/home/player/bla")))

(defun cpped-select-project-config (source-dir)
  "Select a project configuration for the current source directory."
  (interactive (list (read-directory-name "Source Directory: "
                                          (cpped-project-dir))))
  (let ((build-dir (helm :sources (helm-build-sync-source "Configurations"
                                         :candidates
                                         (mapc (lambda (dir)
                                                 ((file-name-nondirectory (directory-file-name dir)) . dir))
                                               (cdr (assoc source-dir cpped-build-directories))))
                         :prompt "Configuration: "
                         :buffer "*helm project*")))
    (cpped-load-project build-dir)
    build-dir))
#+END_SRC

**** Delete configuration
#+BEGIN_SRC emacs-lisp
(defun cpped-delete-cmake-build-dir (build-dir)
  "Delete the currently set build directory."
  (interactive (list (or (cpped-build-dir)
                         (read-directory-name "Build-directory: "
                                              (file-name-as-directory cpped-build-base-directory)))))
  (when (cpped-cmake-build-directory-p build-dir)
    (delete-directory build-dir t t)
    (projectile-remove-known-project (cpped-cmake-source-dir build-dir))))
#+END_SRC

**** Open shell in build directory
#+BEGIN_SRC emacs-lisp
(defun cpped-shell-build-dir ()
  "Open a shell in the current build directory."
  (interactive)
  (let ((build-dir (cpped-build-dir)))
    (when build-dir
      (let ((default-directory (cpped-cmake-build-dir)))
        (ansi-term)))))
#+END_SRC

**** List targets
#+BEGIN_SRC emacs-lisp
(defvar cpped-current-targets nil "An alist of the currently selected build target per build directory.")

(defun cpped-get-cmake-targets (build-dir)
  "List all CMake targets for build-dir."
  (save-match-data
    (let ((output (shell-command-to-string (cpped-maybe-run-in-docker (cpped-cmake-source-dir build-dir) `(cmake --build ,build-dir --target help))))
          (position 0)
          (targets (list "all")))
      (while (string-match "^[\\. ]*\\([^\\[: ]+\\)" output position)
        (let ((target (match-string 1 output)))
          (unless (or (not target)
                      (string= target "edit_cache"))
            (push target targets))
          (setq position (match-end 0))))
      targets)))

(defun cpped-get-make-targets (build-dir)
  "List all make targets for build-dir."
  (let ((targets (list "all")))
    (with-temp-buffer
      (insert (shell-command-to-string (cpped-maybe-run-in-docker (cpped-cmake-source-dir build-dir) `(LANG=C make -C ,build-dir -nqp .DEFAULT 2>/dev/null))))
      (goto-char (point-min))
      (save-match-data
        (when (re-search-forward "^# Files" nil t)
          (while (re-search-forward "^\\([^/%$:#\n\t ]+\\):\\([^=]\\|$\\)" nil t)
            (setq target (match-string 1))
            (unless (or (save-excursion
                          (goto-char (match-beginning 0))
                          (forward-line -1)
                          (looking-at "^# Not a target:"))
                        (string-match "\\.[hoc]p*$" target))
              (push target targets))))
        targets))))

(defun cpped-select-target (build-dir)
  "Select a build target for the current build directory."
  (interactive (list (or (cpped-build-dir)
                         (read-directory-name "Build-directory: "
                                              (file-name-as-directory cpped-build-base-directory)))))
  (let ((current-target (helm :sources (helm-build-sync-source "Targets"
                                         :candidates
                                         (remove-duplicates (sort (if (cpped-cmake-build-directory-p build-dir)
                                                                      (cpped-get-cmake-targets build-dir)
                                                                    (cpped-get-make-targets build-dir)) #'string-lessp) :test 'string=))
                              :prompt "Target: "
                              :preselect (or (cdr (assoc build-dir cpped-current-targets))
                                             "all")
                              :buffer "*helm target*")))
    (push '(build-dir . current-target) cpped-current-targets)
    current-target))

(defun cpped-build-target ()
  "Get the selected build target for the curent build directory."
  (cdr (assoc (cpped-build-dir) cpped-current-targets)))
#+END_SRC

**** Utilities
***** Find source directory
#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-source-dir (build-dir)
  "Find the corresponding source directory for build-dir."
  (interactive (list (read-directory-name "Build-directory: "
                                          (file-name-as-directory cpped-build-base-directory))))
  (let ((cache-file (expand-file-name "CMakeCache.txt" build-dir)))
    (if (file-exists-p cache-file)
        (let ((source-dir (with-temp-buffer
                            (insert-file-contents cache-file)
                            (beginning-of-buffer)
                            (save-match-data
                              (and
                               (search-forward-regexp "CMAKE_HOME_DIRECTORY[^=]*=[:blank:]*\\(.*\\)[:blank:]*$"
                                                      (point-max) nil 1)
                               (match-string 1))))))
          (if (and source-dir
                   (cpped-cmake-source-directory-p source-dir))
              (if (called-interactively-p 'any)
                  (message (format "The source directory for `%s' is `%s'." build-dir source-dir))
                source-dir)
            (error "Source directory information not found in cache")))
      (error "`%s' is not a CMake build directory" build-dir))))
#+END_SRC

***** Get build directory
#+BEGIN_SRC emacs-lisp
(defun cpped-build-dir ()
  "Get the current build directory."
  (interactive)
  (cdr (assoc (cpped-project-dir) cpped-current-build-directories)))
#+END_SRC

***** Check if directory is source directory
#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-source-directory-p (source-dir)
  "Check if source-dir is a CMake source directory."
  (file-exists-p (expand-file-name "CMakeLists.txt" source-dir)))
#+END_SRC

***** Check if directory is build directory
#+BEGIN_SRC emacs-lisp
(defun cpped-cmake-build-directory-p (build-dir)
  "Check if build-dir is a CMake build directory."
  (or (file-exists-p (expand-file-name "CMakeCache.txt" build-dir))))

(defun cpped-ninja-build-directory-p (build-dir)
  "Check if build-dir is a ninja build directory."
  (or (file-exists-p (expand-file-name "build.ninja" build-dir))))

(defun cpped-make-build-directory-p (build-dir)
  "Check if build-dir is a make build directory."
  (or (file-exists-p (expand-file-name "Makefile" build-dir))))

(defun cpped-build-directory-p (build-dir)
  "Check if build-dir is a build directory."
  (or (cpped-cmake-build-directory-p build-dir)
      (cpped-ninja-build-directory-p build-dir)
      (cpped-make-build-directory-p build-dir)))
#+END_SRC

***** Check if directory is build directory for the current project
#+BEGIN_SRC emacs-lisp
(defun cpped-project-build-directory-p (build-dir)
  "Check if build-dir is a build directory for the current project."
  (and (cpped-cmake-build-directory-p build-dir)
       (if (cpped-cmake-build-directory-p build-dir)
           (string-equal (cpped-cmake-source-dir build-dir)
                         (cpped-project-dir))
         (string-equal build-dir
                       (cpped-project-dir)))))
#+END_SRC

*** Build
#+BEGIN_SRC emacs-lisp
(defun cpped-build-target (target)
  "Build the current target in the current build directory. Ask for target if not set."
  (interactive (list (or (or (cpped-build-target)
                             (call-interactively 'cpped-select-target)))))
  (let ((build-dir (cpped-build-dir)))
    (when (and build-dir target)
      (cond
       ((cpped-cmake-build-directory-p) (compile (string-join
                                                  (cpped-maybe-run-in-docker
                                                   (cpped-cmake-source-dir build-dir)
                                                   `(cmake --build ,build-dir --target ,target)))))
       ((cpped-ninja-build-directory-p) (compile (string-join
                                                  (cpped-maybe-run-docker
                                                   (cpped-cmake-source-dir build-dir)
                                                   `(ninja -C ,build-dir ,target)))))
       ((cpped-cmake-build-directory-p) (compile (string-join
                                                  (cpped-maybe-run-docker
                                                   (cpped-cmake-source-dir build-dir)
                                                   `(make -C ,build-dir ,target)))))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-clean-build-directory ()
  "Build the clean target in the current build directory."
  (interactive)
  (cpped-build-target "clean"))
#+END_SRC

*** Run/Debug
#+BEGIN_SRC emacs-lisp
(defun cpped-run-target (target)
  "Build and run the current target in the current build directory. Ask for target if not set."
  (interactive (list (or (or (cpped-build-target)
                             (call-interactively 'cpped-select-target)))))
  (cpped-build-target target)
  (let ((executable (locate-file target exec-path exec-suffixes 'executable)))
    (when executable
      (let ((default-directory(file-name-directory executable)))
        (call-process (cpped-maybe-run-in-docker executable))))))

(defun cpped-debug-target (target)
  "Build and run the current target in the current build directory. Ask for target if not set."
  (interactive (list (or (or (cpped-build-target)
                             (call-interactively 'cpped-select-target)))))
  (cpped-build-target target)
  (let ((executable (locate-file target exec-path exec-suffixes 'executable)))
    (when executable
      (realgud:gdb (cpped-maybe-run-in-docker (concat "gdb -cd=" (file-name-directory executable) " " executable))))))
#+END_SRC

** Languages
*** Common
#+BEGIN_SRC emacs-lisp
(use-package lsp-mode
  :after helm-buffers
  :hook prog-mode
  :custom
  (lsp-auto-configure t)
  (lsp-log-max 100)
  (lsp-prefer-flymake nil)
  (lsp-report-if-no-buffer nil)
  (lsp-restart 'auto-restart)
  (lsp-ui-doc-include-signature nil)
  (lsp-ui-sideline-show-symbol nil)
  :config (push "^\\*lsp-.+" helm-boring-buffer-regexp-list))

(use-package lsp-ui)
#+END_SRC

**** Highlighting
***** [[https://github.com/larstvei/Focus][Dim inactive regions]]
#+BEGIN_SRC emacs-lisp
(use-package focus
  :after lsp-mode
  :hook (prog-mode . focus-mode)
  :custom (focus-dimness -2))
#+END_SRC

***** [[https://github.com/ikirill/hl-indent][Scope background]]
#+BEGIN_SRC emacs-lisp
(use-package hl-indent
  :hook (prog-mode . hl-indent-mode)
  :custom (hl-indent-color-indents t))
#+END_SRC

***** [[https://github.com/ankurdave/color-identifiers-mode][Unique colors for identifiers]]
#+BEGIN_SRC emacs-lisp
(use-package color-identifiers-mode
  :hook prog-mode)
#+END_SRC

***** [[https://github.com/Fanael/rainbow-delimiters][Unique colors for parentheses]]
#+BEGIN_SRC emacs-lisp
(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))
#+END_SRC

***** [[https://github.com/dgutov/highlight-escape-sequences][Escape sequences]]
#+BEGIN_SRC emacs-lisp
(use-package highlight-escape-sequences
  :hook (prog-mode . hes-mode))
#+END_SRC

***** Pretty symbols
#+BEGIN_SRC emacs-lisp
(add-hook 'prog-mode-hook
          (lambda ()
            (push '("!=" . ?≠) prettify-symbols-alist)
            (push '("==" . ?⩵) prettify-symbols-alist)
            (push '(">=" . ?≧) prettify-symbols-alist)
            (push '("<=" . ?≦) prettify-symbols-alist)
            (push '("->" . ?➔) prettify-symbols-alist)
            (push '("return" . ?⮠) prettify-symbols-alist)
            (push '("true" . ?✓) prettify-symbols-alist)
            (push '("TRUE" . ?✓) prettify-symbols-alist)
            (push '("false" . ?🚫) prettify-symbols-alist)
            (push '("FALSE" . ?🚫) prettify-symbols-alist)))
#+END_SRC

***** [[https://github.com/tarsius/hl-todo][Highlight TODO/FIXME/…
#+BEGIN_SRC emacs-lisp
(defface hl-todo-info '((t :inherit info))
  "Face used for info text."
  :group 'hl-todo)

(defface hl-todo-warning '((t :inherit warning))
  "Face used for warning text."
  :group 'hl-todo)

(defface hl-todo-error '((t :inherit error))
  "Face used for error text."
  :group 'hl-todo)

(use-package hl-todo
  :hook (prog-mode . hl-todo-mode)
  :custom
  (global-hl-todo-mode t)
  (hl-todo-keyword-faces '(("???" . hl-todo-info)
                           ("FAIL" . hl-todo-error)
                           ("FIXME" . hl-todo-error)
                           ("HACK" . hl-todo-error)
                           ("INFO" . hl-todo-info)
                           ("NOTE" . hl-todo-info)
                           ("TODO" . hl-todo-warning)
                           ("XXX" . hl-todo-warning)))
  :config
  (push '("???" . ?🛈) prettify-symbols-alist)
  (push '("FAIL" . ?⛐) prettify-symbols-alist)
  (push '("FIXME" . ?🛠) prettify-symbols-alist)
  (push '("HACK" . ?☢) prettify-symbols-alist)
  (push '("INFO" . ?🛈) prettify-symbols-alist)
  (push '("NOTE" . ?🗈) prettify-symbols-alist)
  (push '("TODO" . ?🛠) prettify-symbols-alist)
  (push '("XXX" . ?☓) prettify-symbols-alist))
#+END_SRC

***** Find ToDos in file or project
#+BEGIN_SRC emacs-lisp
(defun cpped-find-todos-in-project ()
  "Show all ToDo items in the project and allow jumping to specific item."
  (interactive)
  (let* ((helm-ag-command-option (concat "--all-text --context=0 --after=0 --depth=-1 --follow --numbers --nobreak --nogroup --noheading --case-sensitive"))
         (current-prefix-arg nil))
    (cl-letf (((symbol-function 'helm-ag--marked-input) '(lambda (escape)
                                                           (concat "[[:space:]/*#;]("
                                                                   (string-join (mapcar (lambda (element)
                                                                                          (regexp-quote (car element)))
                                                                                        hl-todo-keyword-faces) "|")
                                                                   ")[[:space:]:]"))))
      (helm-do-ag (if (ignore-errors (projectile-project-p))
                      (projectile-project-root)
                    default-directory)))))

(defun cpped-find-todos-in-file ()
  "Show all ToDo items in the file and allow jumping to specific item."
  (interactive)
  (let ((original-helm-swoop-pre-input-function helm-swoop-pre-input-function)
        (helm-case-fold-search nil)
        (case-fold-search nil))
    (unwind-protect
        (progn
          (setq helm-swoop-pre-input-function (lambda ()
                                                (concat "[[:space:]/*#;]\\(" (string-join (mapcar (lambda (element)
                                                                                                  (regexp-quote (car element)))
                                                                                                hl-todo-keyword-faces) "\\|")
                                                        "\\)[[:space:]:]")))
          (helm-swoop))
      (setq helm-swoop-pre-input-function original-helm-swoop-pre-input-function))))
#+END_SRC

***** Show current function in mode-line
#+BEGIN_SRC emacs-lisp
(use-package which-func
  :custom (which-func-unknown "n/a")
  :config (which-function-mode 1))
#+END_SRC

***** [[https://github.com/AdamNiederer/cov][Code coverage]]
#+BEGIN_SRC emacs-lisp
(use-package cov
  :after all-the-icons
  :hook ((prog-mode . cov-mode)
         (cpped-after-project-load . (lambda ()
                                       (add-to-list 'cov-coverage-file-paths (cpped-build-dir)))))
  :custom (cov-coverage-mode t)
  :config
  (make-variable-buffer-local 'cov-coverage-file-paths)
  (defvar-local cpped-cov-lines-covered 0 "The number of lines covered in tests and/or application runs.")
  (defvar-local cpped-cov-percentage-covered 0 "The percentage of lines covered in tests and/or application runs.")
  (advice-add 'cov--get-face :after (lambda (percentage)
                                      (when (> percentage 0)
                                        (setq cpped-cov-lines-covered (1+ cpped-cov-lines-covered)))))
  (advice-add 'cov-update :around (lambda (wrapped-function &rest arguments)
                                    (setq lines-covered 0)
                                    (apply wrapped-function arguments)
                                    (setq cpped-cov-percentage-covered (* (/ cpped-cov-lines-covered (string-to-number (format-mode-line "%l"))) 100)
                                      (force-mode-line-update))))
  (defun cpped-coverage-status-face ()
    "Calculate the face for the coverage status."
    (cond ((> cpped-cov-percentage-covered 90) 'cpped-check-status-info)
          ((> cpped-cov-percentage-covered 30) 'cpped-check-status-warning)
          (t 'cpped-check-status-error)))
  (defun cpped-powerline-coverage()
    "Format the modeline coverage information."
    (when cov-coverage-file
      (let ((face (cpped-coverage-status-face)))
        (concat (propertize (all-the-icons-faicon5 "tasks")
                            'face (list ':inherit face
                                        ':family (all-the-icons-faicon5-family))
                            'display '(raise -0.0))
                (propertize (format " %d%%" cpped-cov-percentage-covered)
                            'face face)))))
  (add-to-list 'cpped-powerline-check-status-functions 'cpped-powerline-coverage))
#+END_SRC

**** Navigation
***** [[https://github.com/brotzeit/helm-xref][Helm interface for xref]]
#+BEGIN_SRC emacs-lisp
(use-package helm-xref
  :custom (xref-show-xrefs-function 'helm-xref-show-xrefs))
#+END_SRC

***** [[https://github.com/gregsexton/origami.el][Folding]]
#+BEGIN_SRC emacs-lisp
(use-package origami
  :hook (prog-mode . origami-mode)
  :custom (origami-fold-replacement "…"))

(use-package lsp-origami
  :hook (lsp-mode . lsp-origami-mode))
#+END_SRC

***** Subword-navigation in camelCase words
#+BEGIN_SRC emacs-lisp
(add-hook 'prog-mode-hook (lambda () (subword-mode 1)))
#+END_SRC

***** [[https://github.com/magnars/smart-forward.el][Smart forward/backward]]
#+BEGIN_SRC emacs-lisp
(use-package smart-forward)
#+END_SRC

**** Editing
***** Formatting
#+BEGIN_SRC emacs-lisp
(defvar-local cpped-format-region-function nil "The function to call to format the current region.")
(defvar-local cpped-format-buffer-function nil "The function to call to format the whole buffer.")
(defvar-local cpped-auto-format-enabled-p t "Whether to enable auto-formatting for the current buffer.")
#+END_SRC

****** Auto-format
#+BEGIN_SRC emacs-lisp
(add-hook 'before-save-hook #'(lambda()
                                (when (and cpped-auto-format-enabled-p
                                           cpped-format-buffer-function)
                                  (funcall cpped-format-buffer-function))))
#+END_SRC

****** Fill function calls
#+BEGIN_SRC emacs-lisp
(use-package prog-fill
  :custom
  (prog-fill-break-method-immediate-p t)
  (prog-fill-floating-open-paren-p nil)
  (prog-fill-floating-close-paren-p nil)
  (prog-fill-auto-indent-p t))
#+END_SRC

***** [[https://github.com/remyferre/comment-dwim-2][Smarter commenting]]
#+BEGIN_SRC emacs-lisp
(use-package comment-dwim-2)
#+END_SRC

***** [[https://github.com/victorhge/iedit][Edit all occurences within function]]
#+BEGIN_SRC emacs-lisp
(defvar-local cpped-mark-function 'mark-defun "The function to call to mark the current function.")
(defvar-local cpped-beginning-of-function 'beginning-of-defun "The function to call to jump to the beginning of the current function.")
(defvar-local cpped-end-of-function 'end-of-defun "The function to call to jump to the end of the current function.")

(use-package iedit)

(defun iedit-dwim (arg)
  "Starts iedit but uses \\[narrow-to-defun] to limit its scope."
  (interactive "P")
  (if arg
      (iedit-mode)
    (save-excursion
      (save-restriction
        (widen)
        (if iedit-mode
            (iedit-done)
          (let ((word (current-word))
                (end (progn (funcall cpped-end-of-function)
                            (point)))
                (begin (progn (funcall cpped-beginning-of-function)
                              (point))))
            (iedit-start word begin end)))))))
#+END_SRC

***** Change numbers
#+BEGIN_SRC emacs-lisp
(use-package shift-number)
#+END_SRC

***** [[https://github.com/AdamNiederer/0xc][Convert number formats]]
#+BEGIN_SRC emacs-lisp
(use-package 0xc
  :config (defun cpped-convert-number (base)
            (interactive (list (string-to-number (helm :sources (helm-build-sync-source "Bases"
                                                                  :candidates '("2" "8" "10" "16"))
                                                       :prompt "Base: "
                                                       :buffer "*helm number base*"))))

            (0xc-convert-point base)))
#+END_SRC

***** [[https://github.com/emacsfodder/kurecolor][Modify colors]]
#+BEGIN_SRC emacs-lisp
(use-package kurecolor)
#+END_SRC

***** Auto-completion
#+BEGIN_SRC emacs-lisp
(use-package company
  :hook (after-init . global-company-mode)
  :custom
  (company-auto-complete nil)
  (company-auto-complete-chars '(32 95 41 119 46))
  (company-frontends '(company-preview-if-just-one-frontend company-pseudo-tooltip-unless-just-one-frontend))
  (company-backends '((company-keywords company-yasnippet company-files company-capf company-dabbrev)))
  (company-idle-delay 0)
  (company-selection-wrap-around t)
  (company-show-numbers nil)
  (company-tooltip-align-annotations nil)
  (company-tooltip-flip-when-above nil)
  (company-transformers '(company-sort-by-backend-importance))
  (company-tooltip-limit 30)
  (company-tooltip-minimum-width 50)
  (company-tooltip-offset-display 'scrollbar))

(use-package company-statistics
  :after company
  :config (company-statistics-mode))

(use-package company-quickhelp
  :config (company-quickhelp-mode 1))

(use-package company-lsp
  :after company
  :custom
  (company-transformers nil)
  (company-lsp-async t)
  (company-lsp-cache-candidates nil)
  (company-lsp-enable-snippet t)
  (company-lsp-enable-recompletion t))

(use-package company-box
  :hook (company-mode . company-box-mode))
#+END_SRC

****** Line completion backend
#+BEGIN_SRC emacs-lisp
(defun cpped-company-line-backend (command &optional arg &rest ignored)
  "Completes full lines."
  (interactive (list 'interactive))
  (cl-case command
    (interactive (company-begin-backend 'cpped-company-line-backend))
    (prefix (company-grab-symbol))
    (candidates
     (let ((matches))
       (save-excursion
         (save-restriction
           (widen)
           (goto-char 1)
           (while (search-forward arg nil t)
             (push (concat arg (buffer-substring (point) (point-at-eol))) matches))))
       matches))))

(add-to-list 'company-backends 'cpped-company-line-backend)
#+END_SRC

***** [[https://github.com/davidshepherd7/electric-operator][Automatic spacing]]
#+BEGIN_SRC emacs-lisp
(use-package electric-operator
  :hook ((text-mode . electric-operator-mode)
         (prog-mode . electric-operator-mode))
  :custom (electric-operator-enable-in-docs t))
#+END_SRC

***** [[https://github.com/snosov1/dummyparens][Automatic parens]]
#+BEGIN_SRC emacs-lisp
(use-package dummyparens
  :config
  (global-dummyparens-mode))
#+END_SRC

***** [[http://www.flycheck.org/en/latest/][Syntax checking]]
#+BEGIN_SRC emacs-lisp
(use-package flycheck
  :after (helm-buffers popwin)
  :hook (after-init . global-flycheck-mode)
  :custom
  (flycheck-idle-change-delay 0.3)
  (flycheck-display-errors-delay 0.2)
  (flycheck-checker-error-threshold nil)
  (flycheck-indication-mode nil)
  (flycheck-highlighting-mode nil)
  (flycheck-display-errors-function nil)
  (flycheck-help-echo-function nil)
  (flycheck-process-error-functions nil)
  (flycheck-check-syntax-automatically '(mode-enabled save idle-change))
  :config
  (push "^\\*Flycheck.+\\*$" helm-boring-buffer-regexp-list)
  (push '("^\\*Flycheck.+\\*$" :regexp t :dedicated t :position bottom) popwin:special-display-config)
  (defun cpped-powerline-flycheck-status-face ()
    (pcase flycheck-last-status-change
      (`errored 'cpped-check-status-error)
      (`finished
       (if flycheck-current-errors
           (let-alist (flycheck-count-errors flycheck-current-errors)
             (cond (.error 'cpped-check-status-error)
                   (.warning 'cpped-check-status-warning)
                   (.info 'cpped-check-status-info)))
         'cpped-check-status-info))
      (_ 'cpped-check-status-warning)))
  (defun cpped-powerline-flycheck-status ()
    (when (and (boundp 'flycheck-last-status-change)
               (equal flycheck-last-status-change 'finished))
      (let ((issues (let-alist (flycheck-count-errors flycheck-current-errors)
                      (+ (or .warning 0) (or .error 0) (or .info 0))))
            (face (cpped-powerline-flycheck-status-face)))
        (concat
         (propertize (all-the-icons-faicon5 "bug")
                     'face (list ':inherit face
                                 ':family (all-the-icons-faicon5-family))
                     'display '(raise -0.0))
         (propertize (format " %d" issues)
                     'face face)))))
  (add-to-list 'cpped-powerline-check-status-functions 'cpped-powerline-flycheck-status))
#+END_SRC

Custom error highlighting (colored line under location)
#+BEGIN_SRC emacs-lisp
(defun cpped-flycheck-clear (status)
  "Clear the highlights if appropriate."
  (let ((clear nil))
    (when (boundp 'flycheck-last-status-change)
      (pcase flycheck-last-status-change
        (`not-checked (setq clear t))
        (`errored (setq clear t))
        (`interrupted (setq clear t))
        (_ (setq clear nil))))
    (when clear
      (remove-overlays nil nil 'cpped-flycheck-inline-error t))))

(defun cpped-flycheck-inline-error-messages ()
  "Show Flycheck errors in a new line below the problematic line."
  (remove-overlays nil nil 'cpped-flycheck-inline-error t)
  (mapc #'(lambda (error)
            (let* ((begin (save-excursion
                            (goto-char (flycheck-error-pos error))
                            (forward-line)
                            (point)))
                   (level (symbol-name (flycheck-error-level error)))
                   (face (pcase level
                           ("error" 'flycheck-error)
                           ("warning" 'flycheck-warning)
                           ("info" 'flycheck-info)
                           (_ 'default)))
                   (overlay (make-overlay begin begin)))
              (overlay-put overlay 'before-string (concat
                                                   (propertize (all-the-icons-faicon5 (pcase level
                                                                                       ("error" "times-circle")
                                                                                       ("warning" "exclamation-triangle")
                                                                                       ("info" "info-circle")
                                                                                       (_ "question-circle")))
                                                               'face (list ':inherit face
                                                                           ':family (all-the-icons-faicon5-family))
                                                               'display '(raise -0.0))
                                                   (propertize (concat " " (flycheck-error-message error) "\n") 'face face)))
              (overlay-put overlay 'cpped-flycheck-inline-error t))) flycheck-current-errors))

(add-hook 'flycheck-after-syntax-check-hook #'cpped-flycheck-inline-error-messages)
(add-hook 'flycheck-status-changed-functions #'cpped-flycheck-clear)
#+END_SRC

***** [[https://github.com/michaeljb/bool-flip][Flip booleans]]
#+BEGIN_SRC emacs-lisp
(use-package bool-flip
  :custom
  (bool-flip-alist '(("T" . "F")
                     ("t" . "f")
                     ("TRUE" . "FALSE")
                     ("True" . "False")
                     ("true" . "false")
                     ("Y" . "N")
                     ("y" . "n")
                     ("YES" . "NO")
                     ("Yes" . "No")
                     ("yes" . "no")
                     ("1" . "0")
                     ("ON" . "OFF")
                     ("On" . "Off")
                     ("ENABLED" . "DISABLED")
                     ("Enabled" . "Disabled")
                     ("NOT" . "")
                     ("not" . "")
                     ("!" . "")
                     ("!=" . "==")
                     ("==" . "!=")
                     ("<" . "<=")
                     ("<=" . ">=")
                     (">=" . ">")
                     (">" . "<"))))
#+END_SRC

***** [[https://github.com/atykhonov/emacs-howdoi][Code suggestions]]
#+BEGIN_SRC emacs-lisp
(use-package howdoi)
#+END_SRC

**** Compilation
***** [[https://github.com/abo-abo/helm-make][Select make target with helm]]

TODO

#+BEGIN_SRC emacs-lisp
(use-package helm-make
  :after helm
  :custom
  (helm-make-fuzzy-matching t)
  (helm-make-list-target-method 'default))
#+END_SRC

***** Always kill running compilation when starting another
#+BEGIN_SRC emacs-lisp
(setq compilation-always-kill t)
#+END_SRC

***** Do not ask to save unsaved buffers
#+BEGIN_SRC emacs-lisp
(setq compilation-ask-about-save nil)
#+END_SRC

***** Jump to first error/Move to errors
#+BEGIN_SRC emacs-lisp
(setq compilation-auto-jump-to-first-error t
      compilation-scroll-output 'first-error
      compilation-skip-threshold 2)
#+END_SRC

***** [[https://github.com/EricCrosson/bury-successful-compilation][Hide compilation buffer if successful]]
#+BEGIN_SRC emacs-lisp
(use-package bury-successful-compilation
  :config (bury-successful-compilation 1))
#+END_SRC

***** Show status in mode line
#+BEGIN_SRC emacs-lisp
(defvar-local compilation-run-p nil "Flag to indicate if a comilation was run for the current buffer.")

(add-to-list 'compilation-finish-functions '(lambda ()
                                              (setq compilation-run-p t)
                                              (force-mode-line-update)))

(defun cpped-powerline-compilation-status ()
  "Fomrat the mode line compilation information."
  (when compilation-run-p
    (mapconcat 'identity
               (remove nil (list (propertize (all-the-icons-faicon5 "hammer")
                                             'face (list ':inherit (cond ((> compilation-num-errors-found 0) 'cpped-check-status-error)
                                                                         ((> compilation-num-warnings-found 0) 'cpped-check-status-warning)
                                                                         ((> compilation-num-infos-found 0) 'cpped-check-status-info)
                                                                         (t 'cpped-check-status-info))
                                                         ':family (all-the-icons-faicon5-family))
                                             'display '(raise -0.0))
                                 (mapconcat 'identity
                                            (remove nil (list (when (> compilation-num-errors-found 0)
                                                                (propertize compilation-num-errors-found
                                                                            'face 'cpped-check-status-error))
                                                              (when (> compilation-num-warnings-found 0)
                                                                (propertize compilation-num-warnings-found
                                                                            'face 'cpped-check-status-warning))
                                                              (when (> compilation-num-infos-found 0)
                                                                (propertize compilation-num-infos-found
                                                                            'face 'cpped-check-status-info))))
                                            " / ")))
               " ")))

  (add-to-list 'cpped-powerline-check-status-functions 'cpped-powerline-compilation-status)
#+END_SRC

**** Documentation
***** API
#+BEGIN_SRC emacs-lisp
(use-package helm-dash
  :custom
  (helm-dash-browser-func 'eww)
  (helm-dash-docsets-url "https://api.github.com/repos/Kapeli/feeds/contents/")
  (helm-dash-enable-debugging nil))
#+END_SRC

***** Change Log
#+BEGIN_SRC emacs-lisp
(setq change-log-default-name "CHANGELOG")
#+END_SRC

**** Comments
***** Comment style
#+BEGIN_SRC emacs-lisp
(defvar c-doc-comment-style '((c-mode . gtkdoc)
                              (c++-mode . javadoc)))
#+END_SRC

***** Insert comment characters in new line when pressing enter inside a comment
#+BEGIN_SRC emacs-lisp
(add-hook 'c-mode-common-hook (lambda()
                                (local-set-key (kbd "RET") 'c-context-line-break)))
#+END_SRC

***** Insert license comment
#+BEGIN_SRC emacs-lisp
(use-package legalese
  :hook (prog-mode . (lambda ()
                       (when (= (buffer-size (current-buffer)) 0)
                         (legalese nil))))
  :custom
  (legalese-date-format "%Y-%m-%d")
  (legalese-default-license 'gpl)
  (legalese-templates '((emacs-lisp-mode (nil ";;; " legalese-file-name " --- " _ "\n;;\n"
                                              ";; Copyright © " legalese-year "  " legalese-copyright "\n;;\n"
                                              ";; Author: " legalese-author "\n;;\n"
                                              & -2 "\n"
                                              ";; Created: " legalese-date "\n"
                                              @
                                              '(legalese-license)
                                              @ ";;\n;;\n"
                                                ";;; Commentary: \n;;\n"
                                                ";;; Code: \n\n"
                                                "(provide '" legalese-file ")\n\n"
                                                ";;; " legalese-file-name " ends here\n"))))
  :config
  (if (and (boundp 'company-full-name)
           (not (= 0 (length company-full-name))))
      (progn
        (add-to-list 'legalese-templates '(c++-mode (nil
                                                     "/**\n"
                                                     " * " legalese-file-name "\n\n"
                                                     " * @date " legalese-date "\n"
                                                     " * @author " legalese-author "\n"
                                                     " * @copyright Copyright © " company-full-name ". All rights reserved.\n"
                                                     " */")))
        (add-to-list 'legalese-templates '(default (nil @ legalese-file-name "\n\n"
                                                          "Date: " legalese-date "\n"
                                                          "Author: " legalese-author "\n"
                                                          "Copyright © " company-full-name ". All rights reserved.\n"
                                                          @ "\n")) t))
    (add-to-list 'legalese-templates '(default (nil @ legalese-file-name "\n\n"
                                                      "Copyright © " legalese-year " " legalese-copyright "\n\n"
                                                      "Author: "
                                                      legalese-author "\n\n"
                                                      '(legalese-license)
                                                      @ "\n")))))
#+END_SRC

**** Braces
#+BEGIN_SRC emacs-lisp
(defvar c-hanging-braces-alist '((defun-open before after)
                                 (defun-close before after)
                                 (class-open before after)
                                 (class-close before)
                                 (inline-open before after)
                                 (inline-close before after)
                                 (block-open before after)
                                 (block-close . c-snug-do-while)
                                 (statement-cont before after)
                                 (substatement-open before after)
                                 (statement-case-open before after)
                                 (brace-list-open)
                                 (brace-entry-open)
                                 (extern-lang-open after)
                                 (namespace-open before after)
                                 (namespace-close before after)
                                 (module-open after)
                                 (composition-open after)
                                 (inexpr-class-open after)
                                 (inexpr-class-close before)
                                 (arglist-cont-nonempty)))
(defvar c-hanging-colons-alist '((case-label after) (label after)))
(defvar c-hanging-semi&comma-criteria '(c-semi&comma-inside-parenlist))
#+END_SRC

**** LOC counting/Metrics
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "sloccount")
  (defun cpped-sloccount (argument)
    "Count lines of code in file or project (with prefix argument)."
    (interactive "P")
    (let* ((project-root (cpped-project-dir))
           (thing-to-process (if (and project-root
                                      argument)
                                 project-root
                               (when buffer-file-name
                                 (file-truename buffer-file-name)))))
      (when thing-to-process
        (with-output-to-temp-buffer "*SLOCCount*" (print (shell-command-to-string (concat  "sloccount " thing-to-process)))))))
  (push "\\*SLOCCount\\*" helm-boring-buffer-regexp-list))
#+END_SRC

*** Assembler
#+BEGIN_SRC emacs-lisp
(use-package asm-mode)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package nasm-mode
  :mode "\\.[n]*\\(asm\\|s\\)\\'")
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package x86-lookup
  :after pdf-tools
  :custom
  (x86-lookup-pdf (expand-file-name "~/.docsets/IntelASM.pdf"))
  (x86-lookup-browse-pdf-function 'x86-lookup-browse-pdf-pdf-tools))
#+END_SRC

*** C/C++
#+BEGIN_SRC emacs-lisp
(defconst cpped-c++-source-file-pattern "\\.[Cc]([Cc]|[Pp][Pp]|[Xx][Xx]|++)\\'")
(defconst cpped-c++-header-file-pattern "\\.[Hh]([Hh]|[Pp][Pp]|[Xx][Xx]|++)\\'")

(add-to-list 'auto-mode-alist '("\\.a\\'" . c-mode))
(add-to-list 'auto-mode-alist `(,cpped-c++-source-file-pattern . c++-mode))
(add-to-list 'auto-mode-alist `(,cpped-c++-header-file-pattern . c++-mode))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package ccls
  :after (helm-buffers lsp)
  :custom
  (ccls-executable (expand-file-name "~/.local/bin/ccls"))
  (ccls-sem-highlight-method 'font-lock)
  :config
  (ccls-use-default-rainbow-sem-highlight))
#+END_SRC

**** Navigation
***** Show includes/namespaces in imenu
#+BEGIN_SRC emacs-lisp
(require 'cc-menus)

(add-to-list 'cc-imenu-c-generic-expression '("Include" "^[[:space:]]*#include[[:space:]]+[<\"]\\([^>\"]+\\)" 1))

(add-to-list 'cc-imenu-c++-generic-expression '("Include" "^[[:space:]]*#include[[:space:]]+[<\"]\\([^>\"]+\\)" 1))
(add-to-list 'cc-imenu-c++-generic-expression '("Namespace" "^[[:space:]]*namespace[[:space:]]+\\([^/{]+\\)[[:space:]]*$" 1))
#+END_SRC

***** Share imenu results
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "imenu-anywhere"
  (push '(c-mode c++-mode) imenu-anywhere-friendly-modes))
#+END_SRC

**** Editing
***** Mark/navigation functions
#+BEGIN_SRC emacs-lisp
(add-hook 'c-mode-common-hook (lambda ()
                                (setq cpped-mark-function 'c-mark-function)
                                (setq cpped-beginning-of-function 'c-beginning-of-defun)
                                (setq cpped-end-of-function 'c-end-of-defun)))
#+END_SRC

***** Clang include fixer
#+BEGIN_SRC emacs-lisp
(require 'clang-include-fixer)
(add-hook 'after-save-hook #'(lambda()
                               (when (or (equal major-mode 'c-mode)
                                         (equal major-mode 'c++-mode))
                                 (let ((directory (cpped-build-dir)))
                                   (when directory
                                     (call-process "find-all-symbols" nil nil nil (concat "-merge-dir=" directory) (concat "-output-dir=" directory) (concat "-p" directory) (file-truename buffer-file-name))
                                   (clang-include-fixer))))))
#+END_SRC

***** Auto-newline
#+BEGIN_SRC emacs-lisp
(add-hook 'c-mode-common-hook '(lambda ()
                                 (c-toggle-auto-newline 1)))
#+END_SRC

***** [[https://www.gnu.org/software/emacs/manual/html_node/ccmode/Clean_002dups.html][Auto-clean whitespace]]
#+BEGIN_SRC emacs-lisp
(defvar c-cleanup-list '(scope-operator empty-defun-braces defun-close-semi list-close-comma comment-close-slash))
#+END_SRC

***** Indentation
#+BEGIN_SRC emacs-lisp
(c-add-style "cpped-style"
             `("bsd"
               (c-progress-interval . nil)                   ; do not echo progress when indenting)
               (c-basic-offset . ,cpped-default-indentation)
               (comment-empty-lines . t)
               (c-electric-pound-behavior . '(alignleft))    ; do not indent macros
               (c-auto-align-backslashes . t)                ; align line end escape characters
               (c-offsets-alist . ((innamespace . [0])       ; do not indent namespaces
                                   (brace-list-open . 0)
                                   (substatement-open . 0)
                                   (statement-cont . (add c-lineup-cascaded-calls
                                                          c-lineup-string-cont
                                                          c-lineup-streamop))
                                   (arglist-cont-nonempty . (add c-lineup-argcont
                                                                 c-lineup-cascaded-calls
                                                                 c-lineup-string-cont))))))

(setq c-default-style '((c-mode . "cpped-style")
                        (c++-mode . "cpped-style")
                        (java-mode . "java")
                        (awk-mode . "awk")
                        (other . "bsd")))

(add-hook 'c-mode-common-hook '(lambda ()
                                 (c-toggle-syntactic-indentation 1)
                                 (c-toggle-electric-state 1)))
#+END_SRC

***** Wrap Region
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "wrap-region"
  (wrap-region-add-wrappers
   '(("{" "}" nil (c-mode c++-mode)))))
#+END_SRC

***** Auto-completion
#+BEGIN_SRC emacs-lisp
(use-package company-c-headers
  :after company
  :custom (company-c-headers-path-user '("." "../Includes/")))

(add-hook 'c-mode-common-hook (lambda()
                                (set (make-local-variable 'company-backends) '((company-yasnippet company-lsp company-files company-capf company-dabbrev-code company-ispell cpped-company-line-backend)))))
#+END_SRC

***** Abbreviations
#+BEGIN_SRC emacs-lisp
(define-abbrev-table 'c++-mode-abbrev-table '(
                                              ("breif" "brief")
                                              ("a" "auto")
                                              ("co" "const")
                                              ("cosnt" "const")
                                              ("#d" "#define")
                                              ("#e" "#endif")
                                              ("fa" "// fall-through")
                                              ("#i" "#if")
                                              ("pro" "protected:")
                                              ("#o" "#pragma once")
                                              ("#1" "#pragma once")
                                              ("prs" "protected slots:")
                                              ("pu" "public:")
                                              ("pus" "public slots:")
                                              ("pri" "private:")
                                              ("vir" "virtual")
                                              ("ov" "overwrite")
                                              ("fi" "final")
                                              ("nx" "noexcept")
                                              ("nox" "noexcept")
                                              ("noex" "noexcept")
                                              ("QSrting" "QString")
                                              ("qstr" "QString")
                                              ("si" "signals:")
                                              ("st" "std::")
                                              ("std" "std::")
                                              ("v" "void")
                                              ))
#+END_SRC

***** Automatically change dash to underscore in identifiers
#+BEGIN_SRC emacs-lisp
(use-package smart-dash
  :hook (c-mode-common . smart-dash-mode))
#+END_SRC

***** Formatting
#+BEGIN_SRC emacs-lisp
(use-package clang-format
  :custom (clang-format-executable "clang-format")
  :hook (c-mode-common . (lambda ()
                           (setq cpped-format-region-function 'clang-format)
                           (setq cpped-format-buffer-function 'clang-format-buffer))))
#+END_SRC

***** Syntax checkers
****** Clang
#+BEGIN_SRC emacs-lisp
(setq flycheck-clang-pedantic t
      flycheck-clang-warnings '("all" "extra" "ctor-dtor-privacy" "effc++" "old-style-cast" "overloaded-virtual" "format=2" "null-dereference" "missing-include-dirs" "switch-default" "switch-enum" "unused-parameter" "uninitialized" "float-equal" "shadow" "cast-qual" "conversion" "extra-tokens" "ambiguous-member-template" "bind-to-temporary-copy"))
(add-hook 'c-mode-common-hook (lambda ()
                                (flycheck-select-checker 'c/c++-clang)))
(add-hook 'c++-mode-hook (lambda ()
                           (setq flycheck-clang-language-standard "c++17")))
(push "\\*clang-.*\\*" helm-boring-buffer-regexp-list)
#+END_SRC

****** GCC
#+BEGIN_SRC emacs-lisp
(setq flycheck-gcc-pedantic t
      flycheck-gcc-pedantic-errors nil
      flycheck-gcc-warnings '("all" "extra" "ctor-dtor-privacy" "effc++" "old-style-cast" "overloaded-virtual" "format=2" "missing-include-dirs" "switch-default" "switch-enum" "unused-parameter" "uninitialized" "float-equal" "shadow" "cast-qual" "conversion" "double-promotion" "zero-as-null-pointer-constant" "useless-cast" "logical-op"))
(flycheck-add-next-checker 'c/c++-clang '(t . c/c++-gcc))
(add-hook 'c++-mode-hook (lambda ()
                           (setq flycheck-gcc-language-standard "c++17")))
#+END_SRC

****** [[https://clang-analyzer.llvm.org/][Clang Analyzer]]
#+BEGIN_SRC emacs-lisp
(use-package flycheck-clang-analyzer
  :after flycheck
  :config (flycheck-add-next-checker 'c/c++-gcc '(warning . clang-analyzer)))
#+END_SRC

****** CPPCheck
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "cppcheck")
  (setq flycheck-cppcheck-checks '("warning" "style" "performance" "portability" "information" "missingInclude"))
  (flycheck-add-next-checker 'clang-analyzer '(t . c/c++-cppcheck))
  (add-hook 'c++-mode-hook (lambda ()
                             (setq flycheck-cppcheck-standards "c++11"))))
#+END_SRC

****** [[https://github.com/ch1bo/flycheck-clang-tidy][Clang-tidy]]
#+BEGIN_SRC emacs-lisp
(use-package flycheck-clang-tidy
  :after flycheck
  :hook (cpped-after-project-load-update-project-file-hook . (lambda ()
                                                               (setq-local flycheck-clang-tidy-build-path (cpped-build-dir))))
  :config (flycheck-add-next-checker 'c/c++-cppcheck '(t . c/c++-clang-tidy)))
#+END_SRC

**** Documentation
***** DASH
#+BEGIN_SRC emacs-lisp
(add-hook 'c-mode-common-hook (lambda()
                                (set (make-local-variable 'helm-dash-docsets) '("C" "GLib" "OpenGL4"))))
(add-hook 'c++-mode-hook (lambda()
                           (set (make-local-variable 'helm-dash-docsets) '("C++" "C" "Boost" "GLib" "Qt" "OpenGL4"))))
#+END_SRC

**** Utilities
***** Namespaces
#+BEGIN_SRC emacs-lisp
(use-package outrespace)
#+END_SRC

***** Qt Support
Resource Files
#+BEGIN_SRC emacs-lisp
(push '("\\.qrc\\'" . nxml-mode) auto-mode-alist)
#+END_SRC

Translation Files
#+BEGIN_SRC emacs-lisp
(push '("\\.ts\\'" . nxml-mode) auto-mode-alist)
#+END_SRC

**** Google Test support
https://github.com/google/googletest

#+BEGIN_SRC emacs-lisp
(define-derived-mode gtest-mode
  c++-mode
  "Google Test file"
  "Google Test mode is a major mode for editing Google Test unit test files.")

(provide 'gtest-mode)

(push '("T[Ee][Ss][Tt]_?.*\\.c(c\\|pp\\|xx)\\'" . gtest-mode) auto-mode-alist)
#+END_SRC

*** CMake
#+BEGIN_SRC emacs-lisp
(use-package cmake-mode
  :custom (cmake-tab-width 4)
  :config
  (push '("CMakeLists\\.txt\\'" . cmake-mode) auto-mode-alist)
  (push '(".\\cmake\\'" . cmake-mode) auto-mode-alist)
  (with-eval-after-load "aggressive-fill-paragraph"
    (add-to-list 'afp-fill-comments-only-mode-list 'cmake-mode))
  (with-eval-after-load "all-the-icons"
    (push '(cmake-mode all-the-icons-fileicon "cmake" :v-adjust 0.0) all-the-icons-mode-icon-alist)
    (push '("CMakeLists.txt$" all-the-icons-fileicon "cmake" :v-adjust 0.0) all-the-icons-icon-alist)
    (push '("\\.cmake$" all-the-icons-fileicon "cmake" :v-adjust 0.0) all-the-icons-icon-alist)))
#+END_SRC

**** Imenu integration
#+BEGIN_SRC emacs-lisp
(add-hook 'cmake-mode-hook (lambda ()
                             (setq-local imenu-generic-expression '(("Function" "^ *function *( *\\([^) ]+\\).*$" 1)
                                                                    ("Macro"  "^ *macro *( *\\([^) ]+\\).*$" 1)))))
#+END_SRC

**** [[https://github.com/Lindydancer/cmake-font-lock][Highlighting]]
#+BEGIN_SRC emacs-lisp
(use-package cmake-font-lock
  :hook (cmake-mode . cmake-font-lock-activate))
#+END_SRC

**** Editing
***** Abbreviations
#+BEGIN_SRC emacs-lisp
(define-abbrev-table 'cmake-mode-abbrev-table '(
                                                ("cmkae" "cmake")
                                                ("CMKAE" "CMAKE")
                                                ("CMkae" "CMake")
                                                ("cmd" "${CMAKE_COMMAND}")
                                                ("sd" "${CMAKE_SOURCE_DIR}")
                                                ("bd" "${CMAKE_BINARY_DIR}")
                                                ("cld" "${CMAKE_CURRENT_LIST_DIR}")
                                                ("csd" "${CMAKE_CURRENT_SOURCE_DIR}")
                                                ("cbd" "${CMAKE_CURRENT_BINARY_DIR}")
                                                ("cf" "CMAKE_C_FLAGS")
                                                ("cfd" "CMAKE_C_FLAGS_DEBUG")
                                                ("cfdi" "CMAKE_C_FLAGS_DEBUG_INIT")
                                                ("cfi" "CMAKE_C_FLAGS_INIT")
                                                ("cfr" "CMAKE_C_FLAGS_RELEASE")
                                                ("cfri" "CMAKE_C_FLAGS_RELEASE_INIT")
                                                ("ccf" "CMAKE_CXX_FLAGS")
                                                ("ccfd" "CMAKE_CXX_FLAGS_DEBUG")
                                                ("ccfdi" "CMAKE_CXX_FLAGS_DEBUG_INIT")
                                                ("ccfi" "CMAKE_CXX_FLAGS_INIT")
                                                ("ccfr" "CMAKE_CXX_FLAGS_RELEASE")
                                                ("ccfri" "CMAKE_CXX_FLAGS_RELEASE_INIT")))
#+END_SRC

***** Wrap Region
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "wrap-region"
  (wrap-region-add-wrappers
   '(("{" "}" nil cmake-mode)
     ("${" "}" "$" (cmake-mode c-mode c++-mode))
     ("\"${" "}\"" "\'" (cmake-mode))
     ("@" "@" nil (cmake-mode c-mode c++-mode))))
  (add-hook 'cmake-mode-hook 'wrap-region-mode))
#+END_SRC

***** Autocompletion
#+BEGIN_SRC emacs-lisp
(add-hook 'cmake-mode-hook (lambda()
                             (set (make-local-variable 'company-backends) '((company-yasnippet company-cmake company-files company-capf company-dabbrev-code company-ispell cpped-company-line-backend)))))
#+END_SRC

***** Formatting
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "cmake_format" :package-manager 'pip)

(defun cpped-cmake-format-buffer ()
  "Format the buffer with cmake-format."
  (interactive)
  (when (executable-find "cmake-format")
    (call-process "cmake-format"
                  nil
                  nil
                  nil
                  "--in-place"
                  (buffer-file-name))
  (revert-buffer t t t)))

(add-hook 'cmake-mode-hook (lambda ()
                             (setq cpped-format-buffer-function 'cpped-cmake-format-buffer)))
#+END_SRC

***** Spell checking
#+BEGIN_SRC emacs-lisp
  (with-eval-after-load "wucuo"
    (setq wucuo-personal-font-faces-to-check
          (nconc wucuo-personal-font-faces-to-check '(cquery-sem-local-face
                                                      cquery-sem-member-face
                                                      cquery-sem-static-face
                                                      cquery-sem-type-face-0
                                                      cquery-sem-type-face-1
                                                      cquery-sem-type-face-2
                                                      cquery-sem-type-face-3
                                                      cquery-sem-type-face-4
                                                      cquery-sem-type-face-5
                                                      cquery-sem-type-face-6
                                                      cquery-sem-type-face-7
                                                      cquery-sem-type-face-8
                                                      cquery-sem-type-face-9
                                                      cquery-sem-macro-face-0
                                                      cquery-sem-macro-face-1
                                                      cquery-sem-macro-face-2
                                                      cquery-sem-macro-face-3
                                                      cquery-sem-macro-face-4
                                                      cquery-sem-macro-face-5
                                                      cquery-sem-macro-face-6
                                                      cquery-sem-macro-face-7
                                                      cquery-sem-macro-face-8
                                                      cquery-sem-macro-face-9
                                                      cquery-sem-variable-face-0
                                                      cquery-sem-variable-face-1
                                                      cquery-sem-variable-face-2
                                                      cquery-sem-variable-face-3
                                                      cquery-sem-variable-face-4
                                                      cquery-sem-variable-face-5
                                                      cquery-sem-variable-face-6
                                                      cquery-sem-variable-face-7
                                                      cquery-sem-variable-face-8
                                                      cquery-sem-variable-face-9
                                                      cquery-sem-function-face-0
                                                      cquery-sem-function-face-1
                                                      cquery-sem-function-face-2
                                                      cquery-sem-function-face-3
                                                      cquery-sem-function-face-4
                                                      cquery-sem-function-face-5
                                                      cquery-sem-function-face-6
                                                      cquery-sem-function-face-7
                                                      cquery-sem-function-face-8
                                                      cquery-sem-function-face-9
                                                      cquery-sem-namespace-face-0
                                                      cquery-sem-namespace-face-1
                                                      cquery-sem-namespace-face-2
                                                      cquery-sem-namespace-face-3
                                                      cquery-sem-namespace-face-4
                                                      cquery-sem-namespace-face-5
                                                      cquery-sem-namespace-face-6
                                                      cquery-sem-namespace-face-7
                                                      cquery-sem-namespace-face-8
                                                      cquery-sem-namespace-face-9
                                                      cquery-sem-parameter-face-0
                                                      cquery-sem-parameter-face-1
                                                      cquery-sem-parameter-face-2
                                                      cquery-sem-parameter-face-3
                                                      cquery-sem-parameter-face-4
                                                      cquery-sem-parameter-face-5
                                                      cquery-sem-parameter-face-6
                                                      cquery-sem-parameter-face-7
                                                      cquery-sem-parameter-face-8
                                                      cquery-sem-parameter-face-9
                                                      cquery-inactive-region-face
                                                      cquery-sem-static-field-face
                                                      cquery-sem-static-method-face
                                                      cquery-sem-local-function-face
                                                      cquery-sem-global-variable-face))))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(add-hook 'cmake-mode-hook (lambda()
                             (set (make-local-variable 'helm-dash-docsets) '("CMake"))))
#+END_SRC

*** CSS
#+BEGIN_SRC emacs-lisp
(push '("\\.css\\'". css-mode) auto-mode-alist)
#+END_SRC

**** Editing
***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "csslint")
  (cpped-install-system-package "stylelint" :package-manager 'npm)
  (add-hook 'css-mode-hook (lambda ()
                             (flycheck-select-checker 'css-csslint)
                             (flycheck-add-next-checker 'css-csslint '(t . css-stylelint)))))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(use-package css-eldoc
  :hook (css-mode . turn-on-css-eldoc))
#+END_SRC

*** [[http://elpa.gnu.org/packages/csv-mode.html][CSV]]
#+BEGIN_SRC emacs-lisp
(use-package csv-mode
  :mode ("\\.[Cc][Ss][Vv]\\'" . csv-mode))
#+END_SRC

*** Docker
#+BEGIN_SRC emacs-lisp
(use-package dockerfile-mode
  :config (add-to-list 'auto-mode-alist '("Dockerfile\\'" . dockerfile-mode)))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(add-hook 'dockerfile-mode-hook (lambda()
                                  (set (make-local-variable 'helm-dash-docsets) '("Docker"))))
#+END_SRC

**** [[https://github.com/Silex/docker.el][Control]]
#+BEGIN_SRC emacs-lisp
(use-package docker)
#+END_SRC

**** [[https://github.com/emacs-pe/docker-tramp.el][TRAMP support]]
#+BEGIN_SRC emacs-lisp
(use-package docker-tramp
  :after tramp)
#+END_SRC

**** Editing
***** Language server
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "lsp-mode"
  (cpped-install-system-package "dockerfile-language-server-nodejs" :package-manager 'npm)
  (lsp-register-client (make-lsp-client :new-connection (lsp-stdio-connection '("docker-langserver" "--stdio"))
                                        :major-modes '(dockerfile-mode)
                                        :priority -1
                                        :server-id 'docker-languageserver)))
#+END_SRC

***** Autocompletion
#+BEGIN_SRC emacs-lisp
(add-hook 'dockerfile-mode-hook (lambda()
                                  (set (make-local-variable 'company-backends) '((company-yasnippet company-lsp company-files company-capf company-dabbrev-code company-ispell cpped-company-line-backend)))))
#+END_SRC

***** [[https://github.com/redcoolbeans/dockerlint][Syntax checker]]

TODO use [[https://github.com/hadolint/hadolint/][hadolint]
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "dockerlint" :package-manager 'npm)
  (with-eval-after-load "flycheck"
    (flycheck-define-checker cpped-dockerlint
      "Dockerfile checker (https://github.com/redcoolbeans/dockerlint)"
      :command ("dockerlint" source-original)
      :error-patterns ((error line-start "ERROR: " (message) " on line " line line-end)
                       (warning line-start "WARN: " (message) " on line " line line-end)
                       (info line-start "INFO: " (message) " on line " line line-end))
      :modes (dockerfile-mode))
    (add-to-list 'flycheck-checkers 'cpped-dockerlint)
    (add-hook 'dockerfile-mode-hook (lambda ()
                                      (flycheck-select-checker 'cpped-dockerlint)))))
#+END_SRC

*** Dot
#+BEGIN_SRC emacs-lisp
(use-package graphviz-dot-mode
  :after (org system-packages)
  :custom
  (graphviz-dot-auto-indent-on-braces t)
  (graphviz-dot-indent-width cpped-default-indentation)
  (graphviz-dot-auto-preview-on-save t)
  :config
  (cpped-install-system-package "graphviz")
  (add-to-list 'org-src-lang-modes '("dot" . graphviz-dot)))
#+END_SRC

*** GLSL
#+BEGIN_SRC emacs-lisp
(use-package glsl-mode
  :mode (("\\.vert\\'" . glsl-mode)
         ("\\.frag\\'" . glsl-mode)
         ("\\.geom\\'" . glsl-mode)
         ("\\.glsl\\'" . glsl-mode)))
#+END_SRC

*** Groovy
#+BEGIN_SRC emacs-lisp
(use-package groovy-mode
  :mode "Jenkinsfile")
#+END_SRC

**** Jenkinsfile
***** Imenu support
#+BEGIN_SRC emacs-lisp
(add-hook 'groovy-mode-hook (lambda()
                              (setq imenu-create-index-function #'imenu-default-create-index-function)
                              (setq-local imenu-generic-expression `(("Stages" ,(rx (0+ space)
                                                                                    "stage"
                                                                                    (0+ space)
                                                                                    (? "(")
                                                                                    (in "'\"")
                                                                                    (group (+ (not (in "'\""))))
                                                                                    (in "'\"")
                                                                                    (? ")")
                                                                                    (0+ space)
                                                                                    (? "{")
                                                                                    (0+ space))
                                                                      1)))))
#+END_SRC

***** Syntax check
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "flycheck"
  (defvar cpped-jenkins-url nil "The URL of the Jenkins installation.")
  (cpped-install-system-package "curl")
  (flycheck-define-checker jenkins
    "A Jenkins pipeline syntax checker."
    :command ("/usr/bin/curl"
              "-s" "-X" "POST" "-H" (eval (shell-command-to-string "/usr/bin/curl '-s' 'localhost:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)'"))
              "-F" (eval (concat "jenkinsfile=<" (car (flycheck-substitute-argument 'source 'jenkins))))
              (eval (concat cpped-jenkins-url "/pipeline-model-converter/validate")))
    :error-patterns ((warning line-start (file-name) ":" (message) "@ line " line ", column " column))
    :modes (groovy-mode))
  (add-to-list 'flycheck-checkers 'jenkins))
#+END_SRC

*** HTML
#+BEGIN_SRC emacs-lisp
(push '("\\.x?html?\\'" . html-mode) auto-mode-alist)
#+END_SRC

**** Editing
***** Language server
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "vscode-html-languageserver-bin" :package-manager 'npm))
#+END_SRC

***** Auto-completion
#+BEGIN_SRC emacs-lisp
(add-hook 'c-mode-common-hook (lambda()
                                (set (make-local-variable 'company-backends) '((company-yasnippet company-lsp company-files company-capf company-dabbrev-code company-ispell cpped-company-line-backend)))))
#+END_SRC

***** [[https://github.com/thedaviddias/HTMLHint][Syntax checker]]
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "htmlhint" :package-manager 'npm)
  (with-eval-after-load "flycheck"
    (flycheck-define-checker cpped-htmlhint
      "HTML file checker (https://github.com/thedaviddias/HTMLHint)"
      :command ("htmlhint" "--nocolor" "--format" "compact" source-original)
      :error-patterns ((error line-start (file-name) ": line " line ", col " column ", error - " (message) line-end)
(warning line-start (file-name) ": line " line ", col " column ", warning - " (message) line-end)
(info line-start (file-name) ": line " line ", col " column ", info - " (message) line-end))
      :modes (html-mode))
    (add-to-list 'flycheck-checkers 'cpped-htmlhint)))
#+END_SRC

*** Ini
#+BEGIN_SRC emacs-lisp
(defvar ini-mode-syntax-table
  (let ((table (make-syntax-table)))
    (modify-syntax-entry ?\; "< b" table)
    (modify-syntax-entry ?# "< b" table)
    (modify-syntax-entry ?\n "> b" table)
    table)
  "Syntax table for `ini-mode'.")

(defvar ini-mode-font-lock-keywords
  '(("^\\[\\(.*\\)\\]"
     (1 font-lock-function-name-face))
    ("^\\([^ \t\n=]+\\) *="
     (1 font-lock-variable-name-face)))
  "Highlight rules for `ini-mode'.")

(defun ini-mode-indent-line ()
  "Indent current line as WPDL code"
  (interactive)
  (beginning-of-line))

(define-derived-mode ini-mode prog-mode "Ini-Mode"
  "A major mode for editing ini files."
  (setq-local comment-start "; ")
  (setq-local comment-start-skip "[#;] *")
  (setq-local font-lock-defaults '(ini-mode-font-lock-keywords))
  (setq-local imenu-generic-expression '(("Section" "^\\[\\([a-zA-Z0-9]+\\)\\] *" 1)))
  (setq-local outline-regexp "\\["))

(push '("\\.conf\\'" . ini-mode) auto-mode-alist)
(push '("\\.ini\\'" . ini-mode) auto-mode-alist)
(push '("\\.service\\'" . ini-mode) auto-mode-alist)

(provide 'ini-mode)
#+END_SRC

*** Javascript
**** Editing
***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "standard" :package-manager 'npm)
  (cpped-install-system-package "jscs" :package-manager 'npm)
  (cpped-install-system-package "eslint" :package-manager 'npm)
  (cpped-install-system-package "jshint" :package-manager 'npm)
  (cpped-install-system-package "jslint" :package-manager 'npm)
  (add-hook 'js-mode-hook (lambda ()
                          (flycheck-select-checker 'javascript-standard)
                          (flycheck-add-next-checker 'javascript-standard '(t . javascript-jscs))
                          (flycheck-add-next-checker 'javascript-jscs '(t . javascript-eslint))
                          (flycheck-add-next-checker 'javascript-eslint '(t . javascript-jshint)))))
#+END_SRC

*** JSON
#+BEGIN_SRC emacs-lisp
(use-package json-mode
  :mode "\\.js\\(on\\|[hl]int\\(rc\\)?\\)\\'")

(use-package json-snatcher)
#+END_SRC

**** Navigation
***** Imenu integration
#+BEGIN_SRC emacs-lisp
(add-hook 'js-mode-hook (lambda()
                          (when (derived-mode-p 'json-mode)
                            (setq imenu-create-index-function #'imenu-default-create-index-function)
                            (setq-local imenu-generic-expression '(("Items" "[\"\']\\([[:alnum:]-]+\\)[\"\'][[:space:]]*:[\n[:space:]]*[\\[\\{]" 1))))))
#+END_SRC

**** Editing
***** Formatting
#+BEGIN_SRC emacs-lisp
(add-hook 'json-mode-hook (lambda ()
                            (setq cpped-format-region-function 'json-pretty-print)
                            (setq cpped-format-buffer-function 'json-pretty-print-buffer)))
#+END_SRC

*** Latex
#+BEGIN_SRC emacs-lisp
(push '("\\.tex\\'" . latex-mode) auto-mode-alist)
(push '("\\.txi\\'" . Texinfo-mode) auto-mode-alist)
(push '("\\.bib\\'" . bibtex-mode) auto-mode-alist)
#+END_SRC

*** Lisp
#+BEGIN_SRC emacs-lisp
(push '("\\.emacs\\'" . emacs-lisp-mode) auto-mode-alist)
(push '("\\.el\\'" . emacs-lisp-mode) auto-mode-alist)
(push '("\\.lisp\\'" . lisp-mode) auto-mode-alist)
(push '("\\.lsp\\'" . lisp-mode) auto-mode-alist)
#+END_SRC

**** [[https://github.com/alphapapa/highlight-function-calls][Highlight function calls]]
#+BEGIN_SRC emacs-lisp
(use-package highlight-function-calls
  :hook (emacs-lisp-mode . highlight-function-calls-mode)
  :custom (highlight-function-calls-not t))
#+END_SRC

**** [[https://github.com/Fanael/highlight-defined][Highlight undefined symbols]]
#+BEGIN_SRC emacs-lisp
(defun cpped-highlight-defined--determine-face (symbol)
  "Return the face SYMBOL should be fontified with. If SYMBOL is not one of the recognized types, return nil."
  (if (not (or (fboundp symbol) (special-variable-p symbol) (facep symbol)))
      'warning
    nil))

(use-package highlight-defined
  :hook (emacs-lisp-mode . highlight-defined-mode)
  :config
  (advice-add 'highlight-defined--determine-face :override #'cpped-highlight-defined--determine-face))
#+END_SRC

**** [[https://github.com/cpitclaudel/easy-escape][Simplify Regular Expressions]]
#+BEGIN_SRC emacs-lisp
(use-package easy-escape
  :hook ((lisp-mode . easy-escape-minor-mode)
         (emacs-lisp-mode . easy-escape-minor-mode)))
#+END_SRC

**** Auto-completion
#+BEGIN_SRC emacs-lisp
(add-hook 'elisp-mode-hook (lambda()
                             (set (make-local-variable 'company-backends) '((company-yasnippet company-elisp company-keywords company-files company-capf company-dabbrev-code company-ispell cpped-company-line-backend)))))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(add-hook 'elisp-mode-hook (lambda()
                             (set (make-local-variable 'helm-dash-docsets) '("Emacs Lisp"))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
#+END_SRC

*** Make
#+BEGIN_SRC emacs-lisp
(push '("Makefile\\'" . makefile-mode) auto-mode-alist)
(push '("\\.mak\\'" . makefile-mode) auto-mode-alist)
#+END_SRC

*** Perl
#+BEGIN_SRC emacs-lisp
(push '("#!/usr/bin/perl" . perl-mode) magic-mode-alist)
#+END_SRC

*** Prolog
#+BEGIN_SRC emacs-lisp
(push '("\\.pl\\'" . prolog-mode) auto-mode-alist)
#+END_SRC

*** Python
#+BEGIN_SRC emacs-lisp
(push '("\\.py\\'" . python-mode) auto-mode-alist)
#+END_SRC

*** QML
#+BEGIN_SRC emacs-lisp
(use-package qml-mode
  :mode "\\.qml\\'")
#+END_SRC

**** Imenu integration
#+BEGIN_SRC emacs-lisp
(defun cpped-qml-imenu-create-index()
  (append (imenu-default-create-index-function)
          (js--imenu-create-index)))

(add-hook 'js-mode-hook (lambda()
                          (when (derived-mode-p 'qml-mode)
                            (setq imenu-create-index-function #'cpped-qml-imenu-create-index)
                            (setq-local imenu-generic-expression '(("Items" "^[[:space:]]*\\([a-zA-Z0-9]+\\)[[:space:]\n]*{" 1))))))
#+END_SRC

**** Auto-completion
#+BEGIN_SRC emacs-lisp
(use-package company-qml
  :hook (qml-mode-hook . (lambda()
                           (set (make-local-variable 'company-backends '((company-yasnippet company-qml company-keywords company-files company-capf company-dabbrev-code company-ispell cpped-company-line-backend)))))))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(add-hook 'qml-mode-hook (lambda()
                           (set (make-local-variable 'helm-dash-docsets) '("Qt"))))
#+END_SRC

*** Shell
#+BEGIN_SRC emacs-lisp
(push '("\\.sh\\'" . sh-mode) auto-mode-alist)
#+END_SRC

**** Editing
***** Formatting
#+BEGIN_SRC emacs-lisp
(cpped-install-system-package "beautysh" :package-manager 'pip)

(defun cpped-beautysh-format-region (start end)
  "Format a shell buffer with beautysh."
  (interactive
   (if (use-region-p)
       (list (region-beginning) (region-end))
     (list (beginning-of-buffer) (point))))
  (when (executable-find "beautysh")
    (call-process-region start end "beautysh" t t t "-" (buffer-file-name))))

(add-hook 'sh-mode-hook (lambda ()
                          (setq cpped-format-region-function 'cpped-beautysh-format-region)
                          (setq cpped-format-buffer-function 'cpped-beautysh-format-region)))
#+END_SRC

***** Autocompletion
#+BEGIN_SRC emacs-lisp
(use-package company-shell
  :hook (sh-mode . (lambda()
                     (set (make-local-variable 'company-backends) '((company-yasnippet company-lsp company-shell company-keywords company-files company-capf company-dabbrev-code company-ispell cpped-company-line-backend))))))
#+END_SRC

***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(use-package flycheck-checkbashisms
  :after (flycheck system-packages)
  :hook (sh-mode . (lambda ()
                     (flycheck-select-checker 'sh-bash)
                     (flycheck-add-next-checker 'sh-bash '(t . sh-zsh))
                     (flycheck-add-next-checker 'sh-zsh '(t . sh-checkbashisms))
                     (flycheck-add-next-checker 'sh-checkbashisms '(t . sh-shellcheck))))
  :config
  (cpped-install-system-package "devscripts-checkbashisms" :executable "checkbashisms")
  (cpped-install-system-package "ShellCheck" :executable "shellcheck")
  (add-to-list 'flycheck-checkers 'sh-checkbashisms t))
#+END_SRC

**** BASH
Set correct major mode
#+BEGIN_SRC emacs-lisp
(push '("#!/bin/bash" . bash-mode) magic-mode-alist)
(push '("#!/bin/busybox" . bash-mode) magic-mode-alist)
(push '("\\.bash\\'" . bash-mode) auto-mode-alist)
#+END_SRC

**** ZSH
Set correct major mode
#+BEGIN_SRC emacs-lisp
(push '("#!/usr/bin/zsh" . sh-mode) magic-mode-alist)
(push '("\\.zsh\\'" . sh-mode) auto-mode-alist)

(add-to-list 'interpreter-mode-alist
             '("zsh" . sh-mode))
#+END_SRC

**** DOS-Batch
#+BEGIN_SRC emacs-lisp
(push '("\\.bat\\'" . bat-mode) auto-mode-alist)
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(add-hook 'sh-mode-hook (lambda()
                          (set (make-local-variable 'helm-dash-docsets) '("Bash" "Man Pages"))))
#+END_SRC


*** SSH Config
#+BEGIN_SRC emacs-lisp
(use-package ssh-config-mode)
#+END_SRC

*** Systemd
#+BEGIN_SRC emacs-lisp
(use-package systemd)
#+END_SRC

*** [[https://github.com/skuro/plantuml-mode][UML]]
#+BEGIN_SRC emacs-lisp
(use-package plantuml-mode
  :after (org popwin system-packages)
  :mode "\\.p\\(lant\\)?uml\\'"
  :custom
  (plantuml-jar-path "/usr/share/java/plantuml.jar")
  (org-plantuml-jar-path plantuml-jar-path)
  :config
  (cpped-install-system-package "plantuml")
  (cpped-install-system-package "graphviz")
  (push '("*PLANTUML Preview*" :dedicated t :width 60 :position right :noselect :stick) popwin:special-display-config)
  (add-to-list 'org-src-lang-modes '("plantuml" . plantuml)))

(defun cpped-preview-plantuml-file ()
  ""
  (when (equal major-mode 'plantuml-mode)
    (plantuml-preview-string 4 (buffer-string))))

(add-hook 'find-file-hook 'cpped-preview-plantuml-file)
(add-hook 'after-save-hook 'cpped-preview-plantuml-file)
#+END_SRC

**** [[https://github.com/alexmurray/flycheck-plantuml][Syntax checker]]
#+BEGIN_SRC emacs-lisp
(use-package flycheck-plantuml
  :after plantuml-mode
  :config (flycheck-plantuml-setup))
#+END_SRC

*** [[https://github.com/yoshiki/yaml-mode][YAML]]
#+BEGIN_SRC emacs-lisp
(use-package yaml-mode
  :mode "\.yml\'")
#+END_SRC

**** [[https://github.com/krzysztof-magosa/flycheck-yamllint][Syntax checker]]
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "js-yaml" :package-manager 'npm))

(use-package flycheck-yamllint
  :after (flycheck system-packages)
  :config (cpped-install-system-package "yamllint")
          (flycheck-yamllint-setup)
          (flycheck-add-next-checker 'yaml-jsyaml '(t . yaml-yamllint)))
#+END_SRC

*** XML
#+BEGIN_SRC emacs-lisp
(push '("<\\?xml" . nxml-mode) magic-mode-alist)
#+END_SRC

**** Navigation
***** Jump to element
#+BEGIN_SRC emacs-lisp
(use-package x-path-walker)
#+END_SRC

**** Editing
***** Always add XML declaration
#+BEGIN_SRC emacs-lisp
(defvar nxml-auto-insert-xml-declaration-flag t)
#+END_SRC

***** Autocompletion
#+BEGIN_SRC emacs-lisp
(add-hook 'nxml-mode-hook (lambda()
                            (set (make-local-variable 'company-backends) '((company-yasnippet company-nxml company-files company-capf company-dabbrev-code company-ispell cpped-company-line-backend)))))
#+END_SRC

***** XQuery
#+BEGIN_SRC emacs-lisp
(use-package xquery-tool
  :after system-packages
  :custom
  (xquery-tool-saxonb-jar "/usr/share/java/saxon/saxon.jar")
  (xquery-tool-resolve-xincludes t)
  (xquery-tool-result-buffer-name "*XQuery Results*")
  :config (cpped-install-system-package "saxon"))
#+END_SRC

***** Syntax checkers
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "xmllint")
  (cpped-install-system-package "xmlstarlet")
  (flycheck-add-next-checker 'xml-xmllint '(t . xml-xmlstarlet))
  (add-hook 'nxml-mode-hook (lambda ()
                              (flycheck-select-checker 'xml-xmllint))))
#+END_SRC

***** Formatting
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "system-packages"
  (cpped-install-system-package "xmllint")
  (defun cpped-xml-format-buffer ()
    "Format the buffer with xmllint."
    (interactive)
    (let ((position (point)))
      (call-process-region (point-min)
                           (point-max)
                           "xmllint"
                           t
                           (current-buffer)
                           t
                           "--format"
                           "--nowarning"
                           "-")
      (goto-char position)))

  (add-hook 'nxml-mode-hook (lambda ()
                              (setq cpped-format-region-function nil)
                              (setq cpped-format-buffer-function 'cpped-xml-format-buffer))))
#+END_SRC

**** Documentation
#+BEGIN_SRC emacs-lisp
(add-hook 'nxml-mode-hook (lambda()
                            (set (make-local-variable 'helm-dash-docsets) '("HTML" "SVG" "XSLT"))))
#+END_SRC

** Debugging
#+BEGIN_SRC emacs-lisp
(defvar gdb-many-windows t)
(defvar gdb-show-main nil)
(setq gud-tooltip-mode t)

(use-package realgud
  :custom (realgud-bp-fringe-indicator-style '(realgud-bp-filled . realgud-bp-hollow)))
#+END_SRC

*** Show symbols of ELF files
#+BEGIN_SRC emacs-lisp
(use-package elf-mode
  :config
  (elf-setup-default)
  (push "\\.so\\'" cpped-no-hexedit-extensions))
#+END_SRC

**** [[https://github.com/liblit/demangle-mode][Demangle symbols in ELF files]]
#+BEGIN_SRC emacs-lisp
(use-package demangle-mode
  :config
  (advice-add 'elf-mode :after 'demangle-mode))
#+END_SRC

** Diff/Merge
*** Diff support
#+BEGIN_SRC emacs-lisp
(push '("\\.diff\\'" . diff-mode) auto-mode-alist)
(push '("\\.patch\\'" . diff-mode) auto-mode-alist)

(setq diff-default-read-only t)
#+END_SRC

Auto-highlight details
#+BEGIN_SRC emacs-lisp
(add-hook 'diff-mode-hook 'diff-auto-refine-mode)
#+END_SRC

*** Quit smerge-mode after last resolved conflict
#+BEGIN_SRC emacs-lisp
(setq smerge-auto-leave t)
#+END_SRC

*** Re-use current frame for all diff contents (including command frame)
#+BEGIN_SRC emacs-lisp
(setq ediff-window-setup-function 'ediff-setup-windows-plain)
#+END_SRC

*** Quit diff view without confirmation if buffer is unchanged
#+BEGIN_SRC emacs-lisp
(defun cpped-ediff-smart-quit ()
  "Ask for confirmation only before quitting changed ediff buffers"
  (interactive)
  (ediff-barf-if-not-control-buffer)
  (let* ((buffer-a ediff-buffer-A)
         (buffer-b ediff-buffer-B)
         (buffer-c ediff-buffer-C)
         (buffer-control (current-buffer))
         (modified-buffers (remove-if-not 'buffer-modified-p
                                          (list buffer-a buffer-b buffer-c))))
    (let ((save (if modified-buffers
                    (yes-or-no-p "Save changes?")
                  nil)))
      (loop for buffer in modified-buffers do
            (progn
              (set-buffer buffer)
              (if save
                  (save-buffer)
                (set-buffer-modified-p nil))))
      (set-buffer buffer-control)
      (ediff-really-quit nil))))

(add-hook 'ediff-startup-hook (lambda ()
                                (local-set-key (kbd "q") 'cpped-ediff-smart-quit)))
#+END_SRC

*** Split windows horizontally
#+BEGIN_SRC emacs-lisp
(defvar ediff-merge-split-window-function 'split-window-horizontally)
(defvar ediff-split-window-function 'split-window-horizontally)
#+END_SRC

*** [[https://github.com/mgalgs/diffview-mode][Show unified diff as normal diff]]
#+BEGIN_SRC emacs-lisp
(use-package diffview)
#+END_SRC

*** [[https://github.com/fourier/ztree][Tree diff]]
#+BEGIN_SRC emacs-lisp
(use-package ztree
  :custom
  (ztree-draw-unicode-lines t)
  (ztree-show-number-of-children t))
#+END_SRC

** Version Control
*** Common
**** Limit version control systems to most used ones
#+BEGIN_SRC emacs-lisp
(setq vc-handled-backends '(git svn))
#+END_SRC

**** Always open actual file under source control when visited through a symbolic link
#+BEGIN_SRC emacs-lisp
(setq vc-follow-symlinks t)
#+END_SRC

**** [[https://github.com/dgutov/diff-hl][Show uncommitted lines in the fringe]]
#+BEGIN_SRC emacs-lisp
(use-package diff-hl
  :config
  (global-diff-hl-mode))
#+END_SRC

When using Magit >= 2.4.0
#+BEGIN_SRC emacs-lisp
(add-hook 'magit-post-refresh-hook 'diff-hl-magit-post-refresh)
#+END_SRC

*** Git
**** [[https://github.com/magit/magit][Magit]]
#+BEGIN_SRC emacs-lisp
(use-package magit
  :after (helm helm-buffers)
  :custom
  (git-commit-style-convention-checks nil)
  (git-commit-summary-max-length 80)
  (magit-auto-revert-mode t)
  (magit-completing-read-function 'helm--completing-read-default)
  (magit-diff-expansion-threshold 3)
  (magit-diff-highlight-hunk-region-functions '(magit-diff-highlight-hunk-region-dim-outside magit-diff-highlight-hunk-region-using-underline))
  (magit-diff-highlight-indentation '((".*" . tabs)))
  (magit-diff-refine-hunk 'all)
  (magit-display-buffer-function 'magit-display-buffer-fullframe-status-v1)
  (magit-log-auto-more t)
  (magit-popup-manpage-package 'woman)
  (magit-popup-show-common-commands nil)
  (magit-process-popup-time 3)
  (magit-save-repository-buffers 'dontask)
  (magit-status-show-hashes-in-headers nil)
  (magit-log-arguments '("--graph"
                         "--color"
                         "--decorate"
                         "-n200"))
  (magit-diff-arguments '("--function-context" "--stat" "-M" "-C"))
  :config
  (push "^\\*?magit.*" helm-boring-buffer-regexp-list))

(use-package magit-popup)
#+END_SRC

***** Full screen magit-status
#+BEGIN_SRC emacs-lisp
(defadvice magit-status (around magit-fullscreen activate)
  (window-configuration-to-register :magit-fullscreen)
  ad-do-it
  (delete-other-windows))
#+END_SRC

***** Restore previous window configuration on quit
#+BEGIN_SRC emacs-lisp
(defun magit-quit-session ()
  "Restores the previous window configuration and kills the magit buffer"
  (interactive)
  (kill-buffer)
  (jump-to-register :magit-fullscreen))
#+END_SRC

***** [[https://github.com/magit/forge][Git forge integration]]
#+BEGIN_SRC emacs-lisp
(use-package forge
  :after magit)
#+END_SRC

***** [[https://github.com/terranpro/magit-gerrit][Gerrit integration]]
#+BEGIN_SRC emacs-lisp
(use-package magit-gerrit
  :after (magit magit-popup)
  :quelpa (magit-gerrit
           :fetcher github
           :repo "ispras/magit-gerrit"))
#+END_SRC

***** Find other projects
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "projectile"
  (setq magit-repository-directories (mapcar #'directory-file-name
                                             (cl-remove-if-not (lambda (project)
                                                                 (file-directory-p (concat project "/.git/")))
                                                               (projectile-relevant-known-projects)))
        magit-repository-directories-depth 1))
#+END_SRC

***** Icons for changes
#+BEGIN_SRC emacs-lisp
(defvar prettify-magit-alist (list (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "add" (? (or "s" "ed"))) eow)
                                         (all-the-icons-faicon5 "plus")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group (or "remove" "delete") (? (in "sd"))) eow)
                                         (all-the-icons-faicon5 "trash")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group (? "bug") "fix" (? "e" (in "sd"))) eow)
                                         (all-the-icons-faicon5 "bug")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "fixup!"))
                                         (all-the-icons-faicon5 "wrench")
                                         `(:family ,(all-the-icons-faicon5-family) :foreground ,(face-attribute 'warning :foreground)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "clean" (? (or "s" "ed")) (? " up")) eow)
                                         (all-the-icons-faicon5 "paint-brush")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "update" (? (in "sd"))) eow)
                                         (all-the-icons-faicon5 "sync")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group (or "replace" "exchange") (? (in "sd"))) eow)
                                         (all-the-icons-faicon5 "exchange-alt")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "increase" (? (in "sd"))) eow)
                                         (all-the-icons-faicon5 "chevron-up")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "decrease" (? (in "sd"))) eow)
                                         (all-the-icons-faicon5 "chevron-down")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group (or "en" "dis") "able" (? (in "sd"))) eow)
                                         (all-the-icons-faicon5 "power-off")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "move" (? (in "sd"))) eow)
                                         (all-the-icons-faicon5 "arrow-right")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "optimize" (? (in "sd"))) eow)
                                         (all-the-icons-faicon5 "forward")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (+ (in "0-9a-f")) (+ (in space punctuation)) bow (group "set" (? "s")) eow)
                                         "="
                                         '(:weight 'black :height 1.3))
                                   (list (rx bol (not (in "+@-")) (+ any) bow (group "master") eow)
                                         (all-the-icons-faicon5 "home")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (not (in "+@-")) (+ any) bow (group "origin") eow)
                                         (all-the-icons-faicon5 "cloud")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (not (in "+@-")) (+ any) bow (group "HEAD") eow)
                                         (all-the-icons-faicon5 "cloud")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (not (in "+@-")) (+ any) bow (group "Merge branch") eow)
                                         (all-the-icons-octicon "git-merge")
                                         `(:family ,(all-the-icons-octicon-family)))
                                   (list (rx bol (group "modified") eow)
                                         (all-the-icons-faicon5 "pencil-alt")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (group "new file") eow)
                                         (all-the-icons-faicon5 "plus")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (group "deleted") eow)
                                         (all-the-icons-faicon5 "trash")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (group "renamed") eow)
                                         (all-the-icons-faicon5 "file")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol (group "@@"))
                                         (all-the-icons-faicon5 "align-left")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol "@@" (+ any) (group "@@"))
                                         (all-the-icons-faicon5 "puzzle-piece")
                                         `(:family ,(all-the-icons-faicon5-family)))
                                   (list (rx bol "Magithub is " (group "OFFLINE") eow)
                                         (all-the-icons-octicon "plug")
                                         `(:family ,(all-the-icons-octicon-family))))
  "An alist of expressions and icon properties to replace strings with icons in magit logs.")

(defun cpped-prettify-magit (&rest arguments)
  "Add face properties and compose symbols for buffer from pretty-magit."
  (interactive)
  (with-silent-modifications
    (dolist (entry prettify-magit-alist)
      (let ((expression (nth 0 entry))
            (icon (nth 1 entry))
            (properties (nth 2 entry)))
        (save-excursion
          (goto-char (point-min))
          (while (search-forward-regexp expression nil t)
            (when (and (match-beginning 1)
                       (match-end 1))
              (compose-region (match-beginning 1) (match-end 1) icon)
              (when properties
                (add-face-text-property (match-beginning 1) (match-end 1) properties)))))))))

(advice-add 'magit-status :after 'cpped-prettify-magit)
(advice-add 'magit-refresh-buffer :after 'cpped-prettify-magit)
(add-hook 'diff-mode-hook #'cpped-prettify-magit)
#+END_SRC

***** Import file from stash or branch
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun cpped-list-refs-and-stashes (wrapped-function &rest arguments)
    "Create a list of branches and stashes."
    (append
     (apply wrapped-function arguments)
     (magit-list-stashes)))

  (defun cpped-import-git-file ()
    "Import a git-versioned file from either a branch or the stash."
    (interactive)
    (advice-add #'magit-list-refnames :around #'cpped-list-refs-and-stashes)
    (call-interactively #'magit-file-checkout)
    (advice-remove #'magit-list-refnames #'cpped-list-refs-and-stashes))

  (magit-define-popup-action 'magit-dispatch-popup
    ?I "Import" 'cpped-import-git-file ?!)
  (define-key magit-status-mode-map
    "I" 'cpped-import-git-file))
#+END_SRC

***** Open file from stash or branch
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun cpped-open-git-file ()
    "Open a git-versioned file from either a branch or the stash."
    (interactive)
    (advice-add #'magit-list-refnames :around #'cpped-list-refs-and-stashes)
    (let* ((rev (magit-read-branch-or-commit
                 "Open from revision" magit-buffer-revision))
           (file (magit-read-file-from-rev rev "Open file"))
           (project (magit-toplevel)))
      (magit-find-file rev file)
      (let ((name (concat file "-" rev)))
        (setq buffer-file-name (expand-file-name name project))
        (rename-buffer (file-name-nondirectory name)))
      (read-only-mode t)))

  (magit-define-popup-action 'magit-dispatch-popup
    ?Z "Open" 'cpped-open-git-file ?!)
  (define-key magit-status-mode-map
    "Z" 'cpped-open-git-file))
#+END_SRC

***** Automatically commit changes to WIP branches
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (magit-wip-after-save-mode))
#+END_SRC

**** [[https://github.com/syohex/emacs-git-messenger][Show commit message of line on request]]
#+BEGIN_SRC emacs-lisp
(use-package git-messenger
  :custom
  (git-messenger:handled-backends 'git)
  (git-messenger:use-magit-popup t))
#+END_SRC

**** [[https://github.com/pidu/git-timemachine][Switch to previous version]]
#+BEGIN_SRC emacs-lisp
(use-package git-timemachine
  :custom (git-timemachine-abbreviation-length 8))
#+END_SRC

**** [[https://github.com/jwiegley/git-undo-el][Git undo]]
#+BEGIN_SRC emacs-lisp
(load (concat (file-name-as-directory user-emacs-directory) "elpa/git-undo/git-undo.el"))
#+END_SRC

**** [[https://github.com/emacs-helm/helm-ls-git][Browse other git projects with helm]]
#+BEGIN_SRC emacs-lisp
(use-package helm-ls-git
  :after helm
  :custom (helm-ls-git-fuzzy-match t))
#+END_SRC

**** [[https://github.com/defunkt/gist.el][Gist support]]
#+BEGIN_SRC emacs-lisp
(use-package gist
  :custom (gist-ask-for-description t))
#+END_SRC

**** Config file support
#+BEGIN_SRC emacs-lisp
(use-package gitconfig-mode)
(use-package gitignore-mode)
(use-package gitattributes-mode)
#+END_SRC

* Viewer
** Man Pages
#+BEGIN_SRC emacs-lisp
(setq woman-fill-frame t
      woman-imenu t
      woman-use-topic-at-point t
      woman-use-topic-at-point-default t)
#+END_SRC

** Info Pages
Hide info buffer in buffer list
#+BEGIN_SRC emacs-lisp
(push "\\*info\\*" helm-boring-buffer-regexp-list)
#+END_SRC

*** [[https://github.com/ubolonton/info-colors][Add extra coloring]]
#+BEGIN_SRC emacs-lisp
(use-package info-colors
  :hook (Info-selection . info-colors-fontify-node))
#+END_SRC

** [[https://github.com/politza/pdf-tools][PDF]]
#+BEGIN_SRC emacs-lisp
(use-package pdf-tools
  :after (popwin system-packages)
  :bind (:map pdf-view-mode-map ("q" . kill-this-buffer))
  :mode ("\\.pdf\\'" . pdf-view-mode)
  :hook (pdf-view-mode . pdf-view-midnight-minor-mode)
  :custom
  (pdf-info-epdfinfo-program "/usr/local/bin/epdfinfo")
  (pdf-view-display-size 'fit-page)
  (pdf-annot-activate-created-annotations t)
  (pdf-view-resize-factor 1.1)
  (pdf-view-midnight-colors `(,(face-attribute 'default :foreground) . ,(face-attribute 'default :background)))
  :config
  (cpped-install-system-package "poppler-devel")
  (cpped-install-system-package "poppler-glib-devel")
  (push '("%PDF" . pdf-view-mode) magic-mode-alist)
  (pdf-tools-install t t t)
  (push "\\.pdf\\'" cpped-no-hexedit-extensions)
  (push '("*PDF-Metadata*" :width 60 :position right :noselect t :stick t) popwin:special-display-config)
  (advice-add 'pdf-view-mode :before (lambda (&rest arguments)
                                       (nlinum-mode -1))))
#+END_SRC

** Doc-View
#+BEGIN_SRC emacs-lisp
(require 'doc-view)

(setq doc-view-continuous t
      doc-view-scale-internally nil)

(define-key doc-view-mode-map (kbd "q") 'doc-view-kill-proc-and-buffer)
#+END_SRC

*** ODF
#+BEGIN_SRC emacs-lisp
(push '("\\.odt\\'" . doc-view-mode) auto-mode-alist)
(push "\\.odt\\'" cpped-no-hexedit-extensions)
#+END_SRC

*** DOC
#+BEGIN_SRC emacs-lisp
(push '("\\.doc\\'" . doc-view-mode) auto-mode-alist)
(push "\\.doc\\'" cpped-no-hexedit-extensions)
#+END_SRC

*** DVI
#+BEGIN_SRC emacs-lisp
(push '("\\.dvi\\'" . doc-view-mode) auto-mode-alist)
(push "\\.dvi\\'" cpped-no-hexedit-extensions)
#+END_SRC

*** Postscript
#+BEGIN_SRC emacs-lisp
(push '("\\.ps\\'" . doc-view-mode) auto-mode-alist)
(push "\\.ps\\'" cpped-no-hexedit-extensions)
#+END_SRC

** [[https://github.com/doublep/logview][System Logs]]
#+BEGIN_SRC emacs-lisp
(use-package logview
  :mode "\\.log\\'"
  :hook (logview-mode . (lambda()
                          (auto-revert-tail-mode)
                          (read-only-mode)))
  :custom (logview-auto-revert-mode 'auto-revert-tail-mode))
#+END_SRC

** STrace Logs
#+BEGIN_SRC emacs-lisp
(use-package strace-mode)
#+END_SRC

* Org-Mode
#+BEGIN_SRC emacs-lisp
(use-package helm-org
:after helm)

(use-package org
  :after (helm helm-org helm-buffers popwin)
  :mode ("\\.org\\'" . org-mode)
  :bind (("C-c l" . org-store-link))
  :custom
  (org-blank-before-new-entry '((heading . t)))
  (org-catch-invisible-edits 'error)
  (org-columns-default-format "%50ITEM(Task) %2PRIORITY %10Effort(Effort){:} %10CLOCKSUM")
  (org-default-notes-file "~/.notes.org")
  (org-duration-format 'h:mm)
  (org-ellipsis " ▼")
  (org-enforce-todo-checkbox-dependencies t)
  (org-enforce-todo-dependencies t)
  (org-fast-tag-selection-single-key t)
  (org-global-properties '((Effort_ALL . "0:00 0:10 0:30 1:00 2:00 4:00 8:00 16:00 24:00 40:00 80:00")))
  (org-hide-emphasis-markers t)
  (org-highlight-latex-and-related '(latex script entities))
  (org-image-actual-width t)
  (org-indent-indentation-per-level cpped-default-indentation)
  (org-log-redeadline 'time)
  (org-log-reschedule 'time)
  (org-outline-path-complete-in-steps nil)
  (org-pretty-entities t)
  (org-refile-targets '((nil . (:maxlevel . 6))
                        (org-agenda-files . (:maxlevel . 5))))
  (org-refile-use-outline-path 'file)
  (org-refile-allow-creating-parent-nodes 'confirm)
  (org-completion-use-ido nil)
  (org-src-fontify-natively t)
  (org-hidden-keywords '(title author date email))
  (org-fontify-done-headline t)
  (org-fontify-quote-and-verse-blocks t)
  (org-fontify-whole-heading-line t)
  (org-remove-highlights-with-change t)
  (org-special-ctrl-a/e nil)
  (org-special-ctrl-k nil)
  (org-src-preserve-indentation t)
  (org-src-strip-leading-and-trailing-blank-lines t)
  (org-src-tab-acts-natively t)
  (org-src-window-setup 'current-window)
  (org-startup-with-inline-images t)
  (org-startup-folded nil)
  (org-startup-indented t)
  (org-support-shift-select t)
  (org-time-clocksum-use-effort-durations t)
  (org-use-speed-commands t)
  (org-yank-adjusted-subtrees t)
  (helm-org-headings-fontify nil)
  (helm-org-format-outline-path t)
  :config
  (defvar org-default-todos-file "~/.todos.org" "The default file for todo tasks.")
  (defvar org-default-bugs-file "~/.bugs.org" "The default file for bug tasks.")
  (defvar org-default-events-file "~/.events.org" "The default file for events.")
  (push "\\*Org Agenda\\*" helm-boring-buffer-regexp-list)
  (push '("*Agenda Commands*" :dedicated t :position bottom :height 20) popwin:special-display-config)
  (push '("*Org Agenda*" :position bottom :height 30) popwin:special-display-config)
  (push '("*Org Select*" :height 0.2 :position bottom :noselect nil :stick t) popwin:special-display-config)
  (push '("^CAPTURE-.+\*.org$" :position left :regexp t) popwin:special-display-config)
  (font-lock-add-keywords 'org-mode `(("^[ \t]*\\(?:[-+*]\\|[0-9]+[).]\\)[ \t]+\\(\\(?:\\[@\\(?:start:\\)?[0-9]+\\][ \t]*\\)?\\[\\(?:X\\|\\([0-9]+\\)/\\2\\)\\][^\n]*\n\\)" 1 'org-headline-done prepend)) 'append))
#+END_SRC

** Default files
*** Create agenda files if necessary
#+BEGIN_SRC emacs-lisp
(defvar cpped-org-default-todo-id "eb155a82-92b2-4f25-a3c6-0304591af2f9" "The ID of the default todo item.")

(defun cpped-create-default-file (file &optional content)
  "Create a file with given default content."
  (when (not (file-exists-p file))
    (with-temp-buffer
      (when content
        (insert content))
      (when (string-equal file org-default-todos-file)
        (insert (concat "* Misc\n:PROPERTIES:\n:CLOCK_MODELINE_TOTAL: today\n:ID: " cpped-org-default-todo-id "\n:END:\n")))
      (write-file file)
      (cpped-kill-default-buffer))))

(cpped-create-default-file org-default-bugs-file "#+CATEGORY: Bugs\n\n")
(cpped-create-default-file org-default-todos-file "#+CATEGORY: ToDos\n\n")
(cpped-create-default-file org-default-events-file)
(cpped-create-default-file org-default-notes-file "#+CATEGORY: Notes\n\n")
#+END_SRC

*** Hide default org files in buffer list
#+BEGIN_SRC emacs-lisp
(push (regexp-quote (file-name-nondirectory org-default-bugs-file)) helm-boring-buffer-regexp-list)
(push (regexp-quote (file-name-nondirectory org-default-todos-file)) helm-boring-buffer-regexp-list)
(push (regexp-quote (file-name-nondirectory org-default-events-file)) helm-boring-buffer-regexp-list)
(push (regexp-quote (file-name-nondirectory org-default-notes-file)) helm-boring-buffer-regexp-list)
#+END_SRC

*** Show special name for default buffers in mode line
#+BEGIN_SRC emacs-lisp
(push `(,(file-name-nondirectory org-default-bugs-file) . "*Bugs*") cpped-special-buffer-names-alist)
(push `(,(file-name-nondirectory org-default-todos-file) . "*ToDos*") cpped-special-buffer-names-alist)
(push `(,(file-name-nondirectory org-default-events-file) . "*Events*") cpped-special-buffer-names-alist)
(push `(,(file-name-nondirectory org-default-notes-file) . "*Notes*") cpped-special-buffer-names-alist)
#+END_SRC

*** Never kill special buffers
#+BEGIN_SRC emacs-lisp
(push (file-name-nondirectory org-default-bugs-file) cpped-bury-buffers-list)
(push (file-name-nondirectory org-default-events-file) cpped-bury-buffers-list)
(push (file-name-nondirectory org-default-todos-file) cpped-bury-buffers-list)
#+END_SRC

Remove check on buffer close
#+BEGIN_SRC emacs-lisp
(defun cpped-silence-org-clock (wrapped-function &rest arguments)
  "Do not ask to clock out when closing todo buffer."
  (when (not (string= (substring-no-properties (buffer-name)) (file-name-nondirectory org-default-todos-file)))
    (apply wrapped-function arguments)))

(advice-add 'org-check-running-clock :around #'cpped-silence-org-clock)
#+END_SRC

** Lists
*** Automatically create lists
#+BEGIN_SRC emacs-lisp
(use-package org-autolist
  :after org
  :hook (org-mode . org-autolist-mode))
#+END_SRC

*** Show actual bullets for header items
#+BEGIN_SRC emacs-lisp
(use-package org-bullets
  :after org
  :hook (org-mode . org-bullets-mode)
  :custom (org-bullets-bullet-list '("○")))
#+END_SRC

*** Show actual bullets for list items
#+BEGIN_SRC emacs-lisp
(font-lock-add-keywords 'org-mode
                        '(("^[ \t]*\\(-\\) "
                           (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "•"))))))
#+END_SRC

** Use current heading as function name
#+BEGIN_SRC emacs-lisp
(defun cpped-org-log-current-defun ()
  (save-excursion
    (org-back-to-heading)
    (when (looking-at org-complex-heading-regexp)
      (match-string 4))))

(add-hook 'org-mode-hook (lambda ()
                           (make-variable-buffer-local 'add-log-current-defun-function)
                           (setq add-log-current-defun-function 'cpped-org-log-current-defun)))
#+END_SRC

** Links
*** Shortcuts
#+BEGIN_SRC emacs-lisp
(push '("google"  . "https://www.google.de/?gws_rd=ssl#q=%s") org-link-abbrev-alist)
(push '("wikipedia"  . "https://en.wikipedia.org/wiki/%s") org-link-abbrev-alist)
#+END_SRC

*** Insertion
#+BEGIN_SRC emacs-lisp
(defun cpped-url-to-title (url)
  "Returns the content of the <title> tag of the page at url."
  (with-temp-buffer
    (url-insert-file-contents url)
    (beginning-of-buffer)
    (let ((begin (search-forward "<title>"))
          (end (progn
                 (search-forward "</title>")
                 (search-backward "<"))))
      (buffer-substring-no-properties begin end))))

(defun cpped-org-insert-link-dwim (url)
  "Insert an org link with the target page title as description. The URL is taken from either argument, region, thing-at-point or user input."
  (interactive (list (let (url begin end)
                       (if (region-active-p)
                           (setq begin (region-beginning)
                                 end (region-end)
                                 url (buffer-substring-no-properties begin end))
                         (progn
                           (setq url (thing-at-point 'url))
                           (if (not (= 0 (length url)))
                               (let ((bounds (bounds-of-thing-at-point 'url)))
                                 (setq begin (car bounds)
                                       end (cdr bounds)))
                             (let ((bounds (bounds-of-thing-at-point 'word)))
                               (setq url (read-string "URL: ")
                                     begin (car bounds)
                                     end (cdr bounds))))))
                       (when (and begin
                                  end)
                         (delete-region begin end))
                       url)))
  (when (not (string-match-p (rx line-start "http" (zero-or-one "s") "://") url))
      (setq url (concat "https://" url)))
  (org-insert-link nil url (cpped-url-to-title url)))

(defun cpped-org-convert-to-link-dwim (url title)
  "Convert the region or thing-at-point to a link with thing-at-point as the description."
  (interactive (list (read-string "URL: " "http://www.")
                     (let (title begin end)
                       (if (region-active-p)
                           (setq begin (region-beginning)
                                 end (region-end)
                                 title (buffer-substring-no-properties begin end))
                         (let* ((bounds (bounds-of-thing-at-point 'word)))
                           (setq title (buffer-substring-no-properties (car bounds) (cdr bounds))
                                 begin (car bounds)
                                 end (cdr bounds)))
                         (delete-region begin end)
                         title))))
  (org-insert-link nil url title))
#+END_SRC

** Inline code
*** Auto-save
#+BEGIN_SRC emacs-lisp
(setq org-edit-src-auto-save-idle-delay cpped-autosave-delay)
#+END_SRC

*** Allow evaluation
Disable evaluation confirmation for some languages
#+BEGIN_SRC emacs-lisp
(defun cpped-org-confirm-babel-evaluate (lang body)
  "Do not confirm evaluation for these languages."
  (not (or (string= lang "bash")
           (string= lang "calc")
           (string= lang "dot")
           (string= lang "gnuplot")
           (string= lang "latex")
           (string= lang "emacs-lisp")
           (string= lang "plantuml")
           (string= lang "python")
           (string= lang "sed")
           (string= lang "shell")
           (string= lang "zsh"))))
#+END_SRC

Note: For this to work, Org must be version 8.3 or higher. Org is bundled with emacs and must be updated manually from the repository.
#+BEGIN_SRC emacs-lisp
(org-babel-do-load-languages 'org-babel-load-languages
                             '((calc . t)
                               (dot . t)
                               (gnuplot . t)
                               (latex . t)
                               (lisp . t)
                               (plantuml . t)
                               (python . t)
                               (sed . t)
                               (shell . t)))

(setq org-confirm-babel-evaluate 'cpped-org-confirm-babel-evaluate)
(org-babel-shell-initialize)
(add-hook 'org-babel-after-execute-hook 'org-display-inline-images)
#+END_SRC

*** Set file name for edit buffer
#+BEGIN_SRC emacs-lisp
(defadvice org-edit-src-code (around set-buffer-file-name activate compile)
  (let ((file-name (buffer-file-name)))
    ad-do-it
    (setq buffer-file-name file-name)))
#+END_SRC

** Structure Templates
#+BEGIN_SRC emacs-lisp
(setq org-structure-template-alist
      '(("a" "#+BEGIN_ASCII\n?\n#+END_ASCII\n" "")
        ("b" "#+BEGIN_SRC bash\n?\n#+END_SRC\n" "<src lang=\"bash\">\n?\n</src>")
        ("*" "#+BEGIN_SRC calc\n?\n#+END_SRC\n" "<src lang=\"calc\">\n?\n</src>")
        ("c" "#+BEGIN_CENTER\n?\n#+END_CENTER\n" "<center>\n?\n</center>")
        ("+" "#+BEGIN_SRC c++\n?\n#+END_SRC\n" "<src lang=\"c++\">\n?\n</src>")
        ("d" "#+BEGIN_SRC dot :file %file :cmdline -Kdot -Tpng\n?\n#+END_SRC\n" "<src lang=\"dot\">\n?\n</src>")
        ("e" "#+BEGIN_EXAMPLE\n?\n#+END_EXAMPLE\n" "<example>\n?\n</example>")
        ("h" "#+BEGIN_HTML\n?\n#+END_HTML\n" "<literal style=\"html\">\n?\n</literal>")
        ("i" "#+INCLUDE: %file ?\n" "<include file=%file markup=\"?\">")
        ("l" "#+BEGIN_SRC emacs-lisp\n?\n#+END_SRC\n" "<src lang=\"emacs-lisp\">\n?\n</src>")
        ("p" "#+BEGIN_SRC gnuplot :file %file\n?\n#+END_SRC\n" "<src lang=\"plantuml\">\n?\n</src>")
        ("P" ":PROPERTIES:\n?\n:END:\n")
        ("/" "#+BEGIN_COMMENT\n?\n#+END_COMMENT\n" "<!--\n?\n-->")
        ("q" "#+BEGIN_QUOTE\n?\n#+END_QUOTE\n" "<quote>\n?\n</quote>")
        ("r" "#+BEGIN_SRC ?\n\n#+END_SRC\n" "<src lang=\"?\">\n\n</src>")
        ("s" "#+BEGIN_SRC shell\n?\n#+END_SRC\n" "<src lang=\"shell\">\n?\n</src>")
        ("u" "#+BEGIN_SRC plantuml :file %file\n?\n#+END_SRC\n" "<src lang=\"plantuml\">\n?\n</src>")
        ("v" "#+BEGIN_VERBATIM\n?\n#+END_VERBATIM\n" "<verbatim>\n?\n</verbatim>")
        ("z" "#+BEGIN_SRC zsh\n?\n#+END_SRC\n" "<src lang=\"zsh\">\n?\n</src>")))
#+END_SRC

** TODO-States
#+BEGIN_SRC emacs-lisp
(setq cpped-org-todo-keyword-todo "⚠ To Do"
      cpped-org-todo-keyword-done "✓ Done"
      cpped-org-todo-keyword-bug "🐛 Bug"
      cpped-org-todo-keyword-analysis "🔎 Analysis"
      cpped-org-todo-keyword-correction "🛠 Correction"
      cpped-org-todo-keyword-fixed "✓ Fixed"
      cpped-org-todo-keyword-fixme "🗫 Fixme"
      cpped-org-todo-keyword-in-progress "▶ In Progress"
      cpped-org-todo-keyword-waiting "🕓 Waiting"
      cpped-org-todo-keyword-suspended "💤 Suspended"
      cpped-org-todo-keyword-review "🗫 Review"
      cpped-org-todo-keyword-canceled "🗙 Canceled"
      org-todo-keywords `((sequence ,(concat cpped-org-todo-keyword-todo "(t)")
                                    ,(concat cpped-org-todo-keyword-in-progress "(p!)")
                                    ,(concat cpped-org-todo-keyword-review "(r!/@)")
                                    "|"
                                    ,(concat cpped-org-todo-keyword-done "(d!/@)"))
                          (sequence ,(concat cpped-org-todo-keyword-bug "(b)")
                                    ,(concat cpped-org-todo-keyword-analysis "(a!/@)")
                                    ,(concat cpped-org-todo-keyword-correction "(c!)")
                                    "|"
                                    ,(concat cpped-org-todo-keyword-fixed "(f!/@)"))
                          (sequence ,(concat cpped-org-todo-keyword-fixme "(m)")
                                    "|"
                                    ,(concat cpped-org-todo-keyword-done "(f/@)"))
                          (sequence ,(concat cpped-org-todo-keyword-waiting "(w@/!)")
                                    ,(concat cpped-org-todo-keyword-suspended "(s@/!)"))
                          (sequence "|" ,(concat cpped-org-todo-keyword-canceled "(x@/@)"))))
#+END_SRC

Format according to the state.
#+BEGIN_SRC emacs-lisp
(defface org-todo-keyword-todo '((t :inherit default)) "Face used for todo items." :group 'org)
(defface org-todo-keyword-in-progress '((t :inherit default)) "Face used for in-progress items." :group 'org)
(defface org-todo-keyword-waiting '((t :inherit default)) "Face used for waiting items." :group 'org)
(defface org-todo-keyword-suspended '((t :inherit default)) "Face used for suspended items." :group 'org)
(defface org-todo-keyword-done '((t :inherit default)) "Face used for done items." :group 'org)
(defface org-todo-keyword-canceled '((t :inherit default)) "Face used for canceled items." :group 'org)

(setq org-todo-keyword-faces `((,cpped-org-todo-keyword-todo . org-todo-keyword-todo)
                               (,cpped-org-todo-keyword-done . org-todo-keyword-done)
                               (,cpped-org-todo-keyword-bug . org-todo-keyword-todo)
                               (,cpped-org-todo-keyword-analysis . org-todo-keyword-in-progress)
                               (,cpped-org-todo-keyword-correction . org-todo-keyword-in-progress)
                               (,cpped-org-todo-keyword-fixed . org-todo-keyword-done)
                               (,cpped-org-todo-keyword-fixme . org-todo-keyword-todo)
                               (,cpped-org-todo-keyword-in-progress . org-todo-keyword-in-progress)
                               (,cpped-org-todo-keyword-review . org-todo-keyword-in-progress)
                               (,cpped-org-todo-keyword-waiting . org-todo-keyword-waiting)
                               (,cpped-org-todo-keyword-suspended . org-todo-keyword-suspended)
                               (,cpped-org-todo-keyword-canceled . org-todo-keyword-canceled)))
#+END_SRC

Archive when done, remove flag if reset to todo.
#+BEGIN_SRC emacs-lisp
(setq org-archive-mark-done nil
      org-archive-location "%s_archive::* Archived")
#+END_SRC

** Priorities
#+BEGIN_SRC emacs-lisp
(defface org-priority-high '((t :inherit default)) "Face used for high priority." :group 'org)
(defface org-priority-medium '((t :inherit default)) "Face used for medium priority." :group 'org)
(defface org-priority-low '((t :inherit default)) "Face used for low priority." :group 'org)

(setq org-priority-faces '(("A" . org-priority-high)
                           ("B" . org-priority-medium)
                           ("C" . org-priority-low)))

(use-package org-fancy-priorities
  :hook (org-mode . org-fancy-priorities-mode)
  :custom (org-fancy-priorities-list '((?A . "⚠")
                                       (?B . "⏲")
                                       (?C . "☕"))))
#+END_SRC

** Capture Templates
#+BEGIN_SRC emacs-lisp
(defun cpped-select-topic (name files)
  "Select an agenda topic."
  (let ((helm-org-headings-fontify nil)
        (helm-org-headings-actions (helm-make-actions
                                    "Select topic"
                                    (lexical-let ((_files files))
                                      (lambda (candidate)
                                        (if (markerp candidate)
                                            (progn (set-buffer (marker-buffer candidate))
                                                   (org-capture-put-target-region-and-position)
	                                           (widen)
	                                           (goto-char candidate)
	                                           (set-marker candidate nil))
                                          (progn
                                            (set-buffer (org-capture-target-buffer (if (listp _files)
                                                                                       (car _files)
                                                                                     _files)))
                                            (goto-char (point-max))
                                            (org-capture-put-target-region-and-position)
                                            (widen)))
                                        t)))))
    (or (helm :sources (list (helm-source-org-headings-for-files (if (listp files)
                                                                     files
                                                                   (list files)))
                             (helm-build-dummy-source
                                 "Create top-level entry"
                               :action helm-org-headings-actions))
              :candidate-number-limit 99999
              :preselect name
              :truncate-lines helm-org-truncate-lines
              :input name
              :prompt "Topic: "
              :buffer "*helm org headings*")
        (error "Aborted"))))

(defun cpped-select-todo-topic ()
  "Select a todo topic."
  (cpped-select-topic "" org-default-todos-file))

(defun cpped-select-support-topic ()
  "Select a support topic."
  (cpped-select-topic "Support" org-agenda-files))

(defun cpped-select-bug-topic ()
  "Select a bug topic."
  (cpped-select-topic "" org-default-bugs-file))

(defun cpped-select-note-topic ()
  "Select a note topic."
  (cpped-select-topic "" org-default-notes-file))

(defun cpped-select-event-topic ()
  "Select a event topic."
  (cpped-select-topic "" org-default-events-file))

(defun org-src-language-from-major-mode (local-major-mode)
  "Infer an 'org-mode' source block type from the major mode LOCAL-MAJOR-MODE."
  (car (rassq (intern (replace-regexp-in-string "-mode"
                                                ""
                                                (format "%s"
                                                        local-major-mode)))
              org-src-lang-modes)))

(setq org-capture-templates
      `(("t" "To Do" entry (function cpped-select-todo-topic) ,(concat "* " cpped-org-todo-keyword-todo " [#B] %?\n%U\n%i\n") :empty-lines 1 :kill-buffer t)
        ("p" "Priority To Do" entry (function cpped-select-todo-topic) ,(concat "* " cpped-org-todo-keyword-todo " [#A] %?\n%T\nDEADLINE: %t\n%i\n") :empty-lines 1 :kill-buffer t)
        ("b" "Bug" entry (function cpped-select-bug-topic) ,(concat "* " cpped-org-todo-keyword-bug " [#B] %?\n%U\n%i\n") :empty-lines 1 :kill-buffer t)
        ("f" "Fixme" entry (function cpped-select-bug-topic) ,(concat "* " cpped-org-todo-keyword-fixme " [#A] %?\n%U\nSCHEDULED: %t\nIn function *[[file:%F::%(with-current-buffer (org-capture-get :original-buffer) (number-to-string (line-number-at-pos)))][%(with-current-buffer (org-capture-get :original-buffer) (which-function))()]]*\n#+BEGIN_SRC %(with-current-buffer (org-capture-get :original-buffer) (org-src-language-from-major-mode major-mode))\n%i\n#+END_SRC\n") :empty-lines 1 :kill-buffer t)
        ("s" "Support" entry (function cpped-select-support-topic) ,(concat "* " cpped-org-todo-keyword-in-progress " [#B] %?\n%U\n%i\n") :empty-lines 1 :kill-buffer t :clock-in t :clock-keep t)
        ("n" "Note" entry (function cpped-select-note-topic) "* %?\n%U\n%i\n" :empty-lines 1 :kill-buffer t)
        ("m" "Meeting" entry (function cpped-select-event-topic) ,(concat "* " cpped-org-todo-keyword-todo " [#A] %?\n%T\n%i\n") :empty-lines 1 :kill-buffer t)
        ("i" "Instant Meeting" entry (function cpped-select-event-topic) ,(concat "* " cpped-org-todo-keyword-in-progress " [#A] %?\ns%T\n%i\n") :empty-lines 1 :kill-buffer t :clock-in t :clock-keep t)
        ("c" "Source Code" entry (function cpped-select-note-topic) ,(concat "* %?\n%U\n\nIn function *[[file:%F::%(with-current-buffer (org-capture-get :original-buffer) (number-to-string (line-number-at-pos)))][%(with-current-buffer (org-capture-get :original-buffer) (which-function))()]]*\n#+BEGIN_SRC %(with-current-buffer (org-capture-get :original-buffer) (org-src-language-from-major-mode major-mode))\n%i\n#+END_SRC\n") :empty-lines 1 :kill-buffer t)))
#+END_SRC

** Agenda
#+BEGIN_SRC emacs-lisp
(setq org-agenda-compact-blocks t
      org-agenda-current-time-string "now ────────────────────────────────────────"
      org-agenda-deadline-faces '((0.7 . error)
                                  (0.5 . warning)
                                  (0.0 . default))
      org-agenda-files (list org-default-bugs-file
                             org-default-todos-file
                             org-default-events-file
                             org-default-notes-file)
      org-agenda-format-date "%A, %e.%m.%Y"
      org-agenda-include-diary t
      org-agenda-prefix-format '((agenda  . "  %-24(org-format-outline-path (org-get-outline-path)) %-8T%?-12t% s  ")
                                 (timeline  . "  %l% s")
                                 (todo  . "  %-26(org-format-outline-path (org-get-outline-path)) %-6T%?-12t")
                                 (tags  . "  %-26(org-format-outline-path (org-get-outline-path)) %-6T")
                                 (search . "  %(org-format-outline-path (org-get-outline-path))%-6T"))
      org-agenda-remove-tags 'prefix
      org-agenda-restore-windows-after-quit t
      org-agenda-show-all-dates nil
      org-agenda-skip-unavailable-files t
      org-agenda-skip-deadline-if-done t
      org-agenda-skip-deadline-prewarning-if-scheduled t
      org-agenda-skip-scheduled-if-done t
      org-agenda-skip-timestamp-if-done t
      org-agenda-skip-scheduled-delay-if-deadline t
      org-agenda-skip-scheduled-if-deadline-is-shown t
      org-agenda-start-on-weekday nil
      org-agenda-time-grid '((daily today require-timed)
                             (800 930 1000 1230 1300 1600 1800)
                             "──────────" "──────────")
      org-agenda-todo-keyword-format "%-14s")
#+END_SRC

*** Custom Views
#+BEGIN_SRC emacs-lisp
(setq org-agenda-custom-commands '(("D" "Default agenda view"
                                    ((agenda "" ((org-agenda-skip-function '(let ((tags (save-excursion
                                                                                          (outline-back-to-heading)
                                                                                          (org-get-tags))))
                                                                              (if (or (member "Appointment" tags)
                                                                                      (member "Birthday" tags)
                                                                                      (member "Holiday" tags))
                                                                                  nil
                                                                                (org-agenda-skip-entry-if 'done 'todo `(,cpped-org-todo-keyword-waiting ,cpped-org-todo-keyword-suspended)))))
                                                 (org-agenda-span (if (= 5 (nth 6 (decode-time)))
                                                                      4
                                                                    2))))
                                     (todo (concat cpped-org-todo-keyword-bug "|" cpped-org-todo-keyword-fixme "|" cpped-org-todo-keyword-analysis "|" cpped-org-todo-keyword-correction "|" cpped-org-todo-keyword-review)
                                           ((org-agenda-skip-function '(org-agenda-skip-entry-if 'done 'scheduled))
                                            (org-agenda-overriding-header cpped-org-todo-keyword-bug)
                                            (org-agenda-prefix-format '((todo  . "  %(org-format-outline-path (org-get-outline-path))%?-12t")))
                                            (org-agenda-todo-keyword-format "")))
                                     (todo cpped-org-todo-keyword-waiting
                                           ((org-agenda-overriding-header cpped-org-todo-keyword-waiting)
                                            (org-agenda-todo-keyword-format "")))
                                     (todo cpped-org-todo-keyword-suspended
                                           ((org-agenda-overriding-header cpped-org-todo-keyword-suspended)
                                            (org-agenda-todo-keyword-format "")))
                                     (todo (concat cpped-org-todo-keyword-todo "|" cpped-org-todo-keyword-in-progress)
                                           ((org-agenda-skip-function '(org-agenda-skip-entry-if 'scheduled 'deadline 'done))
                                            (org-agenda-overriding-header cpped-org-todo-keyword-todo)
                                            (org-agenda-todo-keyword-format "")))))
                                   ("n" "Notes" tags "+CATEGORY=\"Notes\""
                                    ((org-agenda-overriding-header "Notes")
                                     (org-agenda-prefix-format '((tags . "%(org-format-outline-path (org-get-outline-path)) ")))))
                                   ("d" "Daily Timesheet" agenda ""
                                    ((org-agenda-overriding-header "Last Day")
                                     (org-agenda-span (if (= 1 (nth 6 (decode-time)))
                                                          4
                                                        2))
                                     (org-agenda-start-day (if (= 1 (nth 6 (decode-time)))
                                                               "-3d"
                                                             "-1d"))
                                     (org-agenda-start-on-weekday nil)
                                     (org-agenda-start-with-clockreport-mode t)
                                     (org-agenda-time-grid nil)
                                     (org-agenda-include-diary nil)
                                     (org-agenda-clockreport-parameter-plist '(:scope agenda-with-archives :indent t :link t :emphasize t :tcolumns 1 :maxlevel 6 :fileskip0 t :formula %))))
                                   ("p" "Monthly Timesheet" agenda ""
                                    ((org-agenda-overriding-header (concat (if (< (nth 3 (decode-time)) 25)
                                                                               "Last"
                                                                             "This")
                                                                           " Month"))
                                     (org-agenda-span 'month)
                                     (org-agenda-start-day (let* ((time (decode-time))
                                                                  (day (nth 3 time))
                                                                  (month (nth 4 time))
                                                                  (year (nth 5 time)))
                                                             (when (< day 25)
                                                               (setq month (if (= 1 month)
                                                                               (progn
                                                                                 (setq year (- year 1))
                                                                                 12)
                                                                             (- month 1))))
                                                             (format "%04d-%02d-01" year month)))
                                     (org-agenda-start-on-weekday nil)
                                     (org-agenda-start-with-clockreport-mode t)
                                     (org-agenda-time-grid nil)
                                     (org-agenda-include-diary nil)
                                     (org-agenda-clockreport-parameter-plist '(:scope agenda-with-archives :indent t :link t :emphasize t :tcolumns 1 :maxlevel 2 :fileskip0 t :formula %))))))
#+END_SRC

*** Reschedule to today
#+BEGIN_SRC emacs-lisp
(defun cpped-org-agenda-reschedule-to-today ()
  "Reschedule the selected item to today."
  (interactive)
  (cl-letf (((symbol-function 'org-read-date) '(lambda (&rest args)
                                                 (current-time))))
    (call-interactively 'org-agenda-schedule)))
#+END_SRC

** [[https://github.com/bard/org-dashboard/blob/master/org-dashboard.el][Progress Report]]
#+BEGIN_SRC emacs-lisp
(require 'url)
(setq url-privacy-level 'high)

(use-package org-dashboard
  :custom (org-dashboard-omit-completed t))
#+END_SRC

** Alert messages
#+BEGIN_SRC emacs-lisp
(use-package org-alert
  :after org
  :hook (after-make-frame-functions . (lambda (_)
                                        (org-alert-enable)))
  :custom
  (alert-default-style 'libnotify)
  (org-alert-interval 86400)
  (org-alert-notification-title "TODO"))
#+END_SRC

** EDiff Compatibility
#+BEGIN_SRC emacs-lisp
(defun cpped-run-in-org-buffer (buffer command &rest arguments)
  "Execute command if given buffer is in org mode"
  (when (and buffer
             (eq (buffer-local-value 'major-mode (get-buffer buffer)) 'org-mode)
             (save-excursion
               (set-buffer buffer)
               (apply command arguments)))))

(defun cpped-ediff-org-unfold ()
  "Unfold at diff location"
  (cpped-run-in-org-buffer ediff-buffer-A 'org-reveal)
  (cpped-run-in-org-buffer ediff-buffer-B 'org-reveal)
  (cpped-run-in-org-buffer ediff-buffer-C 'org-reveal))

(defun cpped-ediff-org-fold ()
  "Fold back to top level"
  (cpped-run-in-org-buffer ediff-buffer-A 'hide-sublevels 1)
  (cpped-run-in-org-buffer ediff-buffer-B 'hide-sublevels 1)
  (cpped-run-in-org-buffer ediff-buffer-C 'hide-sublevels 1))

(add-hook 'ediff-select-hook 'cpped-ediff-org-unfold)
(add-hook 'ediff-unselect-hook 'cpped-ediff-org-fold)
#+END_SRC

** Magit compatibility
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "magit"
  (defun cpped-expand-org-entry ()
  "Expand all entries leading to the selected entry."
  (when (derived-mode-p 'org-mode)
    (org-reveal '(4)))))

(add-hook 'magit-diff-visit-file-hook 'cpped-expand-org-entry)
#+END_SRC

** Change todo state of subtree
#+BEGIN_SRC emacs-lisp
(defun cpped-todo-subtree ()
  "Change the todo state of a subtree."
  (interactive)
  (org-mark-subtree)
  (let ((state (org-fast-todo-selection))
        (begin (point)))
    (when state
      (save-excursion
        (exchange-point-and-mark)
        (while (> (point) begin)
          (org-todo state)
          (outline-previous-visible-heading 1))
        (org-todo state)))))
#+END_SRC

** Mark heading done when all subheadings are done
#+BEGIN_SRC emacs-lisp
(defun cpped-org-summary-change-todo (done todo)
  "Switch entry to DONE when all subentries are done, to TODO otherwise."
  (let (org-log-done org-log-states) ; turn off logging
    (org-todo (if (= todo 0)
                  cpped-org-todo-keyword-done
                cpped-org-todo-keyword-todo))))

(add-hook 'org-after-todo-statistics-hook 'cpped-org-summary-change-todo)
#+END_SRC

** Mark heading done when all checkboxes are checked.
#+BEGIN_SRC emacs-lisp
(defun cpped-checkbox-list-complete ()
  (interactive)
  (save-excursion
    (org-back-to-heading t)
    (let ((begin (point)))
      (end-of-line)
      (when (re-search-backward "\\[\\([0-9]+%\\)\\]\\|\\[\\([0-9]+\\)/\\([0-9]+\\)\\]" begin t)
        (if (or (equal (match-string 1) "100%")
                (and (match-string 2)
                     (equal (match-string 2) (match-string 3))))
            (org-todo cpped-org-todo-keyword-done)
          (org-todo cpped-org-todo-keyword-todo))))))

(add-hook 'org-checkbox-statistics-hook 'cpped-checkbox-list-complete)
#+END_SRC

** Wrap Region
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "wrap-region"
  (wrap-region-add-wrappers
   '(("*" "*" nil org-mode)
     ("~" "~" nil org-mode)
     ("/" "/" nil org-mode)
     ("=" "=" nil org-mode)
     ("_" "_" nil org-mode)
     ("$" "$" nil org-mode)))
  (add-hook 'org-mode-hook 'wrap-region-mode))
#+END_SRC

** Clocking
#+BEGIN_SRC emacs-lisp
(setq org-clock-history-length 25
      org-clock-idle-time nil
      org-clock-in-resume t
      org-clock-in-switch-to-state cpped-org-todo-keyword-in-progress
      org-clock-into-drawer t
      org-clock-out-remove-zero-time-clocks t
      org-clock-out-when-done t
      org-clock-persist 'history
      org-clock-persist-query-resume nil
      org-clock-auto-clock-resolution nil
      org-clock-report-include-clocking-task t)

(org-clock-persistence-insinuate)
#+END_SRC

*** Remaining work time
#+BEGIN_SRC emacs-lisp
(defvar cpped-show-work-time nil "Whether to show work time in the mode line.")
(defvar cpped-clocked-time-today 0 "The work time clocked today.")
(defconst cpped-daily-work-minutes (* 8 60) "The number of hours of work per day.")

(defun cpped-init-clocked-time-today ()
  "(Re-)Initialize the value of 'cpped-clocked-time-today'."
  (interactive)
  (setq cpped-clocked-time-today 0)
  (let ((files (org-agenda-files)))
    (org-agenda-prepare-buffers files)
    (dolist (file files)
      (with-current-buffer (find-buffer-visiting file)
        (setq cpped-clocked-time-today (+ cpped-clocked-time-today (org-clock-sum-today)))))))

(cpped-init-clocked-time-today)

(defun cpped-remaining-work-minutes ()
  "Return the remaining minutes between clocked time today and `cpped-daily-work-minutes`. "
  (interactive)
  (- (+ cpped-clocked-time-today (if (org-clock-is-active)
                                     (floor (- (float-time)
                                               (float-time org-clock-start-time)) 60)
                                   0))
     cpped-daily-work-minutes))

(defun cpped-print-remaining-work-time ()
  "Return the remaining time between clocked time today and `cpped-daily-work-minutes`. "
  (interactive)
  (if (and cpped-show-work-time
             (org-clock-is-active))
      (let* ((difference (cpped-remaining-work-minutes))
             (display-text (format "%s %s%d:%02d"
                                   (propertize (all-the-icons-faicon5 "briefcase")
                                               'face (list ':family (all-the-icons-faicon5-family))
                                               'display '(raise -0.0))
                                   (if (< difference 0)
                                       "-"
                                     "+")
                                   (abs (/ difference 60))
                                   (abs (% difference 60)))))
        (add-face-text-property 0 (length display-text) (list ':foreground (if (< difference 0)
                                                                               (face-attribute 'error :foreground)
                                                                             (face-attribute 'info :foreground))) nil display-text)
        display-text)
    ""))
#+END_SRC

*** Do not show default clocking information in mode line
#+BEGIN_SRC emacs-lisp
(advice-add 'org-clock-update-mode-line :override #'force-mode-line-update)
#+END_SRC

*** Punch in/out
#+BEGIN_SRC emacs-lisp
(defun cpped-clock-in-default-task ()
  "Clock in default task."
  (save-excursion
    (org-with-point-at (org-id-find cpped-org-default-todo-id 'marker)
      (org-clock-mark-default-task)
      (org-clock-in))))

(defun cpped-punch-in ()
  "Start continuous clocking."
  (interactive)
  (cpped-clock-in-default-task))

(defun cpped-punch-out ()
  "Stop clocking tasks."
  (interactive)
  (let ((cpped-keep-clock-running nil))
    (when (org-clock-is-active)
      (org-clock-out)
      (save-some-buffers t nil))))
#+END_SRC

*** Maybe switch to default task when clocking out.
#+BEGIN_SRC emacs-lisp
(defvar cpped-keep-clock-running t "Flag to decide whether to keep the clock always running.")

(defun cpped-clock-out-maybe-activate-default-task ()
  "Clock in default task in certain circumstances when clocking out."
  (when (and cpped-keep-clock-running
             (not org-clock-clocking-in)
             (not org-clock-resolving-clocks-due-to-idleness))
    (cpped-clock-in-default-task)))

(add-hook 'org-clock-out-hook #'cpped-clock-out-maybe-activate-default-task)
#+END_SRC

*** Automatically start clocking when starting emacs.
#+BEGIN_SRC emacs-lisp
(cpped-punch-in)
#+END_SRC

*** Automatically stop clocking when exiting emacs.
#+BEGIN_SRC emacs-lisp
(add-hook 'kill-emacs-hook #'cpped-punch-out)
#+END_SRC

*** Clock in/out of task when starting/stopping
#+BEGIN_SRC emacs-lisp
(defun cpped-org-clock-in-if-starting ()
  "Clock in when a task is started."
  (when (and (string= org-state cpped-org-todo-keyword-in-progress)
             (not (string= org-last-state org-state)))
    (org-clock-in)))

(add-hook 'org-after-todo-state-change-hook #'cpped-org-clock-in-if-starting)

(defun cpped-org-clock-out-if-inactive ()
  "Clock out when a task is stopped."
  (when (and (member org-state '(cpped-org-todo-keyword-done
                                 cpped-org-todo-keyword-fixed
                                 cpped-org-todo-keyword-waiting
                                 cpped-org-todo-keyword-suspended
                                 cpped-org-todo-keyword-canceled))
             (equal (marker-buffer org-clock-marker) (current-buffer))
             (< (point) org-clock-marker)
             (> (save-excursion
                  (outline-next-heading)
                  (point))
                org-clock-marker)
             (not (string= org-last-state org-state)))
    (org-clock-out)))

(add-hook 'org-after-todo-state-change-hook #'cpped-org-clock-out-if-inactive)
#+END_SRC

*** Discover total time clocked today
#+BEGIN_SRC emacs-lisp
#+END_SRC

*** Update cached clock time when clocking out
#+BEGIN_SRC emacs-lisp
(add-hook 'org-clock-out-hook (lambda ()
                                (setq cpped-clocked-time-today (+ cpped-clocked-time-today (floor (- (float-time)
                                                                                                     (float-time org-clock-start-time)) 60)))))
#+END_SRC

*** [[https://github.com/unhammer/org-mru-clock][Switch to last used clock]]
#+BEGIN_SRC emacs-lisp
(use-package org-mru-clock
  :custom (org-mru-clock-how-many 100))
#+END_SRC

* Utilities
** System
*** Processes
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "helm"
  (require 'helm-sys))
#+END_SRC

*** Services
#+BEGIN_SRC emacs-lisp
(use-package helm-systemd)
#+END_SRC

** Use rx syntax for regular expression builder
#+BEGIN_SRC emacs-lisp
(setq reb-re-syntax 'rx)
#+END_SRC

** Calculator
Do not use scientific form so quickly
#+BEGIN_SRC emacs-lisp
(setq calc-display-sci-low -5)
#+END_SRC

** Calendar
#+BEGIN_SRC emacs-lisp
(use-package german-holidays
  :config (setq calendar-holidays holiday-german-HH-holidays))

(setq calendar-date-style 'european
      calendar-week-start-day 1
      european-calendar-style t
      mark-diary-entries-in-calendar t
      mark-holidays-in-calendar t
      calendar-mark-holidays-flag t
      calendar-view-holidays-initially-flag t
      calendar-time-display-form '(24-hours ":" minutes (and time-zone (concat " (" time-zone ")"))))
#+END_SRC

** GNUPlot
#+BEGIN_SRC emacs-lisp
(use-package gnuplot
  :after system-packages
  :mode ("\\.gnuplot\\'" . gnuplot-mode)
  :hook (gnuplot-mode . flyspell-prog-mode)
  :custom
  (gnuplot-eldoc-mode t)
  (gnuplot-image-format "svg")
  (gnuplot-inline-image-mode 'dedicated)
  (gnuplot-tab-completion t)
  :config
  (cpped-install-system-package "gnuplot"))
#+END_SRC

** Weather
#+BEGIN_SRC emacs-lisp
(use-package wttrin
  :custom (wttrin-default-cities `(,calendar-location-name)))
#+END_SRC

* Remote
** Serial Devices
#+BEGIN_SRC emacs-lisp
(defcustom cpped-serial-port nil "The last used serial port.")
(defcustom cpped-serial-port-baudrate 155200 "The last used serial port baud rate.")

(defun cpped-serial-terminal (port baudrate)
  (interactive (let ((ports (directory-files "/dev/" nil "ttyUSB[0-9]+" t)))
                 (list (cond ((= (length ports) 0) nil)
                             ((= (length ports) 1) (car ports))
                             (t (helm :sources (helm-build-sync-source "Serial Port"
                                                 :candidates (directory-files "/dev/" nil "ttyUSB[0-9]+" t))
                                      :prompt "Serial Port: "
                                      :preselect cpped-serial-port
                                      :buffer "*helm serial port*")))
                       (when (> (length ports) 0)
                         (string-to-number (helm :sources (helm-build-sync-source "Baudrate"
                                                            :candidates '("300" "600" "1200" "2400" "4800" "9600" "19200" "38400" "57600" "115200" "230400" "460800" "576000" "921600"))
                                                 :prompt "Baudrate: "
                                                 :preselect (number-to-string cpped-serial-port-baudrate)
                                                 :buffer "*helm serial port*"))))))
  (if port
      (progn
        (serial-term (expand-file-name port "/dev") baudrate)
        (rename-buffer (format "*Serial Terminal %s*" port))
        (set-buffer-process-coding-system 'utf-8-unix 'utf-8-unix)
        (customize-save-variable 'cpped-serial-port port)
        (customize-save-variable 'cpped-serial-port-baudrate baudrate))
    (message "No serial port found.")))
#+END_SRC

** [[https://www.emacswiki.org/emacs/TrampMode][Network Devices]]
#+BEGIN_SRC emacs-lisp
(use-package tramp
  :custom
  (tramp-adb-connect-if-not-connected t)
  (tramp-connection-properties nil)
  (tramp-connection-timeout 10)
  (tramp-default-method "ssh")
  (tramp-default-host nil)
  (tramp-default-user "root")
  (tramp-histfile-override nil))

(use-package helm-tramp
  :after (helm tramp))
#+END_SRC

* [[https://github.com/abo-abo/hydra][Keybindings]]
** Use Escape instead of C-g
#+BEGIN_SRC emacs-lisp
(define-key key-translation-map (kbd "ESC") (kbd "C-g"))
#+END_SRC

** Smart close
#+BEGIN_SRC emacs-lisp
(defun cpped-close-editor ()
  "Close the editor (either frame or emacs), depending on the current mode of operation."
  (interactive)
  (if (= (length (frame-list)) 1)
      (kill-emacs)
    (delete-frame)))
#+END_SRC

** Helm
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "M-x") 'helm-M-x)
(global-set-key (kbd "<menu>") 'helm-M-x)
#+END_SRC

** Hydra
#+BEGIN_SRC emacs-lisp
(use-package hydra)
#+END_SRC

** Projects
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-projects (:exit t :hint nil)
  "
☰ Project 🗁 %s(or (ignore-errors (projectile-project-root))
                   default-directory)%s(let ((build-dir (cpped-build-dir)))
                                          (if build-dir
                                              (concat \" 🛠 \" build-dir)
                                            \"\"))

CMake              ^^Git                         ^^Directories         ^^Shell                    ^^Other
  _o_: Load            _g_: Status                   _/_: Project          _#_: Project directory     _f_: Find
  _c_: Configure       _G_: Other Project Status     _._: Current          _:_: Current directory     _L_: Add change log entry
  _r_: Reconfigure     _l_: Log                      _d_: Subdirectory                              ^^_t_: Show ToDos
  _-_: Reset                                       ^^_b_: Build            _B_: Build directory
  _x_: Close           _v_: Clone
                     ^^_V_: Clone from GitHub
"
  ("o" cpped-load-project)
  ("c" cpped-cmake-configure)
  ("r" cpped-cmake-reconfigure)
  ("-" cpped-cmake-reset)
  ("x" projectile-kill-buffers)
  ("g" magit-status)
  ("G" (let ((current-prefix-arg 4))
         (call-interactively #'magit-status)))
  ("l" magit-log-popup)
  ("v" magit-clone)
  ("V" magithub-clone)
  ("/" projectile-dired)
  ("." dired-jump)
  ("d" projectile-find-dir)
  ("b" (if cmake-ide-build-dir
           (dired cmake-ide-build-dir)))
  ("#" cpped-shell-project-dir)
  (":" ansi-term)
  ("B" cpped-shell-build-dir)

  ("f" (helm-ag (or (helm-ag--project-root)
                    default-directory)))
  ("L" add-change-log-entry)
  ("t" cpped-find-todos-in-project))

(global-set-key (kbd "C-p") #'cpped-hydra-projects/body)
#+END_SRC

** Files
#+BEGIN_SRC emacs-lisp
(defun cpped-create-scratch-buffer ()
  "Create a scratch buffer."
  (interactive)
  (switch-to-buffer (get-buffer-create "*scratch*"))
  (lisp-interaction-mode))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-buffersize ()
  (when (not vlf-mode)
    (concat
     (propertize (all-the-icons-faicon5 "file-alt")
                 'face `(:family ,(all-the-icons-faicon5-family))
                 'display '(raise -0.0))
     (format-mode-line " %I ")
     (propertize (all-the-icons-faicon5 "align-left")
                 'face `(:family ,(all-the-icons-faicon5-family))
                 'display '(raise -0.0))
     (save-excursion
       (goto-char (point-max))
       (format-mode-line " %l")))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun cpped-file-encoding ()
  (concat
   (propertize (all-the-icons-faicon5 "language")
               'face `(:family ,(all-the-icons-faicon5-family))
               'display '(raise -0.0))
   " "
   (symbol-name (coding-system-type buffer-file-coding-system))
   " "
   (propertize (pcase (coding-system-eol-type buffer-file-coding-system)
                 (`0  (all-the-icons-faicon5 "linux"))
                 (`1  (all-the-icons-faicon5 "windows"))
                 (`2 (all-the-icons-faicon5 "apple"))
                 (_ (all-the-icons-faicon5 "question")))
               'face `(:family ,(all-the-icons-faicon5-family))
               'display '(raise -0.0))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-files (:exit t :hint nil)
  "
☰ File %s(concat (cpped-powerline-mode-icon 'default) \" \" (cpped-powerline-buffer-id 'default) \" \" (cpped-buffersize) \" \"  (cpped-file-encoding))

Open                             ^^Save                      ^^Close                  ^^Switch             ^^Version                    ^^Display                       ^^File                           ^^^^^^Encoding
      _o_: Open                      _s_: Save                   _x_: File                _l_: Last file       _v_: Show old version        _V_: Filter                 _<DEL>_: Delete                      ^^^^_C-d_: DOS
      _O_: From docker container     _S_: Save as                _X_: Other files         _f_: Find            _d_: Diff                    _!_: Toggle read-only mode      _m_: Rename                      ^^^^_C-u_: UNIX
      _n_: New                                                 ^^_w_: File and window                        ^^_g_: Log                     _h_: Hexadecimal mode           _D_: Diff to
      _N_: New scratch buffer        _i_: Public gist            _u_: Unused files                           ^^_G_: Autocommit-Log                                        ^^_z_: Clear content
                                   ^^_I_: Private gist           _a_: Close editor                           ^^_b_: Blame                   _6_: Decode Base64              _r_: Run command
      _j_: Header/Source                                                                                 ^^^^^^_T_: Trace lines             _&_: Encode Base64              _c_: Copy name to clipboard
      _t_: Test                      _e_: Encrypt                                                                                                                   ^^^^^^^^_._: Open directory
  _<RET>_: File under cursor                                                                                                                                      ^^^^^^^^^^_+_: Show Directory Tree
      _k_: Gist                      _F_: Toggle auto-format
"
  ("o" cpped-helm-find-files)
  ("O" docker-container-find-file)
  ("n" helm-find-files)
  ("N" cpped-create-scratch-buffer)
  ("j" helm-projectile-find-other-file :exit nil)
  ("t" projectile-toggle-between-implementation-and-test :exit nil)
  ("<RET>" helm-projectile-find-file-dwim)
  ("k" gist-list)

  ("s" save-buffer)
  ("S" cpped-save-copy)
  ("i" (when (yes-or-no-p "Upload as gist?")
         (gist-region-or-buffer)))
  ("I" (when (yes-or-no-p "Upload as private gist?")
         (gist-region-or-buffer-private)))
  ("F" (if cpped-auto-format-enabled-p
           (setq-local cpped-auto-format-enabled-p nil)
         (setq-local cpped-auto-format-enabled-p t)))
  ("e" epa-encrypt-file)

  ("x" cpped-kill-default-buffer)
  ("X" crux-kill-other-buffers)
  ("w" kill-buffer-and-window)
  ("u" clean-buffer-list)
  ("a" cpped-close-editor)

  ("l" cpped-previous-buffer :exit nil)
  ("f" helm-ag-buffers)

  ("v" git-timemachine)
  ("d" magit-diff-buffer-file-popup)
  ("g" magit-log-buffer-file-popup)
  ("G" magit-wip-log-current)
  ("b" magit-blame-popup)
  ("T" (when (region-active-p)
         (let ((magit-log-arguments
                (magit-popup-import-file-args
                 `(,(format "-L %d,%d:%s"
                            (line-number-at-pos (region-beginning))
                            (line-number-at-pos (region-end))
                            buffer-file-name)
                   "--decorate"
                   "--simplify-by-decoration")
                 (list (magit-file-relative-name)))))
           (magit-invoke-popup 'magit-log-popup nil nil))))

  ("<DEL>" crux-delete-file-and-buffer)
  ("m" crux-rename-file-and-buffer)
  ("z" erase-buffer)
  ("r" cpped-execute-command-on-buffer-file)
  ("D" ediff-files)
  ("C-d" cpped-unix2dos)
  ("C-u" cpped-dos2unix)
  ("V" (let ((word (thing-at-point 'word)))
             (if word
                 (loccur word)
               (call-interactively 'loccur))))
  ("!" (progn (read-only-mode)
              (when (and buffer-read-only
                         buffer-file-name)
                (unless (file-writable-p buffer-file-name)
                  (sudo-edit-current-file)))))
  ("h" hexl-mode)
  ("6" (base64-decode-region (point-min) (point-max)))
  ("&" (base64-encode-region (point-min) (point-max)))
  ("c" cpped-copy-file-name-to-clipboard)
  ("." dired-jump)
  ("+" treemacs-toggle))

(global-set-key (kbd "C-f") 'cpped-hydra-files/body)
(global-set-key (kbd "M-^") 'cpped-switch-buffer)

;(define-key term-raw-map (kbd "C-f") 'cpped-hydra-files/body)
#+END_SRC

** Info
#+BEGIN_SRC emacs-lisp
(defun cpped-search-github-code ()
  "Search for code on GitHub."
  (interactive)
  (eww (format "https://github.com/search?q=%s&type=Code" (or (when (region-active-p)
                                                                (buffer-substring-no-properties (region-beginning) (region-end)))
                                                              (read-string "Code: ")))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-info (:exit t :hint nil)
  "
☰ Information %s(format \"%s %s\" (cpped-print-date) (cpped-print-time))

Text                    ^^Code                                ^^Version Control         ^^System             ^^Other
  _._: Character            _d_: Documentation                    _c_: Commit Message       _p_: Processes       _t_: ToDos
  _#_: Number               _r_: References                       _b_: Blame                _M_: Man page        _w_: Weather
  _f_: Define               _h_: Caller hierarchy                                         ^^_I_: Info page
  _x_: Translate            _m_: Member hierarchy
  _s_: Synonym              _i_: Inheritance hierarchy
  _g_: Google
  _G_: Find on GitHub       _+_: Preprocess
  _o_: Preview markdown     _l_: Count lines of code
                          ^^_j_: Copy JSON path

                          ^^_D_: Toggle shell documentation
"
  ("#" describe-number-at-point)
  ("f" define-word-at-point)
  ("x" cpped-translate-word-or-region)
  ("s" synosaurus-lookup)
  ("g" helm-google-suggest)
  ("G" cpped-search-github-code)
  ("o" flymd-flyit)
  ("." what-cursor-position)

  ("d" (if (or (derived-mode-p 'asm-mode)
               (derived-mode-p 'nasm-mode))
           (call-interactively 'x86-lookup)
         (call-interactively 'helm-dash-at-point)))
  ("r" lsp-ui-peek-find-references)
  ("h" (cquery-call-hierarchy nil))
  ("m" cquery-member-hierarchy)
  ("i" cquery-inheritance-hierarchy)

  ("+" cquery-preprocess-file)
  ("l" cpped-sloccount)
  ("j" jsons-print-path)
  ("D" shelldoc-toggle-doc-window)

  ("c" git-messenger:popup-message)
  ("b" magit-blame-popup)

  ("p" helm-top)
  ("M" helm-man-woman)
  ("I" info)

  ("t" cpped-find-todos-in-file)
  ("w" wttrin))

(global-set-key (kbd "C-ß") 'cpped-hydra-info/body)

(global-set-key (kbd "C-c m") (lambda ()
                                (interactive)
                                (popwin:display-buffer "*Messages*")))
#+END_SRC

** Navigation
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-flyspell (:exit nil :columns 1)
  "
☰ Spell Check
"
  ("C-y" flyspell-goto-next-error "Next error")
  ("C-c" helm-flyspell-auto-correct "Correct"))

(defhydra cpped-hydra-flycheck (:exit nil :columns 1)
"
☰ Code Check
"
  ("C-S-e" flycheck-previous-error  "Previous error")
  ("C-e" flycheck-next-error "Next error")
  ("C-w" flycheck-copy-errors-as-kill "Copy errors" :exit t)
  ("C-x" flycheck-clear "Clear errors" :exit t))

(defhydra cpped-hydra-navigation (:exit nil :hint nil)
  "
☰ Navigation

Text                           ^^Code                                 Marker                     ^^Diff                 ^^Other
   _<left>_: Left                  _C-S-s_: Previous S-EXPR          _C-S-i_: Previous instance      _C-S-h_: Previous hunk   _C-c_: Last change
  _<right>_: Right                   _C-s_: Next S-EXPR                _C-i_: Next instance          _C-h_: Next hunk         _C-u_: URL
 _C-<left>_: Previous word             _w_: Up block                 _C-S-t_: Previous ToDo                                   ^^_C-q_: XQuery
_C-<right>_: Next word                 _y_: Down block                 _C-t_: Next ToDo                                       ^^_C-x_: XPath
   _<home>_: Beginning of line         _q_: Left block               _C-S-e_: Previous error
    _<end>_: End of line           _C-S-f_: Beginning of function      _C-e_: Next error
     _<up>_: Previous line           _C-f_: End of function          _C-S-a_: Previous Annotation
   _<down>_: Next line               _C-s_: Symbol declaration         _C-a_: Next Annotation
   _<C-up>_: Previous paragraph      _C-m_: Function
 _<C-down>_: Next paragraph        _C-S-m_: Function (all buffers)
 _<C-home>_: Begining of file      _C-S-n_: Previous namespace
  _<C-end>_: End of file             _C-n_: Next namespace
    _C-S-l_: Previous list           _M-n_: Namespace
      _C-l_: Next list
      _C-j_: jump to character
      _C-l_: Line
   _C-S-c_ : Character
"
  ("<left>" left-char)
  ("<right>" right-char)
  ("C-<left>" left-word)
  ("C-<right>" right-word)
  ("<home>" crux-move-beginning-of-line)
  ("<end>" end-of-visual-line)
  ("<up>" previous-line)
  ("<down>" next-line)
  ("<C-up>" backward-paragraph)
  ("<C-down>" forward-paragraph)
  ("<C-home>" beginning-of-buffer)
  ("<C-end>" end-of-buffer)
  ("C-S-l" backward-up-list)
  ("C-l" down-list)
  ("C-j" avy-goto-char-timer :exit t)
  ("C-l" goto-line-preview :exit t)
  ("C-S-c" goto-char-preview :exit t)

  ("C-S-s" backward-sexp)
  ("C-s" forward-sexp)
  ("w" smart-up)
  ("y" smart-down)
  ("q" smart-left)
  ("d" smart-right)
  ("C-S-f" beginning-of-defun)
  ("C-f" end-of-defun)
  ("C-s" lsp-ui-peek-find-definitions :exit t)
  ("C-m" helm-imenu :exit t)
  ("C-S-m" helm-imenu-anywhere :exit t)
  ("C-S-n" outre-goto-namespace-previous)
  ("C-n" outre-goto-namespace-next)
  ("M-n" outrespace-jump-to-ns)

  ("C-S-i" smartscan-symbol-go-backward)
  ("C-i" smartscan-symbol-go-forward)
  ("C-S-t" hl-todo-previous)
  ("C-t" hl-todo-next)
  ("C-S-e" (progn (flycheck-previous-error)
                  (cpped-hydra-flycheck/body) :exit t))
  ("C-e" (progn (flycheck-next-error)
                (cpped-hydra-flycheck/body) :exit t))
  ("C-y" (progn (flyspell-goto-next-error)
                (cpped-hydra-flyspell/body)) :exit t)
  ("C-S-a" annotate-previous-annotation)
  ("C-a" annotate-next-annotation)

  ("C-S-h" diff-hl-previous-hunk)
  ("C-h" diff-hl-next-hunk)

  ("C-c" goto-last-change :exit t)
  ("C-u" cpped-jump-to-url :exit t)
  ("C-q" xquery-tool-query :exit t)
  ("C-x" helm-x-path-walker :exit t))

(global-set-key (kbd "C-<left>") 'left-word)
(global-set-key (kbd "C-<right>") 'right-word)
(global-set-key (kbd "<home>") 'crux-move-beginning-of-line)
(global-set-key (kbd "<end>") 'end-of-visual-line)
(global-set-key (kbd "C-<up>") 'backward-paragraph)
(global-set-key (kbd "C-<down>") 'forward-paragraph)
(global-set-key (kbd "C-<home>") 'beginning-of-buffer)
(global-set-key (kbd "C-<end>") 'end-of-buffer)

(global-set-key (kbd "C-n") 'cpped-hydra-navigation/body)
(global-set-key (kbd "C-j") 'avy-goto-char-timer)
#+END_SRC

** Folding
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-fold (:exit t :columns 1)
  "
☰ Fold
"
  ("f" origami-forward-toggle-node "(un)fold")
  ("r" origami-recursive-toggle-node "(un)fold recursive")
  ("a" origami-toggle-all-nodes "(un)fold all nodes")
  ("n" cpped-narrow-or-widen-dwim "narrow/widen"))

(global-set-key (kbd "C-+") 'cpped-hydra-fold/body)
#+END_SRC

** Finding
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "C-s") 'helm-swoop)
(global-set-key (kbd "M-s") 'helm-ag-buffers)
(global-set-key (kbd "M-S-s") 'helm-projectile-ag)
#+END_SRC

** Mark
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-mark (:exit nil :hint nil :foreign-keys run :pre (set-mark (point)))
  "
☰ Mark

Mark                            ^^Modify                        ^^Act
  _w_: Word                         _+_: Expand region              _c_: Copy
  _W_: Rest of word                 _x_: Exchange mark and point    _d_: Delete
  _s_: S-EXPR                       _j_: Jump to character          _k_: Kill
  _f_: Function
  _n_: Namespace
  _l_: Rest of line
  _L_: Line up to here
  _b_: Everything before cursor
  _a_: Everything after cursor
  _e_: Everything
"
  ("w" (progn
         (backward-word)
         (mark-word)))
  ("W" mark-word)
  ("s" mark-sexp)
  ("f" (funcall cpped-mark-function))
  ("n" outre-highlight-ns-by-name)
  ("r" rectangle-mark-mode)
  ("+" er/expand-region)
  ("x" exchange-point-and-mark)
  ("j" avy-goto-char-timer)
  ("l" end-of-line)
  ("L" beginning-of-line)
  ("b" mark-buffer-before-point)
  ("a" mark-buffer-after-point)
  ("e" mark-whole-buffer)
  ("c" (kill-ring-save nil nil t) :exit t)
  ("d" (call-interactively #'delete-region) :exit t)
  ("k" (kill-region nil nil t) :exit t))

(global-set-key (kbd "C-SPC") #'cpped-hydra-mark/body)
#+END_SRC

** Editing
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-edit-case (:exit t :columns 1)
  "
☰ Change Case
"
  ("u" fix-word-upcase "Upper case")
  ("l" fix-word-downcase "Lower case")
  ("c" fix-word-capitalize "Capitalize")
  ("i" string-inflection-cycle "Change inflection" :exit nil))

(defhydra cpped-hydra-edit-insert (:exit t :hint nil)
  "
☰ Insert

Date         ^^Time         ^^Timestamp    ^^Block                    ^^Special
  _d_: local     _t_: local     _s_: local     _3_: License               _l_: Link
  _D_: ISO                    ^^_S_: ISO       _f_: File                  _u_: Unicode Character
                                         ^^^^^^_c_: Snippet               _T_: Markdown table of contents
                                         ^^^^^^_C_: Automatic snippet
"
  ("d" cpped-insert-date)
  ("D" cpped-insert-iso-date)
  ("t" cpped-insert-time)
  ("s" cpped-insert-timestamp)
  ("S" cpped-insert-iso-timestamp)
  ("3" legalese)
  ("f" insert-file)
  ("c" yas-insert-snippet)
  ("C" aya-expand)
  ("l" cpped-org-insert-link-dwim)
  ("u" helm-ucs :exit nil)
  ("T" markdown-toc-generate-or-refresh-toc))

(defhydra cpped-hydra-edit-sort (:exit t :columns 1)
  "
☰ Sort
"
  ("L" sort-lines "Lines")
  ("l" cpped-sort-lines-case-insensitive "Lines (case insensitive)")
  ("w" sort-words "Words"))

(defhydra cpped-hydra-edit-move (:exit nil :hint nil)
  "
☰ Move

    ^^↑
    ^_w_
← _a_   _d_ →
    ^_s_
    ^^↓
"
  ("w" smart-shift-up)
  ("<up>" smart-shift-up)
  ("s" smart-shift-down)
  ("<down>" smart-shift-down)
  ("a" smart-shift-left)
  ("<left>" smart-shift-left)
  ("d" smart-shift-right)
  ("<right>" smart-shift-right))

(defhydra cpped-hydra-edit-transpose (:exit t :columns 1)
  "
☰ Transpose
"
  ("c" transpose-chars "Characters")
  ("w" (if (equal major-mode 'org-mode)
           org-transpose-words
         transpose-words) "Words")
  ("l" transpose-lines "Lines")
  ("s" transpose-sentences "Sentences")
  ("e" org-transpose-elements "Org mode elements")
  ("p" transpose-paragraphs "Paragraphs")
  ("t" org-table-transpose-table-at-point "Org mode table"))

(defhydra cpped-hydra-color (:exit nil :hint nil)
  "
☰ Modify color

Brightness ^^Saturation ^^Hue
  _b_: +       _s_: +       _h_: +
  _B_: -       _S_: -       _H_: -
"
  ("b" kurecolor-increase-brightness-by-step)
  ("B" kurecolor-decrease-brightness-by-step)
  ("s" kurecolor-increase-saturation-by-step)
  ("S" kurecolor-decrease-saturation-by-step)
  ("h" kurecolor-increase-hue-by-step)
  ("H" kurecolor-decrease-hue-by-step))

(defhydra cpped-hydra-refactor (:exit t :hint nil)
  "
☰ Refactor

Identifier    ^^Namespace
  _r_: Rename     _w_: Wrap function/region
                ^^_n_: Rename enclosing
                ^^_N_: Rename
                ^^_d_: Delete enclosing
                ^^_D_: Delete
"
  ("r" lsp-rename)
  ("w" (progn
         (when (not (region-active-p))
           (c-mark-function))
         (call-interactively 'outrespace-wrap-namespace-region)))
  ("n" outrespace-change-enclosing-ns-name)
  ("N" outrespace-change-ns-name)
  ("d" outrespace-delete-enclosing-ns)
  ("D" outrespace-delete-ns-by-name))

(defhydra cpped-hydra-edit (:exit t :hint nil)
  "
☰ Edit

                                ^^Rename           ^^Replace                     ^^Change          ^^^Format                        ^^Text             ^^Transform            ^^Code
  _d_: Duplicate                    _n_: Local         _r_: String/Regex             _c_: Case          _>_: Indentation                _t_: Translate     _6_: Encode Base64     _/_: Comment
  _D_: Duplicate & Comment          _N_: File-wide     _p_: in Project               _\"_: String       _m_: Move                       _y_: Synonym       _&_: Decode Base64     _f_: Refactor
  _i_: Insert                                        ^^_G_: With previous commit     _+_: Value +       _j_: Join lines                 _l_: Spelling                             _e_: Evaluate
  _'_: Quoted insert                                                             ^^^^_-_: Value -       _:_: Fill paragraph             _s_: Sort          _k_: Encrypt           _E_: Evaluate & Replace
  _<_: Complete                                                                  ^^^^_#_: Base          _<tab>_: Spaces → Tabs          _x_: Transpose     _K_: Decrypt           _._: Suggestion
  _g_: Edit area                                                                 ^^^^_1_: Flip bool     _<backtab>_: Tabs → Spaces
  ___: Overwrite Mode                                                            ^^^^_C_: Color
  _&_: Typographic Mode                                                          ^^^^_L_: To Link

  _a_: Create Automatic snippet
"
  ("d" crux-duplicate-current-line-or-region)
  ("D" crux-duplicate-and-comment-current-line-or-region)
  ("i" cpped-hydra-edit-insert/body)
  ("'" quoted-insert)
  ("<" helm-company)
  ("g" (if (equal major-mode 'org-mode)
           (org-edit-special)
         (narrow-to-defun)))
  ("_" overwrite-mode)
  ("&" typo-mode)
  ("a" aya-create)

  ("n" iedit-dwim)
  ("N" iedit-mode)

  ("r" vr/query-replace)
  ("p" projectile-replace)
  ("G" git-undo)

  ("c" cpped-hydra-edit-case/body :exit t)
  ("\"" string-edit-at-point)
  ("#" cpped-convert-number)
  ("+" shift-number-up)
  ("-" shift-number-down)
  ("1" bool-flip-do-flip :exit nil)
  ("C" cpped-hydra-color/body :exit t)
  ("L" cpped-org-convert-to-link-dwim :exit t)

  (">" indent-tools-hydra/body :exit t)
  ("m" cpped-hydra-edit-move/body :exit t)
  ("j" cpped-join-lines)
  (":" (if (derived-mode-p 'prog-mode)
           (if (nth 4 (syntax-ppss))
               (fill-paragraph)
             (prog-fill))
         (fill-paragraph)))
  ("<tab>" (let* ((region (region-active-p))
                  (begin (if region
                            (region-beginning)
                          (point-min)))
                 (end (if region
                          (region-end)
                        (point-max))))
             (tabify begin end)
             (indent-region begin end)))
  ("<backtab>" (let* ((region (region-active-p))
                      (begin (if region
                                 (region-beginning)
                               (point-min)))
                      (end (if region
                               (region-end)
                             (point-max))))
                 (untabify begin end)
                 (indent-region begin end)))

  ("t" (cpped-translate-word-or-region nil t))
  ("y" synosaurus-choose-and-replace)
  ("." howdoi-query-line-at-point-replace-by-code-snippet)
  ("l" flyspell-auto-correct-previous-word)
  ("s" cpped-hydra-edit-sort/body :exit t)
  ("x" cpped-hydra-edit-transpose/body :exit t)
  ("k" epa-encrypt-region :exit t)
  ("K" epa-decrypt-region :exit t)

  ("6" base64-encode-region)
  ("&" base64-decode-region)

  ("/" comment-dwim-2)
  ("f" cpped-hydra-refactor/body :exit t)
  ("e" (if (region-active-p)
           (eval-region (region-beginning) (region-end))
         (eval-last-sexp)))
  ("E" (if (region-active-p)
           (let* ((beginning (region-beginning))
                  (end (region-end))
                  (expression (buffer-substring-no-properties beginning end)))
             (kill-region beginning end)
             (eval-expression (car (read-from-string (format "(progn %s)" expression))) t))
           (crux-eval-and-replace))))

(global-set-key (kbd "C-e") 'cpped-hydra-edit/body)
#+END_SRC

*** Indent new lines
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "RET") 'newline-and-indent)
(global-set-key (kbd "<C-return>") 'cpped-newline-after-current-line)
#+END_SRC

*** Undo/Redo
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "C-z") #'undo-tree-undo)
(global-set-key (kbd "C-S-z") #'undo-tree-redo)
(global-set-key (kbd "M-z") #'undo-tree-visualize)
#+END_SRC

*** Kill/yank
Insert at position
#+BEGIN_SRC emacs-lisp
(cua-selection-mode 1)
(delete-selection-mode 0)
(setq cua-global-mark-keep-visible nil)

(global-set-key (kbd "C-M-y") #'cua-toggle-global-mark)

(defun cpped-yank-to-global-mark (prefix)
  (interactive "P")
  (if (cua--global-mark-active)
      (with-current-buffer (marker-buffer cua--global-mark-marker)
        (goto-char (marker-position cua--global-mark-marker))
        (whole-line-or-region-yank prefix)
        (cua--activate-global-mark)
        (message "Copied to global mark in %s:%d"
	         (buffer-name (marker-buffer cua--global-mark-marker))
	         (marker-position cua--global-mark-marker)))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-copy (:exit t :hint nil)
  "
☰ Copy

Copy                     ^^Other
  _k_: line or region        _a_: Append next copy
  _K_: line (back)
  _w_: word
  _W_: word (back)
  _s_: sentence
  _S_: sentence (back)
  _x_: expression
  _X_: expression (back)
  _e_: enclosed area
"
  ("k" whole-line-or-region-kill-ring-save :exit nil)
  ("K" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (cpped-backward-kill-dwim)
         (cpped-yank-to-global-mark)))
  ("w" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (kill-word 1)
         (cpped-yank-to-global-mark)))
  ("W" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (backward-kill-word 1)
         (cpped-yank-to-global-mark)))
  ("s" (let ((kill-read-only-ok t)
           (buffer-read-only t))
         (kill-sentence)
         (cpped-yank-to-global-mark)))
  ("S" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (backward-kill-sentence)
         (cpped-yank-to-global-mark)))
  ("x" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (kill-sexp)
         (cpped-yank-to-global-mark)))
  ("X" (let ((kill-read-only-ok t)
             (buffer-read-only t))
         (backward-kill-sexp)
         (cpped-yank-to-global-mark)))
  ("e" (let ((kill-read-only-ok)
             (buffer-read-only t))
         (call-interactively 'change-inner)
         (cpped-yank-to-global-mark)))
  ("a" append-next-kill :exit nil))

(global-set-key (kbd "M-w") '(lambda(prefix)
                               (interactive "P")
                               (whole-line-or-region-call-with-region 'kill-ring-save prefix t)
                               (cpped-yank-to-global-mark prefix)))
(global-set-key (kbd "M-k") #'cpped-hydra-copy/whole-line-or-region-kill-ring-save)

(defhydra cpped-hydra-kill (:exit t :hint nil)
  "
☰ Cut / Delete

Cut                   ^^Delete                               ^^Other
  _k_: line or region     _SPC_: limit to one space              _a_: Append next kill
  _K_: line (back)        _C-SPC_: blank lines
  _w_: word               _d_: Duplicate lines
  _W_: word (back)        _r_: Lines not matching expression
  _s_: sentence
  _S_: sentence (back)
  _x_: expression
  _X_: expression (back)
  _e_: enclosed area
"
  ("k" whole-line-or-region-kill-region :exit nil)
  ("K" (progn
         (cpped-backward-kill-dwim)
         (cpped-yank-to-global-mark)))
  ("w" (progn
         (kill-word)
         (cpped-yank-to-global-mark)))
  ("W" (progn
         (backward-kill-word)
         (cpped-yank-to-global-mark)))
  ("s" (progn
         (kill-sentence)
         (cpped-yank-to-global-mark)))
  ("S" (progn
         (backward-kill-sentence)
         (cpped-yank-to-global-mark)))
  ("x" (progn
         (kill-sexp)
         (cpped-yank-to-global-mark)))
  ("X" (progn
         (backward-kill-sexp)
         (cpped-yank-to-global-mark)))
  ("e" (progn
         (change-inner)
         (cpped-yank-to-global-mark)))
  ("SPC" just-one-space)
  ("C-SPC" delete-blank-lines)
  ("d" delete-duplicate-lines)
  ("r" keep-lines)
  ("a" append-next-kill :exit nil))

(global-set-key (kbd "C-w") '(lambda(prefix)
                               (interactive "P")
                               (whole-line-or-region-call-with-region 'kill-region prefix t)
                               (cpped-yank-to-global-mark prefix)))
(global-set-key (kbd "C-k") #'cpped-hydra-kill/body)

(defhydra cpped-hydra-yank (:hint nil :exit nil)
  "Yank"
  ("C-y" whole-line-or-region-yank :exit nil)
  ("M-y" helm-show-kill-ring :exit t))

(global-set-key (kbd "C-y") #'cpped-hydra-yank/whole-line-or-region-yank)
(global-set-key (kbd "M-y") #'helm-show-kill-ring)

(define-key term-raw-map (kbd "C-c C-y") 'term-paste)
(define-key term-raw-map (kbd "C-c C-s") (lambda ()
                                           (interactive)
                                           (term-send-raw-string (substring-no-properties (helm-show-kill-ring)))))
#+END_SRC

** Org-Mode
*** Structure templates
#+BEGIN_SRC emacs-lisp
(defun cpped-org-expand-template (shortcut)
  "Expand org structure templates."
  (insert shortcut)
  (org-try-structure-completion))

(defhydra cpped-hydra-org-structure-template (:exit t :hint nil)
  "
☰ Structure templates

Format          ^^Markup         ^^Script            ^^Diagram        ^^Other
  _c_: Center       _a_: ASCII       _l_: Emacs Lisp     _d_: Dot         _i_: include
  _e_: Example      _h_: HTML        _z_: Zsh            _u_: UML         _P_: Properties
  _q_: Quote        _/_: Comment     _+_: C++            _p_: Gnuplot     _*_: Calculator
  _v_: Verbatim                    ^^_b_: Bash
                                 ^^^^_s_: Shell
                                 ^^^^_r_: Source
"
  ("c" (cpped-org-expand-template "<c"))
  ("e" (cpped-org-expand-template "<e"))
  ("q" (cpped-org-expand-template "<q"))
  ("v" (cpped-org-expand-template "<v"))
  ("a" (cpped-org-expand-template "<a"))
  ("h" (cpped-org-expand-template "<h"))
  ("/" (cpped-org-expand-template "</"))
  ("l" (cpped-org-expand-template "<l"))
  ("z" (cpped-org-expand-template "<z"))
  ("+" (cpped-org-expand-template "<+"))
  ("b" (cpped-org-expand-template "<b"))
  ("s" (cpped-org-expand-template "<s"))
  ("r" (cpped-org-expand-template "<r"))
  ("d" (cpped-org-expand-template "<d"))
  ("u" (cpped-org-expand-template "<u"))
  ("p" (cpped-org-expand-template "<p"))
  ("i" (cpped-org-expand-template "<i"))
  ("P" (cpped-org-expand-template "<P"))
  ("*" (cpped-org-expand-template "<*")))

(define-key org-mode-map "<" (lambda ()
                               (interactive)
                               (if (looking-back "^")
                                   (cpped-hydra-org-structure-template/body)
                                 (self-insert-command 1))))
#+END_SRC

** PDF-View-Mode
#+BEGIN_SRC emacs-lisp
(with-eval-after-load "pdf-tools"
  (progn
    (defhydra cpped-hydra-pdf-view (:exit nil :hint nil)
      "
☰ PDF

Navigation           ^^Zoom                 ^^Annotations               ^^Information
  _p_: Previous page     _+_: Zoom in           _l_: List                   _m_: Show metadata
  _n_: Next page         _-_: Zoom out          _._: List attachments

  _a_: First page        _f_: Fit to page       _t_: Add text
  _e_: Last page         _w_: Fit to width      _#_: Highlight
                       ^^_h_: Fit to height     _\__: Underline
  _g_: Go to page                             ^^_~_: Squiggly underline
                                            ^^^^_/_: Strikethrough
  _o_: Show outline
                                            ^^^^_d_: Delete
"
      ("p" pdf-view-previous-page)
      ("<prior>" pdf-view-previous-page)
      ("n" pdf-view-next-page)
      ("<next>" pdf-view-next-page)
      ("a" pdf-view-first-page)
      ("<home>" pdf-view-first-page)
      ("e" pdf-view-last-page)
      ("<end>" pdf-view-last-page)
      ("g" pdf-view-goto-page)
      ("o" pdf-outline)

      ("+" pdf-view-enlarge)
      ("-" pdf-view-shrink)
      ("f" pdf-view-fit-page-to-window)
      ("w" pdf-view-fit-width-to-window)
      ("h" pdf-view-fit-height-to-window)

      ("l" pdf-annot-list-annotations)
      ("." pdf-annot-attachment-dired)
      ("t" pdf-annot-add-text-annotation)
      ("#" pdf-annot-add-highlight-markup-annotation)
      ("_" pdf-annot-add-underline-markup-annotation)
      ("~" pdf-annot-add-squiggly-markup-annotation)
      ("/" pdf-annot-add-strikeout-markup-annotation)
      ("d" pdf-annot-delete)

      ("m" (if (get-buffer "*PDF-Metadata*")
               (kill-buffer "*PDF-Metadata*")
             (pdf-misc-display-metadata))))

    (add-hook 'pdf-view-mode-hook 'cpped-hydra-pdf-view/body)))
#+END_SRC

** DocView-Mode
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-doc-view (:exit nil :hint nil)
  "
☰ Document

Navigation           ^^Zoom
  _p_: Previous page     _+_: Zoom in
  _n_: Next page         _-_: Zoom out

  _a_: First page        _f_: Fit to page
  _e_: Last page         _w_: Fit to width
                       ^^_h_: Fit to height
  _g_: Go to page
"
  ("p" doc-view-previous-page)
  ("<prior>" doc-view-previous-page)
  ("n" doc-view-next-page)
  ("<next>" doc-view-next-page)
  ("a" doc-view-first-page)
  ("<home>" doc-view-first-page)
  ("e" doc-view-last-page)
  ("<end>" doc-view-last-page)
  ("g" doc-view-goto-page)

  ("+" doc-view-enlarge)
  ("-" doc-view-shrink)
  ("f" doc-view-fit-page-to-window)
  ("w" doc-view-fit-width-to-window)
  ("h" doc-view-fit-height-to-window))

(add-hook 'doc-view-minor-mode-hook 'cpped-hydra-doc-view/body)

;(define-key doc-view-mode-map (kbd "C-s") #'doc-view-search)
#+END_SRC

** Logview-Mode
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-logview (:exit nil :hint nil :foreign-keys run)
  "
☰ Log

Navigation                      ^^Levels                       ^^Filter
  _p_: Previous entry               _1_: Errors                    _f_: Edit
  _n_: Next entry                   _2_: Warnings                  _x_: Reset
                                  ^^_3_: Information
  _P_: Previous important entry     _4_: Debug                     _h_: Hide entries
  _N_: Next important entry         _5_: All                       _s_: Show entries

                                  ^^_+_: Show all as important     _d_: Toggle details
"
  ("n" logview-next-entry)
  ("p" logview-previous-entry)
  ("N" logview-next-as-important-entry)
  ("P" logview-previous-as-important-entry)
  ("1" logview-show-only-errors)
  ("2" logview-show-errors-and-warnings)
  ("3" logview-show-errors-warnings-and-information)
  ("4" logview-show-errors-warnings-information-and-debug)
  ("5" logview-show-all-levels)
  ("+" logview-show-only-as-important)
  ("f" logview-edit-filters)
  ("x" logview-reset-all-filters)
  ("h" logview-hide-entry)
  ("s" (if (region-active-p)
           (logview-show-entries)
         (logview-show-region-entries)))
  ("d" (if (region-active-p)
           (logview-toggle-entry-details)
         (logview-toggle-region-entry-details)))
  ("q" cpped-kill-default-buffer :exit t)
  ("ESC" cpped-kill-default-buffer :exit t))

(add-hook 'logview-mode-hook 'cpped-hydra-logview/body)
#+END_SRC

** Remote
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-remote (:exit t :columns 1)
  "
☰ Remote
"
  ("t" cpped-serial-terminal "Serial Terminal")
  ("s" helm-tramp "Remote Shell"))

(global-set-key (kbd "C-r") 'cpped-hydra-remote/body)
#+END_SRC

** Windows
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-windows (:exit nil :hint nil)
  "
☰ Window Management

Focus                  ^^^^Close                ^^Split               ^^Align               ^^View                                ^^Zoom               ^^Size                    ^^Misc
  _\\^_: Switch window       _x_: Window            ^_v_: Vertically       _t_: Swap windows     _<left>_: Scroll left                 _C-+_: Zoom in       _f_: Toggle fullscreen    _l_: Lock screen
                         ^^^^_X_: Other windows     _h_: Horizontally     _+_: Enlarge         _<right>_: Scroll right                _C--_: Zoom out
                         ^^^^_q_: Frame                                 ^^_-_: Shrink           _<C-up>_: Scroll other window up
                                                                                    ^^^^^^^^^^_<C-down>_: Scroll other window down
                                                                                    ^^^^^^^^^^_<C-home>_: Beginning of other window
                                                                                     ^^^^^^^^^^_<C-end>_: End of other window
                                                                                           ^^^^^^^^^^_1_: Toggle line numbers
                                                                                           ^^^^^^^^^^_#_: Toggle relative line numbers
"
  ("x" delete-window :exit t)
  ("X" delete-other-windows :exit t)
  ("^" (call-interactively #'switch-window) :exit t)
  ("q" cpped-close-editor)
  ("v" split-window-below)
  ("h" split-window-right)
  ("t" crux-transpose-windows)
  ("+" enlarge-window-horizontally)
  ("-" shrink-window-horizontally)
  ("<left>" scroll-left)
  ("<right>" scroll-right)
  ("<up>" scroll-up)
  ("<down>" scroll-down)
  ("<home>" beginning-of-buffer)
  ("<end>" end-of-buffer)
  ("<C-up>" scroll-other-window)
  ("<C-down>" scroll-other-window-down)
  ("<C-home>" beginning-of-buffer-other-window)
  ("<C-end>" end-of-buffer-other-window)
  ("1" display-line-numbers-mode)
  ("#" (if (eq display-line-numbers 'relative)
           (setq display-line-numbers t)
         (setq display-line-numbers 'relative)))
  ("C-+" cpped-zoom-in)
  ("C--" cpped-zoom-out)
  ("f" toggle-frame-fullscreen :exit t)
  ("l" cpped-lock-screen :exit t))

(global-set-key (kbd "C-^") #'cpped-hydra-windows/body)
(global-set-key (kbd "C-x C-c") #'cpped-close-editor)
#+END_SRC

** Settings
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-settings (:exit t :hint nil)
  "
☰ Settings

Settings                       ^^Snippets            ^^Abbreviations             ^^Packages
  _c_: Open config file            _Y_: New snippet      _A_: New abbreviation       _p_: Show packages
  _m_: Open customization file     _y_: Edit snippet     _a_: Edit abbreviations
  _t_: Edit theme
  _v_: Customize variable
  _g_: Customize group

  _s_: Set variable

  _d_: %s(if debug-on-error
             \"Disable\"
           \"Enable\") debug on error
"
  ("c" (find-file cpped-config-file))
  ("m" (find-file custom-file))
  ("y" yas-visit-snippet-file)
  ("Y" yas-new-snippet)
  ("a" edit-abbrevs)
  ("A" add-inverse-global)
  ("p" list-packages)
  ("t" (custom-theme-visit-theme cpped-theme))
  ("v" customize-variable)
  ("g" customize-group)
  ("s" set-variable)
  ("d" (setq debug-on-error (not debug-on-error))))

(global-set-key (kbd "C-S-s") #'cpped-hydra-settings/body)
#+END_SRC

** Help
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-help (:exit t :columns 1)
  "
☰ Help
"
  ("f" helpful-callable "Function")
  ("v" describe-variable "Variable")
  ("s" describe-symbol "Symbol")
  ("k" describe-key "Key")
  ("p" finder-commentary "Package")
  ("y" describe-syntax "Syntax")
  ("m" helm-man-woman "Man Page")
  ("i" info "Info Page"))

(global-set-key (kbd "C-h") #'helpful-at-point)
(global-set-key (kbd "C-S-h") #'cpped-hydra-help/body)
#+END_SRC

** Tools
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-tools-docker (:exit t :hint nil)
  "
☰ Docker

  _i_: Images
  _c_: Containers
  _v_: Volumes
  _n_: Networks
  _m_: Machines
"
  ("i" docker-images)
  ("c" docker-containers)
  ("v" docker-volumes)
  ("n" docker-networks)
  ("m" docker-machines)
  ("l" docker-container-logs-popup))

(defhydra cpped-hydra-tools (:exit t :hint nil)
  "
☰ Tools

Tools                      ^^Last Command    ^^System
  _c_: Calculator              _r_: Repeat       _a_: Run application
  _x_: Regex Builder           _f_: Resume       _p_: Show processes
  _e_: Evaluate expression                     ^^_s_: Show system services
                                             ^^^^_d_: Docker

_=_: Directory Diff
"
  ("c" helm-calcul-expression)
  ("x" re-builder)
  ("e" eval-expression)
  ("=" ztree-diff)
  ("r" repeat)
  ("f" helm-resume)
  ("a" cpped-run-application)
  ("p" helm-top)
  ("s" helm-systemd)
  ("d" cpped-hydra-tools-docker/body))

(global-set-key (kbd "C-t") #'cpped-hydra-tools/body)
#+END_SRC

*** Docker
**** Images
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-docker-images (:exit nil :hint nil :foreign-keys run)
  "
☰ Docker Images

              ^^Sync        ^^Info
  _r_: Run        _f_: Pull     _ß_: Inspect
              ^^^^_p_: Push
  _k_: Remove     _t_: Tag
"
  ("r" docker-images-run-popup)
  ("k" docker-images-rmi-popup)
  ("f" docker-images-pull-popup)
  ("p" docker-images-push-popup)
  ("t" docker-images-tag-entry)
  ("ß" docker-images-inspect-popup)
  ("q" nil :exit t))

(add-hook 'docker-images-mode-hook 'cpped-hydra-docker-images/body)
#+END_SRC

**** Containers
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-docker-containers (:exit nil :hint nil :foreign-keys run)
  "
☰ Docker Containers

Run            ^^Info
  _s_: Start       _ß_: Inspect
  _t_: Stop        _d_: Diff
  _p_: Pause
  _r_: Restart
  _k_: Kill
"
  ("s" docker-containers-start-popup)
  ("t" docker-containers-stop-popup)
  ("p" docker-containers-pause-popup)
  ("r" docker-containers-restart-popup)
  ("k" docker-containers-kill-popup)
  ("ß" docker-containers-inspect-popup)
  ("d" docker-containers-diff-popup)
  ("q" nil :exit t))

(add-hook 'docker-containers-mode-hook 'cpped-hydra-docker-containers/body)
#+END_SRC

**** Machines
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-docker-machines (:exit nil :hint nil :foreign-keys run)
  "
☰ Docker Machines

              ^^Run           ^^Info
  _c_: Create    _s_: Start       _ß_: Inspect
               ^^_t_: Stop        _e_: Environment
  _k_: Remove    _r_: Restart
"
  ("c" docker-machine-create)
  ("k" docker-machine-rm-popup)
  ("s" docker-machine-start-popup)
  ("t" docker-machine-stop-popup)
  ("r" docker-machine-restart-popup)
  ("ß" docker-machine-inspect)
  ("e" docker-machine-env-popup)
  ("q" nil :exit t))

(add-hook 'docker-machines-mode-hook 'cpped-hydra-docker-machines/body)
#+END_SRC

** Build
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-build (:exit t :columns 1)
  "
☰ Build 🞋 %s(if cpped-cmake-current-target
     cpped-cmake-current-target
    \"none\")
"
  ("t" cpped-cmake-select-target "Select Target")
  ("b" cpped-build-target "Build target")
  ("B" (let ((cpped-cmake-current-target nil))
         (call-interactively #'cpped-build-target)) "Select and build target")
  ("c" cpped-cmake-clean-build-directory "Clean build directory"))

(global-set-key (kbd "C-b") #'cpped-hydra-build/body)
#+END_SRC

** Planning
#+BEGIN_SRC emacs-lisp
(defhydra cpped-hydra-planning (:exit t :hint nil)
  "
☰ Planning %s(format \"%s %s\" (cpped-print-time) (cpped-print-remaining-work-time))

Open                ^^Create       ^^Work         ^^Task                        ^^Chart
  _a_: Agenda           _c_: Entry     _b_: Break     _r_: Clock in recent task     _d_: Daily timesheet
  _u_: Current Task                               ^^^^_i_: Clock in                 _m_: Monthly timesheet
                                                ^^^^^^_o_: Clock out
  _t_: ToDos                                      ^^^^_E_: Set estimate
  _b_: Bugs                                       ^^^^_+_: Increase estimate
  _n_: Notes
  _e_: Events
"
  ("a" (org-agenda nil "D"))
  ("u" org-clock-goto)
  ("t" (find-file org-default-todos-file))
  ("b" (find-file org-default-bugs-file))
  ("n" (find-file org-default-notes-file))
  ("e" (find-file org-default-events-file))

  ("c" helm-org-capture-templates)

  ("b" (if (not (org-clocking-p))
           (org-mru-clock-in)
         (cpped-punch-out)
         (cpped-lock-screen)))

  ("r" org-mru-clock-in)
  ("i" org-clock-in)
  ("o" org-clock-out)
  ("E" (when (and (org-clocking-p)
                  org-clock-marker)
         (with-current-buffer (marker-buffer org-clock-marker)
           (goto-char (marker-position org-clock-marker))
           (org-set-effort (helm :sources (helm-build-sync-source "Effort"
                                            :candidates (split-string (cdr (assoc 'Effort_ALL org-global-properties)) " "))
                                 :prompt "Effort: "
                                 :preselect org-clock-effort
                                 :buffer "*helm effort*")))))
  ("+" (when (and (org-clocking-p)
                  org-clock-marker)
         (with-current-buffer (marker-buffer org-clock-marker)
           (goto-char (marker-position org-clock-marker))
           (org-set-effort nil t))))

  ("d" (org-agenda nil "d"))
  ("m" (org-agenda nil "p")))

(global-set-key (kbd "C-l") #'cpped-hydra-planning/body)
#+END_SRC

* Notify when loading is finished
#+BEGIN_SRC emacs-lisp
(notifications-notify :title "IDE ready")
#+END_SRC
